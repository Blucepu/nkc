!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";function e(){return(e=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e}).apply(this,arguments)}var n=[],t=[],a=parseInt($("#applicationFormId").text()),r=$("#fundId").text();function i(e,n){var t=e.page||0,a=e.pageCount||1;if(a<=1)return"";var r,i,o="",s=t-3,c=t+3;s>0?c>a?(i=a,r=s-(c-a)<0?0:s-(c-a)):(i=c,r=s):(r=0,i=c<a?a<c-s?a:c-s:a-1),console.log(r,t,i),void 0===n&&(n="");for(var d=0;d<a;d++)if(!(d<r||d>i)){var l="";t===d&&(l="active"),o+='<li class="'+l+'"><a onclick="getThreads('+d+","+n+')">'+(d+1)+"</a></li>"}return o}function o(e,n){var t=i(e,n);$(".pageList").html(t)}function s(e,n,t){var a="",r="";t=!0===t?"disabled":"","add"===n?(a="addThread",r="glyphicon glyphicon-plus"):(a="deleteThread",r="glyphicon glyphicon-remove");for(var i="",o=0;o<e.length;o++){var s=e[o],c=s.tid,d=s.uid,l=s.pid,u=s.username,p=s.t,f=s.toc;i+='<div class="threadList">'+('<div class="col-xs-10 col-md-10"><div class="postString displayNone">'+JSON.stringify(s)+'</div><span>文号：</span><span class="threadNumber">'+l+'&nbsp;&nbsp;</span><a href="/m/'+d+'" target="_blank">'+u+"</a><span>&nbsp;发表于 "+f+'</span><br><a href="/t/'+c+'" target="_blank">'+p+"</a></div>")+('<div class="col-xs-2 col-md-2 delete '+t+" "+r+'" onclick="'+a+"('"+c+"','"+l+"');this.style.backgroundColor = '#2aabd2';\"></div>")+"</div>"}return i}function c(e,n,t,a){var r;""===(r=s(n,"add"===a?"add":"delete",t))&&(r='<div class="blank blank-selectedThread">暂无数据</div>',$(e).html()),$(e).html(r)}function d(){var e="";0===n.length&&(e="<span>暂未选择</span>");for(var t=0;t<n.length;t++)e+='<span class="fund-span selectedUser selected" onclick="deleteThread(\''+n[t].tid+"')\">"+n[t].pid+'<span class="fund-span delete glyphicon glyphicon-remove"></span></span>';$("#selectedThread").html(e)}function l(){var e=$("#actualMoney .list .fund-money-list").length;t=[];for(var n=0;n<e;n++){var a=$('.actualPurpose[num="'+n+'"]').text(),r=$('.actualCount[num="'+n+'"]').text();(r=parseInt(r))>=1||(r=0);var i=$('.actualMoney[num="'+n+'"]').text();(i=parseInt(i))>=1||(i=0),t.push({purpose:a,count:r,money:i})}u()}function u(){for(var e="",n=0,a=0;a<t.length;a++){var r=t[a],i=r.count*r.money;n+=i,e+='<div class="fund-money-list">'+('<div class="actualPurpose" contenteditable=true num="'+a+'">'+r.purpose+"</div>")+('<div class="actualCount" contenteditable=true num="'+a+'">'+r.count+"</div>")+('<div class="actualMoney" contenteditable=true num="'+a+'">'+r.money+"</div>")+('<div class="actualTotal" num="'+a+'">'+i+"</div>")+('<div class="delete glyphicon glyphicon-remove" onclick="deleteList('+a+')"></div>')+"</div>"}$("#actualMoney .list").html(e);var o=$(".factMoney").text(),s=(o=parseInt(o))>=n?o-n:0;if($("#aggregate").text("实际批准："+o+"元，实际花费："+n+"元，应退金额："+s+"元"),s>0){var c='&nbsp;&nbsp;<span class="fund-span" onclick="refund('+s+')">去退款</span>';$("#aggregate").html($("#aggregate").html()+c)}p()}function p(){$("div[contenteditable=true]").on("blur",(function(){l()}))}$((function(){l()})),e(window,{getThreads:function(e,n){var t;if(e=void 0!==e?"page="+e+"&":"",void 0===n){var r=$("#searchThread").val();if(""===r)return screenTopWarning("输入不能为空！");t="/t?"+e+"from=applicationForm&applicationFormId="+a+"&keywords="+r}else t="/t?"+e+"from=applicationForm&self=true";$(".unselectedThreads").html('<div class="blank blank-selectedThread">搜索中...</div>'),nkcAPI(t,"GET",{}).then((function(e){tempThreads=e.threads,o(e.paging,n),0===tempThreads.length&&screenTopAlert("什么也没找到..."),c(".unselectedThreads",tempThreads,!1,"add")})).catch((function(e){screenTopWarning(e.error);$(".unselectedThreads").html('<div class="blank blank-selectedThread">error</div>')}))},createPageList:i,displayPageList:o,createThreadsList:s,disabledRolling:function(e){$(window).scrollTop(e)},initThreadsList:function(){for(var e=$(".selectedThreads .threadList .postString"),t=e.length,a=0;a<t;a++){var r=e.eq(a).text(),i=JSON.parse(r);n.push(i)}},displayThreadsList:c,deleteThread:function(e){for(var t=0;t<n.length;t++)n[t].tid===e&&n.splice(t,1);d()},addThread:function(e,t){for(var a=!1,r=0;r<n.length;r++)if(n[r].tid===e){a=!0;break}a||n.push({tid:e,pid:t}),d()},displaySelectedThreads:d,clearLog:function(){$(".unselectedThreads").html('<div class="blank" style="color:#aaa;">暂无数据</div>')},submit:function(e){var a=$('input[name="success"]'),r=!1,i=$("#content").val();return i?(a.eq(0).is(":checked")&&(r=!0),0===n.length?screenTopWarning("请选择文章。"):void nkcAPI("/fund/a/"+e+"/complete","POST",{successful:r,selectedThreads:n,c:i,actualMoney:t}).then((function(){screenTopAlert("提交成功。"),setTimeout((function(){openToNewLocation("/fund/a/"+e)}),1200)})).catch((function(e){screenTopWarning(e.error)}))):screenTopWarning("请输入项目结项报告。")},submitCompletedAudit:function(e,n){var t=$("#completedAuditContent").val();if("notPass"===e&&""===t)return screenTopWarning("请填写理由。");nkcAPI("/fund/a/"+n+"/complete/audit","POST",{c:t,type:e}).then((function(){openToNewLocation("/fund/a/"+n)})).catch((function(e){screenTopWarning(e.error)}))},initActualMoney:l,displayActualMoney:u,divBlur:p,addList:function(){t.push({purpose:"新建",count:0,money:0}),u()},deleteList:function(e){t.splice(e,1),u()},compute:function(){l()},refund:function(e){var n,a=r,i=e,o="refund",s=t,c=NKC.methods.isPhone(),d="/fund/donation?getUrl=true&fundId="+a+"&money="+i+"&type="+o+"&actualMoney="+s;if("reactNative"!==NKC.configs.platform){if(c)return d+="&redirect=true",screenTopAlert("正在前往支付宝..."),window.location.href=d;n=window.open()}nkcAPI(d,"GET").then((function(e){"reactNative"===NKC.configs.platform?NKC.methods.visitUrl(e.url,!0):n.location=e.url,sweetInfo("请在浏览器新打开的窗口完成支付！若没有新窗口打开，请检查新窗口是否已被浏览器拦截。")})).catch((function(e){sweetError(e),n&&(n.document.body.innerHTML=e.error||e)}))},disappearMask:function(){$("#donation-mask").addClass("hidden")}})}));
