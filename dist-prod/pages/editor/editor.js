!function(t){"function"==typeof define&&define.amd?define(t):t()}((function(){"use strict";function t(){return(t=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var o=arguments[e];for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(t[n]=o[n])}return t}).apply(this,arguments)}window.editor=void 0,window.PostInfo=void 0,window.PostButton=void 0,window.PostToColumn=void 0,window.PostSurvey=void 0,window.ForumSelector=void 0,window.CommonModal=void 0;var e=!1;function o(){window.PostInfo=new Vue({el:"#postInfo",data:{minorForumCount:data.minorForumCount||{},saveDraftTimeout:6e4,originalWordLimit:data.originalWordLimit||0,type:"newThread",thread:"",post:"",forum:"",draftId:"",oldDraft:"",forums:[],selectedForums:[],anonymous:!1,parentPostId:"",abstractCn:"",abstractEn:"",title:"",content:"",contentLength:"",cover:"",coverUrl:"",coverData:"",keyWordsCn:[],keyWordsEn:[],authorInfos:[],originState:0,surveyId:"",quoteHtml:"",showCloseInfo:!1,websiteUserId:data.websiteCode+"ID"},mounted:function(){var t=this;editor.addListener("contentChange",(function(){t.watchContentChange()})),data.mainForums=data.mainForums||[];for(var e=0;e<data.mainForums.length;e++)t.initForumCategory(data.mainForums[e]);this.selectedForums=data.mainForums||[],this.thread=data.thread,this.post=data.post,this.forum=data.forum,this.type=data.type,this.draftId=data.draftId,this.oldDraft=data.oldDraft,this.initPost(data.post);var o=this;if(editor.methods.selectedDraft=function(t){o.insertDraftInfo(t)},o.oldDraft){var n="是否加载 "+o.format("YYYY/MM/DD HH:ss:mm",o.oldDraft.tlm)+" 编辑但未提交的内容？";sweetQuestion(n).then((function(){NKC.configs.isApp?window.location.href="/editor?type=redit&id="+o.oldDraft.did:o.visitUrl("/editor?type=redit&id="+o.oldDraft.did)})).catch((function(){o.autoSaveToDraft(),o.showCloseInfo=!0,o.getContentFromLocal(),o.alertPermissionInfo()}))}else o.autoSaveToDraft(),o.showCloseInfo=!0,setTimeout((function(){o.getContentFromLocal()}),2e3),o.alertPermissionInfo()},watch:{selectedForums:function(){setTimeout((function(){floatForumPanel.initPanel()}),100),PostButton&&PostButton.checkAnonymous()}},computed:{allowedOriginal:function(){var t=this.contentLength>=this.originalWordLimit;return t||(this.originState=0),t},keywordsLength:function(){return this.keyWordsEn.length+this.keyWordsCn.length},abstractCnLength:function(){return this.getLength(this.abstractCn)},abstractEnLength:function(){return this.getLength(this.abstractEn)},selectedForumsId:function(){for(var t=[],e=this.selectedForums,o=0;o<e.length;o++){var n=e[o];n.fid&&t.push(n.fid)}return t},selectedCategoriesId:function(){for(var t=[],e=this.selectedForums,o=0;o<e.length;o++){var n=e[o];n.cid&&t.push(n.cid)}return t},mainForum:function(){return this.selectedForums[0]},minorForums:function(){var t=[].concat(this.selectedForums);return t.shift(),t}},methods:{getLength:NKC.methods.checkData.getLength,checkString:NKC.methods.checkData.checkString,checkEmail:NKC.methods.checkData.checkEmail,visitUrl:NKC.methods.visitUrl,fromNow:NKC.methods.fromNow,format:NKC.methods.format,getUrl:NKC.methods.tools.getUrl,insertDraftInfo:function(t){},watchContentChange:function(){var t=editor.getContentTxt();this.contentLength=t.length},alertPermissionInfo:function(){data.permissionInfo&&sweetInfo(data.permissionInfo)},getContentFromLocal:function(){!NKC.configs.isApp||"newThread"!==data.type||data.post&&data.post.c||s()},removeCover:function(){this.cover="",this.coverData="",this.coverUrl=""},selectCover:function(){var t=this;return NKC.modules.SelectResource?NKC.methods.selectImage?(window.SelectResource||(window.SelectResource=new NKC.modules.SelectResource),window.SelectImage||(window.SelectImage=new NKC.methods.selectImage),void SelectResource.open((function(e){var o,n=e.resources[0];o=n.originId?"/ro/"+n.originId:"/r/"+n.rid,SelectImage.show((function(e){t.coverData=e,NKC.methods.fileToUrl(NKC.methods.blobToFile(e)).then((function(e){t.coverUrl=e,SelectImage.close()}))}),{aspectRatio:1.5,url:o})}),{allowedExt:["picture"],countLimit:1})):sweetError("未引入图片裁剪模块"):sweetError("未引入资源选择模块")},autoSaveToDraft:function(){var t=this,e=this.type;if("newThread"===e){if(!(t.title||t.content||t.selectedForums&&t.selectedForums.length||t.cover||t.abstractCn||t.abstractEn||t.keyWordsCn||t.keyWordsEn||t.authorInfos||t.surveyId))return}else if("newPost"===e&&!t.title&&!t.content)return;setTimeout((function(){t.saveToDraftBase().then((function(){PostButton.saveToDraftSuccess(),t.autoSaveToDraft()})).catch((function(e){sweetError("草稿保存失败："+(e.error||e)),t.autoSaveToDraft()}))}),t.saveDraftTimeout)},saveToDraft:function(){this.saveToDraftBase().then((function(){PostButton.saveToDraftSuccess(),sweetSuccess("草稿已保存")})).catch((function(t){sweetError("草稿保存失败："+(t.error||t))}))},initPost:function(t){if(t){this.title=t.t,this.setTitle();var e=/<blockquote cite.+?blockquote>/,o=t.c.match(e);o&&o[0]&&(this.quoteHtml=o[0]),this.content=t.c.replace(e,""),this.setContent(),this.cover=t.cover,this.parentPostId=t.parentPostId,this.abstractCn=t.abstractCn,this.abstractEn=t.abstractEn,this.originState=t.originState,this.keyWordsCn=t.keyWordsCn,this.keyWordsEn=t.keyWordsEn,this.authorInfos=t.authorInfos,this.surveyId=t.surveyId}},getTitle:function(){this.title=$("#title").val()},setTitle:function(){$("#title").val(this.title)},getContent:function(){if(!e)return sweetError("编辑器尚未初始化");this.content=editor.getContent()},setContent:function(){if(!e)return sweetError("编辑器尚未初始化");editor.setContent(this.content)},addAuthor:function(){this.authorInfos.push({name:"",kcid:"",agency:"",agencyCountry:"",agencyAdd:"",isContract:!1,contractObj:{contractEmail:"",contractTel:"",contractAdd:"",contractCode:""}})},initForumCategory:function(t){t.forum.threadTypes&&t.forum.threadTypes.length||(t.cid="")},moveAuthor:function(t,e){var o,n=this.authorInfos;if("up"===e){if(0===t)return;o=t-1}else{if(t+1===n.length)return;o=t+1}var r=n[t];n[t]=n[o],n[o]=r,Vue.set(n,0,n[0])},removeAuthor:function(t,e){sweetQuestion("确定要删除该条作者信息？").then((function(){e.splice(t,1)})).catch((function(){}))},removeKeyword:function(t,e){e.splice(t,1)},getForumById:function(t){for(var e=this.forums,o=0;o<e.length;o++){var n=e[o];if(n.fid===t)return n}},removeSelectedForums:function(t){this.selectedForums.splice(t,1)},addKeyword:function(){var t=this;if(!NKC.modules.CommonModal)return sweetError("未引入表单模块");window.CommonModal||(window.CommonModal=new NKC.modules.CommonModal),CommonModal.open((function(e){t.keyWordsEn=[],t.keyWordsCn=[];var o=e[0].value,n=e[1].value;o=o.replace(/，/gi,","),n=n.replace(/，/gi,",");for(var r=o.split(","),i=n.split(","),a=0;a<r.length;a++){var s=r[a];(s=s.trim())&&-1===t.keyWordsCn.indexOf(s)&&t.keyWordsCn.push(s)}for(a=0;a<i.length;a++){var d=i[a];(d=d.trim())&&-1===t.keyWordsEn.indexOf(d)&&t.keyWordsEn.push(d)}if(!r.length&&!i.length)return sweetError("请输入关键词");CommonModal.close()}),{data:[{label:"中文，添加多个请以逗号分隔",dom:"textarea",value:this.keyWordsCn.join("，")},{label:"英文，添加多个请以逗号分隔",dom:"textarea",value:this.keyWordsEn.join(",")}],title:"添加关键词"})},selectForumsByType:function(t){var e=this;window.ForumSelector||(window.ForumSelector=new NKC.modules.ForumSelector);var o=[].concat(e.selectedForumsId),n="";"mainForum"===t&&(n=o.shift()),ForumSelector.open((function(o){if(o.logo=o.forum.logo,o.color=o.forum.color,o.fName=o.forum.displayName,o.cName=o.threadType?o.threadType.name:"","mainForum"===t)Vue.set(e.selectedForums,0,o);else{if(-1!==e.selectedForumsId.indexOf(o.fid))return;e.selectedForums.push(o)}}),{highlightForumId:n,selectedForumsId:o,disabledForumsId:[]})},checkAuthorInfos:function(){for(var t=this.checkAuthorInfos,e=0;e<t.length;e++){var o=t[e];this.checkString(o.name,{name:"作者姓名",minLength:1,maxLength:100}),this.checkString(o.kcid,{name:this.websiteUserId,minLength:0,maxLength:100}),this.checkString(o.agency,{name:"机构名称",minLength:0,maxLength:100}),this.checkString(o.agencyAdd,{name:"机构地址",minLength:0,maxLength:100}),o.isContract&&(this.checkEmail(o.contractObj.contractEmail),this.checkString(o.contractObj.contractEmail,{name:"通信邮箱",minLength:1,maxLength:200}),this.checkString(o.contractObj.contractTel,{name:"通信电话",minLength:0,maxLength:100}),this.checkString(o.contractObj.contractAdd,{name:"通信地址",minLength:0,maxLength:200}),this.checkString(o.contractObj.contractCode,{name:"通信邮编",minLength:0,maxLength:100}))}},checkTitle:function(){if(this.title.length<3)throw new Error("标题不能少于3个字");if(this.title.length>100)throw new Error("标题不能超过100个字")},checkContent:function(){var t=$(this.content).text();if(t.length>1e5)throw new Error("内容不能超过10万字");if(t.length<2)throw new Error("内容不能少于2个字")},checkAbstract:function(){this.checkString(this.abstractCn,{name:"中文摘要",minLength:0,maxLength:1e3}),this.checkString(this.abstractEn,{name:"英文摘要",minLength:0,maxLength:1e3})},checkForums:function(){if(!this.selectedForumsId.length)throw"请至少选择一个专业";for(var t=0;t<this.selectedForums.length;t++){if(null===this.selectedForums[t].cid)throw"请选择完整的专业分类"}},checkKeywords:function(){if(this.keywordsLength>50)throw"关键词数量超出限制"},getPost:function(){var t={},e=this;if(e.getTitle(),e.getContent(),t.abstractCn=e.abstractCn,t.abstractEn=e.abstractEn,t.parentPostId=e.parentPostId,t.keyWordsEn=e.keyWordsEn,t.keyWordsCn=e.keyWordsCn,t.cover=e.cover,t.t=e.title,t.fids=e.selectedForumsId,t.cids=e.selectedCategoriesId,t.c=(e.quoteHtml||"")+e.content,t.authorInfos=e.authorInfos,t.originState=e.originState,t.did=e.draftId,PostButton.havePermissionToSendAnonymousPost&&PostButton.allowedAnonymous&&(t.anonymous=!!PostButton.anonymous),PostToColumn&&PostToColumn.getStatus){var o=PostToColumn.getStatus();o.checkbox&&(t.columnMainCategoriesId=o.selectedMainCategoriesId||[],t.columnMinorCategoriesId=o.selectedMinorCategoriesId||[])}if(PostSurvey){var n=PostSurvey.getSurvey();n&&(t.survey=n)}return t},submit:function(){var t,e=this,o={};Promise.resolve().then((function(){PostButton.disabledSubmit=!0,t=e.type,o=e.getPost()})).then((function(){var n;return"newThread"===t?(e.checkTitle(),e.checkContent(),e.checkAbstract(),e.checkForums(),e.checkKeywords(),e.checkAuthorInfos(),(n=new FormData).append("body",JSON.stringify({post:o})),e.coverData&&n.append("postCover",NKC.methods.blobToFile(e.coverData)),nkcUploadFile("/f/"+o.fids[0],"POST",n)):"newPost"===t?(e.checkString(e.title,{name:"标题",minLength:0,maxLength:200}),e.checkContent(),nkcAPI("/t/"+e.thread.tid,"POST",{post:o})):"modifyPost"===t?(e.checkString(e.title,{name:"标题",minLength:0,maxLength:200}),e.checkContent(),(n=new FormData).append("body",JSON.stringify({post:o})),e.coverData&&n.append("postCover",NKC.methods.blobToFile(e.coverData)),nkcUploadFile("/p/"+e.post.pid,"PUT",n)):"modifyThread"===t?(e.checkTitle(),e.checkContent(),e.checkAbstract(),e.checkKeywords(),e.checkAuthorInfos(),(n=new FormData).append("body",JSON.stringify({post:o})),e.coverData&&n.append("postCover",NKC.methods.blobToFile(e.coverData)),nkcUploadFile("/p/"+e.post.pid,"PUT",n)):"modifyForumDeclare"===t?(e.checkContent(),nkcAPI("/f/"+e.forum.fid+"/settings/info","PUT",{declare:o.c,did:e.draftId,operation:"updateDeclare"})):"modifyForumLatestNotice"===t?(e.checkContent(),nkcAPI("/f/"+e.forum.fid+"/settings/info","PUT",{content:o.c,operation:"modifyForumLatestNotice"})):void 0})).then((function(t){e.showCloseInfo=!1,"reactNative"===NKC.configs.platform?NKC.methods.visitUrlAndClose(t.redirect):"apiCloud"===NKC.configs.platform?(e.visitUrl(t.redirect||"/"),setTimeout((function(){api.closeWin()}),1e3)):e.visitUrl(t.redirect||"/")})).catch((function(t){PostButton.disabledSubmit=!1,console.log(t),sweetError(t)}))},saveToDraftBase:function(){var t=this;return Promise.resolve().then((function(){var e,o,n=t.getPost(),r=t.type;if("newThread"===r)e="forum";else if("newPost"===r)e="thread",o=t.thread.tid;else if("modifyPost"===r)e="post",o=t.post.pid;else if("modifyThread"===r)e="post",o=t.post.pid;else if("modifyForumDeclare"===r)e="forumDeclare",o=t.forum.fid;else{if("modifyForumLatestNotice"!==r)throw"未知的草稿类型";e="forumLatestNotice",o=t.forum.fid}var i=new FormData;return i.append("body",JSON.stringify({post:n,draftId:t.draftId,desType:e,desTypeId:o})),t.coverData&&i.append("postCover",NKC.methods.blobToFile(t.coverData)),nkcUploadFile("/u/"+NKC.configs.uid+"/drafts","POST",i)})).then((function(e){return t.draftId=e.draft.did,e.draft.cover&&(t.coverData="",t.coverUrl="",t.cover=e.draft.cover),Promise.resolve()}))}}}),window.PostButton=new Vue({el:"#postButton",data:{disabledSubmit:!1,checkProtocol:!0,havePermissionToSendAnonymousPost:data.havePermissionToSendAnonymousPost||!1,allowedAnonymousForumsId:data.allowedAnonymousForumsId||[],allowedAnonymous:!1,anonymous:!!data.post&&data.post.anonymous,autoSaveInfo:""},methods:{checkAnonymous:function(){for(var t=PostInfo.selectedForumsId,e=!1,o=0;o<t.length;o++){var n=t[o];if(-1!==this.allowedAnonymousForumsId.indexOf(n)){e=!0;break}}e?this.allowedAnonymous=!0:(this.anonymous=!1,this.allowedAnonymous=!1)},format:NKC.methods.format,saveToDraftSuccess:function(){var t=new Date;this.autoSaveInfo="草稿已保存 "+this.format("HH:mm:ss",t)},autoSaveToDraft:PostInfo.autoSaveToDraft,saveToDraft:PostInfo.saveToDraft,submit:function(){PostInfo.submit()}}})}function n(){var t=$(".editor .edui-editor-toolbarbox.edui-default");if("app"===NKC.methods.getRunType())t.css("top",0),$("body").css("padding-top",t.height()+40);else{var e=$(".navbar.navbar-default.navbar-fixed-top.nkcshade").height()+t.height();$("body").css("padding-top",e+40)}}function r(){if(PostSurvey){var t=$("#disabledSurveyButton");PostSurvey.app.disabled?t.text("取消").removeClass("btn-success").addClass("btn-danger"):t.text("创建").removeClass("btn-danger").addClass("btn-success"),PostSurvey.app.disabled=!PostSurvey.app.disabled}}function i(){$("#disabledSurveyButton").hide()}function a(t,e,o,n){var r={rid:t,ext:e,oname:o,mediaType:n};NKC.methods.appResourceToHtml(r).then((function(t){try{editor.execCommand("inserthtml",t)}catch(t){console.log(t),sweetError("编辑器未准备就绪")}}))}function s(){var t=api.getPrefs({key:"ueContent",sync:!0});editor.setContent(t)}window.data=void 0,$((function(){window.data=NKC.methods.getDataById("data"),window.editor=UE.getEditor("content",NKC.configs.ueditor.editorConfigs),editor.methods={},editor.addListener("ready",(function(t){n(),e=!0,o()})),NKC.modules.SelectColumnCategories&&(window.PostToColumn=new NKC.modules.SelectColumnCategories),NKC.modules.SurveyEdit&&$("#moduleSurveyEdit").length&&(window.PostSurvey=new NKC.modules.SurveyEdit,PostSurvey.init({surveyId:data.post?data.post.surveyId:""}),"newThread"!==data.type&&i(),data.post&&data.post.surveyId&&r()),window.editor=editor})),window.onresize=function(){n()},window.onbeforeunload=function(){if(PostInfo.showCloseInfo)return"离开前保存草稿了吗？"},NKC.methods.selectedDraft=function(t){PostInfo.insertDraft(t)},t(window,{initVueApp:o,resetBodyPaddingTop:n,disabledSurveyForm:r,hideButton:i,mediaInsertUE:a,saveUEContentToLocal:function(){var t=editor.getContent();api.setPrefs({key:"ueContent",value:t})},setLocalContentToUE:s,appUpdateVideo:function(){var t=window.location.protocol+"//"+window.location.host+"/r";$("#attach").css("display","none"),api.getPicture({sourceType:"camera",encodingType:"jpg",mediaValue:"video",destinationType:"url",allowEdit:!1,quality:100,saveToPhotoAlbum:!1,videoQuality:"medium"},(function(e,o){e?(api.toast({msg:"视频正在处理，请稍后...",duration:3e3,location:"bottom"}),api.ajax({url:t,method:"post",timeout:15,headers:{FROM:"nkcAPI"},data:{values:{},files:{file:e.data}}},(function(t,e){t?(a(t.r.rid,t.r.ext,t.r.oname,t.r.mediaType),api.toast({msg:"视频处理完毕",duration:1e3,location:"bottom"})):api.toast({msg:"视频处理失败，请检查当前网络环境...",duration:1e3,location:"bottom"})}))):api.toast({msg:"已取消视频处理",duration:1e3,location:"bottom"})}))},appUpdateImage:function(){var t=window.location.protocol+"//"+window.location.host+"/r";$("#attach").css("display","none"),api.getPicture({sourceType:"camera",encodingType:"jpg",mediaValue:"pic",destinationType:"url",allowEdit:!1,quality:100,saveToPhotoAlbum:!1},(function(e,o){e?(api.toast({msg:"图片正在处理，请稍后...",duration:2e3,location:"bottom"}),api.ajax({url:t,method:"post",timeout:15,headers:{FROM:"nkcAPI"},data:{values:{},files:{file:e.data}}},(function(t,e){t?(a(t.r.rid,t.r.ext,t.r.oname,t.r.mediaType),api.toast({msg:"图片已处理",duration:1e3,location:"bottom"})):(api.toast({msg:"已取消图片处理",duration:1e3,location:"bottom"}),console.log(JSON.stringify(e)))}))):api.toast({msg:"已取消图片处理",duration:1e3,location:"bottom"})}))},EditorReady:e})}));
