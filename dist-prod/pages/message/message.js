!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";function e(){return(e=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var a in s)Object.prototype.hasOwnProperty.call(s,a)&&(e[a]=s[a])}return e}).apply(this,arguments)}window.app=void 0;var t=$(window).width(),s=window.filterXSS,a=document.getElementById("data").innerText,i=NKC.methods.getDataById("templatesData").templates,r=(a=JSON.parse(a)).targetUser,n=a.grades,p=a.messageSettings,o=a.userDigestThreadCount,d=t<1100;function c(e){app.mobile&&-1===window.location.href.indexOf("#")&&window.history.pushState({},"page",window.location.href+"#"+e)}function u(e){if(!e)return"";var t=parseInt(e/60),s=Math.ceil(e%60);return t<1?s+"":t+"' "+s}function g(e){app.voiceHisIndex&&e!==app.voiceHisIndex&&(h(app.voiceHisIndex),l(app.voiceHisIndex)),app.voiceHisIndex=e,audioId="audio"+e,document.getElementById(audioId).play()}function f(e){audioId="audio"+e,document.getElementById(audioId).pause()}function l(e){audioId="audio"+e,document.getElementById(audioId).load()}function m(e){app.messages[e].c.playType?(app.messages[e].c.playType=!1,Vue.set(app.messages,e,app.messages[e]),l(e)):(app.messages[e].c.playType=!0,Vue.set(app.messages,e,app.messages[e]),g(e))}function h(e){app.messages[e].c.playType=!1,Vue.set(app.messages,e,app.messages[e])}function v(e){var t=e.username,s=e.description,a=e.uid,i=$("#addFriend");i.attr("data-uid",a),i.find(".avatar img").attr("src",NKC.methods.tools.getUrl("userAvatar",e.avatar)),i.find(".content .username").text(t),i.find(".content .description").text(s),i.find(".input").show(),i.find(".success").hide(),i.show()}d&&$("body").css("background-color","#ffffff"),$((function(){window.app=new Vue({el:"#app",data:{voiceHisIndex:"",locationData:"",mobile:d,userList:[],target:"",targetUser:"",messageSettings:p,userDigestThreadCount:o,systemInfoViewed:!1,targetUserSendLimit:"",targetUserGrade:"",selectedUserListItem:"",socketStatus:"",messages:[],blackListUid:[],sendFailedMessages:[],showEmoji:!1,user:"",uploadInfo:"",twemoji:[],userInput:{},oldLastMessageId:"",showSettings:!1,showSearch:!1,searchText:"",searchUsers:[],friends:[],categories:[],beep:[],timeOut:"",contentBody:{scrollTo:0,height:0},info:"",canGetMessage:!0,listType:"messages",friend:"",category:"",editCategory:!1,showFriendNotes:!1,showPermissionSettings:!1,friendImageProgress:"",onlyReceiveFromFriends:!1,showMobileNavbar:!0,showMobileList:!0,showMobileSettings:!1,showMobileContacts:!1,showMobileGroups:!1,voiceImg:{playRight:"/default/playRight.gif",playLeft:"/default/playLeft.gif",stopRight:"/default/stopRight.png",stopLeft:"/default/stopLeft.png"},messageTypes:i,messageLimit:{timeLimit:!1,xsfLimit:!1,digestLimit:!1,gradeLimit:0},allowAllMessageWhenSale:!1,targetUserAllowAllMessage:!1,grades:n,showMandatoryLimitInfo:!1,blacklistInfo:"",sizeLimit:""},beforeCreate:function(){for(var e=$(".templates-dom"),t=$(".mobile-templates-dom"),s=0;s<i.length;s++){var a=i[s],r=$("<div v-if='target === \""+a._id+"\"'></div>"),n=$("<div style='height: 100%'></div>");n.append($("<div class='ms-header'>"+a.name+"</div>"));var p=$("<div class='ms-notice' ref='content'></div>"),o=$("<transition name='fade'><div class='ms-loading-info'>{{info}}</div></transition>");p.append(o.clone());for(var d=$("<div class='ms-notice-body' v-for='item in messages'><div class='ms-notice-time'>{{format('YYYY/MM/DD HH:mm:ss', item.tc)}}</div></div>"),c=$("<div class='ms-notice-content'></div>"),u=$("<div class='mobile-messages-body' v-if='target === \""+a._id+"\"' ref='content'><div class='noSelectUser' v-if='messages.length === 0'><div class='fa' style='font-size:1.5rem;'>暂无消息</div></div></div>"),g=$("<div v-else style='padding: 1rem;'></div>"),f=0;f<a.templates.length;f++){var l=a.templates[f],m=l.type,h=l.dom,v=$("<div v-if='item.c.type === \""+m+"\"'>"+h+"</div>");c.append(v)}d.append(c),p.append(d.clone()),n.append(p),r.append(n),e.append(r),g.append(o),g.append(d),u.append(g),t.append(u)}},watch:{messages:function(){for(var e=0;e<this.messages.length;e++){var t=this.messages[e];t.canWithdrawn=!t.withdrawn&&!t.status&&new Date(t.tc)>Date.now()-6e4,"UTU"!==t.ty&&"STE"!==t.ty||t.c.ty||(t.html=s(t.c,{whiteList:{}}),t.html=t.html.replace(/\n/g,"<br/>"),t.html=t.html.replace(/\s/g,"&nbsp;"),t.html=t.html.replace(/\[f\/(.*?)]/g,(function(e,t){return'<img class="message-emoji" src="/twemoji/2/svg/'+t+'.svg"/>'})),t.html=common.URLifyHTML(t.html))}}},computed:{showCustomizeLimitInfo:function(){if(!this.targetUserAllowAllMessage&&!this.systemInfoViewed){var e=this.targetUser,t=this.targetUserSendLimit,s=this.targetUserGrade;if(e&&s){for(var a=!1,i=0;i<this.friends.length;i++)if(this.friends[i].tUid===e.uid){a=!0;break}if(!a&&t.status)return!!(t.timeLimit&&new Date(this.user.toc).getTime()>Date.now()-2592e6||t.digestLimit&&0===this.userDigestThreadCount||t.xsfLimit&&this.user.xsf<=0||t.gradeLimit>this.user.grade._id||t.volumeB&&!this.user.volumeB||!t.volumeB&&t.volumeA&&!this.user.volumeA)||void 0}}},showSystemLimitInfo:function(){if(!this.targetUserAllowAllMessage&&!this.systemInfoViewed){var e=this.targetUser,t=this.targetUserSendLimit,s=this.targetUserGrade,a=this.messageSettings;if(e&&s){for(var i=!1,r=0;r<this.friends.length;r++)if(this.friends[r].tUid===e.uid){i=!0;break}if(!i&&!t.status)return-1!==a.gradeLimit.indexOf(this.user.grade._id)&&-1!==a.gradeProtect.indexOf(s._id)||void 0}}},friendsByOrder:function(){for(var e="0123456789abcdefghijklmnopqrstuvwxyz*".split(""),t={},s=0;s<e.length;s++)t[e[s]]=[];var a=app.friends.concat();for(s=0;s<a.length;s++){var i=a[s],r=i.info.name||i.targetUser.username,n=slugify(r);t[n=n?n[0]:"*"].push(i)}var p=[];for(var s in t)"*"!==s&&0!==t[s].length&&p.push({letter:s.toUpperCase(),friends:t[s]});return 0!==t["*"].length&&p.push({letter:"*",friends:t["*"]}),p},newMessageCount:function(){for(var e=0,t=0;t<this.userList.length;t++)this.userList[t].count>0&&(e+=this.userList[t].count);return e>99?99:e},friendsId:function(){for(var e=[],t=0;t<this.friends.length;t++)e.push(this.friends[t].uid);return e},firstMessageId:function(){for(var e,t=0;t<this.messages.length;t++){var s=this.messages[t];if(!s.status){e=s._id;break}}return e},lastMessageId:function(){for(var e,t=this.messages.length-1;t>=0;t--){var s=this.messages[t];if(!s.status){e=s._id;break}}return e},lastId:function(){var e;return 0!==this.messages.length&&(e=this.messages[this.messages.length-1]._id),e},socketInfo:function(){return this.socketStatus?{connect_timeout:{text:"连接超时，请刷新",color:"red"},error:{text:"连接失败，请刷新",color:"red"},connecting:{text:"正在连接...",color:"blue"},connect:{text:"已连接",color:"green"},disconnect:{text:"连接已断开，请刷新",color:"red"},reconnecting:{text:"正在重新连接...",color:"blue"},reconnect_failed:{text:"重新连接失败，请刷新",color:"red"},connect_failed:{text:"连接失败，请刷新",color:"red"},notConnect:{text:"未连接",color:"red"}}[this.socketStatus]:{text:"暂未连接"}}},methods:{format:NKC.methods.format,fromNow:NKC.methods.fromNow,getUrl:NKC.methods.tools.getUrl,getSize:NKC.methods.tools.getSize,secondToMinute:u,startPlayAudio:g,stopPlayAudio:f,restartPlayAudio:l,stopOrStartPlay:m,stopPlayType:h,openVideo:function(e){document.getElementById("btn"+e).style.display="none",document.getElementById(e).play()},stopVideo:function(e){document.getElementById("btn"+e).style.display="inline-block",document.getElementById(e).pause()},initMobile:function(e){app.showMobileNavbar=!0,app.showMobileList=!1,app.showMobileSettings=!1,app.showMobileContacts=!1,app.showMobileGroups=!1,app[e]=!0},addFriendToSelectedFriends:function(e){-1===app.category.friendsId.indexOf(e.targetUser.uid)&&(app.category.friendsId.push(e.targetUser.uid),app.category.friends.push(e))},removeFriendFromSelectedFriends:function(e){var t=app.category.friendsId.indexOf(e.targetUser.uid);-1!==t&&(app.category.friendsId.splice(t,1),app.category.friends.splice(t,1))},addFriendCategory:function(){app.selectCategory({_id:"",name:"",description:"",friendsId:[],friends:[]}),app.editCategory=!0},deleteCategory:function(e){confirm("确认要删除分组“"+e.name+"”？")&&nkcAPI("/friend_category/"+e._id,"DELETE",{}).then((function(){app.initialization()})).catch((function(e){screenTopWarning(e.error||e)}))},cancelEditCategory:function(){app.editCategory=!1,app.category=app.category.category_},editCategoryBegin:function(){var e=app.category;app.category=JSON.parse(JSON.stringify(app.category)),app.category.category_=e,app.editCategory=!0},saveCategory:function(){var e=app.category;if(app.category.category_,e&&app.editCategory){var t="POST",s="/friend_category";e._id&&(t="PUT",s+="/"+e._id),nkcAPI(s,t,{name:e.name,description:e.description,friendsId:e.friendsId}).then((function(e){var t=app.extendCategoryFriends(e.category);app.category=t,app.editCategory=!1})).catch((function(e){screenTopWarning(e.error||e)}))}},deleteFriend:function(e){!0!==e&&!1===confirm("确认要删除该好友？")||nkcAPI("/friend/"+app.friend.tUid,"DELETE",{}).then((function(e){app.friend={targetUser:app.friend.targetUser}})).catch((function(e){screenTopWarning(e.error||e)}))},addToBlackList:function(){var e=app.friend.tUid;e||(e=app.friend.targetUser.uid),NKC.methods.addUserToBlacklist(e,"message").then((function(t){if(t){-1===app.blackListUid.indexOf(e)&&app.blackListUid.push(e);for(var s=0;s<app.userList.length;s++){var a=app.userList[s];"UTU"===a.type&&a.user&&a.user.uid===e&&app.removeChat(a)}}}))},removeFromBlackList:function(){var e=app.friend.tUid||app.friend.targetUser.uid;NKC.methods.removeUserFromBlacklist(e).then((function(t){if(t){var s=app.blackListUid.indexOf(e);-1!==s&&app.blackListUid.splice(s,1)}}))},removeChat:function(e){e.type,nkcAPI("/message/chat/"+(e.user?e.user.uid:e.type),"DELETE",{}).then((function(){})).catch((function(e){screenTopWarning(e.error||e)}))},addFriend:v,addFriendsPhone:function(){if(app.friend.info.phone.length>=5)return screenTopWarning("最多只能为好友添加5个联系电话");app.friend.info.phone.push("")},removeFriendsPhone:function(e){app.friend.info.phone.splice(e,1)},uploadFriendNoteImage:function(e){var t=e.target,s=t.files;if(0!==s.length){var a=s[0],i=new FormData;i.append("file",a),uploadFilePromise("/friend/"+app.friend.tUid+"/image",i,(function(e){app.friendImageProgress=(e.loaded/e.total*100).toFixed(0),e.loaded===e.total&&setTimeout((function(){app.friendImageProgress=""}),2e3)})).then((function(e){t.value=null,e.friend._id===app.friend._id&&(app.friend.info.image=!0,app.$refs.friendImage&&(app.$refs.friendImage.src="/friend/"+app.friend.tUid+"/image?t="+Date.now()))}))}},saveFriendSettings:function(){if(app.friend){var e=document.getElementById("location");app.friend.info.location=e.value,nkcAPI("/message/settings/"+app.friend.tUid,"PUT",{info:app.friend.info,cid:app.friend.cid}).then((function(){screenTopAlert("保存成功");var e=app.friend.friend;delete app.friend.friend,Vue.set(app.friends,app.friends.indexOf(e),app.friend);for(var t=0;t<app.userList.length;t++)if(app.userList[t].friend&&app.userList[t].friend._id===app.friend._id){app.userList[t].friend=app.friend;break}})).catch((function(e){screenTopWarning(e.error||e)}))}},postApplication:function(e,t){var s=t.uid;if(-1===["true","false","ignored"].indexOf(e))return screenTopWarning("处理好友添加申请类型错误：agree: "+e);nkcAPI("/u/"+s+"/friends/agree","POST",{agree:e}).then((function(){t.agree=e})).catch((function(e){screenTopWarning(e.error||e)}))},scrollToBottom:function(){var e=this.$refs.content;e&&(e.scrollTop=e.scrollHeight+1e4)},updateUserList:function(e){var t=e.user,s=e.message;if("UTU"!==s.ty){for(var a,i=0;i<app.userList.length;i++){if((r=app.userList[i]).type===s.ty){a=r;break}}return a?(a.message=s,a.time=s.tc,app.userList.splice(app.userList.indexOf(a),1),app.userList.unshift(r)):(a={type:s.ty,message:s,time:s.tc,count:0},"STU"===s.ty&&(a.name=s.c.messageType.name,a.content=s.c.messageType.content),app.userList.unshift(a)),void(app.target===a.type?a.count=0:a.count++)}var r,n=-1;for(i=0;i<app.userList.length;i++){var p=app.userList[i];if(s.s===app.user.uid&&p.user&&s.r===p.user.uid||s.r===app.user.uid&&p.user&&s.s===p.user.uid){n=i,r=p;break}}if(!r){var o;for(i=0;i<app.friends.length;i++){var d=app.friends[i];if(d.tUid===t.uid){o=d;break}}r={type:"UTU",count:0,user:t,friend:o}}r.message=s,r.time=s.tc,app.targetUser&&app.targetUser.uid===r.user.uid?r.count=0:s.s===app.user.uid||r.count++,-1!==n&&app.userList.splice(n,1),app.userList.unshift(r)},initialization:function(){this.targetUser="",this.target="",this.messages=[],this.info="",this.showEmoji=!1,this.showSettings=!1,this.showSearch=!1,this.searchText="",this.canGetMessage=!0,this.searchUsers=[],this.showFriendNotes=!1,this.showPermissionSettings=!1,this.friendImageProgress="",this.friend="",this.category="",this.selectCategoryFriendsId=[],this.editCategory=!1,this.systemInfoViewed=!1,this.targetUserSendLimit="",this.targetUserGrade=""},getMessage:function(){if(!app.canGetMessage)return Promise.reject();app.canGetMessage=!1,app.info="加载中~";var e=this.targetUser&&this.targetUser.uid?this.targetUser.uid:"",t="/message/data?type="+this.target+(e?"&uid="+e:"");this.firstMessageId?t+="&firstMessageId="+this.firstMessageId+"&t="+Date.now():t+="&t="+Date.now();var s=app.target;return nkcAPI(t,"GET",{}).then((function(e){if(app.target===s){if(app.twemoji=e.twemoji,app.sizeLimit=e.sizeLimit,app.blacklistInfo=e.blacklistInfo,app.targetUserAllowAllMessage=e.targetUserAllowAllMessage,app.targetUserAllowAllMessage?app.showMandatoryLimitInfo="":app.showMandatoryLimitInfo=e.showMandatoryLimitInfo,app.targetUserSendLimit=e.targetUserSendLimit,app.targetUserGrade=e.targetUserGrade,0===e.messages.length)return app.info="没有了~",Promise.reject();app.info="",app.messages=e.messages.concat(app.messages),app.canGetMessage=!0;var t=app.$refs.content;return t&&app.target&&(t.onscroll=function(){this.scrollTop>20||(app.contentBody.scrollTo=t.scrollTop,app.contentBody.height=t.scrollHeight,app.getMessage().then((function(){var e=t.scrollHeight;t.scrollTop=e-app.contentBody.height})).catch((function(){})))}),Promise.resolve()}})).catch((function(e){screenTopWarning(e.error||e),app.canGetMessage=!0}))},extendReminder:function(e){if(!e)return"";var t;switch(e.c.type){case"replyThread":case"replyPost":t="回复";break;case"digestPost":t="回复被设置精华";break;case"digestThread":t="文章被设置精华";break;case"bannedThread":t="文章被删除";break;case"threadWasReturned":t="文章被退回";break;case"bannedPost":t="回复被删除";break;case"postWasReturned":t="回复被退回";break;case"recommend":t="点赞";break;case"@":t="@";break;case"xsf":t="学术分";break;default:t=""}return t},getInputTextFromLocal:function(){var e=localStorage.userInput;try{e=JSON.parse(e),app.userInput=e}catch(e){app.userInput={}}},saveUserInputToLocal:function(){var e=app.userInput;localStorage.userInput=JSON.stringify(e)},extendCategoryFriends:function(e){for(var t=[],s=[],a=0;a<e.friendsId.length;a++)for(var i=e.friendsId[a],r=0;r<app.friends.length;r++){var n=app.friends[r];if(n.targetUser.uid===i){t.push(n.targetUser.uid),s.push(n);break}}return e.friendsId=t,e.friends=s,e},getUserList:function(){return new Promise((function(e,t){nkcAPI("/message?t="+Date.now(),"GET",{}).then((function(t){app.userList=t.userList,app.friends=t.usersFriends,app.blackListUid=t.blackListUid;for(var s=0;s<t.categories.length;s++)t.categories[s]=app.extendCategoryFriends(t.categories[s]);app.categories=t.categories,app.user=t.user;var a=t.user.generalSettings.messageSettings,i=a.beep;for(var r in app.onlyReceiveFromFriends=a.onlyReceiveFromFriends,app.messageLimit=a.limit,app.allowAllMessageWhenSale=a.allowAllMessageWhenSale,app.messageLimitArr=[],app.messageLimit.timeLimit&&app.messageLimitArr.push("time"),app.messageLimit.xsfLimit&&app.messageLimitArr.push("xsf"),app.messageLimit.digestLimit&&app.messageLimitArr.push("digest"),app.beep=[],i)i.hasOwnProperty(r)&&i[r]&&app.beep.push(r);e()})).catch((function(e){screenTopWarning(e.error||e)}))}))},saveMessageSettings:function(){for(var e={usersMessage:!1,STE:!1,reminder:!1},t=0;t<app.beep.length;t++)e[app.beep[t]]=!0;var s=this.messageLimit,a=this.messageLimitArr;if(s.timeLimit=-1!==a.indexOf("time"),s.digestLimit=-1!==a.indexOf("digest"),s.xsfLimit=-1!==a.indexOf("xsf"),s.status&&!s.timeLimit&&!s.digestLimit&&!s.xsfLimit&&!s.volumeA&&!s.volumeB&&Number(s.gradeLimit)<2)return screenTopWarning("请至少勾选一项防骚扰设置");nkcAPI("/message/settings","PUT",{beep:e,onlyReceiveFromFriends:app.onlyReceiveFromFriends,limit:s,allowAllMessageWhenSale:this.allowAllMessageWhenSale}).then((function(){updateBeep(e),screenTopAlert("保存成功")})).catch((function(e){screenTopWarning(e.error||e)}))},computeUserListOrder:function(){for(var e=[],t=0;t<app.userList.length;t++){var s=app.userList[t];if(0!==e.length){for(var a=!1,i=0;i<e.length;i++){var r=e[i];if(new Date(s.time).getTime()>new Date(r.time).getTime()){e.splice(i,0,s),a=!0;break}}a||e.push(s)}else e.push(s)}app.userList=e},selectUser:function(e){if(this.initialization(),c(e.type),this.selectedUserListItem=e,"UTU"===e.type){app.target=e.type,app.targetUser=e.user,app.targetUser.friend=e.friend,this.getInputTextFromLocal(),this.getMessage().then((function(){app.scrollToBottom(),0!==e.count&&nkcAPI("/message/mark","PUT",{type:"UTU",uid:app.targetUser.uid}).then((function(){e.count=0})).catch((function(e){screenTopWarning(e.error||e)}))})).catch((function(){}));for(var t=!1,s=0;s<app.userList.length;s++)"UTU"===app.userList[s].type&&app.userList[s].user.uid===e.user.uid&&(t=!0);if(!t){var a;for(s=0;s<app.friends.length;s++){var i=app.friends[s];if(i.tUid===e.user.uid){a=i;break}}app.userList.unshift({type:"UTU",count:0,user:e.user,friend:a})}}else"STE"===e.type?(app.target=e.type,this.getMessage().then((function(){app.scrollToBottom(),0!==e.count&&nkcAPI("/message/mark","PUT",{type:"STE"}).then((function(){e.count=0})).catch((function(e){screenTopWarning(e.error||e)}))})).catch((function(){}))):"newFriends"===e.type?(app.target="newFriends",this.getMessage().then((function(){app.scrollToBottom()})).catch((function(){}))):(app.target=e.type,this.getMessage().then((function(){app.scrollToBottom(),0!==e.count&&nkcAPI("/message/mark","PUT",{type:e.type}).then((function(){e.count=0})).catch((function(e){screenTopWarning(e.error||e)}))})).catch((function(){})))},selectCategory:function(e){this.initialization(),c("category"),app.target="category",e.friends||(e.friends=""),app.category=e},selectFriend:function(e){if(this.initialization(),c("friend"),app.target="friend",!e._id)for(var t=0;t<app.friends.length;t++){var s=app.friends[t];if(s.tUid===e.targetUser.uid){e=s;break}}var a=JSON.parse(JSON.stringify(e));a.friend=e,app.friend=a},selectExpression:function(e){var t,s=app.userInput[app.targetUser.uid]||"",a=app.$refs.input;if(a.selectionStart)t=a.selectionStart;else if(document.selection){a.focus();var i=document.selection.createRange(),r=i.duplicate();r.moveToElementText(a),r.setEndPoint("EndToEnd",i),t=r.text.length-i.text.length}var n="[f/"+e+"]";if(t>1){var p=s.substring(0,t),o=p+n;app.userInput[app.targetUser.uid]=s.replace(p,o)}else app.userInput[app.targetUser.uid]=n+(app.userInput[app.targetUser.uid]||"");app.showEmoji=!1},uploadResourceData:function(e){uploadFilePromise("/message/resource",e.formData,(function(t){e.loaded=(t.loaded/t.total*100).toFixed(1),t.loaded===t.total&&(e.loaded="100")})).then((function(t){Vue.set(app.messages,app.messages.indexOf(e),t.messages[0]),app.updateUserList({user:app.targetUser,message:t.messages[0]}),app.computeUserListOrder()})).catch((function(t){screenTopWarning(t.error||t),e.status="failed"}))},checkFileSize:function(e,t){var s=this.sizeLimit;if(s){var a,i=e.split(".");i=i.pop().toLowerCase();for(var r=0;r<s.others.length;r++){var n=s.others[r];if(n.ext.toLowerCase()===i){a=n;break}}a||(a={ext:i,size:s.default});var p=1024*a.size;if(t>p)throw i.toUpperCase()+"文件大小不能超过"+this.getSize(p,1)}},uploadResource:function(e,t){var s;if(t)e.status="sending",e.loaded="",e.tc=new Date,app.messages.splice(app.messages.indexOf(e),1),app.messages.push(e),app.uploadResourceData(e);else{var a=e.target.files;if(0===a.length)return;for(var i=app.targetUser.uid,r=0;r<a.length;r++){var n=a[r];try{this.checkFileSize(n.name,n.size)}catch(e){return app.uploadInfo=e.message||e,setTimeout((function(){app.uploadInfo=""}),3e3)}var p=new FormData;p.append("targetUid",i),p.append("socketId",socket.id),p.append("file",n),s={_id:Date.now()+Math.random(),status:"sending",loaded:"",ty:"UTU",r:app.targetUser.uid,s:app.user.uid,vd:!1,tc:new Date,c:{ty:"file",na:n.name,id:""},formData:p},app.messages.push(s),app.uploadResourceData(s)}}},sendToUser:function(e){var t,s=!!e;if(e){t=e.c,e.status="sending";var a=app.messages.indexOf(e);Vue.set(app.messages,a,e)}else{if(!(t=app.userInput[app.targetUser.uid]))return screenTopWarning("输入的内容不能为空");var i=Date.now();e={_id:i,c:t,status:"sending",s:this.user.uid,r:this.targetUser.uid,ty:"UTU",vd:!1,toc:new Date}}nkcAPI("/message/user/"+app.targetUser.uid,"POST",{content:t,socketId:socket.id}).then((function(t){var s=app.messages.indexOf(e);Vue.set(app.messages,s,t.message),app.updateUserList({user:app.targetUser,message:t.message}),app.computeUserListOrder()})).catch((function(t){sweetError(t.error||t);var s=app.messages.indexOf(e);app.messages[s].status="failed",Vue.set(app.messages,s,app.messages[s])})),s||(app.messages.push(e),app.userInput[app.targetUser.uid]="",app.saveUserInputToLocal())},connect:function(){app.getUserList().then((function(){if(app.target){var e="/message/newMessages?target="+app.target;return"UTU"===app.target&&app.targetUser&&(e+="&uid="+app.targetUser.uid,app.lastMessageId&&(e+="&lastMessageId="+app.lastMessageId)),nkcAPI(e,"GET",{}).then((function(e){var t=e.messages;0!==t.length&&(beep("notice"),"UTU"===app.target&&"UTU"===e.target&&app.targetUser.uid===e.targetUser.uid?(app.messages=app.messages.concat(t),nkcAPI("/message/mark","PUT",{type:"STU",uid:app.targetUser.uid}).catch((function(e){screenTopWarning(e.error||e)}))):app.target===e.target&&(app.messages=app.messages.concat(t),nkcAPI("/message/mark","PUT",{type:app.target}).catch((function(e){screenTopWarning(e.error||e)}))))}))}})).catch((function(e){screenTopWarning(e.error||e)}))},searchUser:function(){if(!app.searchText)return screenTopWarning("请输入用户名");var e="/u?username="+app.searchText+"&uid="+app.searchText;nkcAPI(e,"GET",{}).then((function(e){for(var t=[],s=0;s<e.targetUsers.length;s++){var a=e.targetUsers[s];a.uid!==app.user.uid&&t.push(a)}app.searchUsers=t,0===t.length&&screenTopWarning("未找到相关用户")})).catch((function(e){screenTopWarning(e.error||e)}))},withdrawn:function(e){nkcAPI("/message/withdrawn","PUT",{messageId:e._id}).then((function(){e.withdrawn=!0,Vue.set(app.messages,app.messages.indexOf(e),e)})).catch((function(t){Vue.set(app.messages,app.messages.indexOf(e),e),screenTopWarning(t.error||t)}))}},beforeUpdate:function(){},updated:function(){if(app.oldLastMessageId!==app.lastId&&(app.scrollToBottom(),app.oldLastMessageId=app.lastId),this.showFriendNotes){var e=document.getElementById("country");e&&"--"===e.innerText&&($(".bs-chinese-region").chineseRegion("source",app.locationData),$("#location").val($("#location").attr("data")))}},mounted:function(){this.getUserList().then((function(){if(!NKC.configs.isApp)if(r)app.selectUser({type:"UTU",user:r});else{for(var e=!1,t=0;t<app.userList.length;t++){if(0!==(s=app.userList[t]).count){e=!0,app.selectUser(s);break}}if(!e&&app.userList.length>0){var s=app.userList[0];app.selectUser(s)}}})),$.getJSON("/location.json",(function(e){for(var t=0;t<e.length;t++){var s={id:e[t].id,name:e[t].cname,level:e[t].level,parentId:e[t].upid};e[t]=s}app.locationData=e})),socket&&(socket.connected?this.socketStatus="connect":socket.disconnected&&(this.socketStatus="disconnect"));var e=this;socket.on("connect",(function(){e.socketStatus="connect"})),socket.on("connecting",(function(){e.socketStatus="connecting"})),socket.on("disconnect",(function(t){e.socketStatus="disconnect"})),socket.on("reconnecting",(function(){e.socketStatus="reconnecting"})),socket.on("reconnect",(function(){app.connect(),e.socketStatus="connect"})),socket.on("connect_failed",(function(){e.socketStatus="connect_failed"})),socket.on("reconnect_failed",(function(){e.socketStatus="reconnect_failed"})),socket.on("error",(function(t){console.log(t),e.socketStatus="error"})),socket.on("connect_timeout",(function(){e.socketStatus="connect_timeout"})),socket.on("message",(function(e){var t=e.message,s=e.user,a=e.targetUser,i=t.ty;if("STE"===i)beep("notice"),app.updateUserList({message:t}),"STE"===app.target&&(app.messages.push(t),nkcAPI("/message/mark","PUT",{type:"STE"}).catch((function(e){screenTopWarning(e.error||e)})));else if("STU"===i)beep("notice"),app.updateUserList({message:t}),"STU"===app.target&&(app.messages.push(t),nkcAPI("/message/mark","PUT",{type:"STU"}).catch((function(e){screenTopWarning(e.error||e)})));else if("UTU"===i){if(t.socketId===socket.id)return;"UTU"===app.target&&app.targetUser&&(app.targetUser.uid===s.uid?(nkcAPI("/message/mark","PUT",{type:"UTU",uid:app.targetUser.uid}).catch((function(e){screenTopWarning(e.error||e)})),app.messages.push(t)):app.targetUser.uid===a.uid&&app.messages.push(t)),s.uid!==app.user.uid?beep("message"):s=a,app.updateUserList({user:s,message:t})}else if("friendsApplication"===i){if(app.getUserList().then((function(){!1!==t.agree&&beep("message")})),"newFriends"===app.target&&app.user.uid!==t.uid){for(var r=!1,n=0;n<app.messages.length;n++){var p=app.messages[n];if(p._id===t._id){p.toc=t.toc,p.description=t.description,p.agree=t.agree,r=!0;break}}r||app.messages.push(t)}}else if("deleteFriend"===i){var o=t.deleterId,d=t.deletedId;if(o===app.user.uid)f=d;else{if(d!==app.user.uid)return;f=o}for(n=0;n<app.friends.length;n++){if(app.friends[n].tUid===f){app.friends.splice(n,1);break}}for(n=0;n<app.userList.length;n++){if("UTU"===(g=app.userList[n]).type&&g.user.uid===f){app.userList.splice(n,1);break}}}else if("modifyFriend"===i){var c=t.friend;if(app.user.uid!==c.uid)return;for(n=0;n<app.friends.length;n++){if(app.friends[n].tUid===c.tUid){Vue.set(app.friends,n,c);break}}for(n=0;n<app.userList.length;n++){if((g=app.userList[n]).friend&&g.friend.tUid===c.tUid){g.friend=c;break}}}else if("removeChat"===i){d=t.deletedId;var u=!1;-1!==["STU","STE","newFriends"].indexOf(d)&&(u=!0);for(n=0;n<app.userList.length;n++){var g=app.userList[n];if(u&&g.type===d||g.user&&g.user.uid===d){app.userList.splice(n,1),"UTU"===g.type&&d===app.targetUser.uid&&app.initialization();break}}}else if("markAsRead"===i){var f=t.targetUid,l=t.uid;if(app.user.uid!==l)return;var m=t.messageType;if("UTU"===m)for(n=0;n<app.userList.length;n++){if("UTU"===(g=app.userList[n]).type&&g.user.uid===f){g.count=0;break}}else if("STE"===m)for(n=0;n<app.userList.length;n++){if("STE"===(g=app.userList[n]).type){g.count=0;break}}else for(n=0;n<app.userList.length;n++){if((g=app.userList[n]).type===m){g.count=0;break}}}else if("editFriendCategory"===i){var h=t.category;if(app.user.uid!==h.uid)return;var v=t.editType;if("add"===v){var U=!1;for(n=0;n<app.categories.length;n++){if(app.categories[n]._id===h._id){U=!0;break}}U||(h=app.extendCategoryFriends(h),app.categories.unshift(h))}else if("remove"===v)for(n=0;n<app.categories.length;n++){if(app.categories[n]._id===h._id){app.category._id===h._id&&app.initialization(),app.categories.splice(n,1);break}}else if("modify"===v)for(n=0;n<app.categories.length;n++){if(app.categories[n]._id===h._id){h=app.extendCategoryFriends(h),Vue.set(app.categories,n,h),app.category._id===h._id&&(app.category=h);break}}}})),socket.on("userDisconnect",(function(e){for(var t=e.targetUid,s=0;s<app.userList.length;s++){(a=app.userList[s]).user&&a.user.uid===t&&(a.user.online=!1)}for(s=0;s<app.friends.length;s++){var a;(a=app.friends[s]).targetUser&&a.targetUser.uid===t&&(a.targetUser.online=!1)}})),socket.on("userConnect",(function(e){for(var t=e.targetUid,s=0;s<app.userList.length;s++){(a=app.userList[s]).user&&a.user.uid===t&&(a.user.online=!0,a.user.onlineType=e.onlineType)}for(s=0;s<app.friends.length;s++){var a;(a=app.friends[s]).targetUser&&a.targetUser.uid===t&&(a.targetUser.online=!0,a.targetUser.onlineType=e.onlineType)}})),socket.on("withdrawn",(function(e){var t=e.messageId;if(app.targetUser&&(e.uid===app.targetUser.uid||e.uid===app.user.uid))for(var s=0;s<app.messages.length;s++){var a=app.messages[s];if(a._id===t){a.withdrawn=!0,a.c="";break}}for(s=0;s<app.userList.length;s++){var i=app.userList[s];if(i.message&&i.message._id===t){i.message.withdrawn=!0,i.message.c="";break}}})),NKC.configs.isApp&&(this.showMobileContacts=!1,this.showMobileGroups=!1,this.showMobileList=!1,"friends"===a.page?this.showMobileContacts=!0:"categories"===a.page?this.showMobileGroups=!0:this.showMobileList=!0)}})})),window.onpopstate=function(e){app.mobile&&app.initialization()},e(window,{winWidth:t,xss:s,data:a,templates:i,targetUser:r,grades:n,messageSettings:p,userDigestThreadCount:o,pageName:"message",addHistory:c,secondToMinute:u,startPlayAudio:g,stopPlayAudio:f,restartPlayAudio:l,stopOrStartPlay:m,stopPlayType:h,startPlayType:function(e){app.messages[e].c.playType=!0,Vue.set(app.messages,e,app.messages[e])},closeFrameOfAddFriend:function(){var e=$("#addFriend");e.hide(),e.find(".input").hide(),e.find(".success").hide(),e.find("textarea").val("")},openFrameOfAddFriend:v,addFriendByUid:function(){var e=$("#addFriend"),t=e.attr("data-uid"),s=e.find("textarea").val();nkcAPI("/u/"+t+"/friends","POST",{description:s}).then((function(t){e.find(".input").hide(),e.find(".success").show()})).catch((function(e){screenTopWarning(e.error||e)}))}})}));
