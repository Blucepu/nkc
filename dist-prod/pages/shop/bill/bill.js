!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";function e(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function t(t,r){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=function(t,r){if(t){if("string"==typeof t)return e(t,r);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?e(t,r):void 0}}(t))||r&&t&&"number"==typeof t.length){n&&(t=n);var s=0,o=function(){};return{s:o,n:function(){return s>=t.length?{done:!0}:{done:!1,value:t[s++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,c=!1;return{s:function(){n=n.call(t)},n:function(){var e=n.next();return a=e.done,e},e:function(e){c=!0,i=e},f:function(){try{a||null==n.return||n.return()}finally{if(c)throw i}}}}var r=NKC.methods.getDataById("data");r.results.map((function(e){e.buyMessage="",e.products.map((function(e){var t=e.product;t.isFreePost||(e.freightName=t.freightTemplates[0].name,e.certId="")}))}));var n=new Vue({el:"#app",data:{addresses:r.addresses,selectedAddress:r.addresses[0]||"",results:r.results,freightTotal:0,priceTotal:0,showAddressForm:!1,addressForm:{username:"",address:"",location:"",mobile:""}},mounted:function(){this.extendProduct(),window.SelectAddress=new NKC.modules.SelectAddress},methods:{getUrl:NKC.methods.tools.getUrl,visitUrl:NKC.methods.visitUrl,checkString:NKC.methods.checkData.checkString,switchAddressForm:function(){this.showAddressForm=!this.showAddressForm},saveAddressForm:function(){var e=this,t=this.addressForm,r=t.username,n=t.address,s=t.location,o=t.mobile;Promise.resolve().then((function(){return e.checkString(r,{name:"收件人姓名",minLength:1,maxLength:50}),e.checkString(s,{name:"所在地区",minLength:1,maxLength:100}),e.checkString(n,{name:"详细地址",minLength:1,maxLength:500}),e.checkString(o,{name:"手机号",minLength:1,maxLength:100}),nkcAPI("/u/".concat(NKC.configs.uid,"/settings/transaction"),"PUT",{operation:"add",addresses:[e.addressForm]})})).then((function(t){e.addresses=t.addresses,e.addresses.length?e.selectedAddress=e.addresses[e.addresses.length-1]:e.selectedAddress="",e.switchAddressForm()})).catch(sweetError)},selectLocation:function(){var e=this;SelectAddress.open((function(t){e.addressForm.location=t.join(" ")}))},changeCount:function(e,t){if("up"==e){if(t.count>=t.productParam.stocksSurplus)return void screenTopWarning("库存不足");t.count++}else t.count>1&&t.count--;this.extendProduct()},extendProduct:function(){var e=0,r=0;this.results.map((function(n){n.products.map((function(n){var s=n.freightName,o=n.product,i=o.freightTemplates,a=o.isFreePost;if(!a){var c,d=t(i);try{for(d.s();!(c=d.n()).done;){var u=c.value;u.name===s&&(n.freight=u)}}catch(e){d.e(e)}finally{d.f()}}var h=0,f=0;n.params.map((function(e){var t=e.count,r=e.price;h+=t,f+=t*r})),n.countTotal=h,n.priceTotal=f,n.freightTotal=0,a||(1===n.countTotal?n.freightTotal=n.freight.firstPrice:n.freightTotal=n.freight.firstPrice+n.freight.addPrice*(n.countTotal-1)),e+=n.freightTotal,r+=n.priceTotal}))})),this.freightTotal=e,this.priceTotal=r},selectAddress:function(e){this.selectedAddress=e},setFreightByName:function(){this.extendProduct()},getAddresses:function(){var e=this;nkcAPI(window.location.href+"&t=".concat(Date.now()),"GET").then((function(t){e.addresses=t.addresses,sweetSuccess("刷新成功")})).catch(sweetError)},selectedFile:function(e,t){var r=t.product,n=$("input.hidden.input-".concat(r.productId)),s=(n=n[0]).files[0],o=new FormData;o.append("type","shopping"),o.append("file",s),nkcUploadFile("/shop/cert","POST",o).then((function(r){t.certId=r.cert._id,Vue.set(e.products,e.products.indexOf(t),t),sweetSuccess("上传成功")})).catch(sweetError)},getCert:function(e){NKC.methods.visitUrl("/shop/cert/".concat(e),!0)},submit:function(){var e=this.results,t={params:[],address:this.selectedAddress};Promise.resolve().then((function(){if(!t.address)throw"请选择收货地址";return e.map((function(e){var r=e.products,n=e.user,s=e.buyMessage,o={uid:n.uid,buyMessage:s,products:[]};r.map((function(e){var t=e.product,r=e.params,n=e.priceTotal,s=e.freightTotal,i=e.certId,a=e.freightName;if(t.uploadCert&&!i)throw"请上传凭证";if(!t.isFreePost&&!a)throw"请选择物流";var c={productId:t.productId,priceTotal:n,freightTotal:s,certId:i,freightName:a,productParams:[]};r.map((function(e){var t=e.productParam,r=e.count,n=e.price,s=e.cartId;c.productParams.push({_id:t._id,cartId:s,count:r,price:n})})),o.products.push(c)})),t.params.push(o)})),console.log(t),nkcAPI("/shop/order","POST",t)})).then((function(e){openToNewLocation("/shop/pay?ordersId="+e.ordersId.join("-")),sweetSuccess("提交成功，正在前往付款页面")})).catch(sweetError)}}});window.app=n}));
