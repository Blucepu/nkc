!function(r){"function"==typeof define&&define.amd?define(r):r()}((function(){"use strict";var r=new Vue({el:"#app",data:{applyType:"seller",display:{apply:!1},newRefund:{type:"",reason:"",money:"",paramId:""},error:"",info:"",user:"",order:"",refund:"",refunds:[],reason:"",type:"",money:"",applyRMInput:!1,uploadStatus:"",trackNumber:"",displayGiveUpInput:!1,giveUpReason:""},computed:{orderOriginPrice:function(){for(var r=0,e=0;e<this.order.params.length;e++)r+=this.order.params[e].productPrice;return r},param:function(){var r;if(this.newRefund&&this.newRefund.paramId?r=this.newRefund.paramId:this.refund.paramId&&(r=this.refund.paramId),!r)return"";for(var e=0;e<this.order.params.length;e++)if(this.order.params[e].costId===r)return this.order.params[e];return""},status:function(){var r=this.refunds[this.refunds.length-1];return r.logs[r.logs.length-1]},product:function(){if(this.order)return this.order.product},productParam:function(){if(this.order)return this.order.productParam},params:function(){return this.order.params},seller:function(){if(this.order)return this.order.product.user},refundMoneyMax:function(){return this.param?this.param.singlePrice*this.param.count:this.order.orderPrice}},mounted:function(){var r=document.getElementById("data");r=JSON.parse(r.innerHTML),this.order=r.order,this.user=r.user,this.refunds=r.refunds,r.refund?this.refund=r.refund:"finish"===this.order.orderStatus||this.order.closeStatus||(this.display.apply=!0)},methods:{format:NKC.methods.format,cancelOrder:function(){this.clearInfo(),nkcAPI("/shop/refund","POST",{refund:{reason:r.reason},orderId:this.order.orderId}).then((function(){r.info="订单取消成功，正在前往我的订单",setTimeout((function(){openToNewLocation("/shop/order")}),2e3)})).catch((function(e){r.error=e.error||e}))},saveCerts:function(){this.clearInfo();for(var e=this.order.certs,t=[],n=0;n<e.length;n++)t.push(e[n]._id);nkcAPI("/shop/cert","PUT",{certsId:t}).then((function(){r.info="保存成功",setTimeout((function(){r.info=""}),3e3)})).catch((function(e){r.error=e.error||e}))},deleteCert:function(e){this.clearInfo(),nkcAPI("/shop/cert/"+e._id,"DELETE").then((function(){var t=r.order.certs.indexOf(e);-1!==t&&r.order.certs.splice(t,1)})).catch((function(e){r.error=e.error||e}))},viewCert:function(r){window.open("/shop/cert/"+r._id)},selectApplyType:function(r){this.applyType=r},clearInfo:function(){this.info="",this.error=""},submitApply:function(){this.clearInfo();var e=this.applyType,t=this.newRefund,n=this.param;if(""===t.reason)return this.error="请输入理由";if(""===t.type)return this.error="请选择退款方式";if("money"!==t.type&&"platform"===e)return this.error="请求平台介入时退款方式只能选择【只退款】";if(!(t.money>=0))return this.error="请输入正确的退款金额";if(n){if(100*t.money>n.productPrice)return this.error="退款金额不能超过退款中的商品的金额"}else if(100*t.money>this.order.orderPrice)return this.error="退款金额不能超过商品总金额";"platform"===e&&(t.root=!0);var o={refund:t,orderId:this.order.orderId};nkcAPI("/shop/refund","POST",o).then((function(){window.location.reload()})).catch((function(e){r.error=e.error||e}))},upload:function(e,t,n){if(e.length<t+1)n.value="";else{var o=e[t],i=new FormData;i.append("type","refund"),i.append("orderId",this.order.orderId),i.append("file",o),this.param&&i.append("paramId",this.param.costId),uploadFilePromise("/shop/cert",i,(function(n){var o=n.loaded/n.total*100;o>=100&&(o=100,e.length===t+1&&setTimeout((function(){r.uploadStatus=""}),2e3)),r.uploadStatus="上传中... "+(t+1)+"/"+e.length+" "+o.toFixed(1)+"%"})).then((function(e){var t=e.cert;r.order.certs.push(t)})).catch((function(e){r.error=e.error||e})).finally((function(){r.upload(e,t+1,n)}))}},selectedFile:function(r){var e=r.target,t=e.files;this.upload(t,0,e)},submitTrackNumber:function(){this.clearInfo(),nkcAPI("/shop/refund/"+this.refund._id,"POST",{type:"submitTrackNumber",trackNumber:this.trackNumber}).then((function(){window.location.reload()})).catch((function(r){this.error=r.error||r}))},giveUpRefund:function(){var e=this.refund;nkcAPI("/shop/refund/"+e._id,"POST",{type:"giveUp",reason:r.giveUpReason}).then((function(){window.location.reload()})).catch((function(r){screenTopWarning(r)}))},refundType:function(r){return{money:"只退款",product:"退货退款"}[r]}}});window.app=r}));
