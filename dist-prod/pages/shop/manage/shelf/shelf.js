!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";function e(){return(e=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e}).apply(this,arguments)}var t=NKC.methods.getDataById("data"),i=t.grades,n=t.dealInfo,r=t.product,o={},s={status:!1,count:2};n.templates.map((function(e){e.firstPrice=parseFloat(e.firstPrice),e.addPrice=parseFloat(e.addPrice)})),r&&(r.vipDisGroup.map((function(e){return o[e.vipLevel]=e})),-1==r.purchaseLimitCount?s.status=!1:(s.status=!0,s.count=r.purchaseLimitCount),r.imgIntroductions.length=5,r.productParams.map((function(e){e.price=e.price/100,e.originPrice=e.originPrice/100})),r.freightTemplates.map((function(e){e.firstPrice=e.firstPrice/100,e.addPrice=e.addPrice/100})));var a=i.map((function(e){var t=o[e._id];return{vipLevel:e._id,grade:e,vipNum:t?t.vipNum:100}}));window.app=new Vue({el:"#app",data:{type:r?"modify":"create",submitting:!1,showCloseInfo:!0,shopForums:t.shopForumTypes,selectedShopForumId:"",mainForums:[],title:"",abstract:"",content:"",keywords:[],imgIntroductions:r?r.imgIntroductions:["","","","",""],paramForum:!1,selectedParams:r?r.productParams:[],params:[],vipDisGroup:a,vipDiscount:!!r&&!!r.vipDiscount,stockCostMethod:r?r.stockCostMethod:"orderReduceStock",purchaseLimit:s,uploadCert:!!r&&!!r.uploadCert,uploadCertDescription:r?r.uploadCertDescription:"",productSettings:r?r.productSettings:{priceShowToVisit:!0,priceShowAfterStop:!0},isFreePost:!r||!!r.isFreePost,defaultTemplates:n.templates,freightTemplates:r?r.freightTemplates:[],shelfType:"immediately",shelfTime:""},watch:{shelfType:function(){this.initTime()}},mounted:function(){r||(window.CommonModal=new NKC.modules.CommonModal,window.SelectForums=new NKC.modules.ForumSelector,window.editor=UE.getEditor("container",NKC.configs.ueditor.shopConfigs),this.initTime(),this.addParam())},computed:{selectedShopForum:function(){if(this.selectedShopForum)return this.selectedShopForum.fid},imgMaster:function(){return this.imgIntroductions[0]},paramAttributes:function(){var e=this.params,t=[];return e.map((function(e){(e=(e=(e=(e=e.value.replace(/，/g,",")).split(",")).map((function(e){return(e+"").trim()}))).filter((function(e){return!!e}))).length&&t.push(e)})),t=(t=NKC.methods.doExchange(t)).map((function(e){return Array.isArray(e)&&(e=e.join(", ")),e}))},freightTemplateNames:function(){return this.freightTemplates.map((function(e){return e.name}))}},methods:{save:function(){var e=this,t=NKC.methods.checkData,i=t.checkNumber,n=t.checkString,o={};Promise.resolve().then((function(){if(e.submitting=!0,"create"===e.type){if(e.content=editor.getContent(),!e.selectedShopForumId)throw"请选择商品分类";o.mainForumsId=[e.selectedShopForumId].concat(e.mainForums.map((function(e){return e.fid}))),n(e.title,{name:"商品标题",minLength:6,maxLength:200}),o.productName=e.title,n(e.abstract,{name:"商品简介",minLength:6,maxLength:1e3}),o.productDescription=e.abstract,e.keywords.map((function(e){n(e,{name:"关键词",minLength:1,maxLength:20})})),o.attention=e.keywords,n(e.content,{name:"图文描述",minLength:1,maxLength:1e5}),o.productDetails=e.content}var t=e.imgIntroductions.filter((function(e){return!!e}));if(!t.length)throw"请至少选择一张商品图";o.imgIntroductions=t;var s=[];if(!(s=e.selectedParams).length)throw"请至少添加一个商品规格";if(s.map((function(e){var t=e.name,r=e.originPrice,o=e.price,s=e.useDiscount,a=e.stocksTotal;if(n(t,{name:"规格名称",minLength:1,maxLength:100}),i(a,{name:"规格库存",min:0}),i(r,{name:"规格价格",min:.01,fractionDigits:2}),s&&(i(o,{name:"规格优惠价",min:.01,fractionDigits:2}),o>=r))throw"规格优惠价必须小于原价"})),o.productParams=s,o.vipDisGroup=[],e.vipDiscount&&(e.vipDisGroup.map((function(e){var t=e.vipNum;i(t,{name:"折扣率",min:1,max:100})})),o.vipDisGroup=e.vipDisGroup),o.vipDiscount=e.vipDiscount,!e.isFreePost){if(!e.freightTemplates.length)throw"请至少添加一条运费信息";e.freightTemplates.map((function(e){var t=e.name,r=e.firstPrice,o=e.addPrice;n(t,{name:"物流名称",minLength:1,maxLength:100}),i(r,{name:"物流首件价格",min:0,fractionDigits:2}),i(o,{name:"物流每增加一件的价格",min:0,fractionDigits:2})})),o.freightTemplates=e.freightTemplates}if(o.isFreePost=!!e.isFreePost,o.productSettings=e.productSettings,o.stockCostMethod=e.stockCostMethod,e.purchaseLimit.status?(i(e.purchaseLimit.count,{name:"限购数量",min:1}),o.purchaseLimitCount=e.purchaseLimit.count):o.purchaseLimitCount=-1,e.uploadCert&&(n(e.uploadCertDescription,{name:"凭证说明",minLength:1,maxLength:1e3}),o.uploadCertDescription=e.uploadCertDescription),o.uploadCert=e.uploadCert,"create"===e.type)if("immediately"===e.shelfType)o.productStatus="insale";else if("save"===e.shelfType)o.productStatus="notonshelf";else{o.productStatus="notonshelf";var a=$("#shelfTime"),u=new Date(a.val()).getTime();o.shelfTime=u}else o.productId=r.productId;return nkcAPI("/shop/manage/shelf","POST",{post:o})})).then((function(t){sweetSuccess("提交成功"),e.submitting=!1,e.showCloseInfo=!1,NKC.methods.visitUrl("/shop/manage/goods")})).catch((function(t){e.submitting=!1,sweetError(t)}))},disabledSelectParam:function(e){if(e._id){if(e.isEnable){var t=0;if(this.selectedParams.map((function(e){e.isEnable&&t++})),t<=1)return sweetError("不允许屏蔽所有规格")}e.isEnable=!e.isEnable}},initTime:function(){$(".time").datetimepicker({language:"zh-CN",format:"yyyy-mm-dd hh:ii",autoclose:!0,todayHighlight:1,startView:2,minView:0,forceParse:0})},selectPictures:function(e){var t=this;window.SelectResource||(window.SelectResource=new NKC.modules.SelectResource),SelectResource.open((function(i){if(!["png","jpg","jpeg"].includes(i.resources[0].ext))return sweetInfo("仅支持png、jpg和jpeg格式的图片");Vue.set(t.imgIntroductions,e,i.resourcesId[0])}),{allowedExt:["picture"],countLimit:1})},changeArrIndex:function(e,t,i){var n,r=e[t],o=e.length;if("left"===i){if(0===t)return;n=t-1}else{if(t+1===o)return;n=t+1}var s=e[n];Vue.set(e,t,s),Vue.set(e,n,r)},removePicture:function(e){var t=this;sweetQuestion("确定要删除当前商品图片？").then((function(){Vue.set(t.imgIntroductions,e,"")})).catch((function(e){}))},reloadTemplate:function(){var e=this;nkcAPI("/shop/manage/settings","GET").then((function(t){e.defaultTemplates=t.dealInfo.templates,sweetSuccess("刷新成功")})).catch(sweetError)},addTemplate:function(){this.freightTemplates.push({name:"",firstPrice:"",addPrice:""})},removeFromArr:function(e,t){e.splice(t,1)},selectTemplate:function(t){this.freightTemplateNames.includes(t.name)||this.freightTemplates.push(e({},t))},removeKeyword:function(e){this.keywords.splice(e,1)},selectForum:function(){var e=this,t=e.shopForums.map((function(e){return e.fid}));window.SelectForums.open((function(t){e.mainForums=[t.forum]}),{selectedForumsId:e.selectedShopForumId?[e.selectedShopForumId]:[],disabledForumsId:t})},addKeywords:function(){var e=this;CommonModal.open((function(t){var i=t[0].value;i=(i=i.replace(/，/g,",")).split(",");var n=[];i.map((function(e){(e=(e=e||"").trim())&&!n.includes(e)&&n.push(e)})),e.keywords=n,CommonModal.close()}),{title:"添加关键词",data:[{dom:"textarea",label:"多个关键词以逗号分隔",value:this.keywords.join(", ")}]})},removeParamAttribute:function(e){this.params.splice(e,1)},resetParamForum:function(){this.params=[{value:""},{value:""}]},removeSelectParam:function(e){this.selectedParams.splice(e,1)},addParam:function(e){e=e&&e.name?e:this.newParam(),this.selectedParams.push(e)},newParam:function(e){return e?e="":this.selectedParams.length||(e="默认"),{name:e,originPrice:"",price:"",isEnable:!0,useDiscount:!1,stocksTotal:""}},addParams:function(){this.resetParamForum(),this.paramForum=!0},addParamAttribute:function(){this.params.push({value:""})},saveParamAttribute:function(){var e=this.paramAttributes,t=this;if(!e.length)return sweetError("请至少填写一个属性值");e.map((function(e){t.addParam(t.newParam(e))})),this.paramForum=!1}}}),window.onbeforeunload=function(){if(app.showCloseInfo)return"关闭页面后，已填写的内容将会丢失。确定要关闭当前页面？"}}));
