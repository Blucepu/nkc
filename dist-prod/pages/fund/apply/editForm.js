!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";function e(){return(e=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e}).apply(this,arguments)}window.ue=void 0,window.appButton=void 0;for(var t=NKC.methods.getDataById("data"),r=[],o=0;o<t.form.members.length;o++)r.push(t.form.members[o].user);t.form.project||(t.form.project={t:"",c:"",abstractCn:"",abstractEn:"",keyWordsCn:[],keyWordsEn:[]}),t.form.project.abstractHeader="项目摘要",t.form.project.enableAbstract=!0,t.form.project.enableKeyWords=!0,t.form.project.enableAuthorInfos=!1,t.form.project.enableOriginState=!1,t.form.budgetMoney||(t.form.budgetMoney=[]);var s=new Vue({el:"#app",data:{user:t.user,step:Number(t.step),form:t.form,fund:t.fund,showUploadedPhotos:!1,lifePhotos:t.lifePhotos,searchKeyword:"",searchError:"",selectedMembers:r,searchUsers:[],searchPosts:[],selectedPosts:t.form.threads.applying,saveError:"",saveInfo:"",selectedForum:t.form.forum},mounted:function(){document.getElementById("project")&&(window.ue=UE.getEditor("project",NKC.configs.ueditor.fundConfigs),ue.ready((function(){ue.setContent(s.form.project.c||"")})),paperProto.init(t.form.project||""));var e=this;3===this.step&&setInterval((function(){e.save()}),18e4)},watch:{saveError:function(){appButton.saveError=this.saveError},saveInfo:function(){appButton.saveInfo=this.saveInfo},selectedPosts:function(){var e=this.selectedPosts;this.form.threadsId.applying=[];for(var t=0;t<e.length;t++)this.form.threadsId.applying.push(e[t].tid)}},computed:{budgetMoneyTotal:function(){for(var e=[],t=0;t<this.form.budgetMoney.length;t++){var r=this.form.budgetMoney[t].money,o=this.form.budgetMoney[t].count;e.push(Number(r)*Number(o))}return e},moneyTotal:function(){for(var e=0,t=0;t<this.budgetMoneyTotal.length;t++)e+=this.budgetMoneyTotal[t];return e},selectedPhotosId:function(){for(var e=[],t=0;t<this.form.applicant.lifePhotos.length;t++)e.push(this.form.applicant.lifePhotos[t]._id);return e},steps:function(){for(var e=[{name:"选择申请方式",completed:!1},{name:"填写身份信息",completed:!1},{name:"填写项目内容",completed:!1},{name:"填写其他信息",completed:!1},{name:"提交申请",completed:!1}],t=this.step,r=0;r<e.length;r++)t>r&&(e[r].completed=!0);return e},selectedMembersId:function(){for(var e=[],t=0;t<this.selectedMembers.length;t++)e.push(this.selectedMembers[t].uid);return e}},methods:{format:NKC.methods.format,getUrl:NKC.methods.tools.getUrl,strToHTML:NKC.methods.strToHTML,visitUrl:NKC.methods.visitUrl,toUploadPhoto:function(){confirm("页面跳转将可能导致当前页面输入的内容丢失，请注意保存！")&&this.visitUrl("/u/"+this.user.uid+"/settings/resume",!0)},floatToInt:function(e){e.money=parseInt(e.money),e.count=parseInt(e.count)},showSelectForum:function(){window.ForumSelector||(window.ForumSelector=new NKC.modules.ForumSelector);var e=this;window.ForumSelector.open((function(t){e.selectedForum=t.forum}))},searchUser:function(){this.searchError="";var e=this.searchKeyword;if(!e)return this.searchError="请输入用户名或用户ID";nkcAPI("/u?uid="+e+"&username="+e,"GET").then((function(e){s.searchUsers=e.targetUsers,s.searchUsers.length||(s.searchError="未找到相关用户")})).catch((function(e){s.searchError=e.error||e}))},clearSearchUsers:function(){this.searchUsers=[]},searchPost:function(){this.searchError="";var e=this.searchKeyword;if(!e)return this.searchError="请输入文号或标题";nkcAPI("/t?applicationFormId="+this.form._id+"&type=applicationFormSearch&title="+e+"&pid="+e,"GET").then((function(e){s.searchPosts=e.posts,s.searchPosts.length||(s.searchError="未找到相关文章")})).catch((function(e){s.searchError=e.error||e}))},loadMyPosts:function(){nkcAPI("/t?type=myPosts","GET").then((function(e){s.searchPosts=e.posts,s.searchPosts.length||(s.searchError="未找到相关文章")})).catch((function(e){s.searchError=e.error||e}))},addPost:function(e){-1===this.form.threadsId.applying.indexOf(e.tid)&&this.selectedPosts.push(e)},removePost:function(e){this.selectedPosts.splice(e,1)},infoMeUsers:function(e){nkcAPI("/u/"+s.user.uid+"?t="+e,"GET").then((function(e){s.searchUsers=e.users})).catch((function(e){screenTopWarning(e)}))},addMember:function(e){-1===this.selectedMembersId.indexOf(e.uid)&&this.selectedMembers.push(e)},removeMember:function(e){var t=this.selectedMembers.indexOf(e);-1!==t&&this.selectedMembers.splice(t,1)},switchStep:function(e){var t=this.step;if(t>=5)return openToNewLocation("/fund/a/"+this.form._id+"/settings?s="+(t-1));var r="/fund/a/"+this.form._id+"/settings?s="+(t+1);"last"===e&&(r="/fund/a/"+this.form._id+"/settings?s="+(t-1)),this.save((function(){openToNewLocation(r)}))},saveFunc:function(){this.save()},reloadPhoto:function(){nkcAPI("/me/life_photos","GET",{}).then((function(e){s.lifePhotos=e.lifePhotos})).catch((function(e){screenTopWarning(e.error)}))},removePhoto:function(e){var t=this.form.applicant.lifePhotos.indexOf(e);-1!==t&&this.form.applicant.lifePhotos.splice(t,1)},addPhoto:function(e){-1===this.selectedPhotosId.indexOf(e._id)&&this.form.applicant.lifePhotos.push(e)},addBudget:function(){var e=this.form.budgetMoney.length;this.form.budgetMoney.push({purpose:"用途"+(e+1),count:0,money:0})},removeBudget:function(e){this.form.budgetMoney.splice(e,1)},save:function(e){this.saveError="",this.saveInfo="";var t=this.step,r={s:t},o="/fund/a/"+this.form._id;if(1===t){this.saveError="",this.saveInfo="";var n=this.selectedMembers;if("team"===this.form.from&&0===n.length)return this.saveError="团队申请必须添加至少一个组员";r.from=this.form.from,r.newMembers=[];for(var i=0;i<this.selectedMembersId.length;i++)r.newMembers.push({uid:this.selectedMembersId[i]})}else if(2===t){r.account=this.form.account;var a=this.form.applicant,c=this.selectedPhotosId;r.newApplicant={name:a.name,idCardNumber:a.idCardNumber,mobile:a.mobile,description:a.description,lifePhotosId:c}}else if(3===t){var h=this.form.project,f=paperProto.paperExport();h.keyWordsCn=f.keyWordsCn,h.keyWordsEn=f.keyWordsEn,h.abstractCn=f.abstractCn,h.abstractEn=f.abstractEn,h.c=ue.getContent(),r.project=h}else if(4===t){if(r.projectCycle=this.form.projectCycle,!r.projectCycle)return s.saveError="请输入研究周期";if(r.budgetMoney=this.form.budgetMoney,0===r.budgetMoney.length)return s.saveError="请输入资金预算";if(this.fund.thread.count>0){if(this.form.threadsId.applying.length<this.fund.thread.count)return s.saveError="请选择技术文章，最少"+this.fund.thread.count+"篇";r.threadsId=this.form.threadsId.applying}if(!this.selectedForum)return s.saveError="请选择学科分类";r.category=this.selectedForum.fid}nkcAPI(o,"PUT",r).then((function(){e?e():5===s.step?openToNewLocation("/fund/a/"+s.form._id):s.saveInfo="保存成功"})).catch((function(e){s.saveError=e.error||e}))}}});window.appButton=new Vue({el:"#app_button",data:{step:Number(t.step),saveError:"",saveInfo:""},methods:{saveFunc:s.saveFunc,switchStep:s.switchStep,deleteForm:function(){!0===confirm("删除申请表后所有填写的内容都将会被删除，确认要删除吗？")&&nkcAPI("/fund/a/"+s.form._id+"?type=delete","DELETE",{}).then((function(e){openToNewLocation("/fund/list/"+e.fund._id.toLowerCase())})).catch((function(e){screenTopWarning(e.error)}))}}}),e(window,{ue:ue,app:s})}));
