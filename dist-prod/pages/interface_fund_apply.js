!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";function e(){return(e=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e}).apply(this,arguments)}var n=[],t=[],a="",o=[],i="";window.applicationFormId=void 0,$((function(){d(),u(),h(),y(),objString=$("#applicationFormId").text(),obj=JSON.parse(objString),window.applicationFormId=parseInt(obj.id),s=parseInt(obj.s),L(),W(),x(),E(),b()}));var r=[],c=[];window.fixedFn=void 0;var l=[];function d(){$("#team").on("click",(function(){p()})),$("#personal").on("click",(function(){f()})),$(".wechat").on("click",(function(){k(),$("#bankName").css("display","none")})),$(".alipay").on("click",(function(){C(),$("#bankName").css("display","none")})),$(".bankCard").on("click",(function(){w(),$("#bankName").css("display","block")})),$("#account").on("click",(function(){if(y(),""===i)return $("#account").blur(),alert("请先选择收款方式！")})).on("focus",(function(){if(y(),""===i)return $("#account").blur(),alert("请先选择收款方式！")}))}function u(){$("#team").hasClass("active")&&p()}function p(){$("#teamDiv").fadeIn(),$("#team").addClass("active"),$("#personal").removeClass("active")}function f(){$("#teamDiv").fadeOut(),$("#team").removeClass("active"),$("#personal").addClass("active")}function h(){var e=$(".selectedUser").length;n=[];for(var t=0;t<e;t++)n.push({uid:$(".selectedUser").eq(t).attr("uid"),username:$(".selectedUser").eq(t).text()})}function v(){var e="";if(0===t.length)return $("#usersList").html('<div class="blank">暂无数据</div>');for(var n=0;n<t.length;n++){var a=t[n];e+='<span class="fund-span disabled" uid="'+a.uid+'" onclick="selectUser('+a.uid+')">'+a.username+'<span class="fund-span add glyphicon glyphicon-ok"></span></span>'}$("#usersList").html(e)}function m(){var e="";if(0===n.length)return $("#selectedUsersDiv").html("<h4>暂未添加组员</h4>");e+="<h4>已添加组员：</h4>";for(var t=0;t<n.length;t++){var a=n[t];e+='<span class="fund-span selectedUser" uid="'+a.uid+'" onclick="deleteUser('+a.uid+')">'+a.username+'<span class="fund-span delete glyphicon glyphicon-minus"></span></span></span>'}$("#selectedUsersDiv").html(e)}function g(e){var t={newMembers:[],from:"personal",s:s};if($("#team").hasClass("active")){if(0===n.length)return screenTopWarning("团队申请必须要有组员，若没有组员请选择个人申请。");t.newMembers=n,t.from="team"}nkcAPI("/fund/a/"+applicationFormId,"PUT",t).then((function(n){void 0===e?screenTopAlert("保存成功！"):e(n)})).catch((function(e){return screenTopWarning(e.error)}))}function b(){for(var e=$(".photo-selected img"),n=0;n<e.length;n++)l.push(parseInt(e.eq(n).attr("photoId")));T()}function T(){for(var e=$(".fund-photo-list img"),n=0;n<e.length;n++){for(var t=!1,a=0;a<l.length;a++)parseInt(e.eq(n).attr("photoId"))===l[a]&&(t=!0);t?e.eq(n).addClass("active"):e.eq(n).removeClass("active")}var o="";for(n=0;n<l.length;n++)o+='<div class="col-xs-12 col-md-4 photo-content"><div class=" glyphicon glyphicon-minus delete-photo" onclick="removePhoto('+l[n]+')"></div><img src="/photo_small/'+l[n]+'" photoId='+l[n]+"/></div>";$(".photo-selected .row").html(o),0===l.length?$("#selectLifePhotoInfo").text("暂未选择生活照"):$("#selectLifePhotoInfo").text("已选择生活照")}function y(){$(".wechat").hasClass("active")?i="wechat":$(".alipay").hasClass("active")?i="alipay":$(".bankCard").hasClass("active")&&(i="bankCard")}function k(){$(".wechat").addClass("active"),$(".alipay").removeClass("active"),$(".bankCard").removeClass("active"),y()}function C(){$(".bankCard").removeClass("active"),$(".alipay").addClass("active"),$(".wechat").removeClass("active"),y()}function w(){$(".bankCard").addClass("active"),$(".alipay").removeClass("active"),$(".wechat").removeClass("active"),y()}function I(e){try{var n=J(),t={account:{paymentType:n.paymentType,number:n.account,name:n.bankCardName,bankName:n.bankName},newApplicant:{name:n.name,idCardNumber:n.idCardNumber,mobile:n.mobile,description:n.description,lifePhotosId:l},s:s};nkcAPI("/fund/a/"+applicationFormId,"PUT",t).then((function(n){if(void 0!==e)return e(n);screenTopAlert("保存成功！")})).catch((function(e){screenTopWarning(e.error)}))}catch(e){screenTopWarning(e)}}function P(e){var n=$("#title").val(),t=$("#abstract").val(),a=$("#content").val();return n?!t&&obj.detailedProject?screenTopWarning("请输入项目摘要。"):a||obj.detailedProject?void nkcAPI("/fund/a/"+applicationFormId,"PUT",{s:s,project:{t:n,abstract:t,c:a}}).then((function(n){void 0===e?screenTopAlert("保存成功！"):e(n)})).catch((function(e){screenTopWarning(e.error)})):screenTopWarning("请输入项目内容。"):screenTopWarning("请输入项目标题。")}function L(){for(var e=$(".list .fund-money-list").length,n=[],t=0;t<e;t++)n.push({purpose:N("purpose",t),count:N("count",t),money:N("money",t)});o=n}function N(e,n){var t=$("."+e+"[num="+n+"]").text();if("purpose"!==e){var a=parseInt(t);return a<0&&(a=0),a}return t}function A(){var e=$("#projectCycle").val();if((e=parseInt(e))<=0)throw"研究周期不能小于0天";a=e}function F(e){var n="",t=0,a=o.length;if(0===a)$("#aggregate").text(""),n='<div class="blank" style="color: #ccc;line-height: 4rem;">暂无数据</div>';else{for(var i=0;i<a;i++){var s=o[i];s.i=i,n+=U(s,e),t+=s.count*s.money,s.i=void 0}$("#aggregate").text("总计："+t+"元")}$("#budgetMoney .list").html(n)}function U(e,n){var t=e.purpose,a=e.count,o=e.money,i=a*o,s=e.i,r="";return!0===n&&(r="disabled"),'<div class="fund-money-list" num='+s+'><div class="purpose" contenteditable=true num='+s+">"+t+'</div><div class="count" contenteditable=true num='+s+">"+a+'</div><div class="money" contenteditable=true num='+s+">"+o+'</div><div class="total" num='+s+">"+i+'</div><div class="delete glyphicon glyphicon-minus '+r+'" onclick="deleteList('+s+')"></div></div>'}function W(){$(".purpose, .count, .money").unbind(),$(".purpose, .count, .money").one("blur",(function(){L(),F(),W()}))}function x(){$(".addPurpose").on("click",(function(){var e=$(this).text();""!==$("#purpose").val()&&(e="，"+e),$("#purpose").val($("#purpose").val()+e)}))}function j(e){try{A()}catch(e){return screenTopWarning(e)}var n={s:s,projectCycle:a},t=$("#purpose").val();0===$("#purpose").length?n.budgetMoney=o:n.budgetMoney=t,n.category=$("#category").attr("fid"),nkcAPI("/fund/a/"+applicationFormId,"PUT",n).then((function(n){void 0===e?screenTopAlert("保存成功！"):e(n)})).catch((function(e){screenTopWarning(e.error)}))}function M(){nkcAPI("/me/life_photos","GET",{}).then((function(e){O(e.lifePhotos)})).catch((function(e){screenTopWarning(e.error)}))}function O(e){if(0!==e.length){for(var n="",t=0;t<e.length;t++){var a=e[t];n+='<div class="col-xs-12 col-md-4"><img photoId=photo._id src="/photo_small/'+a._id+'" onclick="selectLifePhoto('+a._id+')")></div>'}$(".fund-photo-list").html(n)}}function S(e,n,t){var a="",o="";t=!0===t?"disabled":"";for(var i="",s=0;s<e.length;s++){var c=e[s],l=c.tid;a="addThread",o="glyphicon glyphicon-plus";for(var d=0;d<r.length;d++){if(r[d].tid===l){a="deleteThread",o="glyphicon glyphicon-minus";break}}var u=c.uid,p=c.pid,f=c.username,h=c.t,v=c.toc;i+='<div class="threadList">'+('<div class="col-xs-10 col-md-10"><div class="postString displayNone">'+JSON.stringify(c)+'</div><span>文号：</span><span class="threadNumber">'+p+'&nbsp;&nbsp;</span><a href="/m/'+u+'" target="_blank">'+f+"</a><span>&nbsp;发表于 "+v+'</span><br><a href="/t/'+l+'" target="_blank">'+h+"</a></div>")+('<div class="col-xs-2 col-md-2 delete '+t+" "+o+'" onclick="'+a+"('"+l+"', this);\"></div>")+"</div>"}return i}function q(e){$(window).scrollTop(e)}function E(){for(var e=$(".selectedThreads .threadList .postString"),n=e.length,t=0;t<n;t++){var a=e.eq(t).text(),o=JSON.parse(a);r.push(o)}}function _(e,n,t,a){var o;""===(o=S(n,0,t))&&(o='<div class="blank blank-selectedThread">暂无数据</div>',$(e).html()),$(e).html(o)}function D(e,n){var t=e.page||0,a=e.pageCount||1;if(a<=1)return"";var o,i,s="",r=t-3,c=t+3;r>0?c>a?(i=a,o=r-(c-a)<0?0:r-(c-a)):(i=c,o=r):(o=0,i=c<a?a<c-r?a:c-r:a-1),void 0===n&&(n="");for(var l=0;l<a;l++)if(!(l<o||l>i)){var d="";t===l&&(d="active"),s+='<li class="'+d+'"><a onclick="getThreads('+l+","+n+')">'+(l+1)+"</a></li>"}return s}function G(e,n){var t=D(e,n);$(".pageList").html(t)}function B(e){for(var n=[],t=0;t<r.length;t++){var a=r[t];n.push(a.tid)}var o={threadsId:n,s:s};nkcAPI("/fund/a/"+applicationFormId,"PUT",o).then((function(n){void 0===e?screenTopAlert("保存成功！"):e(n)})).catch((function(e){screenTopWarning(e.error)}))}function J(){var e={name:$("#name").val(),idCardNumber:$("#idCardNumber").val(),mobile:$("#mobile").val(),description:$("#description").val()};if(""===e.name)throw"请输入真实姓名！";if(""===e.idCardNumber)throw"请输入身份证号码！";if(!1===/(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/.test(e.idCardNumber))throw"身份证号码不合法！";if(""===e.mobile)throw"请输入联系电话！";if(0!==$(".wechat, .alipay, .bankCard").length){if($(".wechat").hasClass("active"))e.paymentType="wechat";else if($(".alipay").hasClass("active"))e.paymentType="alipay";else{if(!$(".bankCard").hasClass("active"))throw"请选择收款方式！";if(e.paymentType="bankCard",!$("#bankCardName input").val())throw"请输入户名！";if(!$("#bankName input").val())throw"请输入银行全称！";e.bankName=$("#bankName input").val()}if(e.account=$("#account").val(),e.bankCardName=$("#bankCardName input").val(),""===e.account)throw"请输入收款账号！"}if(""===e.description)throw"请输入自我介绍";return e}e(window,{init:d,initTeam:u,clearTeam:function(){n=[],t=[],v(),m()},teamDisplay:p,teamDisappear:f,initSelectedUsers:h,getSubscribeUsers:function(e){nkcAPI("/u/"+e+"/subscribe","GET",{}).then((function(e){t=e.targetUsers,v()})).catch((function(e){return screenTopWarning(e.error)}))},getSubscribers:function(e){nkcAPI("/u/"+e+"/subscribe?fans=true","GET",{}).then((function(e){t=e.targetUsers,v()})).catch((function(e){return screenTopWarning(e.error)}))},displayResult:v,displaySelectedUsers:m,selectUser:function(e){e=""+e;for(var a="",o=0;o<t.length;o++){(i=t[o]).uid===e&&(a=i.username)}for(o=0;o<n.length;o++){var i;if((i=n[o]).uid===e)return}n.push({uid:e,username:a}),m()},deleteUser:function(e){e=""+e;for(var t=0;t<n.length;t++)if(n[t].uid===e){n.splice(t,1);break}m()},getUser:function(){$("#usersList").html('<div class="blank">搜索中，请稍后...</div>');var e=$("#username").val();if(""===e)return screenTopWarning("输入不能为空！");nkcAPI("/u?username="+e+"&uid="+e,"GET",{}).then((function(e){t=e.targetUsers,v()})).catch((function(e){return screenTopWarning(e.error)}))},submitApplicationMethod:function(e){g(e?function(){openToNewLocation("/fund/a/"+applicationFormId+"/settings?s="+(s-1))}:function(){openToNewLocation("/fund/a/"+applicationFormId+"/settings?s="+(s+1))})},saveApplicationMethod:g,selectLifePhoto:function(e){if($('img[photoId="'+e+'"]').hasClass("active")){var n=l.indexOf(e);-1!==n&&l.splice(n,1),screenTopAlert("已移除"+e)}else{for(var t=!1,a=0;a<l.length;a++)l[a]===e&&(t=!0);t||l.push(e),screenTopAlert("已选择"+e)}T()},initLifePhoto:b,displayLifePhotos:T,removePhoto:function(e){e=parseInt(e);var n=l.indexOf(e);-1!==n&&(l.splice(n,1),T())},initFundPay:y,chooseWechat:k,chooseAlipay:C,chooseBankCard:w,submitApplicantMessages:function(e){I(e?function(){openToNewLocation("/fund/a/"+applicationFormId+"/settings?s="+(s-1))}:function(){openToNewLocation("/fund/a/"+applicationFormId+"/settings?s="+(s+1))})},saveApplicantMessages:I,saveProject:P,toEditor:function(){P((function(){openToNewLocation("/editor?type=application&id="+applicationFormId+"&cat=p")}))},submitProject:function(e){P(e?function(){openToNewLocation("/fund/a/"+applicationFormId+"/settings?s="+(s-1))}:function(){openToNewLocation("/fund/a/"+applicationFormId+"/settings?s="+(s+1))})},initBudgetMoney:L,getText:N,readProjectValue:A,displayPurpose:F,editor:function(){L();var e=$(".fund-money-list .delete");0!==e.length&&(e.eq(0).hasClass("disabled")?$(".fund-money-list .delete").removeClass("disabled"):$(".fund-money-list .delete").addClass("disabled"))},deleteList:function(e){L(),o.splice(e,1),F()},addList:function(){L();var e={money:0,count:0,purpose:"新建"+(o.length+1)};o.push(e),F(),W()},fundMoneyList:U,onContentChange:W,saveBudgetMoney:function(e,n){L();try{A()}catch(e){return screenTopWarning(e)}var t={projectCycle:a,budgetMoney:o,s:s};nkcAPI("/fund/a/"+e,"PUT",t).then((function(e){void 0!==n?n(e):screenTopAlert("保存成功！")})).catch((function(e){screenTopWarning(e.error)}))},initAddPurpose:x,savePurpose:j,compute:function(){L(),F()},displayPopupPanel:function(){$(".popupPanel").removeClass("disabled");var e=$(window).scrollTop();window.fixedFn=q,$("html, body").css("overflow","hidden"),$(window).scroll((function(){fixedFn(e)})),M()},getLifePhotos:M,createLifePhotosHtml:O,disappearPopupPanel:function(){$(".popupPanel").addClass("disabled"),$("html, body").css("overflow","auto"),window.fixedFn=function(){}},createThreadsList:S,disabledRolling:q,initThreadsList:E,displayThreadsList:_,displayDeleteThreadBtn:function(){$(".selectedThreads .delete").eq(0).hasClass("disabled")?$(".selectedThreads .delete").removeClass("disabled"):$(".selectedThreads .delete").addClass("disabled")},deleteThread:function(e,n){for(var t=0;t<r.length;t++)r[t].tid===e&&r.splice(t,1);if(n){console.log(n);var a=$(n);if(a.hasClass("glyphicon-minus")){a.removeClass("glyphicon-minus").addClass("glyphicon-plus");var o=a.attr("onclick");a.attr("onclick",o.replace("deleteThread","addThread"))}}screenTopAlert("移除成功!"),_(".selectedThreads",r,!1)},addThread:function(e,n){for(var t,a=0;a<c.length;a++)c[a].tid===e&&(t=c[a]);var o=!1;for(a=0;a<r.length;a++)if(r[a].tid===t.tid){o=!0;break}var i=$(n);if(i.hasClass("glyphicon-plus")){i.removeClass("glyphicon-plus").addClass("glyphicon-minus");var s=i.attr("onclick");i.attr("onclick",s.replace("addThread","deleteThread"))}return o?screenTopWarning("该贴子已在已选列表中，不需要重复添加！"):(r.push(t),_(".selectedThreads",r,!1),screenTopAlert("添加成功！"))},createPageList:D,displayPageList:G,getThreads:function(e,n){var t;if(e=void 0!==e?"page="+e+"&":"",void 0===n){var a=$("#searchThread").val();if(""===a)return screenTopWarning("输入不能为空！");t="/t?"+e+"from=applicationForm&applicationFormId="+applicationFormId+"&keywords="+a}else t="/t?"+e+"from=applicationForm&self=true";$(".unselectedThreads").html('<div class="blank blank-selectedThread">搜索中...</div>'),nkcAPI(t,"GET",{}).then((function(e){c=e.threads,G(e.paging,n),0===c.length&&screenTopAlert("什么也没找到..."),_(".unselectedThreads",c,!1)})).catch((function(e){screenTopWarning(e.error);$(".unselectedThreads").html('<div class="blank blank-selectedThread">error</div>')}))},saveThreadsList:B,saveOtherMessages:function(){j((function(){B((function(){screenTopAlert("保存成功！")}))}))},submitOtherMessages:function(e){j(e?function(){B((function(){openToNewLocation("/fund/a/"+applicationFormId+"/settings?s="+(s-1))}))}:function(){B((function(){openToNewLocation("/fund/a/"+applicationFormId+"/settings?s="+(s+1))}))})},submitApplicationForm:function(){var e={s:s};nkcAPI("/fund/a/"+applicationFormId,"PUT",e).then((function(){openToNewLocation("/fund/a/"+applicationFormId)})).catch((function(e){screenTopWarning(e.error)}))},deleteApplicationForm:function(e){!0===confirm("删除申请表后所有填写的内容都将会被删除，确认要删除吗？")&&nkcAPI("/fund/a/"+e+"?type=delete","DELETE",{}).then((function(e){openToNewLocation("/fund/list/"+e.fund._id.toLowerCase())})).catch((function(e){screenTopWarning(e.error)}))},chooseCategory:function(e,n){$("#category").attr("fid",e).text(n)},back:function(){openToNewLocation("/fund/a/"+applicationFormId+"/settings?s="+(s-1))},userMessagesForm:J})}));
