!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";function e(){return(e=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e}).apply(this,arguments)}var t="",n={};function o(e){var t="String"==typeof e?document.getElementById(e):e;if("selectionStart"in t){var n=t.selectionEnd-t.selectionStart;return{start:t.selectionStart,end:t.selectionEnd,length:n,text:t.value.substr(t.selectionStart,n)}}if(document.selection){t.focus();var o=document.selection.createRange(),i=t.createTextRange(),r=i.duplicate();if(r.moveToBookmark(o.getBookmark()),i.setEndPoint("EndToStart",r),null===o||null===i)return{start:t.value.length,end:t.value.length,length:0,text:""};var c=o.text.replace(/[\r\n]/g,"."),a=t.value.replace(/[\r\n]/g,".").indexOf(c,i.text.length);return{start:a,end:a+c.length,length:c.length,text:o.text}}return{start:t.value.length,end:t.value.length,length:0,text:""}}function r(e,t,n){var i="string"==typeof e?document.getElementById(e):e;selection=o(e);var r=selection.start,a=r+t.length;return i.value=i.value.substr(0,r)+t+i.value.substr(selection.end,i.value.length),n&&c(e,a,a),i.focus()}function c(e,t,n){var r="string"==typeof e?document.getElementById(e):e;if("selectionStart"in r)r.focus(),r.selectionStart=t,r.selectionEnd=n;else if(document.selection){r.focus();var c=r.createTextRange(),a=t;for(i=0;i<a;i++)-1!==r.value.charAt(i).search(/[\r\n]/)&&(t-=.5);for(a=n,i=0;i<a;i++)-1!==r.value.charAt(i).search(/[\r\n]/)&&(n-=.5);c.moveEnd("textedit",-1),c.moveStart("character",t),c.moveEnd("character",n-t),c.select()}return o(e)}window.Attachments=void 0,window.quotePostApp=void 0,$(document).ready((function(){new Promise((function(e,t){NKC.configs.isApp?setTimeout((function(){e()}),300):e()})).then((function(){NKC.methods.autoHidePostContent()})).catch((function(e){console.error(e)})),window.moduleToColumn&&moduleToColumn.init(),!window.SubscribeTypes&&NKC.modules.SubscribeTypes&&new NKC.modules.SubscribeTypes,$("#container").length&&l();for(var e=$(".module-survey-form"),t=0;t<e.length;t++){var o=e.eq(t).attr("id");new NKC.modules.SurveyForm("#"+o).init()}if(n.dom=$("#moduleAuthor"),n.app=new Vue({el:"#moduleAuthorApp",data:{contract:""}}),$("#moduleAuthor").modal({show:!1}),NKC.methods.markDom($("#highlight>.highlight")),0!==$(".w-e-text-container").length){$(".w-e-text-container").resizable({containment:"#body",minHeight:100,minWidth:100,maxWidth:1400}),$(window).width()<750&&($(".ThreadTitleText").css("font-size","20px"),$(".airnum1").css("font-size","16px"),$(".airnum2").css("font-size","16px"),$(".airnum3").css("font-size","10px")),$(window).width()<433&&$(".ThreadTitle1").css("width","65%");var i=geid("ReplyContent"),c=geid("proxy");c&&c.addEventListener("click",(function(e){r(i,e.target.getAttribute("data-unicode"),!0)})),scrollTo(0,0);var a=document.getElementById("quotePost");if(a){var s=JSON.parse(a.innerText);p(s.pid,s.step,s.page)}}}));var a=ga("replytarget","value");function s(){var e={c:ue.getContent(),l:"html"};return window.quotePostApp&&window.quotePostApp&&(e.quote=window.quotePostApp.pid),e}function d(){$("#ReplyContent").find(".MathJax_Preview").each((function(){var e;0!==$(this).next().next().length?(e=$(this).next().next().attr("type").length>15?"$$"+$(this).next().next().html()+"$$":"$"+$(this).next().next().html()+"$",$(this).next().next().replaceWith(e),$(this).next().replaceWith(""),$(this).replaceWith("")):$(this).parent().remove()}))}function u(){var e=s();if(!e||""===e.c.replace(/<[^>]+>/g,""))throw"请填写回复内容";var t=I();e.columnMainCategoriesId=t.mainCategoriesId,e.columnMinorCategoriesId=t.minorCategoriesId;var n=$("#sendAnonymousPost");return n.length&&(e.anonymous=n.prop("checked")),e}function l(){setTimeout((function(){Promise.resolve().then((function(){var e=u();e.t="";var n="/u/"+NKC.configs.uid+"/drafts",o={post:e,draftId:t,desType:"thread",desTypeId:$("#threadId").text()};return nkcAPI(n,"POST",o)})).then((function(e){t=e.draft.did,l()})).catch((function(e){console.log(e),l()}))}),6e4)}function h(e){var t=$("#ButtonReply");e?(t.attr("disabled","disabled"),t.html("回复中... <span class='fa fa-spinner fa-spin'>")):(t.removeAttr("disabled"),t.html("回复"))}function p(e){window.quotePostApp||(window.quotePostApp=new Vue({el:"#quoteContent",data:{username:"",uid:"",step:"",c:"",pid:""},methods:{getUrl:NKC.methods.tools.getUrl,load:function(e){var t=this;nkcAPI("/p/"+e+"/quote","GET").then((function(e){var n=e.quotePost;n&&n.pid&&(t.username=n.username,t.uid=n.uid,t.pid=n.pid,t.step=n.step,t.c=n.c,window.location.href="#container")})).catch(sweetError)},clear:function(){this.username="",this.uid="",this.step="",this.c="",this.pid=""}}})),window.quotePostApp.load(e)}function m(){var e=gv("TargetForum").trim().split(":");return 2!==e.length?screenTopWarning("请选择一个目标"):e=e[0]}function f(e){return e=e.toString(),nkcAPI("/f/"+e+"/category","GET",{}).then((function(e){return(e=e.categorys).length?screenTopQuestion("请选择一个分类：",["0:（无分类）"].concat(e.map((function(e){return e.cid+":"+e.name})))):null})).then((function(e){return e?e.split(":")[0]:0}))}function g(){$(".managementDiv").slideToggle()}window.displayManagement=g;var T=$(".thread-content"),w=$(".hiddenThreadContent"),v=T.css("max-height"),P=$(".showThreadContentBtn"),C=P.text(),A=P.attr("hide-text");function I(){if(!window.ColumnCategoriesDom)return[];var e=ColumnCategoriesDom.getStatus();if(e.checkbox&&0===e.selectedMainCategoriesId.length)throw"请选择专栏文章主分类";return{mainCategoriesId:e.selectedMainCategoriesId||[],minorCategoriesId:e.selectedMinorCategoriesId||[]}}function y(e){e?$("#ButtonReply").attr("disabled",!1):$("#ButtonReply").attr("disabled",!0)}$(".dropdown-menu.stop-propagation").on("click",(function(e){e.stopPropagation()})),window.ColumnCategoriesDom=void 0,$((function(){NKC.modules.SelectColumnCategories&&(window.ColumnCategoriesDom=new NKC.modules.SelectColumnCategories);var e=$("#protocolCheckbox");e.on("change",(function(){y(e.prop("checked"))})),y(e.prop("checked"))}));var k=NKC.methods.getDataById("threadForumsId");function M(){window.MoveThread||(window.MoveThread=new NKC.modules.MoveThread);var e=NKC.methods.getDataById("threadForumsId");window.MoveThread.open((function(t){var n=t.forums,o=t.moveType,i=t.violation,r=t.violationReason;window.MoveThread.lock(),nkcAPI("/threads/move","POST",{forums:n,moveType:o,threadsId:[e.tid],violation:i,violationReason:r}).then((function(){screenTopAlert("操作成功"),window.MoveThread.close()})).catch((function(e){sweetError(e),window.MoveThread.unlock()}))}),{selectedCategoriesId:e.categoriesId,selectedForumsId:e.mainForumsId})}function x(){return $(".single-post-checkbox input[type='checkbox']")}function b(){x().prop("checked",!1)}function L(){for(var e=[],t=x(),n=0;n<t.length;n++){var o=t.eq(n);o.prop("checked")&&e.push(o.attr("data-pid"))}return e}function N(e){NKC.methods.disabledPosts(e)}var S=[];function H(){socket.emit("joinRoom",{type:"post",data:{postId:k.pid}})}function K(e){if(e&&(e.comment&&NKC.configs.uid!==e.comment.uid&&bulletComments.add(e.comment),k.isLastPage)){var t=$(e.html).find(".single-post-container");t=t[0];try{MathJax.typesetPromise([t])}catch(e){console.log(e)}t=$(t),$(".single-posts-container").append(t),floatUserPanel.initPanel(),NKC.methods.initSharePanel(),NKC.methods.initStickerViewer(),NKC.methods.initVideo(),NKC.methods.initPostOption(),NKC.configs.isApp||NKC.methods.initImageViewer(),S.push(new NKC.modules.NKCHL({type:"post",targetId:e.postId,notes:[]}))}}function E(e){e&&(e.comment&&NKC.configs.uid!==e.comment.uid&&bulletComments.add(e.comment),NKC.methods.insertComment(e.parentCommentId,e.parentPostId,e.html))}$((function(){var e=NKC.methods.getDataById("threadForumsId");NKC.oneAfter("mathJaxRendered",(function(t,n){if(e.notes&&e.notes.length)for(var o=0;o<e.notes.length;o++){var i=e.notes[o];S.push(new NKC.modules.NKCHL({type:i.type,targetId:i.targetId,notes:i.notes}))}n()})),NKC.methods.highlightBlockBySelector("[data-tag='nkcsource'][data-type='pre']");var t=window.location.hash;NKC.configs.isApp&&t&&setTimeout((function(){window.location.hash="",window.location.hash=t}),1e3),NKC.configs.uid&&socket&&(NKC.methods.setThreadListNewPostCount($("#threadId").text().trim(),0),window.bulletComments=new NKC.modules.BulletComments({offsetTop:NKC.configs.isApp?20:60}),socket.on("connect",H),socket.on("postMessage",(function(e){K(e)})),socket.on("commentMessage",(function(e){E(e)})),socket.connected&&H())})),"reactNative"===NKC.configs.platform&&(window._userSelect=!0),ue.ready((function(){ue.body.addEventListener("keydown",(function(e){13===e.keyCode&&e.ctrlKey&&$("#ButtonReply").click()}))})),e(window,{addToColumn:function(e,t){moduleToColumn.show((function(t){var n=t.columnId,o=t.mainCategoriesId,i=t.minorCategoriesId;nkcAPI("/m/"+n+"/post","POST",{type:"addToColumn",mainCategoriesId:o,minorCategoriesId:i,postsId:[e]}).then((function(){window.location.reload(),moduleToColumn.hide()})).catch((function(e){screenTopWarning(e)}))}),{selectMul:!0})},removeToColumn:function(e,t){nkcAPI("/m/"+t+"/post","POST",{type:"removeColumnPostByPid",postsId:[e]}).then((function(){window.location.reload()})).catch((function(e){screenTopWarning(e)}))},get_selection:o,replace_selection:r,set_selection:c,cartThread:function(e){nkcAPI("addThreadToCart",{tid:e}).then((function(){return screenTopAlert(e+" added to cart")})).catch((function(e){screenTopWarning(e.error)}))},cartPost:function(e){nkcAPI("addPostToCart",{pid:e}).then((function(){return screenTopAlert(e+" added to cart")})).catch((function(e){screenTopWarning(e.error)}))},setDigest:function(e){nkcAPI("/t/"+e+"/digest","POST",{}).then((function(){window.location.reload()})).catch((function(e){screenTopWarning(e.error||e)}))},cancelDigest:function(e){nkcAPI("/t/"+e+"/digest","DELETE",{}).then((function(){window.location.reload()})).catch((function(e){screenTopWarning(e.error||e)}))},setTopped:function(e){nkcAPI("/t/"+e+"/topped","POST",{}).then((function(){window.location.reload()})).catch((function(e){screenTopWarning(e.error||e)}))},cancelTopped:function(e){nkcAPI("/t/"+e+"/topped","DELETE",{}).then((function(){window.location.reload()})).catch((function(e){screenTopWarning(e.error||e)}))},assemblePostObject:s,modifyMathJax:d,getPost:u,autoSaveDraft:l,saveDraft:function(e,n){Promise.resolve().then((function(){d();var o=u();o.t="";return nkcAPI("/u/"+n+"/drafts","POST",{post:o,draftId:t,desType:"thread",desTypeId:e})})).then((function(e){t=e.draft.did,sweetSuccess("保存成功")})).catch((function(e){sweetError(e)}))},setSubmitButton:h,submit:function(e){Promise.resolve().then((function(){h(!0),d();var n=u();return t&&(n.did=t),nkcAPI("/t/"+e,"POST",{post:n})})).then((function(e){return ue.setContent(""),h(!1),window.quotePostApp&&window.quotePostApp.clear(),K(e.renderedPost),screenTopAlert("发送成功")})).catch((function(e){sweetError(e),h(!1)}))},quotePost:p,dateTimeString:function(e){return new Date(e).toLocaleString()},at:function(e){if(!ue)return screenTopAlert("权限不足");ue.execCommand("inserthtml","@"+e),window.location.href="#container"},goEditor:function(){window.localStorage.quoteHtml=document.getElementById("quoteContent").innerHTML,window.localStorage.replyHtml=ue.getContent(),NKC.methods.visitUrl("/editor?type=thread&id="+a.trim().split("/")[1],!0)},extractfid:m,moveThreadTo:function(e){f(m()).then((function(e){return M()})).then((function(){screenTopAlert("请刷新")})).catch((function(e){screenTopWarning(e.error)}))},askCategoryOfForum:f,recycleThread:function(e){M()},widerArea:function(){var e=geid("ReplyContent");e.rows=10,e.style.resize="vertical",geid("WiderArea").style.display="none"},switchVInPersonalForum:function(e,t,n){var o,i,r;if(!t){o="恢复专栏显示",i="在专栏隐藏";var c=!1;(r=geid("visibility")).innerHTML===i&&(c=!0),nkcAPI("/t/"+e+"/switchInPersonalForum","PUT",{hideInMid:c}).then((function(){if(r.innerHTML===o)return r.innerHTML=i,void screenTopAlert("已恢复该帖在专栏的显示");r.innerHTML=o,screenTopAlert("已在专栏屏蔽该帖")})).catch((function(e){screenTopWarning(e.error)}))}"MF"===n&&(o="在"+t+"显示",i="在"+t+"隐藏",r=geid("MFVisibility"),nkcAPI("switchVInPersonalForum",{tid:e}).then((function(){if(r.innerHTML===o)return r.innerHTML=i,void screenTopAlert("已恢复该帖在"+t+"的显示");r.innerHTML=o,screenTopAlert("已在"+t+"屏蔽该帖")})).catch((function(e){screenTopWarning(e.error)}))),"OF"===n&&(o="在"+t+"显示",i="在"+t+"隐藏",r=geid("OFVisibility"),nkcAPI("switchVInPersonalForum",{tid:e}).then((function(){if(r.innerHTML===o)return r.innerHTML=i,void screenTopAlert("已恢复该帖在"+t+"的显示");r.innerHTML=o,screenTopAlert("已在"+t+"屏蔽该帖")})).catch((function(e){screenTopWarning(e.error)})))},moveToPersonalForum:function(e){var t=geid("moveToPersonal");nkcAPI("moveToPersonalForum",{tid:e}).then((function(){screenTopAlert("已将该帖送回个人专栏"),t.innerHTML=""})).catch((function(e){screenTopWarning(e.error)}))},switchDInPersonalForum:function(e,t,n){var o,i,r;if(!t){o="取消专栏加精",i="在专栏加精";var c=!1;(r=geid("digest")).innerHTML===i&&(c=!0),nkcAPI("/t/"+e+"/switchInPersonalForum","PUT",{digestInMid:c}).then((function(){if(r.innerHTML===i)return screenTopAlert("已将该帖在个人专栏加精"),void(r.innerHTML=o);screenTopAlert("已取消专栏加精"),r.innerHTML=i})).catch((function(e){screenTopWarning(e.error)}))}"MF"===n&&(o="在"+t+"取消加精",i="在"+t+"加精",r=geid("MFDigest"),nkcAPI("switchDInPersonalForum",{tid:e}).then((function(){if(r.innerHTML===i)return screenTopAlert("已将该帖在"+t+"加精"),void(r.innerHTML=o);screenTopAlert("已取消在"+t+"的加精"),r.innerHTML=i})).catch((function(e){screenTopWarning(e.error)}))),"OF"===n&&(o="在"+t+"取消加精",i="在"+t+"加精",r=geid("OFDigest"),nkcAPI("switchDInPersonalForum",{tid:e}).then((function(){if(r.innerHTML===i)return screenTopAlert("已将该帖在"+t+"加精"),void(r.innerHTML=o);screenTopAlert("已取消在"+t+"的加精"),r.innerHTML=i})).catch((function(e){screenTopWarning(e.error)})))},switchTInPersonalForum:function(e,t,n){var o,i,r;if(!t){o="取消专栏置顶",i="在专栏置顶";var c=!1;(r=geid("topped")).innerHTML===i&&(c=!0),nkcAPI("/t/"+e+"/switchInPersonalForum","PUT",{toppedInMid:c}).then((function(){if(r.innerHTML===i)return screenTopAlert("已将该帖在个人专栏置顶"),void(r.innerHTML=o);screenTopAlert("已取消专栏置顶"),r.innerHTML=i})).catch((function(e){screenTopWarning(e.error)}))}"MF"===n&&(o="在"+t+"取消置顶",i="在"+t+"置顶",r=geid("MFTopped"),nkcAPI("switchTInPersonalForum",{tid:e,type:n}).then((function(){if(r.innerHTML===i)return screenTopAlert("已将该帖在"+t+"置顶"),void(r.innerHTML=o);screenTopAlert("已取消该贴在"+t+"的置顶"),r.innerHTML=i})).catch((function(e){screenTopWarning(e.error)}))),"OF"===n&&(o="在"+t+"取消置顶",i="在"+t+"置顶",r=geid("OFTopped"),nkcAPI("switchTInPersonalForum",{tid:e,type:n}).then((function(){if(r.innerHTML===i)return screenTopAlert("已将该帖在"+t+"置顶"),void(r.innerHTML=o);screenTopAlert("已取消该贴在"+t+"的置顶"),r.innerHTML=i})).catch((function(e){screenTopWarning(e.error)})))},adSwitch:function(e){var t=geid("adBtn"),n="取消首页置顶";nkcAPI("/t/"+e+"/ad","PUT",{}).then((function(){if(t.innerHTML===n)return screenTopAlert("取消首页置顶成功"),void(t.innerHTML="首页置顶");screenTopAlert("首页置顶成功"),t.innerHTML=n})).catch((function(e){screenTopWarning("操作失败： "+e.error)}))},htmlDecode:function(e){var t=document.createElement("div");t.innerHTML=e;var n=t.innerText||t.textContent;return t=null,n},displayManagement:g,showThreadContent:function(){"none"===w.css("display")?(w.show(),T.css("max-height",v),P.text(C)):(w.hide(),T.css("max-height","none"),P.text(A))},removeForumsId:function(e,t){nkcAPI("/t/"+e+"/forum?fid="+t,"DELETE",{}).then((function(){screenTopAlert("移除成功")})).catch((function(e){screenTopWarning(e.error||e)}))},addForum:function(e){var t=getResult();nkcAPI("/t/"+e+"/forum","POST",{fid:t.fid,cid:t.cid}).then((function(){screenTopAlert("添加成功")})).catch((function(e){screenTopWarning(e.error||e)}))},originTextShow:function(e){var t=$(e).parent("a"),n=e.getBoundingClientRect(),o=document.createElement("span");o.setAttribute("id","originPanelShell"),o.style.position="absolute",o.style.background="#eee",o.style.zIndex="20000",o.style.width=n.width+"px",$(t).css("position","relative"),$(t).append(o);var i=document.createElement("div");i.setAttribute("id","originPanelWall"),i.className="originTextWall",o.appendChild(i);var r="<div>"+$(e).attr("data-text")+"</div>";i.innerHTML=r},originTextClose:function(){$("#originPanelShell").remove()},originPanelShow:function(e){var t=$(e).parent("span"),n=e.getBoundingClientRect(),o=document.createElement("span");o.setAttribute("id","originPanelShell"),o.style.position="absolute",o.style.background="#eee",o.style.zIndex="20000",o.style.width=n.width+"px",$(t).css("position","relative"),$(t).append(o);var i=document.createElement("div");i.setAttribute("id","originPanelWall"),i.className="originPanelWall",o.appendChild(i);var r=$(e).attr("data-email"),c=$(e).attr("data-tel"),a=$(e).attr("data-add"),s=$(e).attr("data-code"),d="";r&&(d+="<div>通信邮箱："+r+"</div>"),c&&(d+="<div>电话号码："+c+"</div>"),a&&(d+="<div>通信地址："+a+"</div>"),s&&(d+="<div>邮政编码："+s+"</div>"),i.innerHTML=d},originPanelClose:function(){$("#originPanelShell").remove()},turnUser:function(e){e&&openToNewLocation("/u/"+e)},turnSearch:function(e){e&&openToNewLocation("/search?c="+e)},getSelectedColumnCategoriesId:I,disabledPostButtonByProtocol:y,topPost:function(e,t){nkcAPI("/p/"+e+"/topped","POST",{topped:!!t}).then((function(){sweetSuccess("操作成功")})).catch((function(e){sweetError(e)}))},showAttachments:function(){window.Attachments||(window.Attachments=new NKC.modules.Attachments({pid:NKC.configs.pid,fid:NKC.configs.fid})),Attachments.app.loaded&&!Attachments.app.hidden?Attachments.hide():Attachments.show()},displayAuthor:function(e){var t=NKC.methods.strToObj(e);n.dom.modal("show"),n.app.contract=t},pushGoodsToHome:function(e,t){nkcAPI("/shop/product/"+e+"/top","push"===t?"POST":"DELETE").then((function(){window.location.reload()})).catch(sweetError)},moveThread:M,deleteThread:function(){window.DisabledPost||(window.DisabledPost=new NKC.modules.DisabledPost);var e=NKC.methods.getDataById("threadForumsId");window.DisabledPost.open((function(t){var n,o=t.type,i=t.reason,r=t.remindUser,c=t.violation,a={postsId:[e.pid],reason:i,remindUser:r,violation:c};n="toDraft"===o?"/threads/draft":"/threads/recycle",DisabledPost.lock(),nkcAPI(n,"POST",a).then((function(){screenTopAlert("操作成功"),DisabledPost.close(),DisabledPost.unlock()})).catch((function(e){sweetError(e),DisabledPost.unlock()}))}))},openHidePostPanel:function(e,t){window.hidePostPanel||(window.hidePostPanel=new NKC.modules.HidePost),window.hidePostPanel.open((function(){window.location.reload()}),{pid:e,hide:t})},getPostsDom:x,resetCheckbox:b,markAllPosts:function(){var e=x();if("inline-block"===e.eq(0).css("display")){for(var t=e.length,n=0,o=0;o<t;o++){e.eq(o).prop("checked")&&n++}t===n?e.prop("checked",!1):e.prop("checked",!0)}},managePosts:function(){b();var e=x();"none"===e.eq(0).css("display")?e.css("display","inline-block"):e.css("display","none")},getMarkedPostsId:L,disabledThreadPost:N,disabledMarkedPosts:function(){N(L())},joinPostRoom:H,insertRenderedPost:K,insertRenderedComment:E})}));
