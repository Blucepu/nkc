!function(t){"function"==typeof define&&define.amd?define(t):t()}((function(){"use strict";function t(){return(t=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o])}return t}).apply(this,arguments)}var e={},n={},o={},i={};function s(t){clearTimeout(o[t])}function a(t,i){o[i]=setTimeout((function(){Promise.resolve().then((function(){var o=e[i].getContent();if(!o)throw"请输入评论内容";var s=n[i]||"",a="/u/"+NKC.configs.uid+"/drafts";return nkcAPI(a,"POST",{post:{c:o,parentPostId:i},draftId:s,desType:"thread",desTypeId:t})})).then((function(e){n[i]=e.draft.did,a(t,i)})).catch((function(e){console.log(e),a(t,i)}))}),6e4)}function m(t,n,o){var i=$(".edit_"+n+"_container");if(i.length){var s=$(".edit_"+n+"_container_input");if(s.length){if(s.html())return i.is(":hidden")?i.show():o?void 0:i.hide();var m=$('<button class="btn btn-default btn-sm m-r-05" onclick="saveCommentDraft(\''+t+"', '"+n+"')\">存草稿</button>"),c=$('<button class="btn btn-primary btn-sm" data-comment-button="'+n+'" onclick="submitPostComment(\''+t+"', '"+n+"', "+o+')">提交</button>'),d=$("<div class='text-right m-t-05 m-b-1'></div>");if(d.append(m),!o){var r=$('<button class="btn btn-default btn-sm m-r-05" onclick="closePostComment(\''+n+"')\">取消</button>");d.append(r)}d.append(c);var p=$("<div id='edit_"+n+"' class='m-t-1 m-b-05'></div>");s.append(p,d),e[n]&&e[n].destroy&&e[n].destroy(),e[n]=UE.getEditor("edit_"+n,NKC.configs.ueditor.commentConfigs),i.show(),a(t,n),NKC.configs.uid&&nkcAPI("/blacklist?pid="+n,"GET").then((function(t){var e=t.blacklistInfo;if(e){var n=$("<div class='blacklist-info'><div class='fa fa-exclamation-circle'></div><span>"+e+"</span></div>");s.prepend(n)}}))}}}function c(t,e){var n;e&&(n=new NKC.modules.PagePosition),$(".edit_"+t+"_container").hide(),s(t),n&&n.restore()}var d={};function r(t,e,n,o){var i=$("#post_comments_"+e);i.show(),$(".show_comments_button_"+e).hide(),$(".hide_comments_button_"+e).show();var s="/p/"+e;n&&(s="/p/"+e+"?page="+n),nkcAPI(s,"GET").then((function(n){var s=n.html,a=n.postPermission,c=$('.single-post-comment[data-type="singlePostComment"][data-pid="'+e+'"]'),r=c.find(".post-comment-warning"),u=c.find(".post-editor-notice");a.permit?(m(t,e,!0),u.show()):u.hide(),c.show(),r.html(a.warning);var f=n.paging.buttonValue;d[e]=s||" ",i.html(s);var h=p(f,t,e);i.prepend(h),i.append(h.clone()),$(".dropdown-menu.stop-propagation").on("click",(function(t){t.stopPropagation()})),o&&o(),NKC.methods.initVideo&&setTimeout((function(){NKC.methods.initVideo()}),300),l()})).catch((function(t){screenTopWarning(t)}))}function p(t,e,n){for(var o=$("<div class='paging-button post-comments-page'></div>"),i=0;i<t.length;i++){var s,a=t[i],m="";0===i&&(m="radius-left"),i===t.length-1&&(m="radius-right"),"active"===a.type&&(m+=" active"),s="null"===a.type?$("<a class='pointer button "+m+"' >...</a>"):$("<a onclick=\"viewPostComments('"+e+"', '"+n+"', "+a.num+')" class="pointer button '+m+'">'+(a.num+1)+"</a>"),o.append(s)}return o}function l(){window.floatUserPanel&&floatUserPanel.initPanel(),NKC.methods.initStickerViewer&&NKC.methods.initStickerViewer(),NKC.methods.initSharePanel&&NKC.methods.initSharePanel()}t(window,{editor:e,draftsId:n,timeout:o,disableButton:i,closeSaveCommentDraft:s,autoSaveCommentDraft:a,saveCommentDraft:function(t,o){var i=e[o].getContent(),s=n[o]||"";Promise.resolve().then((function(){var e="/u/"+NKC.configs.uid+"/drafts";return nkcAPI(e,"POST",{post:{c:i,parentPostId:o},draftId:s,desType:"thread",desTypeId:t})})).then((function(t){n[o]=t.draft.did,sweetSuccess("保存成功")})).catch((function(t){sweetError(t)}))},postComment:m,closePostComment:c,submitPostComment:function(t,n,o){if(!i[n]){$("button[data-comment-button='"+n+"']").attr("disabled","disabled").text("提交中"),i[n]=!0;var s=e[n].getContent();nkcAPI("/t/"+t,"POST",{postType:"comment",post:{c:s,l:"html",parentPostId:n}}).then((function(s){var a=s.comment.parentPost,m=s.html;if(s.level1Comment)r(t,n,999999,(function(){screenTopAlert("评论成功"),o||c(n),NKC.methods.markDom($("#post_comment_"+s.comment.pid+">.highlight")),NKC.methods.scrollToDom($("#post_comment_"+s.comment.pid)),e[n].execCommand("cleardoc")}));else{var d=$("#post_comments_div_"+a.pid),p=$("#post_comment_"+a.pid);if(!d.length){if(!p.length)return;d=$("<div class='post-comments' id='post_comments_div_"+a.pid+"'></div>"),p.append(d)}d.append(m),screenTopAlert("评论成功"),o||c(n),NKC.methods.markDom($("#post_comment_"+s.comment.pid+">.highlight")),NKC.methods.scrollToDom($("#post_comment_"+s.comment.pid)),e[n].execCommand("cleardoc"),l()}delete i[n],$("button[data-comment-button='"+n+"']").removeAttr("disabled").text("提交")})).catch((function(t){sweetError(t),delete i[n],$("button[data-comment-button='"+n+"']").removeAttr("disabled").text("提交")}))}},comments:d,viewPostComments:r,createPageDom:p,hidePostComments:function(t,e){$(".show_comments_button_"+t).show(),$(".hide_comments_button_"+t).hide(),c(t,e),$('.single-post-comment[data-type="singlePostComment"][data-pid="'+t+'"]').hide(),$("#post_comments_"+t).hide()},initUserPanel:l})}));
