!function(t){"function"==typeof define&&define.amd?define(t):t()}((function(){"use strict";function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function e(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,o=new Array(e);n<e;n++)o[n]=t[n];return o}function n(t,n){var o="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!o){if(Array.isArray(t)||(o=function(t,n){if(t){if("string"==typeof t)return e(t,n);var o=Object.prototype.toString.call(t).slice(8,-1);return"Object"===o&&t.constructor&&(o=t.constructor.name),"Map"===o||"Set"===o?Array.from(t):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?e(t,n):void 0}}(t))||n&&t&&"number"==typeof t.length){o&&(t=o);var a=0,i=function(){};return{s:i,n:function(){return a>=t.length?{done:!0}:{done:!1,value:t[a++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,s=!0,d=!1;return{s:function(){o=o.call(t)},n:function(){var t=o.next();return s=t.done,t},e:function(t){d=!0,r=t},f:function(){try{s||null==o.return||o.return()}finally{if(d)throw r}}}}var o=new(function(){function e(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),this.editors={},this.tid=null,this.cWriteInfo=!0,this.postPermission={permit:!1,warning:null},this.sendAnonymousPost=!1}var o,a,i;return o=e,(a=[{key:"getPostHeightFloat",value:function(){var t=$('.hidden[data-type="hidePostContentSettings"]');if(!t.length)throw"未读取到与post内容隐藏相关的配置";return(t=NKC.methods.strToObj(t.html())).float}},{key:"getPostMaxHeight",value:function(){var t=$(document).width(),e=$('.hidden[data-type="hidePostContentSettings"]');if(!e.length)throw"未读取到与post内容隐藏相关的配置";return e=NKC.methods.strToObj(e.html()),t<768?e.xs:t<992?e.sm:e.md}},{key:"autoHidePostContent",value:function(){for(var t=$(".single-post-container"),e=0;e<t.length;e++){var n=t.eq(e),o=n.attr("data-hide"),a=n.attr("data-pid");if("not"!==o){var i=this.getPostMaxHeight();n.find(".single-post-center").height()>i&&this.hidePostContent(a)}}}},{key:"hidePostContent",value:function(t){var e=$('.single-post-container[data-pid="'.concat(t,'"]')),n=e.find(".single-post-center"),o=this.getPostHeightFloat(),a=this.getPostMaxHeight();n.css({"max-height":a*o+"px"});var i=e.find(".switch-hidden-status");i.find(".switch-hidden-status-button").html('<div class="fa fa-angle-down"><strong> 加载全文</strong></div>'),e.attr("data-hidden","true"),i.removeClass("hidden")}},{key:"showPostContent",value:function(t){var e=$('.single-post-container[data-pid="'.concat(t,'"]'));e.find(".single-post-center").css({"max-height":"none"});var n=e.find(".switch-hidden-status");n.find(".switch-hidden-status-button").html('<div class="fa fa-angle-up"> 收起</div>'),e.attr("data-hidden","false"),n.removeClass("hidden")}},{key:"switchPostContent",value:function(t){if("true"===$('.single-post-container[data-pid="'.concat(t,'"]')).attr("data-hidden")){var e=$(document).scrollTop();this.showPostContent(t),scrollTo(0,e)}else{var n=new NKC.modules.PagePosition;this.hidePostContent(t),n.restore()}}},{key:"getPostContainer",value:function(t){return $('.single-post-container[data-pid="'.concat(t,'"]'))}},{key:"getCommentContainer",value:function(t){return $('[data-type="singlePostCommentContainer"][data-pid="'.concat(t,'"]'))}},{key:"getSingleComment",value:function(t){return $('.single-comment[data-pid="'.concat(t,'"]'))}},{key:"getCommentButton",value:function(t){return $('[data-type="singlePostCommentButton"][data-pid="'.concat(t,'"]'))}},{key:"createCommentElements",value:function(t){var e=$('.single-comments[data-pid="'.concat(t,'"]'));return e.length||(e=$('<div class="single-comments" data-pid="'.concat(t,'"></div>'))),e}},{key:"getPages",value:function(t,e){var o=$('.single-comment-paging[data-pid="'.concat(t,'"]'));o.length||(o=$('<div class="single-comment-paging" data-pid="'.concat(t,'"></div>'))),o.html("");var a,i=n(e.buttonValue);try{for(i.s();!(a=i.n()).done;){var r=a.value,s=$('<span class="'.concat(r.type,'">..</span>'));"null"!==r.type&&(s.text(r.num+1),s.attr("onclick","NKC.methods.getPostCommentsByPage('".concat(t,"', ").concat(r.num,")"))),o.append(s)}}catch(t){i.e(t)}finally{i.f()}return o}},{key:"switchPostBackgroundColor",value:function(t,e){this.getPostContainer(t).attr("data-show-comments",e?"true":"false")}},{key:"showPostComment",value:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=o.highlightCommentId,i=void 0===a?null:a;this.removeAllEditorApp(t);var r=this,s=this.getCommentContainer(t);this.switchPostBackgroundColor(t,!0);var d=this.getCommentButton(t),c=s.find(".single-post-comment-loading"),m=s.find(".single-post-comment-error");c.length>0&&c.remove(),m.length>0&&m.remove();var u=$("<div class=\"single-post-comment-loading\"><div class='fa fa-spinner fa-spin'></div>加载中...</div>");"true"!==s.attr("data-opened")&&s.append(u),s.attr("data-hide","false"),d.attr("data-show-number","false"),this.renderPostCommentNumber(t),this.getPostComments(t,n).then((function(n){u.remove();var o=n.tid,a=n.htmlContent,d=n.paging,c=n.postPermission;d.page+1>=d.pageCount?s.attr("data-last-page","true"):s.attr("data-last-page","false"),r.postPermission=c,r.tid=o,r.sendAnonymousPost=n.sendAnonymousPost;var m=e.createCommentElements(t);m.html(a);var l=r.getPages(t,d);"true"!==s.attr("data-opened")&&(s.append(l),s.append(m),s.append(l.clone(!0)),s.attr("data-opened","true"));var h=r.getEditorApp(t,s,{cancelEvent:"switchPostComment",keepOpened:!0,position:"bottom"});if(e.cWriteInfo=n.cWriteInfo,n.cWriteInfo?s.append($('<div class="text-danger single-post-comment-error">'.concat(n.cWriteInfo,"</div>"))):(h.show=!0,h.container.show()),i){var p=$('.single-comment[data-pid="'.concat(i,'"]>.single-comment-center'));NKC.methods.scrollToDom(p),NKC.methods.markDom(p)}r.autoSaveDraft(t)})).then((function(){r.initNKCSource()})).catch((function(t){var e=$('<div class="single-post-comment-error text-danger">'.concat(t.error||t.message||t,"</div>"));s.html(e)}))}},{key:"initNKCSource",value:function(){floatUserPanel.initPanel(),NKC.methods.initSharePanel(),NKC.methods.initPostOption(),NKC.methods.initStickerViewer(),NKC.configs.isApp||NKC.methods.initImageViewer(),NKC.methods.initVideo()}},{key:"removeAllEditorApp",value:function(t){for(var e=this.getCommentContainer(t).find(".single-comment"),n=0;n<e.length;n++){var o=e.eq(n);this.removeEditorApp(o.attr("data-pid"))}this.removeEditorApp(t)}},{key:"hidePostComment",value:function(t){this.switchPostBackgroundColor(t,!1);var e=this.getCommentContainer(t),n=this.getCommentButton(t);e.attr("data-hide","true"),n.attr("data-show-number","true"),this.renderPostCommentNumber(t)}},{key:"renderPostCommentNumber",value:function(t){var e,n=this.getCommentButton(t),o=Number(n.attr("data-number"));"true"===n.attr("data-show-number")?(e="评论",o>0&&(e+="(".concat(o,")"))):e="折叠评论",n.text(e)}},{key:"setPostCommentNumber",value:function(t){var e=this.getCommentButton(t),n=Number(e.attr("data-number"));e.attr("data-number",n+1)}},{key:"switchPostComment",value:function(t,e,n){if("false"===this.getCommentContainer(t).attr("data-hide"))if(e){var o=new NKC.modules.PagePosition;this.hidePostComment(t),o.restore()}else this.hidePostComment(t);else this.showPostComment(t,n)}},{key:"getPostComments",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return nkcAPI("/p/".concat(t,"/comments?page=").concat(e),"GET")}},{key:"removeEditorApp",value:function(t){var e=this.getEditorAppData(t);e&&(clearTimeout(e.timeoutId),e.app&&e.app.destroy&&e.app.destroy(),e.container&&e.container.remove&&e.container.remove(),delete this.editors[t])}},{key:"getEditorAppData",value:function(t){return this.editors[t]}},{key:"getEditorApp",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};n.keepOpened=n.keepOpened||!1;var o=n.cancelEvent,a=void 0===o?"switchCommentForm":o,i=n.position,r=void 0===i?"top":i,s=this.editors[t];if(void 0===s){var d,c,m=e,u=$('<div class="single-comment-editor-container"></div>'),l=$('<div class="single-comment-warning"></div>');if(l.html(this.postPermission.warning),u.append(l),this.postPermission.permit){d=$('<div class="single-comment-editor" id="singlePostEditor_'.concat(t,'">'));var h=$('<div class="single-comment-prompt">200字以内，仅用于支线交流，主线讨论请采用回复功能。</div>'),p=$('<div class="single-comment-button" data-type="'.concat(t,'"></div>')),f="NKC.methods.".concat(a,'("').concat(t,'", true)');this.sendAnonymousPost&&p.append($('\n          <div class="checkbox">\n            <label>\n              <input type="checkbox" data-type="anonymous" /> 匿名发表\n            </label>\n          </div>\n        ')),p.append($('\n          <div class="checkbox">  \n            <label>\n              <input type="checkbox" checked="checked" data-type="protocol" onchange="NKC.methods.setProtocolStatus(\''.concat(t,'\')" /> 我已阅读并同意遵守与本次发表相关的全部协议。<a href="/protocol" target="_blank">查看协议</a>\n            </label>\n          </div>\n        '))),p.append($('<button class="btn btn-primary btn-sm" data-type="post-button" onclick="NKC.methods.postData(\''.concat(t,"')\">提交</button>"))).append($('<button class="btn btn-default btn-sm" onclick="NKC.methods.saveDraft(\''.concat(t,"')\">存草稿</button>"))).append($('<button class="btn btn-default btn-sm" onclick=\''.concat(f,"'>取消</button>"))),u.append(h).append(d).append(p)}"top"===r?m.prepend(u):m.append(u),d&&(c=UE.getEditor(d.attr("id"),NKC.configs.ueditor.commentConfigs)),u.hide(),this.editors[t]={app:c,draftId:null,options:n,container:u,pid:t,show:!1,timeoutId:null,prevDraft:""}}return this.editors[t]}},{key:"switchCommentForm",value:function(t){if(!NKC.configs.uid)return NKC.methods.toLogin();var e=this.getSingleComment(t);if(e.find(".single-post-comment-error").remove(),this.cWriteInfo)return e.append($('<div class="single-post-comment-error text-danger">'.concat(this.cWriteInfo,"</div>")));var n=e.children(".single-comment-bottom"),o=this.getEditorApp(t,n);if(o.show){if(o.options.keepOpened)return;o.show=!1,o.container.hide(),clearTimeout(o.timeoutId),this.removeEditorApp(t)}else o.show=!0,o.container.show(),this.autoSaveDraft(t)}},{key:"getEditorContent",value:function(t){return this.getEditorApp(t).app.getContent()}},{key:"clearEditorContent",value:function(t){this.getEditorApp(t).app.setContent("")}},{key:"changeEditorButtonStatus",value:function(t,e){var n=this.getEditorApp(t).container.find("[data-type=post-button]");n.attr("disabled",e),e?n.html('<div class="fa fa-spinner fa-spin"></div> 提交中...'):n.html("提交")}},{key:"postData",value:function(t){var e=this.getEditorContent(t),n=this;return Promise.resolve().then((function(){if(!e)throw"评论内容不能为空";var o=$('.single-comment-button[data-type="'.concat(t,'"]')).find('input[data-type="anonymous"]').prop("checked");return n.changeEditorButtonStatus(t,!0),nkcAPI("/t/"+n.tid,"POST",{postType:"comment",post:{c:e,l:"html",anonymous:o,parentPostId:t}})})).then((function(e){screenTopAlert("发表成功");var o=e.renderedPost;n.clearEditorContent(t),n.changeEditorButtonStatus(t,!1),n.switchCommentForm(t),o&&n.insertComment(o.parentCommentId,o.parentPostId,o.html)})).catch((function(e){sweetError(e),n.changeEditorButtonStatus(t,!1)}))}},{key:"saveDraftData",value:function(t){var e=this.getEditorApp(t);e.prevDraft;var n=this.getEditorContent(t);e.prevDraft=n;var o=this;return Promise.resolve().then((function(){if(n)return nkcAPI("/u/".concat(NKC.configs.uid,"/drafts"),"POST",{post:{c:n,l:"html"},draftId:e.draftId,desType:"thread",desTypeId:o.tid})})).then((function(t){return t?(e.draftId=t.draft.did,{saved:!0}):{saved:!1,error:"草稿内容不能为空"}}))}},{key:"saveDraft",value:function(t){this.saveDraftData(t).then((function(t){var e=t.saved,n=t.error;e?sweetSuccess("草稿已保存"):sweetError(n)})).catch(sweetError)}},{key:"autoSaveDraft",value:function(t){var e=this,n=e.getEditorApp(t);n&&n.show&&(clearTimeout(n.timeoutId),n.timeoutId=setTimeout((function(){e.saveDraftData(t).then((function(){e.autoSaveDraft(t)})).catch((function(n){screenTopWarning(n),e.autoSaveDraft(t)}))}),1e4))}},{key:"insertComment",value:function(t,e,n){var o=this.getCommentContainer(t);if(o.length){if("false"===o.attr("data-last-page"))return;o.children('.single-comments[data-pid="'.concat(t,'"]')).children('.single-comments[data-pid="'.concat(t,'"]')).append($(n))}else this.getSingleComment(t).children(".single-comment-bottom").children('.single-comments[data-pid="'.concat(t,'"]')).append($(n));this.setPostCommentNumber(e,1),this.renderPostCommentNumber(e),this.initNKCSource()}},{key:"setProtocolStatus",value:function(t){var e=$('.single-comment-button[data-type="'.concat(t,'"]')),n=e.find('input[data-type="protocol"]'),o=e.find('button[data-type="post-button"]');n.prop("checked")?o.removeAttr("disabled"):o.attr("disabled","disabled")}}])&&t(o.prototype,a),i&&t(o,i),e}());NKC.methods.autoHidePostContent=function(){o.autoHidePostContent()},NKC.methods.switchPostContent=function(t){o.switchPostContent(t)},NKC.methods.switchPostComment=function(t,e,n){o.switchPostComment(t,e,n)},NKC.methods.switchCommentForm=function(t){o.switchCommentForm(t)},NKC.methods.postData=function(t){o.postData(t)},NKC.methods.saveDraft=function(t){o.saveDraft(t)},NKC.methods.getPostCommentsByPage=function(t,e){o.showPostComment(t,e)},NKC.methods.showPostComment=function(t,e,n){o.showPostComment(t,e,n)},NKC.methods.insertComment=function(t,e,n){o.insertComment(t,e,n)},NKC.methods.setProtocolStatus=function(t){o.setProtocolStatus(t)}}));
