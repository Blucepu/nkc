!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";var e,i=[];NKC.modules.Login=function(){window.verifications||(window.verifications=new NKC.modules.Verifications);var t=this;t.dom=$("#moduleLogin"),t.dom.modal({show:!1,backdrop:"static"}),t.app=new Vue({el:"#moduleLoginApp",data:{nationCodes:nationCodes,type:"login",registerStep:1,category:"username",username:"",password:"",repeatPassword:"",nationCode:"86",code:"",mobile:"",waiting:0,svgData:"",error:"",info:"",submitting:!1,succeed:!1},methods:{changeStep:function(e){if(1===e)return this.registerStep=e;var i=this,t=this.throwError;return Promise.resolve().then((function(){var e=i.username,t=i.password,n=i.repeatPassword;if(!e)throw"请输入用户名";if(!t)throw"请输入密码";if(!n)throw"请输入密码";if(t!==n)throw"两次输入的密码不相同";return nkcAPI("/register/check","POST",{username:e,password:t})})).then((function(){i.registerStep=e})).catch((function(e){t(e.error||e.message||e)}))},selectCategory:function(e){this.category=e,this.throwError("")},selectType:function(e){this.type=e},throwError:function(e){this.error=e.error||e.message||e},submit:function(){var e=this.throwError;e("");var i=this,t=this.type,n=this.category,o={},r=this.username,s=this.password,a=this.mobile,c=this.nationCode,u=this.code;if("login"===t){if("username"===n){if(!r)return e("请输入用户名");if(!s)return e("请输入密码");o={username:r,password:s}}else if("mobile"===n){if(!c)return e("请选择国际区号");if(!a)return e("请输入手机号");if(!s)return e("请输入密码");o={nationCode:c,mobile:a,password:s,loginType:"mobile"}}else{if(!c)return e("请选择国际区号");if(!a)return e("请输入手机号");if(!u)return e("请输入短信验证码");o={loginType:"code",nationCode:c,mobile:a,code:u}}this.submitting=!0,nkcAPI("/login","POST",o).then((function(){i.succeed=!0,NKC.configs.isApp?NKC.methods.rn.emit("login"):window.location.reload()})).catch((function(t){e(t),i.submitting=!1}))}else{if(!r)return e("请输入用户名");if(!s)return e("请输入密码");if(!c)return e("请选择国际区号");if(!a)return e("请输入手机号");if(!u)return e("请输入短信验证码");this.submitting=!0,nkcAPI("/register","POST",{nationCode:c,mobile:a,code:u,username:r,password:s}).then((function(){i.succeed=!0,NKC.configs.isApp?NKC.methods.rn.emit("login"):window.location.href="/register/subscribe"})).catch((function(t){e(t),i.submitting=!1}))}},sendMobileCode:function(i){var t=this.throwError;t("");var n=this,o=this.nationCode,r=this.mobile;if(!o)return t("请选择国际区号");if(!r)return t("请输入手机号码");var s,a={nationCode:o,mobile:r};s="register"===i?"/sendMessage/register":"/sendMessage/login",verifications.open().then((function(e){return a.verifySecret=e.secret,nkcAPI(s,"POST",a)})).then((function(){clearTimeout(e),n.waiting=120,e=setInterval((function(){0!==n.waiting?n.waiting--:clearTimeout(e)}),1e3)})).catch((function(e){t(e)}))},getSvgData:function(){var e=this;nkcAPI("/register/code?t="+Date.now(),"GET").then((function(i){e.svgData=i.svgData})).catch((function(e){sweetError(e)}))},close:function(){i.length=0,NKC.configs.isApp?NKC.methods.rn.emit("closeWebView"):t.dom.modal("hide")},open:function(e){t.dom.modal("show"),t.app.type=e||"login",t.app.getSvgData()}}}),t.open=t.app.open,t.close=t.app.close};var t=new NKC.modules.Login;window.Login=t}));
