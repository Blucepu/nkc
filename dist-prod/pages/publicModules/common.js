!function(t){"function"==typeof define&&define.amd?define(t):t()}((function(){"use strict";var t={methods:{},modules:{},configs:{imageExt:["jpg","jpeg","png","svg","gif","webp"],audioExt:["mp3"],videoExt:["mp4"]},events:{},eventsLog:{},on:function(e,o){t.events[e]||(t.events[e]=[]),t.events[e].push(o)},remove:function(e,o){for(var n=t.events[e]||[],r=0;r<n.length;r++){if(o===n[r])return n.splice(r,1)}},one:function(e,o){t.on(e,(function e(n,r){o(n,r),t.remove(e)}))},oneAfter:function(e,o){if(t.eventsLog[e])return o(void 0,(function(){}));t.one(e,o)},emit:function(e,o){t.eventsLog[e]=!0;!function t(e,n){n>=e.length||(0,e[n])(o,(function(){t(e,n+1)}))}((t.events[e]||[]).concat([]),0)}};t.methods.getLoginStatus=function(){return t.configs.isApp?"apiCloud"===t.configs.platform?!!appGetFromLocal("user"):"reactNative"===t.configs.platform?!!t.configs.uid:void 0:!!t.configs.uid},t.methods.getRunType=function(){return t.configs.isApp?"app":"web"},t.methods.visitUrl=function(e,o){if(!o)return window.location.href=e;t.configs.isApp?"apiCloud"===t.configs.platform?t.methods.openOnlinePage(e):(0!==e.indexOf("http")&&(e=location.origin+e),t.methods.rn.emit("openNewPage",{href:e})):window.open(e)},t.methods.visitUrlAndClose=function(e){t.methods.rn.emit("openNewPageAndClose",{href:location.origin+e})},t.methods.openOnlinePage=function(t){t=t.replace(/\/f\/([0-9]+)[?#]?.*/gi,(function(t,e){return"/f/"+e+"/latest"})),emitEvent("openOnlinePage",{url:t})},t.methods.getDayCountByYearMonth=function(t,e){return t=parseInt(t),2===(e=parseInt(e))?t%4==0&&t%100!=0||t%400==0?29:28:-1!==[4,6,9,11].indexOf(e)?30:31},t.methods.base64ToBlob=function(t){for(var e=t.split(","),o=e[0].match(/:(.*?);/)[1],n=atob(e[1]),r=n.length,i=new Uint8Array(r);r--;)i[r]=n.charCodeAt(r);return new Blob([i],{type:o})},t.methods.blobToFile=function(t,e){return t.lastModifiedDate=new Date,t.name=e||Date.now()+".png",t},t.methods.base64ToFile=function(e,o){return t.methods.blobToFile(t.methods.base64ToBlob(e),o)},t.methods.fileToUrl=function(t){return new Promise((function(e,o){var n=new FileReader;n.readAsDataURL(t),n.onload=function(t){e(this.result)}}))},t.methods.strToObj=function(t){return JSON.parse(decodeURIComponent(t))},t.methods.getDataById=function(e){var o=document.getElementById(e);return o?t.methods.strToObj(o.innerHTML):{}},t.methods.scrollToDom=function(t){if(t.length){var e=t.offset().top;setTimeout((function(){$("html,body").animate({scrollTop:e-300},500)}))}},t.methods.markDom=function(t){if(t.length){t.css("background-color","rgba(255, 251, 221, 1)");var e=2,o=setInterval((function(){(e-=.1)<0&&clearInterval(o),t.css("background-color","rgba(255, 251, 221, "+(e<1?e:1)+")")}),1e3)}},t.methods.strToBase64=function(t){return window.btoa(encodeURIComponent(t))},t.methods.base64ToStr=function(t){return decodeURIComponent(window.atob(t))},t.methods.logout=function(){var e=window.location.href;nkcAPI("/logout?t="+Date.now(),"GET").then((function(){return nkcAPI(e,"GET")})).then((function(){"reactNative"===t.configs.platform&&t.methods.rn.emit("logout"),window.location.reload()})).catch((function(t){window.location.href="/"}))},t.methods.ipUrl=function(t){return"http://www.ip138.com/ips138.asp?ip="+t+"&action=2"},t.methods.getSize=function(e,o){return t.methods.tools.getSize(e,o)},t.methods.getRandomColor=function(){for(var t="#",e=0;e<6;e++){var o=Math.round(15*Math.random());t+="0123456789abcdef".slice(o,o+1)}return t},t.methods.appResourceToHtml=function(e){return nkcAPI("/r/"+e.rid+"?d=object","GET").then((function(o){var n,r=(e=o.resource).mediaType;return n="mediaPicture"===r?"picture":"mediaVideo"===r?"video":"mediaAudio"===r?"audio":"attachment",t.methods.resourceToHtml(n,e.rid,e.oname)})).catch(sweetError)},t.methods.resourceToHtml=function(t,e,o){var n={picture:function(){return"<img data-tag='nkcsource' data-type='picture' data-id='"+e+"' src=\"/r/"+e+'">'},sticker:function(){return"<img data-tag='nkcsource' data-type='sticker' data-id='"+e+"' src=\"/sticker/"+e+'">'},video:function(){return'<p><br></p><p><video data-tag="nkcsource" data-type="video" data-id="'+e+'" src="/r/'+e+'" controls></video>'+decodeURI("%E2%80%8E")+"</p>"},audio:function(){return'<p><br></p><p><audio data-tag="nkcsource" data-type="audio" data-id="'+e+'" src="/r/'+e+'" controls></audio>'+decodeURI("%E2%80%8E")+"</p>"},attachment:function(){return'<p><a data-tag="nkcsource" data-type="attachment" data-id="'+e+'" href="/r/'+e+'" target="_blank" contenteditable="false">'+o+"</a>&#8203;</p>"},pre:function(){},xsf:function(){return'<p><br></p><section data-tag="nkcsource" data-type="xsf" data-id="'+e+'" data-message="浏览这段内容需要'+e+'学术分(双击修改)"><p>&#8203;<br></p></section>'},twemoji:function(t){function e(){return t.apply(this,arguments)}return e.toString=function(){return t.toString()},e}((function(){var t=twemoji.convert.fromCodePoint(e);return"<img data-tag='nkcsource' data-type='twemoji' data-id='"+e+"' data-char='"+t+"' src=\"/twemoji/2/svg/"+e+'.svg">'})),formula:function(){}}[t];return n?n():""},t.methods.toLogin=function(e){t.configs.isApp?"apiCloud"===t.configs.platform?emitEvent("openLoginPage",{type:e}):"reactNative"===t.configs.platform&&t.methods.rn.emit("openLoginPage",{type:e}):Login.open("register"===e?"register":"login")},t.methods.scrollTop=function(t,e){t?void 0===t.scrollTo?(t=$(t)).scrollTop(e):t.scrollTo(0,e):window.scrollTo(0,e)},t.methods.saveToLocalStorage=function(t,e){window.localStorage.setItem(t,JSON.stringify(e))},t.methods.getFromLocalStorage=function(t){var e=window.localStorage.getItem(t);return e?JSON.parse(e):{}},t.methods.doExchange=function(e){var o=e.length;if(o>=2){for(var n=e[0].length,r=e[1].length,i=new Array(n*r),a=0,c=0;c<n;c++)for(var s=0;s<r;s++)e[0][c]instanceof Array?i[a]=e[0][c].concat(e[1][s]):i[a]=[e[0][c]].concat(e[1][s]),a++;var d=new Array(o-1);for(c=2;c<e.length;c++)d[c-1]=e[c];return d[0]=i,t.methods.doExchange(d)}return 1===o?e[0]:e},t.methods.disabledPosts=function(e){var o=e;"string"==typeof e&&(o=[e]),e&&o.length&&(window.DisabledPost||(window.DisabledPost=new t.modules.DisabledPost),window.DisabledPost.open((function(t){var e,n={postsId:o,reason:t.reason,remindUser:t.remindUser,violation:t.violation};e="toDraft"===t.type?"/threads/draft":"/threads/recycle",nkcAPI(e,"POST",n).then((function(){screenTopAlert("操作成功"),DisabledPost.close(),DisabledPost.unlock()})).catch((function(t){sweetError(t),DisabledPost.unlock()}))})))},t.modules.PagePosition=function(){var t=this;t.fromTheBottom=$(document).height()-$(document).scrollTop(),t.restore=function(){setTimeout((function(){var e=$(document).height()-t.fromTheBottom;window.scrollTo(0,e)}),100)}},t.methods.sendMobileCode=function(t){return nkcAPI("/sendMessage/"+t,"POST")},t.methods.sendEmailCode=function(e){return nkcAPI("/u/"+t.configs.uid+"/settings/email","POST",{operation:e})},t.methods.getIpInfo=function(t){return nkcAPI("/ipinfo?ip="+t,"GET").then((function(t){return t.ipInfo})).then((function(t){return t?asyncSweetCustom("<p style='font-weight: normal;'>ip: "+t.ip+"<br>位置: "+t.location+"</p>"):sweetError("获取ip信息失败")})).catch(sweetError)},t.methods.replaceTwemoji=function(t){var e=document.createElement("div");return e.innerHTML=t,$(e).find("[data-tag='nkcsource'][data-type='twemoji']").each((function(t,e){$(e).replaceWith(e.dataset.char)})),e.innerHTML},t.methods.replaceEmojiChar=function(t){return twemoji.replace(t,(function(t){var e=twemoji.convert.toCodePoint(t);return"<img data-tag='nkcsource' data-type='twemoji' data-id='"+e+"' data-char='"+t+"' src=\"/twemoji/2/svg/"+e+'.svg">'}))},t.methods.addXsfDataMessage=function(t){var e=document.createElement("div");return e.innerHTML=t,$(e).find("[data-tag='nkcsource'][data-type='xsf']").each((function(t,e){var o=$(e).attr("data-id");$(e).attr("data-message","浏览这段内容需要"+o+"学术分(双击修改)")})),e.innerHTML},t.methods.ueditor={getContent:function(e){return e=t.methods.replaceTwemoji(e)},setContent:function(e){return e=t.methods.replaceEmojiChar(e),e=t.methods.addXsfDataMessage(e)},insertContent:function(t){return(t=$("<div>"+t+"</div>")).find("span.nkc-hl").css({"background-color":"","border-bottom":""}).removeClass("nkc-hl"),t=t.html()}},t.methods.toChat=function(e,o,n){"reactNative"===t.configs.platform?t.methods.rn.emit("toChat",{uid:e,name:o,type:n||"UTU"}):t.methods.visitUrl("/message?uid="+e,!0)},t.methods.appToast=function(e){var o=e.message||e.error||e;"reactNative"===t.configs.platform?t.methods.rn.emit("toast",{content:o}):screenTopAlert(o)},t.methods.appReloadPage=function(){"reactNative"===t.configs.platform?t.methods.rn.emit("reloadWebView"):window.location.reload()},t.methods.appSelectLocation=function(){if("reactNative"===t.configs.platform)return new Promise((function(e,o){t.methods.rn.emit("selectLocation",{},(function(t){e(t)}))}))},t.methods.appClosePage=function(){"reactNative"===t.configs.platform&&t.methods.rn.emit("closeWebView")},t.methods.addUserToBlacklist=function(t,e,o){var n=!1,r=!1;return Promise.resolve().then((function(){return nkcAPI("/blacklist?tUid="+t,"GET")})).then((function(t){var e;if(n=t.isFriend,r=t.subscribed,t.bl)throw"对方已在黑名单中";if(n?e="该会员在你的好友列表中，确定放入黑名单吗？":r&&(e="该会员在你的关注列表中，确定放入黑名单吗？"),e)return sweetQuestion(e)})).then((function(){if(n)return nkcAPI("/friend/"+t,"DELETE",{})})).then((function(){if(r)return SubscribeTypes.subscribeUserPromise(t,!1)})).then((function(){return nkcAPI("/blacklist","POST",{tUid:t,from:e,pid:o})})).then((function(t){return sweetSuccess("操作成功"),t})).catch(sweetError)},t.methods.removeUserFromBlacklist=function(t){return Promise.resolve().then((function(){return nkcAPI("/blacklist?tUid="+t,"GET")})).then((function(e){if(!e.bl)throw"对方未在黑名单中";return nkcAPI("/blacklist?tUid="+t,"DELETE")})).then((function(t){return sweetSuccess("操作成功"),t})).catch(sweetError)},t.methods.isPhone=function(){return/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)},t.methods.search=function(t){var e=$("#"+t);if(e.length){var o=e.val();window.open("/search?c="+encodeURI(o))}},t.methods.showNotification=function(t,e,o){if("Notification"in window){var n=$(document.head).find("[rel='shortcut icon']").attr("href");return"granted"!==Notification.permission?Notification.requestPermission().then((function(t){return new Promise((function(e,o){if("granted"===t)return r();o("用户拒绝通知")}))})):r()}function r(){return new Promise((function(r,i){var a=new Notification(t,{body:e,icon:n});a.onclick=function(){r({action:"click"})},a.onclose=function(){r({action:"close"})},setTimeout((function(){a.close()}),o||1e4)}))}},t.methods.getLocalStorageKey=function(e){return{forumThreadList:"forumThreadList_"+(t.configs.uid||"visitor")}[e]},t.methods.getObjectDataFromLocalStorage=function(t){var e=localStorage.getItem(t);return"string"==typeof(e=null===e?{}:JSON.parse(e))&&(e={}),e},t.methods.setObjectDataToLocalStorage=function(t,e){localStorage.setItem(t,JSON.stringify(e))},t.methods.getThreadListNewPostCount=function(e){var o=t.methods.getLocalStorageKey("forumThreadList");return t.methods.getObjectDataFromLocalStorage(o)[e]||0},t.methods.setThreadListNewPostCount=function(e,o){var n=t.methods.getLocalStorageKey("forumThreadList"),r=t.methods.getObjectDataFromLocalStorage(n);r[e]=o,t.methods.setObjectDataToLocalStorage(n,r)},t.methods.removeLocalStorageByKey=function(e){e=t.methods.getLocalStorageKey(e),localStorage.removeItem(e)},t.methods.isMobilePhoneBrowser=function(){return/(iPhone|iPad|iPod|iOS|Android)/i.test(window.navigator.userAgent)},t.methods.isPcBrowser=function(){return!t.methods.isMobilePhoneBrowser()},window.NKC=t}));
