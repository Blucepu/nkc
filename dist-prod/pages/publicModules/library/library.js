!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";function e(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,i=new Array(t);o<t;o++)i[o]=e[o];return i}function t(t,o){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=function(t,o){if(t){if("string"==typeof t)return e(t,o);var i=Object.prototype.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?e(t,o):void 0}}(t))||o&&t&&"number"==typeof t.length){i&&(t=i);var r=0,n=function(){};return{s:n,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,l=!0,s=!1;return{s:function(){i=i.call(t)},n:function(){var e=i.next();return l=e.done,e},e:function(e){s=!0,a=e},f:function(){try{l||null==i.return||i.return()}finally{if(s)throw a}}}}NKC.modules.Library=function(){return function e(o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);var i=o.lid,r=o.folderId,n=o.tLid,a=o.uploadResourcesId,l=this;l.app=new Vue({el:"#moduleLibrary",data:{uid:NKC.configs.uid,uploadResourcesId:a,pageType:"list",nav:[],folders:[],files:[],lid:i,tLid:n,sort:"time",histories:[],index:0,selectedFiles:[],mark:!1,selectedLibrariesId:[],permission:[],lastHistoryLid:"",selectedCategory:"book",selectedFolder:"",selectedFolderPath:"",listCategories:["book","paper","program","media","other"],categories:[{id:"book",name:"图书"},{id:"paper",name:"论文"},{id:"program",name:"程序"},{id:"media",name:"媒体"},{id:"other",name:"其他"}],protocol:!0},watch:{listCategories:function(){this.saveCategoriesToLocalStorage()}},mounted:function(){r&&this.saveToLocalStorage(r),this.getCategoriesFromLocalStorage();var e=NKC.methods.getFromLocalStorage("libraryVisitFolderLogs")[this.lid],t=this;void 0!==e&&e!==this.lid?this.getList(e).then((function(){t.addHistory(t.lid),t.addFileByRid()})).catch((function(e){t.getListInfo(t.lid)})):this.getListInfo(t.lid),window.CommonModal||(NKC.modules.CommonModal?window.CommonModal=new NKC.modules.CommonModal:sweetError("未引入通用弹框")),window.ResourceInfo||(NKC.modules.ResourceInfo?window.ResourceInfo=new NKC.modules.ResourceInfo:sweetError("未引入资源信息模块")),window.SelectResource||(NKC.modules.SelectResource?window.SelectResource=new NKC.modules.SelectResource:sweetError("未引入资源信息模块")),window.LibraryPath||(NKC.modules.LibraryPath?window.LibraryPath=new NKC.modules.LibraryPath:sweetError("未引入文库路径选择模块")),window.onpopstate=this.onpopstate},computed:{uploading:function(){var e,o=t(this.selectedFiles);try{for(o.s();!(e=o.n()).done;){if("uploading"===e.value.status)return!0}}catch(e){o.e(e)}finally{o.f()}},lastFolder:function(){var e=this.nav.length;if(e>1)return this.nav[e-2]},folder:function(){var e=this.nav.length;return 0!==e?this.nav[e-1]:{}},folderList:function(){var e=this.listCategories,t=this.files,o=this.folders,i=this.uid,r=t;return e.includes("own")&&i&&(r=t.filter((function(e){return e.uid===i}))),r=r.filter((function(t){return e.includes(t.category)})),o.concat(r)},uploadedCount:function(){var e=0;return this.selectedFiles.map((function(t){"uploaded"===t.status&&e++})),e},unUploadedCount:function(){var e=0;return this.selectedFiles.map((function(t){"notUploaded"===t.status&&e++})),e}},methods:{getUrl:NKC.methods.tools.getUrl,visitUrl:NKC.methods.visitUrl,format:NKC.methods.format,getSize:NKC.methods.tools.getSize,checkString:NKC.methods.checkData.checkString,scrollTo:NKC.methods.scrollTop,addFileByRid:function(){var e=this.uploadResourcesId;if(e&&!(e.length<=0)){var t=e.join("-");nkcAPI("/rs?rid=".concat(t),"GET").then((function(e){e.resources.map((function(e){l.app.selectedFiles.push(l.app.createFile("onlineFile",e))})),l.app.pageType="uploader",l.app.uploadResourcesId=[]})).catch(sweetError)}},clearUnUploaded:function(){this.selectedFiles=this.selectedFiles.filter((function(e){return"notUploaded"!==e.status}))},selectFilesFolder:function(){var e=this;LibraryPath.open((function(t){var o=t.folder,i=t.path;e.selectedFolder=o,e.selectedFolderPath=i}),{lid:this.lid,warning:"该操作将覆盖本页所有设置，请谨慎操作。"})},clearUploaded:function(){this.selectedFiles=this.selectedFiles.filter((function(e){return"uploaded"!==e.status}))},markCategory:function(){var e=this.selectedCategory,t=this.selectedFiles;e&&sweetQuestion("该操作将覆盖本页所有设置，请再次确认。").then((function(){t.map((function(t){return t.category=e}))})).catch((function(e){}))},markFolder:function(){var e=this.selectedFolder,t=this.selectedFolderPath,o=this.selectedFiles;if(e){var i=this;sweetQuestion("该操作将覆盖本页所有设置，请再次确认。").then((function(){o.map((function(o){o.folder=e,o.folderPath=t})),i.selectedFolder="",i.selectedFolderPath=""})).catch((function(e){}))}},onpopstate:function(e){var t=e.state,o=this.lid;t&&t.lid&&(o=t.lid),this.getList(o).catch((function(e){sweetError(e)}))},getListInfo:function(e,t){this.getList(e,t).then((function(){l.app.addHistory(e),l.app.addFileByRid()})).catch((function(e){sweetError(e)}))},per:function(e){return this.permission.includes(e)},markLibrary:function(){this.mark=!this.mark,this.selectedLibrariesId=[]},markAll:function(){this.selectedLibrariesId.length===this.folderList.length?this.selectedLibrariesId=[]:this.selectedLibrariesId=this.folderList.map((function(e){return e._id}))},deleteFolders:function(){this.deleteFolder(this.selectedLibrariesId)},moveFolders:function(){this.moveFolder(this.selectedLibrariesId)},selectPath:function(e){LibraryPath.open((function(t){var o=t.folder,i=t.path;e.folder=o,e.folderPath=i}),{lid:e.folder?e.folder._id:""})},createFile:function(e,t){var o=t.folder,i=t.folderPath,r=t._id,n=t.toc,a=t.rid,s=t.category,d=t.name,c=void 0===d?"":d,u=t.oname,f=t.description,p=void 0===f?"":f,h={_id:r,type:e,rid:a,name:c||u,size:t.size,category:s||"",description:p,folder:o||this.folder,folderPath:i||"/"+l.app.nav.map((function(e){return e.name})).join("/"),data:t,toc:n||new Date,status:"notUploaded",disabled:!1,progress:0,error:""};return h.name=h.name.replace(/\..*?$/gi,""),"localFile"===h.type&&(t.type.includes("image")?h.ext="mediaPicture":h.ext="mediaAttachment"),"mediaPicture"===h.ext?(h.error="暂不允许上传图片到文库",h.disabled=!0):h.size>209715200&&(h.error="文件大小不能超过200MB",h.disabled=!0),h},startUpload:function(){this.uploadFile(0,this.selectedFiles)},removeFile:function(e){this.selectedFiles.splice(e,1)},uploadFile:function(e,t){if(!(e>=t.length)){var o=t[e],i=o.status;if(o.disabled||"notUploaded"!==i)return this.uploadFile(e+1,t);o.error="",o.status="uploading",Promise.resolve().then((function(){if(!o)throw"文件异常";if(l.app.checkString(o.name,{minLength:1,maxLength:500,name:"文件名称"}),l.app.checkString(o.description,{minLength:0,maxLength:1e3,name:"文件说明"}),!["media","paper","book","program","other"].includes(o.category))throw"未选择文件分类";if(!o.folder)throw"未选择目录";if("localFile"===o.type)return NKC.methods.getFileMD5(o.data)})).then((function(e){if("localFile"===o.type){var t=new FormData;return t.append("fileName",o.data.name),t.append("type","checkMD5"),t.append("md5",e),nkcUploadFile("/r","POST",t)}})).then((function(e){if(e&&!e.uploaded&&"localFile"===o.type){var t=new FormData;return t.append("file",o.data),nkcUploadFile("/r","POST",t,(function(e,t){o.progress=t}))}return e})).then((function(e){if("localFile"===o.type){var t=e.r;if(o.data=t,o.ext=t.mediaType,o.rid=t.rid,o.toc=t.toc,o.type="onlineFile","mediaPicture"===o.ext)throw o.disabled=!0,new Error("暂不允许上传图片到文库")}})).then((function(){if("modify"===o.type){var e=o._id,t={name:o.name,description:o.description,category:o.category};return nkcAPI("/library/".concat(e),"PUT",t)}var i=o.name,r=o.description,n=o.category,a=o.rid,l=o.folder,s={rid:a,name:i,description:r,category:n};return(new FormData).append("body",JSON.stringify(s)),nkcAPI("/library/".concat(l._id),"POST",s)})).then((function(){o.status="uploaded"})).catch((function(e){o.error=e.error||e.message||e,o.status="notUploaded"})).finally((function(){l.app.uploadFile(e+1,t)}))}},back:function(){this.lastFolder&&this.selectFolder(this.lastFolder)},toUpload:function(){this.mark||(this.pageType="uploader")},toList:function(){this.selectFolder(this.folder),this.pageType="list"},saveCategoriesToLocalStorage:function(){var e=this.listCategories,t=NKC.methods.getFromLocalStorage("libraryListCategories");t[this.lid]=e,NKC.methods.saveToLocalStorage("libraryListCategories",t)},getCategoriesFromLocalStorage:function(){var e=NKC.methods.getFromLocalStorage("libraryListCategories")[this.lid];e&&(this.listCategories=e)},saveToLocalStorage:function(e){var t=NKC.methods.getFromLocalStorage("libraryVisitFolderLogs");t[this.lid]=e,NKC.methods.saveToLocalStorage("libraryVisitFolderLogs",t)},addHistory:function(e){if(!this.lastHistoryLid||this.lastHistoryLid!==e){var t=window.location.href;t.includes("#")&&(t=t.replace(/#.*/gi,"")),window.history.pushState({lid:e},"page",t+"#"+e),this.lastHistoryLid=e}},getList:function(e,t){var o="/library/".concat(e,"?file=true&nav=true&folder=true&permission=true&t=").concat(Date.now());return nkcAPI(o,"GET").then((function(o){l.app.nav=o.nav,l.app.folders=o.folders,l.app.files=o.files,l.app.permission=o.permission,l.app.saveToLocalStorage(e),t&&l.app.scrollTo(null,0)}))},selectOnlineFiles:function(){SelectResource.open((function(e){e.resources.map((function(e){l.app.selectedFiles.push(l.app.createFile("onlineFile",e))}))}),{allowedExt:["attachment","video","audio"],countLimit:99})},selectedLocalFiles:function(){var e,o=document.getElementById("moduleLibraryInput").files,i=t(void 0===o?[]:o);try{for(i.s();!(e=i.n()).done;){var r=e.value;this.selectedFiles.push(this.createFile("localFile",r))}}catch(e){i.e(e)}finally{i.f()}document.getElementById("moduleLibraryInput").value=""},selectFolder:function(e,t){this.mark||("folder"===e.type?this.getListInfo(e._id,t):this.selectFile(e))},selectNavFolder:function(e){"list"!==this.pageType&&(this.pageType="list"),this.selectFolder(e)},moveFolder:function(e){var t;t=Array.isArray(e)?e:[e];var o={};o.foldersId=t;var i="/library/".concat(this.folder._id,"/list");LibraryPath.open((function(e){o.targetFolderId=e.folder._id,nkcAPI(i,"PUT",o).then((function(e){sweetSuccess("执行成功".concat(e.ignoreCount?"，共有".concat(e.ignoreCount,"个项目因存在冲突或不是你自己发布的而被忽略"):"")),l.app.mark=!1,l.app.selectFolder(l.app.folder)})).catch((function(e){sweetError(e)}))}),{lid:l.app.folder._id,warning:"此操作不会保留原有目录结构，且不可恢复。"})},editFolder:function(e){if(!this.mark){var t="文件夹",o=[{dom:"input",type:"text",label:"".concat(t,"名称"),value:e.name},{dom:"textarea",label:"".concat(t,"简介"),value:e.description}];"file"===e.type&&(t="文件",o.push({dom:"radio",label:"文件分类",radios:[{name:"图书",value:"book"},{name:"论文",value:"paper"},{name:"程序",value:"program"},{name:"媒体",value:"media"},{name:"其他",value:"other"}],value:e.category})),CommonModal.open((function(t){var o=t[0].value,i=t[1].value,r="";if("file"===e.type&&(r=t[2].value),!o)return sweetError("名称不能为空");nkcAPI("/library/"+e._id,"PUT",{name:o,description:i,category:r}).then((function(){l.app.selectFolder(l.app.folder),window.CommonModal.close()})).catch((function(e){sweetError(e)}))}),{title:"编辑".concat(t),data:o})}},deleteFolder:function(e){Array.isArray(e)||(e=[e]),e.length&&(e=e.join("-"),sweetQuestion("确定要执行删除操作？").then((function(){nkcAPI("/library/".concat(l.app.folder._id,"/list?lid=").concat(e),"DELETE").then((function(e){l.app.mark=!1,l.app.selectFolder(l.app.folder),sweetSuccess("执行成功".concat(e.ignoreCount?"，共有".concat(e.ignoreCount,"个项目因不是你自己发布的而被忽略"):""))})).catch((function(e){sweetError(e)}))})).catch((function(){})))},selectFile:function(e){ResourceInfo.open({lid:e._id})},createFolder:function(){this.mark||window.CommonModal.open((function(e){var t=e[0].value,o=e[1].value;if(!t)return sweetError("名称不能为空");nkcAPI("/library/"+l.app.folder._id+"/list","POST",{name:t,description:o}).then((function(){sweetSuccess("文件夹创建成功"),window.CommonModal.close(),l.app.selectFolder(l.app.folder)})).catch((function(e){sweetError(e)}))}),{title:"新建文件夹",data:[{dom:"input",type:"text",label:"文件夹名称",value:""},{dom:"textarea",label:"文件夹简介",value:""}]})}}})}}()}));
