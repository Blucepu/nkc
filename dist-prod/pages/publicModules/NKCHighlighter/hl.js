!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}NKC.modules.NKCHL=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=this,o=e.type,i=e.targetId,a=e.notes,c=void 0===a?[]:a;n.type=o,n.id=i;var s="".concat(o,"-content-").concat(i);n.rootElement=document.getElementById(s),window.addEventListener("mouseup",(function(){setTimeout((function(){n.removeBtn()}),50)}),!0);var r=new NKCHighlighter({rootElementId:s,clownClass:["MathJax_CHTML","MathJax"],clownAttr:{"data-tag":"nkcsource"}});n.hl=r,r.on(r.eventNames.select,(function(e){if(NKC.methods.getLoginStatus()){var t=e.range;n.sleep(200).then((function(){var e=n.hl.getStartNodeOffset(t);e&&(n.createBtn2(e).onclick=function(){var e=r.getNodes(t),o=r.getNodesContent(e);$(window).width()<768?NKC.methods.visitUrl("/note?content=".concat(o,"&targetId=").concat(n.id,"&type=post&offset=").concat(e.offset,"&length=").concat(e.length),!0):n.newNote({id:"",content:o,targetId:n.id,type:"post",notes:[],node:e}).then((function(e){r.createSource(e._id,e.node)})).catch(sweetError)})})).catch(sweetError)}})).on(r.eventNames.create,(function(e){})).on(r.eventNames.click,(function(e){NKC.methods.getLoginStatus()?$(window).width()>=768?n.showNotePanel(e.id):NKC.methods.visitUrl("/note/".concat(e.id),!0):NKC.methods.toLogin("login")})).on(r.eventNames.hover,(function(e){r.addClass(e,"post-node-hover")})).on(r.eventNames.hoverOut,(function(e){r.removeClass(e,"post-node-hover")})),r.restoreSources(c)}var n,o,i;return n=t,(o=[{key:"createBtn2",value:function(e){this.removeBtn();var t=e.top,n=e.left,o=$("<span><span>添加笔记</span></span>");return o.addClass("nkc-hl-btn"),$(window).width()>=768?o.css({top:t-2.6*12+"px",left:n-21.6+"px"}):o.css({top:t-$(document).scrollTop()-3+"px"}),$(body).append(o),o[0]}},{key:"createBtn",value:function(e){this.removeBtn();var t=document.createElement("span");t.classList.add("nkc-hl-btn"),t.innerText="记笔记";var n=$(this.rootElement),o=n.offset(),i=o.top,a=o.left,c=$(window).scrollTop(),s=n.width(),r=e.y-i+c,l=e.x-a;return l+60>a+s&&(l=a+s-60),t.style.top=r+"px",t.style.left=l+"px",this.rootElement.appendChild(t),t}},{key:"removeBtn",value:function(){$(".nkc-hl-btn").remove()}},{key:"sleep",value:function(e){return new Promise((function(t){setTimeout((function(){t()}),e)}))}},{key:"initNotePanel",value:function(){window.notePanel||(window.notePanel=new NKC.modules.NotePanel)}},{key:"newNote",value:function(e){return this.initNotePanel(),new Promise((function(t,n){window.notePanel.open((function(e){t(e)}),{note:e})}))}},{key:"showNotePanel",value:function(e){this.initNotePanel(),window.notePanel.open((function(e){}),{id:e})}}])&&e(n.prototype,o),i&&e(n,i),t}()}));
