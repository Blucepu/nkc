!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";function e(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function n(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=new Array(t);n<t;n++)o[n]=e[n];return o}function r(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return o(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?o(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){l=!0,a=e},f:function(){try{s||null==n.return||n.return()}finally{if(l)throw a}}}}window.Source=function(){function t(n){e(this,t);var o=n.hl,i=n.node,a=n.id,s=n._id,l=n.content;a=a||s;var u=this;this.hl=o,this.node=i,this.content=o.getNodesContent(i),this.dom=[],this.id=a,this._id="nkc-hl-id-".concat(a);var c=this.node,f=c.offset,d=c.length,h=u.getNodes(this.hl.root,f,d);if(0===d||!h.length){var v,m=o.root,g=m.nextSibling,p=m.parentNode;null===g?(v=document.createElement("div")).classList.add("nkc-free-notes"):v=g;var y=document.createElement("span");y.innerText=l,v.appendChild(y),g||p.appendChild(v),h=[y]}h.map((function(e){if(e.textContent.length){var t=e.parentNode;if(t.classList.contains("nkc-hl")){var n=t.getAttribute("data-nkc-hl-id");if(!n)return;n=n.split("-");var o,i=[],a=r(n);try{for(a.s();!(o=a.n()).done;){var s=o.value;i.push(u.hl.getSourceByID(Number(s)))}}catch(e){a.e(e)}finally{a.f()}var l,c=r(t.childNodes);try{var f=function(){var o=l.value;if(!o.textContent.length)return"continue";var r=document.createElement("span");r.className="nkc-hl",r.onmouseover=t.onmouseover,r.onmouseout=t.onmouseout,r.onclick=t.onclick,i.map((function(e){e.dom.push(r)})),o===e?(1===t.childNodes.length&&1!==h.length||(r.onmouseover=function(){u.hl.emit(u.hl.eventNames.hover,u)},r.onmouseout=function(){u.hl.emit(u.hl.eventNames.hoverOut,u)},r.onclick=function(){u.hl.emit(u.hl.eventNames.click,u)}),r.className+=" nkc-hl-cover",r.setAttribute("data-nkc-hl-id",n.concat([u.id]).join("-")),u.dom.push(r)):r.setAttribute("data-nkc-hl-id",n.join("-")),r.appendChild(o.cloneNode(!1)),t.replaceChild(r,o)};for(c.s();!(l=c.n()).done;)f()}catch(e){c.e(e)}finally{c.f()}i.map((function(e){var n=e.dom.indexOf(t);-1!==n&&e.dom.splice(n,1)})),t.onmouseout=null,t.onmouseover=null,t.onclick=null}else{var d=document.createElement("span");d.classList.add("nkc-hl"),d.setAttribute("data-nkc-hl-id",u.id),d.onmouseover=function(){u.hl.emit(u.hl.eventNames.hover,u)},d.onmouseout=function(){u.hl.emit(u.hl.eventNames.hoverOut,u)},d.onclick=function(){u.hl.emit(u.hl.eventNames.click,u)},u.dom.push(d),d.appendChild(e.cloneNode(!0)),e.parentNode.replaceChild(d,e)}}})),this.hl.sources.push(this),this.hl.emit(this.hl.eventNames.create,this)}return n(t,[{key:"addClass",value:function(e){this.dom.map((function(t){t.classList.add(e)}))}},{key:"removeClass",value:function(e){this.dom.map((function(t){t.classList.remove(e)}))}},{key:"destroy",value:function(){this.dom.map((function(e){e.className=""}))}},{key:"getSources",value:function(){return this.sources}},{key:"getNodes",value:function(e,t,n){for(var o=[e],r=0,i=null,a=n,s=[],l=!1;i=o.pop();){for(var u=i.childNodes,c=u.length-1;c>=0;c--){var f=u[c];this.hl.isClown(f)||o.push(f)}if(3===i.nodeType&&i.textContent.length&&(r+=i.textContent.length)>t){if(a<=0)break;var d=void 0;d=l?0:i.textContent.length-(r-t),l=!0;var h=void 0;a<=i.textContent.length-d?(h=a,a=0):a-=h=i.textContent.length-d,s.push({node:i,startOffset:d,needLength:h})}}return s=s.map((function(e){var t=e.node,n=e.startOffset,o=e.needLength;return n>0&&(t=t.splitText(n)),t.textContent.length!==o&&t.splitText(o),t}))}}]),t}(),window.NKCHighlighter=function(){function t(n){e(this,t);var o,r=n.rootElementId,i=n.excludedElementClass,a=void 0===i?[]:i,s=n.excludedElementTagName,l=void 0===s?[]:s,u=n.clownClass,c=void 0===u?[]:u,f=n.clownAttr,d=void 0===f?[]:f,h=n.clownTagName,v=void 0===h?[]:h,m=this;m.root=document.getElementById(r),m.excludedElementClass=a,m.excludedElementTagName=l,m.clownClass=c,m.clownAttr=d,m.clownTagName=v,m.range={},m.sources=[],m.events={},m.disabled=!1,m.eventNames={create:"create",hover:"hover",hoverOut:"hoverOut",select:"select"},document.addEventListener("mousedown",(function(){clearInterval(o)})),document.addEventListener("selectionchange",(function(){m.range={},clearInterval(o),o=setTimeout((function(){m.initEvent()}),500)}))}return n(t,[{key:"initEvent",value:function(){try{if(this.disabled)return;var e=this.getRange();if(!e||e.collapsed)return;if(e.startContainer===this.range.startContainer&&e.endContainer===this.range.endContainer&&e.startOffset===this.range.startOffset&&e.endOffset===this.range.endOffset)return;if(!this.contains(e.startContainer)||!this.contains(e.endContainer))return;this.range=e,this.emit(this.eventNames.select,{range:e})}catch(e){console.log(e.message||e)}}},{key:"contains",value:function(e){for(;e=e.parentNode;)if(e===this.root)return!0;return!1}},{key:"getParent",value:function(e,t){if(t!==e.root){if(this.isClown(t))throw new Error("划词越界");t.parentNode&&e.getParent(e,t.parentNode)}}},{key:"getRange",value:function(){var e=this;try{var t=window.getSelection().getRangeAt(0),n=t.startOffset,o=t.endOffset,r=t.startContainer,i=t.endContainer;if(this.getParent(this,r),this.getParent(this,i),this.findNodes(r,i).map((function(t){e.getParent(e,t)})),n===o&&r===i)return;return t}catch(e){console.log(e.message||e)}}},{key:"destroy",value:function(e){"string"==typeof e&&(e=this.getSourceByID(e)),e.destroy()}},{key:"restoreSources",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=r(t);try{for(n.s();!(e=n.n()).done;){var o=e.value;o.hl=this,new Source(o)}}catch(e){n.e(e)}finally{n.f()}}},{key:"getNodes",value:function(e){var t,n,o=e.startContainer,i=e.endContainer,a=e.startOffset,s=e.endOffset,l=[];if(o===i)n=t=o,l.push({node:t,offset:a,length:s-a});else{n=i,3===(t=o).nodeType&&l.push({node:t,offset:a,length:t.textContent.length-a});var u,c=r(this.findNodes(t,n));try{for(c.s();!(u=c.n()).done;){var f=u.value;l.push({node:f,offset:0,length:f.textContent.length})}}catch(e){c.e(e)}finally{c.f()}l.push({node:n,offset:0,length:s})}for(var d=[],h=0,v=l;h<v.length;h++){var m=v[h],g=m.node,p=m.offset,y=m.length,k=g.textContent.slice(p,p+y),C=this.getOffset(g);d.push({content:k,offset:C+p,length:y})}if(!d.length)return null;for(var N="",w=0,b=0,x=0;x<d.length;x++){var S=d[x];N+=S.content,b+=S.length,0===x&&(w=S.offset)}return{content:N,offset:w,length:b}}},{key:"getNodesContent",value:function(e){return e.content}},{key:"createSource",value:function(e,t){return new Source({hl:this,id:e,node:t})}},{key:"getSourceByID",value:function(e){var t,n=r(this.sources);try{for(n.s();!(t=n.n()).done;){var o=t.value;if(o.id===e)return o}}catch(e){n.e(e)}finally{n.f()}}},{key:"addClass",value:function(e,t){("string"==typeof e?this.getSourceByID(e):e).addClass(t)}},{key:"removeClass",value:function(e,t){("string"==typeof e?this.getSourceByID(e):e).removeClass(t)}},{key:"getOffset",value:function(e){for(var t=[this.root],n=null,o=0;n=t.pop();){for(var r=n.childNodes,i=r.length-1;i>=0;i--){var a=r[i];this.isClown(a)||t.push(a)}if(3===n.nodeType&&n!==e)o+=n.textContent.length;else if(3===n.nodeType)break}return o}},{key:"findNodes",value:function(e,t){var n=[],o=this.getSameParentNode(e,t);if(o){var i=!1,a=!1;!function o(s){if(s.hasChildNodes()){var l,u=r(s.childNodes);try{for(u.s();!(l=u.n()).done;){var c=l.value;if(a||c===t)return void(a=!0);i&&3===c.nodeType?n.push(c):c===e&&(i=!0),o(c)}}catch(e){u.e(e)}finally{u.f()}}}(o)}return n}},{key:"isClown",value:function(e){if(1===e.nodeType){var t,n=e.classList,o=r(this.clownClass);try{for(o.s();!(t=o.n()).done;){var i=t.value;if(n.contains(i))return!0}}catch(e){o.e(e)}finally{o.f()}var a=e.tagName.toLowerCase();if(this.clownTagName.includes(a))return!0;for(var s in this.clownAttr)if(this.clownAttr.hasOwnProperty(s)&&e.getAttribute(s)===this.clownAttr[s])return!0}}},{key:"getSameParentNode",value:function(e,t){var n=this;if(!t||e===t)return e.parentNode;var o,r=[],i=[],a=function e(t,o){o.push(t),t!==n.root&&t.parentNode&&e(t.parentNode,o)};a(e,r),a(t,i);for(var s=0,l=r;s<l.length;s++){var u=l[s];if(i.includes(u)){o=u;break}}return o}},{key:"getSourceById",value:function(e){var t,n=r(this.sources);try{for(n.s();!(t=n.n()).done;){var o=t.value;if(o.id===e)return o}}catch(e){n.e(e)}finally{n.f()}}},{key:"offset",value:function(e){var t,n=0,o=0;return function e(r,i){1===r.nodeType&&(t=window.getComputedStyle(r).position,void 0!==i||"static"!==t?(n=r.offsetTop+n-r.scrollTop,o=r.offsetLeft+o-r.scrollLeft,"fixed"!==t&&e(r.parentNode)):e(r.parentNode))}(e,!0),{top:n,left:o}}},{key:"getStartNodeOffset",value:function(e){var t=document.createElement("span");t.style.display="inline-block",t.style.verticalAlign="top",e.insertNode(t);var n=t.parentNode;t.style.width="30px";var o=this.offset(t);return n.removeChild(t),o}},{key:"lock",value:function(){this.disabled=!0}},{key:"unlock",value:function(){this.disabled=!1}},{key:"on",value:function(e,t){return this.events[e]||(this.events[e]=[]),this.events[e].push(t),this}},{key:"emit",value:function(e,t){(this.events[e]||[]).map((function(e){e(t)}))}}]),t}()}));
