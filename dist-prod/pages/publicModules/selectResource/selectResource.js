!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";NKC.modules.SelectResource=function(){var e=this;e.dom=$("#moduleSelectResource"),e.dom.draggable({scroll:!1,handle:".module-sr-title",drag:function(t,o){o.position.top<0&&(o.position.top=0);var i=$(window).height();o.position.top>i-30&&(o.position.top=i-30);var n=e.dom.width();o.position.left<100-n&&(o.position.left=100-n);var r=$(window).width();o.position.left>r-100&&(o.position.left=r-100)}}),e.app=new Vue({el:"#moduleSelectResourceApp",data:{isApp:NKC.configs.isApp&&"reactNative"===NKC.configs.platform,uid:"",user:"",pageType:"list",category:"all",resourceType:"",quota:16,paging:{},pageNumber:"",resources:[],allowedExt:[],countLimit:10,selectedResources:[],loading:!0,fastSelect:!1,pictureExt:["swf","jpg","jpeg","gif","png","svg","bmp"],files:[],croppingPicture:!1,isTouchEmit:!1,sizeLimit:null},mounted:function(){},computed:{fileSizeLimit:function(){var e=this.sizeLimit;if(!e)return"";var t=[];(t=t.concat(e.others)).push({ext:"其他",size:e.default});for(var o="文件大小限制\n",i=0;i<t.length;i++){var n=t[i];i>0&&(o+="\n"),o+=n.ext.toUpperCase()+"："+this.getSize(1024*n.size,1)}return o},show:function(){var e={},t=this.allowedExt;return-1!==t.indexOf("audio")&&(e.audio=!0),-1!==t.indexOf("video")&&(e.video=!0),-1!==t.indexOf("picture")&&(e.picture=!0),-1!==t.indexOf("attachment")&&(e.attachment=!0),(-1!==t.indexOf("all")||e.audio&&e.video&&e.picture&&e.attachment)&&(e.all=!0),e},windowWidth:function(){return $(window).width()},windowHeight:function(){return $(window).height()},screenType:function(){return this.windowWidth<700?"sm":"md"},selectedResourcesId:function(){for(var e=[],t=this.selectedResources,o=0;o<t.length;o++){var i=t[o];-1===e.indexOf(i.rid)&&e.push(i.rid)}return e}},methods:{getUrl:NKC.methods.tools.getUrl,getSize:NKC.methods.tools.getSize,checkFileSize:function(e,t){var o=this.sizeLimit;if(o){var i,n=e.split(".");n=n.pop().toLowerCase();for(var r=0;r<o.others.length;r++){var s=o.others[r];if(s.ext.toLowerCase()===n){i=s;break}}i||(i={ext:n,size:o.default});var a=1024*i.size;if(t>a)throw n.toUpperCase()+"文件大小不能超过"+this.getSize(a,1)}},showFileSizeLimit:function(){asyncSweetCustom(this.fileSizeLimit.replace(/\n/gi,"<br>"))},cancelCropPicture:function(){this.resetCropper(),this.changePageType("list")},rotate:function(t){"left"===t?e.cropper.rotate(-90):e.cropper.rotate(90)},resetCropper:function(){e.cropper&&e.cropper.destroy&&e.cropper.destroy()},editImage:function(t){this.croppingPicture=!1,this.changePageType("editPicture"),setTimeout((function(){e.app.resetCropper();var o=$("#moduleSelectResourceEdit");o.cropper({viewMode:1}),e.cropper=o.data("cropper");var i="";i=t.originId?"/ro/"+t.originId:"/r/"+t.rid,e.cropper.replace(i)}),10)},cropPicture:function(){e.app.croppingPicture=!0,setTimeout((function(){try{e.cropper.getCroppedCanvas().toBlob((function(t){var o=NKC.methods.blobToFile(t,Date.now()+".jpg");e.app.uploadSelectFile(o),e.app.changePageType("list"),e.app.resetCropper()}),"image/jpeg")}catch(t){console.log(t),e.app.croppingPicture=!1,sweetError(t)}}),10)},readyPaste:function(){var e=this,t=$("#pasteContent");t.off("paste"),t.one("paste",(function(t){for(var o=(t.clipboardData||t.originalEvent&&t.originalEvent.clipboardData||{}).items||[],i=[],n=0;n<o.length;n++){var r=o[n].getAsFile();r&&i.push(r)}i.length&&e.uploadSelectFile(i)}))},pasteContent:function(){},initModule:function(){e.dom.css({height:"43.5rem"}),e.dom.draggable({scroll:!1,handle:".module-sr-title",drag:function(t,o){o.position.top<0&&(o.position.top=0);var i=$(window).height();o.position.top>i-30&&(o.position.top=i-30);var n=e.dom.width();o.position.left<100-n&&(o.position.left=100-n);var r=$(window).width();o.position.left>r-100&&(o.position.left=r-100)}})},destroyModule:function(){e.dom.draggable("destroy")},resetDomPosition:function(){var t=e.dom,o=$(window).width();$(window).height(),o<700?t.css({width:.8*o,top:0,right:0}):t.css("left",.5*(o-t.width()))},close:function(){e.dom.hide(),this.destroyModule(),this.resetCropper(),setTimeout((function(){e.app.selectedResources=[],e.app.resourceType="all",e.app.category="all"}),500)},open:function(t,o){this.resetDomPosition(),this.resetCropper(),e.callback=t,o=o||{},e.app.countLimit=o.countLimit||50,e.app.allowedExt=o.allowedExt||["all","audio","video","attachment","picture"],o.resourceType?e.app.resourceType=o.resourceType:e.app.resourceType=e.app.allowedExt[0],e.app.pageType=o.pageType||"list",e.app.fastSelect=o.fastSelect||!1,e.app.getResources(0),this.initModule(),e.dom.show()},selectCategory:function(e){this.category=e,this.getResources(0)},getResources:function(t){var o="/me/media?quota="+this.quota+"&skip="+t+"&type="+this.resourceType+"&c="+this.category+"&t="+Date.now();nkcAPI(o,"GET").then((function(t){e.app.sizeLimit=t.sizeLimit,e.app.paging=t.paging,e.app.pageNumber=e.app.paging.page+1,e.app.resources=t.resources,e.app.loading=!1})).catch((function(e){sweetError(e)}))},changePage:function(e){var t=this.paging;if(!(t.buttonValue.length<=1||"last"===e&&0===t.page||"next"===e&&t.page+1===t.pageCount)){var o="last"===e?-1:1;this.getResources(t.page+o)}},clickInput:function(){this.files.length>=20&&sweetInfo("最多仅允许20个文件同时上传，请稍后再试。");var e=document.getElementById("moduleSelectResourceInput");e&&e.click()},removeFile:function(e){this.files.splice(e,1)},startUpload:function(t){return t.error="",this.selectCategory("upload"),Promise.resolve().then((function(){if(e.app.checkFileSize(t.data.name,t.data.size),"uploading"===t.status)throw"文件正在上传...";if("uploaded"===t.status)throw"文件已上传成功！";return t.status="uploading",NKC.methods.getFileMD5(t.data)})).then((function(e){var o=new FormData;return o.append("type","checkMD5"),o.append("fileName",t.name),o.append("md5",e),nkcUploadFile("/r","POST",o)})).then((function(e){if(!e.uploaded){var o=new FormData;return o.append("file",t.data,t.data.name||Date.now()+".png"),nkcUploadFile("/r","POST",o,(function(e,o){t.progress=o}),36e5)}})).then((function(){t.status="uploaded";var o=e.app.files.indexOf(t);e.app.files.splice(o,1)})).catch((function(e){t.status="unUpload",t.progress=0,t.error=e.error||e,console.log(e),screenTopWarning(e.error||e)}))},newFile:function(e){return{name:e.name,ext:"image"===e.type.slice(0,5)?"picture":"file",size:NKC.methods.getSize(e.size,1),data:e,error:"",progress:0,status:"unUpload"}},uploadSelectFile:function(e){var t=this;return e.constructor===Array?e.forEach((function(e){e.name||-1===e.type.indexOf("image")||(e.name=Date.now()+Math.round(1e3*Math.random())+".png"),t.files.push(t.newFile(e))})):(e=this.newFile(e),this.files.unshift(e)),function e(){for(var o,i=0;i<t.files.length;i++){var n=t.files[i];if("unUpload"===n.status&&!n.error){o=n;break}}return o?t.startUpload(o).then(new Promise((function(e,t){console.log("【上传成功】",o.name),setTimeout(e,1e3)}))).then((function(){return e()})):Promise.resolve()}().then((function(){console.log("【全部上传完成】"),"upload"!==t.category||t.files.length||setTimeout((function(){t.category="all",t.getResources(0)}),500)}))},selectedFiles:function(){var e=$("#moduleSelectResourceInput")[0],t=[].slice.call(e.files);e.value="",t.length<=0||this.uploadSelectFile(t)},changePageType:function(e){this.pageType=e,"list"===e&&this.crash()},crash:function(){var e=this.paging;this.getResources(e.page)},done:function(){var t=this.selectedResources,o=this.selectedResourcesId;e.callback({resources:t,resourcesId:o}),e.close()},fastSelectPage:function(){var e=this.pageNumber-1,t=this.paging;if(t&&t.buttonValue.length){var o=t.buttonValue[t.buttonValue.length-1].num;if(e<0||o<e)return sweetInfo("输入的页数超出范围");this.getResources(e)}},getIndex:function(e,t){for(var o=-1,i=0;i<e.length;i++)if(e[i].rid===t.rid){o=i;break}return o},visitUrl:function(e){NKC.methods.visitUrl(e,!0)},removeSelectedResource:function(e){this.selectedResources.splice(e,1)},fastSelectResource:function(t){this.fastSelect?e.callback(t):this.selectResource(t)},selectResource:function(e){var t=this.getIndex(this.selectedResources,e);if(-1!==t)this.selectedResources.splice(t,1);else{if(this.selectedResources.length>=this.countLimit)return;this.selectedResources.push(e)}},selectResourceType:function(e){this.resourceType=e,this.getResources(0)},takePicture:function(){NKC.methods.rn.emit("takePictureAndUpload",{},(function(t){e.app.crash()}))},takeVideo:function(){NKC.methods.rn.emit("takeVideoAndUpload",{},(function(t){e.app.crash()}))},recordAudio:function(){NKC.methods.rn.emit("recordAudioAndUpload",{},(function(t){e.app.crash()}))}}});var t=e.dom.find("#pasteContent"),o="";t.on({dragenter:function(e){e.stopPropagation(),e.preventDefault(),o=t.text(),t.text("松开鼠标上传文件")},dragleave:function(e){e.stopPropagation(),e.preventDefault(),t.text(o)},dragover:function(e){e.stopPropagation(),e.preventDefault()},drop:function(i){i.preventDefault(),i.stopPropagation(),t.text(o);var n=[].slice.call(i.originalEvent.dataTransfer.files);n.length&&e.app.uploadSelectFile(n)}}),socket&&socket.on&&socket.on("fileTransformProcess",(function(t){"fileProcessFailed"===t.state&&(console.error(t.err),sweetError("文件处理失败\n附件中含有不支持的特殊格式，请处理以后再上传")),e.app.getResources(0)})),e.open=e.app.open,e.close=e.app.close}}));
