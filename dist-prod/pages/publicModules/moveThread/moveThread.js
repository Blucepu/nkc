!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";NKC.modules.MoveThread=function(){var e=this;e.dom=$("#moduleMoveThread"),e.dom.modal({show:!1}),e.app=new Vue({el:"#moduleMoveThreadApp",data:{forums:[],selectedForums:[],loading:!0,moveType:"add",forumType:"",forum:"",hideMoveType:!1,forumCategories:[],showAnonymousCheckbox:!1,onlyAnonymous:!1,forumCountLimit:20,submitting:!1,showRecycle:!1,recycleId:"",violation:!1,violationReason:""},computed:{canSelectForums:function(){for(var e=this.forums,o=[],t=0;t<e.length;t++)o=o.concat(e[t].allChildForums||[]);return o},selectedForumsId:function(){for(var e=[],o=0;o<this.selectedForums.length;o++)e.push(this.selectedForums[o].fid);return e},showForums:function(){for(var e=[],o=0;o<this.forums.length;o++){var t=this.forums[o];if(t.categoryId===this.forumType){if(!this.onlyAnonymous){e.push(t);continue}for(var r=0;r<t.allChildForums.length;r++){if(t.allChildForums[r].allowedAnonymousPost){e.push(t);break}}}}return e}},methods:{getUrl:NKC.methods.tools.getUrl,getCategory:function(e,o){for(var t=e.threadTypes,r=0;r<t.length;r++){var s=t[r];if(-1!==o.indexOf(s.cid+"")||-1!==o.indexOf(s.cid))return s}},getForumsById:function(e){for(var o=this.canSelectForums,t=0;t<o.length;t++)if(e===o[t].fid)return o[t]},getAllChildForums:function(e,o){if(e.childrenForums&&e.childrenForums.length>0)for(var t=0;t<e.childrenForums.length;t++){var r=e.childrenForums[t];r.childrenForums&&0!==r.childrenForums.length||(this.showRecycle||r.fid!==this.recycleId)&&(r.selectedThreadType="",o.push(r)),this.getAllChildForums(r,o)}return o},selectForum:function(e){if(-1===this.selectedForumsId.indexOf(e.fid)){if(this.selectedForums.length>=this.forumCountLimit)return sweetWarning("最多只能选择"+this.forumCountLimit+"个专业");this.selectedForums.push(e),this.forum=""}},removeForum:function(e){this.selectedForums.splice(e,1),this.forum=""},submit:function(){for(var o=[],t=0;t<this.selectedForums.length;t++){var r=this.selectedForums[t];o.push({fid:r.fid,cid:r.selectedThreadType?r.selectedThreadType.cid:"",fName:r.displayName,description:r.description,iconFileName:r.iconFileName,logo:r.logo,banner:r.banner,cName:r.selectedThreadType?r.selectedThreadType.name:"",color:r.color})}if(0===o.length)return screenTopWarning("请至少选择一个专业");e.callback({forumsId:this.selectedForumsId,forums:o,moveType:this.moveType,originForums:this.selectedForums,violation:this.violation,violationReason:this.violationReason})},showThreadType:function(e){this.forum=e},selectThreadType:function(e){this.forum.selectedThreadType=e,this.forum=""},resetThreadType:function(){this.forum.selectedThreadType="",this.forum=""}}}),e.open=function(o,t){e.callback=o,e.dom.modal("show"),nkcAPI("/f","GET").then((function(o){e.app.recycleId=o.recycleId;for(var r=0;r<o.forums.length;r++){var s=o.forums[r];s.allChildForums=e.app.getAllChildForums(s,[])}if(e.app.forums=o.forums,e.app.loading=!1,e.app.forumCategories=o.forumCategories,e.app.forumType||(e.app.forumType=e.app.forumCategories[0]._id),e.app.forumCountLimit=20,t){if(e.app.showRecycle=t.showRecycle||!1,t.selectedForumsId&&t.selectedForumsId.length>0){var i=[],n=t.selectedForumsId;for(r=0;r<n.length;r++){var u=e.app.getForumsById(n[r]);u&&(t.selectedCategoriesId&&(u.selectedThreadType=e.app.getCategory(u,t.selectedCategoriesId)),i.push(u))}e.app.selectedForums=i}t.hideMoveType&&(e.app.hideMoveType=!0),e.app.showAnonymousCheckbox=t.showAnonymousCheckbox||!1,t.forumCountLimit&&(e.app.forumCountLimit=t.forumCountLimit)}})).catch((function(e){screenTopWarning(e)}))},e.close=function(){e.dom.modal("hide"),e.app.selectedForums=[],e.app.moveType="replace",e.app.showAnonymousCheckbox=!1,e.app.onlyAnonymous=!1,e.app.forumType="",e.unlock()},e.lock=function(){e.app.submitting=!0},e.unlock=function(){e.app.submitting=!1}}}));
