!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";NKC.modules.SurveyForm=function(e){var t=this;e=e||"#moduleSurveyForm";var s=$(e).attr("data-survey-id");t.app=new Vue({el:e,data:{loading:!0,survey:"",targetUser:"",showResult:!1,havePermission:!1,surveyRewardScore:"",posted:!1,options:[],status:"",surveyPost:"",errorInfo:{},users:[]},computed:{rewardInfo:function(){var e=this.survey.reward,t=this.targetUser.kcb,s=this.surveyRewardScore.name,o=this.surveyRewardScore.unit;if(e.status&&!(e.rewardedCount>=e.rewardCount||t/100<e.onceKcb))return"作者设定每次提交奖励"+e.onceKcb/100+o+s+"，数量有限，发完即止。"},optionsObj:function(){for(var e={},t=this.options,s=0;s<t.length;s++){var o=t[s];o&&o.answerId&&o.optionId&&(e[o.optionId+"-"+o.answerId]=o)}return e},postResult:function(){if(this.showResult){var e=this.survey;return e.type,"参与人数："+e.postCount}},timeInfo:function(){var e=this.status;return"unStart"===e?"开始时间："+this.startTime+" ，结束时间："+this.endTime:"beginning"===e?"结束时间："+this.endTime:"end"===e?"已结束。":""},formName:function(){return{vote:"投票",survey:"问卷调查",score:"评分"}[this.survey.type]},startTime:function(){return this.survey?this.format("YYYY/MM/DD HH:mm:ss",this.survey.st):""},endTime:function(){return this.survey?this.format("YYYY/MM/DD HH:mm:ss",this.survey.et):""},postTime:function(){return this.posted&&this.surveyPost&&this.surveyPost.toc?this.format("YYYY/MM/DD HH:mm:ss",this.surveyPost.toc):""},answerScore:function(){var e=this.survey,t=this.options;if("score"===e.type){for(var s=0,o=0,r=0,n=0;n<e.options.length;n++)for(var i=e.options[n],u=0;u<i.answers.length;u++){s+=i.answers[u].maxScore,r+=t[n].answers[u].score,o++}return{score:s,postScore:r,count:o}}},totalScore:function(){var e=this.answerScore;if(void 0!==e)return e.score},answerCount:function(){var e=this.answerScore;if(void 0!==e)return e.count},postScore:function(){var e=this.answerScore;if(void 0!==e)return e.postScore}},methods:{format:NKC.methods.format,getUrl:NKC.methods.tools.getUrl,getColor:NKC.methods.getRandomColor,modifyPost:function(){"end"!==this.status&&(this.posted=!1)},selectCount:function(e){var t=e.minVoteCount,s=e.maxVoteCount;return t===s?1===t?"单项选择":"必选数量："+t:"勾选数量必须>="+t+"且<="+s},resetSelectedAnswerById:function(e){for(var t=0;t<this.options.length;t++){var s=this.options[t];s.optionId===e&&(s.selected=!1)}},getSelectedAnswerCountById:function(e){for(var t=0,s=0;s<this.options.length;s++){var o=this.options[s];o.optionId===e&&o.selected&&t++}return t},getOptionById:function(e,t){for(var s=0;s<this.options.length;s++){var o=this.options[s];if(o.optionId===e&&o.answerId===t)return o}},checkTime:function(){var e=this.survey,t=this;if(e){var s=new Date(e.et).getTime(),o=new Date(e.st).getTime(),r=Date.now();t.status=r<o?"unStart":r<s?"beginning":"end"}setTimeout((function(){t.checkTime()}),1e3)},getIndex:function(e){return["a","b","c","d"][e]},submit:function(){var e=this,t=this.survey,s=this.options,o=this.surveyRewardScore.name,r=this.surveyRewardScore.unit;if(this.errorInfo={},"score"===t.type)for(var n=0;n<t.options.length;n++)for(var i=t.options[n],u=0;u<i.answers.length;u++){var a=i.answers[u],d=this.getOptionById(i._id,a._id),c=a.maxScore,h=a.minScore;if(""===d.score||d.score<h||d.score>c)return this.errorInfo[i._id+"_"+a._id]=!0,window.location.href="#"+i._id+"_"+a._id,sweetError("打分分值不在规定的范围内，请检查")}nkcAPI("/survey/"+t._id,"POST",{options:s,type:this.surveyPost?"modifyPost":"newPost"}).then((function(s){void 0!==s.rewardNum?sweetSuccess("提交成功！获得"+s.rewardNum/100+r+o,{autoHide:!1}):sweetSuccess("提交成功"),e.getSurveyById(t._id)})).catch((function(e){sweetError(e)}))},selectOption:function(e,t){if(this.havePermission&&"beginning"===this.status&&!this.posted){var s=this.options,o=this.survey,r=o.options[e],n=r.answers[t],i=this.getOptionById(r._id,n._id);if(i&&i.selected)i.selected=!1;else{if(this.getSelectedAnswerCountById(r._id)>=o.options[e].maxVoteCount){if(1!==o.options[e].maxVoteCount)return;this.resetSelectedAnswerById(r._id)}i?i.selected=!0:s.push({score:"",selected:!0,optionId:r._id,answerId:n._id})}}},visitUrl:function(e){NKC.methods.visitUrl(e,!0)},getSurveyById:function(e){var t=this;nkcAPI("/survey/"+e,"GET").then((function(e){var s=[];if(t.showResult=e.showResult,t.users=e.users,t.targetUser=e.targetUser,t.surveyRewardScore=e.surveyRewardScore,e.surveyPost)t.surveyPost=e.surveyPost,s=e.surveyPost.options,t.posted=!0;else for(var o=0;o<e.survey.options.length;o++)for(var r=e.survey.options[o],n=0;n<r.answers.length;n++){var i=r.answers[n];s.push({optionId:r._id,answerId:i._id,selected:!1,score:""})}if(t.havePermission=e.havePermission,t.options=s,t.showResult)for(o=0;o<e.survey.options.length;o++){var u=e.survey.options[o],a=0,d=void 0;for(n=0;n<u.answers.length;n++){a+=(i=u.answers[n]).postScore||0,i.color=t.getColor(),i.progress=0===e.survey.postCount?0:(100*(i.postCount||0)/(e.survey.postCount||0)).toFixed(1),i.progress&&(!d||d<parseFloat(i.progress))&&(d=i.progress),i.average=0===e.survey.postCount?0:((i.postScore||0)/(e.survey.postCount||0)).toFixed(2)}u.postScore=a;for(n=0;n<u.answers.length;n++){i=u.answers[n];d?d===parseFloat(i.progress)?i.domProgress=100:i.domProgress=100*parseFloat(i.progress)/d:i.domProgress=i.progress}}t.survey=e.survey,t.loading=!1}))}},mounted:function(){s&&this.getSurveyById(s),this.checkTime(),setTimeout((function(){floatUserPanel.initPanel(),NKC.methods.initImageViewer(".option-resource img")}),300)}}),t.init=function(e){(e=e||{}).surveyId&&t.app.getSurveyById(e.surveyId)}}}));
