!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";NKC.modules.SurveyEdit=function(){var e=this,r=/^(http|https):\/\//i;e.app=new Vue({el:"#moduleSurveyEdit",data:{disabled:!0,deadlineMax:"",targetUser:"",targetUserSurveyRewardScore:"",surveyRewardScore:"",survey:"",newSurvey:"",grades:[],roles:[],users:[],timeEnd:{year:"",month:"",day:"",hour:"",minute:""},timeStart:{year:"",month:"",day:"",hour:"",minute:""},error:""},computed:{selectedUsers:function(){for(var e=this.survey.permission.uid||[],r=[],t=0;t<e.length;t++){var n=this.getUserById(e[t]);n&&r.push(n)}return r},rewardKcbTotal:function(){var e=this.survey;if(e.reward.onceKcb&&e.reward.rewardCount)return(e.reward.onceKcb*e.reward.rewardCount).toFixed(2)},rewardWarning:function(){this.targetUser;var e=this.survey,r=this.surveyRewardScore;if(this.targetUserSurveyRewardScore/100<e.reward.onceKcb*e.reward.rewardCount)return"你的"+r.name+"不足，透支后将不再奖励。"},timeStartDay:function(){return NKC.methods.getDayCountByYearMonth(this.timeStart.year,this.timeStart.month)},timeEndDay:function(){return NKC.methods.getDayCountByYearMonth(this.timeEnd.year,this.timeEnd.month)},voteCount:function(){for(var e=[],r=1;r<=this.survey.options.length;r++)e.push(r);return e},formName:function(){return{vote:"发起投票",survey:"问卷调查",score:"评分"}[this.survey.type]}},mounted:function(){var e=this;e.setTime(),e.newSurvey={st:"",et:"",showResult:"all",disabled:!1,showVoter:"always",reward:{rewardedCount:0,rewardCount:0,onceKcb:0,status:!1},permission:{visitor:!1,voteUpCount:0,postCount:0,threadCount:0,digestThreadCount:0,registerTime:0,gradesId:[1],certsId:["default"],uid:[]},description:"",options:[this.newOption()],type:"vote"},nkcAPI("/survey?t=thread","GET").then((function(r){e.deadlineMax=r.deadlineMax,e.grades=r.grades;for(var t=[],n=0;n<r.grades.length;n++)t.push(r.grades[n]._id);e.newSurvey.permission.gradesId=t,e.roles=r.roles,e.targetUser=r.user,e.surveyRewardScore=r.surveyRewardScore,e.targetUserSurveyRewardScore=r.targetUserSurveyRewardScore}))},methods:{checkNumber:NKC.methods.checkData.checkNumber,checkString:NKC.methods.checkData.checkString,getUrl:NKC.methods.tools.getUrl,removeUser:function(e){this.survey.permission.uid.splice(e,1)},getUserById:function(e){for(var r=this.users,t=0;t<r.length;t++){var n=r[t];if(n.uid===e)return n}},newAnswer:function(){return{content:"",links:[],links_:[],resourcesId:[],minScore:0,maxScore:0}},newOption:function(){return{content:"",answers:[this.newAnswer()],links:[],links_:[],resourcesId:[],maxVoteCount:1,minVoteCount:1}},getVoteCount:function(e){for(var r=(e.answers||[]).length,t=[],n=1;n<=r;n++)t.push(n);return t},getMinVoteCount:function(e){for(var r=(e.answers||[]).length,t=[],n=0;n<=r;n++)t.push(n);return t},toInt:function(){var e=this.survey;e.permission.registerTime=parseInt(e.permission.registerTime),e.permission.digestThreadCount=parseInt(e.permission.digestThreadCount),e.permission.threadCount=parseInt(e.permission.threadCount),e.permission.postCount=parseInt(e.permission.postCount),e.permission.voteCount=parseInt(e.permission.voteCount);for(var r=0;r<e.options.length;r++)for(var t=e.options[r],n=0;n<t.answers.length;n++){var s=t.answers[n];s.maxScore=parseFloat(s.maxScore.toFixed(2)),s.minScore=parseFloat(s.minScore.toFixed(2))}e.reward.onceKcb=parseFloat(e.reward.onceKcb.toFixed(2)),e.reward.rewardCount=parseInt(e.reward.rewardCount)},modifyLinks:function(e,r){for(var t=[],n=0;n<e.length;n++){var s=e[n];"str"===r?t.push(s.link):t.push({index:n,link:s})}return t},setTime:function(e,r){e||(e=new Date),r||(r=new Date(Date.now()+864e5)),this.timeStart={year:e.getFullYear(),month:e.getMonth()+1,day:e.getDate(),hour:e.getHours(),minute:e.getMinutes()},this.timeEnd={year:r.getFullYear(),month:r.getMonth()+1,day:r.getDate(),hour:r.getHours(),minute:r.getMinutes()}},addAnswer:function(e){e.answers.push(this.newAnswer())},removeResourceId:function(e,r){e.resourcesId.splice(r,1)},visitUrl:function(e){NKC.methods.visitUrl(e,!0)},removeOption:function(r){sweetQuestion("确定要删除该问题？").then((function(){e.app.survey.options.splice(r,1)})).catch((function(){}))},removeLink:function(e,r){e.links_.splice(r,1)},checkHttp:function(e){r.test(e.link)||(e.link="http://"+e.link)},addLink:function(e){e.links_.push({index:e.links_.length,link:"http://"})},selectUser:function(){if(!window.SelectUser){if(!NKC.modules.SelectUser)return sweetError("未引入选择用户模块");window.SelectUser=new NKC.modules.SelectUser}var e=this;SelectUser.open((function(r){var t=r.usersId,n=r.users;e.users=e.users.concat(n);for(var s=e.survey.permission.uid,o=0;o<t.length;o++){var i=t[o];-1===s.indexOf(i)&&s.push(i)}}),{userCount:999,selectedUsersId:this.survey.permission.uid||[]})},addResource:function(e){if(!window.SelectResource){if(!NKC.modules.SelectResource)return sweetError("未引入选择资源附件模块");window.SelectResource=new NKC.modules.SelectResource}SelectResource.open((function(r){for(var t=r.resourcesId,n=0;n<t.length;n++){var s=t[n];-1===e.resourcesId.indexOf(s)&&e.resourcesId.push(s)}}),{allowedExt:["picture"]})},addOption:function(){this.survey.options.push(this.newOption())},copy:function(e,r){r?e.push(JSON.parse(JSON.stringify(r))):e.push(JSON.parse(JSON.stringify(e[e.length-1])))},moveOption:function(e,r,t){var n,s,o,i;if(s=void 0!==t?(n=r.answers).indexOf(t):(n=this.survey.options).indexOf(r),"up"===e){if(0===s)return;i=s-1}else{if(s+1===n.length)return;i=s+1}o=n[i],n[s]=o,void 0!==t?(n[i]=t,Vue.set(n,i,t)):(n[i]=r,Vue.set(n,i,r))},removeAnswer:function(e,r){sweetQuestion("确定要移除该选项？").then((function(){e.answers.splice(r,1)})).catch((function(){}))},selectType:function(e){this.survey.type=e,"vote"!==e||this.survey.options&&this.survey.options.length||(this.survey.options=[this.newOption()])},te:function(e){throw e},submit:function(){if(!this.disabled){this.error="";for(var e=JSON.parse(JSON.stringify(this.survey)),r=0;r<e.options.length;r++){var t=e.options[r];t.links=this.modifyLinks(t.links_,"str");for(var n=0;n<t.answers.length;n++){var s=t.answers[n];"score"===e.type&&(s.maxScore=parseFloat(s.maxScore.toFixed(2)),s.minScore=parseFloat(s.minScore.toFixed(2))),s.links=this.modifyLinks(s.links_,"str")}}var o=this.timeEnd,i=this.timeStart,u=new Date(i.year+"-"+i.month+"-"+i.day+" "+i.hour+":"+i.minute),a=new Date(o.year+"-"+o.month+"-"+o.day+" "+o.hour+":"+o.minute);return e.st=u,e.et=a,e.reward.onceKcb=parseFloat(e.reward.onceKcb||0),e.reward.rewardCount=parseInt(e.reward.rewardCount||0),e.reward.onceKcb=100*e.reward.onceKcb,e}}}}),e.init=function(r){(r=r||{}).pid&&(e.app.newSurvey.pid=r.pid),r.surveyId?nkcAPI("/survey/"+r.surveyId,"GET").then((function(r){for(var t=0;t<r.survey.options.length;t++){var n=r.survey.options[t];if(n.links_=e.app.modifyLinks(n.links),n.answers&&n.answers.length)for(var s=0;s<n.answers.length;s++){var o=n.answers[s];o.links_=e.app.modifyLinks(o.links)}}r.survey.reward.onceKcb=r.survey.reward.onceKcb/100,e.app.survey=r.survey,e.app.disabled=!1,e.app.users=r.allowedUsers,e.app.targetUser=r.targetUser,e.app.setTime(new Date(e.app.survey.st),new Date(e.app.survey.et))})).catch((function(e){sweetError(e)})):e.app.survey=e.app.newSurvey},e.getSurveyData=function(){return{ps:e.app.ps,options:e.app.ps}},e.getSurvey=function(){return e.app.submit()}}}));
