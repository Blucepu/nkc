!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";function e(){return(e=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e}).apply(this,arguments)}function t(){$(ue.body).find(".MathJax_Preview").each((function(){if(0!==$(this).next().next().length){if($(this).next().next().attr("type").length>15)var e="$$"+$(this).next().next().html()+"$$";else e="$"+$(this).next().next().html()+"$";$(this).next().next().replaceWith(e),$(this).next().replaceWith(""),$(this).replaceWith("")}else $(this).parent().remove()})),$(ue.body).find("#MathJax_Message").remove()}function o(){$("#saveToThreadWithCheckDom").modal("hide"),t();var e,o=u(),n=o.type,a=o.id,i=$("#draftId").html(),r=document.getElementById("quoteContent")?document.getElementById("quoteContent").innerHTML:"";try{e=ue.getContent()}catch(t){e=""}var d=r+e||"";d=common.URLifyHTML(d),n&&"forum"!==n||(n="forum");var s={t:geid("title").value.trim(),c:d,l:"html",did:i,desType:n,desTypeId:a},c=$("#sendAnonymousPost");c.length&&(s.anonymous=c.prop("checked"));var l={};if(-1!==["post","thread","forum","redit"].indexOf(n)){try{l=paperProto.paperExport()}catch(e){return void sweetError(e)}for(var m in l)l.hasOwnProperty(m)&&(s[m]=l[m])}s.mainForumsId=[],s.categoriesId=[],$("#newPanelForum").find(".chooseForum").each((function(){var e=$(this).attr("fid");e&&"undefined"!==e&&s.mainForumsId.push(e)})),$("#newPanelForum").find(".chooseCate").each((function(){var e=$(this).attr("cid");e&&"undefined"!==e&&s.categoriesId.push(e)}));var p=$("#userNowId").html();return nkcAPI("/u/"+p+"/drafts","POST",{post:s}).then((function(e){"success"==e.status&&($("#draftId").html(e.did),screenTopAlert("保存成功！"))})).catch((function(e){sweetError(e||e.error),geid("post").disabled=!1}))}var n=NKC.methods.getDataById("postData").targetPost;function a(e){e?$("#post").attr("disabled",!1):$("#post").attr("disabled",!0)}function i(e){var t=$("#sendAnonymousDom"),o=$("#sendAnonymousDom input"),n=$("#sendAnonymousPostInfo");t.length&&o.length&&(e?(o.attr("disabled",!1),o.attr("title",""),n.text("")):(o.prop("checked",!1),o.attr("disabled",!0),n.text("（所选专业分类不支持匿名发表）")))}function r(e){if(!anonymousData||!anonymousData.allowedAnonymousForumsId||0===anonymousData.allowedAnonymousForumsId.length||0===e.length)return!1;for(var t=0;t<e.length;t++){var o=e[t];if(-1!==anonymousData.allowedAnonymousForumsId.indexOf(o))return!0}return!1}function d(){if(!window.ColumnCategoriesDom)return[];var e=ColumnCategoriesDom.getStatus();if(e.checkbox&&0===e.selectedCategoriesId.length){var t=geid("ButtonReply");throw t&&(t.disabled=!1),"请选择专栏文章分类"}return e.selectedCategoriesId}function s(){$("#postToThreadWithCheckDom").modal("hide"),t();var e=u(),o=e.type,n=e.id,a=e.cat,i=(document.getElementById("quoteContent")?document.getElementById("quoteContent").innerHTML:"")+ue.getContent();if(i.length<1)return screenTopWarning("请填写内容");var r=geid("title").value.trim();if("redit"!==o&&"thread"!==o&&"post"!==o&&"application"!==o&&""===r&&"forum_declare"!==o)return screenTopWarning("请填写标题");if(r.length>50)return screenTopWarning("文章标题50字以内");var s,c=$("#draftDelType").html()||"",l=$("#draftDelTypeId").html()||"",m=$("#draftId").html()||"",p=[],h=[];if(!o||"forum"==o||"forum"==c){if($("#newPanelForum").find(".chooseForum").each((function(){var e=$(this).attr("fid");e&&"undefined"!==e&&p.push(e)})),$("#newPanelForum").find(".chooseCate").each((function(){var e=$(this).attr("cid");e&&"undefined"!==e&&h.push(e)})),0===p.length)return screenTopWarning("请选择专业");n=p[0],o="forum",a=h[0]}try{s=w()}catch(e){return screenTopWarning(e)}var f={t:r,c:i,l:"html",did:m,fids:p,cids:h,cat:a,desType:c,desTypeId:l};if(s&&(f.survey=s),"post"===o||"thread"===o||"forum"===o){try{var g=paperProto.paperExport()}catch(e){return void screenTopWarning(e)}try{f.columnCategoriesId=d()}catch(e){return screenTopWarning(e)}for(var y in g)f[y]=g[y]}var C,T,b,P=$("#sendAnonymousPost");if(P.length&&(f.sendAnonymousPost=P.prop("checked")),geid("post").disabled=!0,"post"===o)C="PUT",T="/p/"+n,b={post:f};else if("forum"===o)C="POST",T="/f/"+n,b={post:f};else if("thread"===o)C="POST",T="/t/"+n,b={post:f};else if("application"===o&&"p"===a)C="PUT",T="/fund/a/"+n,b={project:f,s:3};else if("application"===o&&"c"===a)C="POST",T="/fund/a/"+n+"/comment",b={comment:f};else if("application"===o&&"r"===a)C="POST",T="/fund/a/"+n+"/report",b={c:f.c,t:f.t,l:f.l};else if("redit"===o)"thread"===c?(C="POST",T="/t/"+l,b={post:f}):"post"===c&&(C="PUT",T="/p/"+l,b={post:f});else{if("forum_declare"!==o)return geid("post").disabled=!1,screenTopWarning("未知的请求类型："+o);C="PUT",T="/f/"+n+"/settings/info",b={declare:f.c,operation:"updateDeclare"}}try{v()}catch(e){}return nkcAPI(T,C,b).then((function(e){e.redirect?openToNewLocation(e.redirect):"post"===o&&redirect()})).catch((function(e){screenTopWarning(e||e.error),geid("post").disabled=!1}))}function u(){var e=window.location.search.match(/[\d\w]*=[\d\w\/]*/g),t={};if(e)for(var o=0;o<e.length;o++){var n=e[o].split("="),a=n[0],i=n[1];t[a]=i}return t}window.ColumnCategoriesDom=void 0,window.anonymousData=void 0,window.SurveyEdit=void 0,window.SelectUser=void 0,$((function(){NKC.modules.SelectColumnCategories&&(window.ColumnCategoriesDom=new NKC.modules.SelectColumnCategories),NKC.modules.SelectUser&&(window.SelectUser=new NKC.modules.SelectUser),NKC.modules.SurveyEdit&&$("#moduleSurveyEdit").length&&(window.SurveyEdit=new NKC.modules.SurveyEdit,SurveyEdit.init({surveyId:n?n.surveyId:""}),n&&n.surveyId||$("#disabledSurveyButton").show());var e=$("#protocolCheckbox");e.on("change",(function(){a(e.prop("checked"))})),a(e.prop("checked")),$("#sendAnonymousDom").length&&(window.anonymousData=NKC.methods.getDataById("anonymousData"),anonymousData.targetForumsId=anonymousData.targetForumsId||[],i(r(anonymousData.targetForumsId)),setInterval((function(){var e=$("#newPanelForum");if(e.length){var t=[];e.find(".chooseForum").each((function(){var e=$(this).attr("fid");e&&"undefined"!==e&&t.push(e)})),i(r(t))}}),1e3))})),$("#targetPost").length>0?paperProto.init(JSON.parse($("#targetPost").text())):paperProto.init();var c=h("type");"post"==c&&((m=(p=f($("#disnoneplay").html())).match(/<blockquote cite.+?blockquote>/))&&(document.getElementById("quoteContent").innerHTML=m[0],geid("quoteCancel").style.display="inline"),p=p.replace(/<blockquote cite.+?blockquote>/gim,""),ue.ready((function(){ue.setContent(p)})));if("thread"==c){var l=window.localStorage.replyHtml,m=window.localStorage.quoteHtml;ue.ready((function(){ue.setContent(l)})),m&&(document.getElementById("quoteContent").innerHTML=m,geid("quoteCancel").style.display="inline")}"redit"==c&&((m=(p=f($("#disnoneplay").html())).match(/<blockquote cite.+?blockquote>/))&&(document.getElementById("quoteContent").innerHTML=m[0],geid("quoteCancel").style.display="inline"),p=p.replace(/<blockquote cite.+?blockquote>/gim,""),ue.ready((function(){ue.setContent(p)})));if(-1!==["application","forum_declare"].indexOf(c)){var p=f($("#disnoneplay").html());ue.ready((function(){ue.setContent(p)}))}function h(e){var t=document.location.toString().split("?");if(t.length>1){for(var o,n=t[1].split("&"),a=0;a<n.length;a++)if(null!=(o=n[a].split("="))&&o[0]==e)return o[1];return""}return""}function f(e){var t=document.createElement("div");t.innerHTML=e;var o=t.innerText||t.textContent;return t=null,o}function g(e,t,o){var n="";n="jpg"===(t=t.toLowerCase())||"png"===t||"gif"===t||"bmp"===t||"jpeg"===t||"svg"===t?"<p><img src="+e+" width='640'></p>":"mp4"===t?"<video src="+e+" controls style=width:640px;>video</video>":"mp3"===t?"<audio src="+e+" controls>Your browser does not support the audio element</audio>":"<p><a href="+e+"><img src=/default/default_thumbnail.png>"+o+"</a></p>",ue.execCommand("inserthtml",n)}function y(){apiready=function(){var e=api.getPrefs({key:"ueContent",sync:!0});ue.ready((function(){ue.setContent(e)}))}}function v(){api.removePrefs({key:"ueContent"})}function w(){return window.SurveyEdit&&window.SurveyEdit.getSurvey?window.SurveyEdit.getSurvey():""}c||y(),e(window,{articleTransfer:t,saveToThreadWithCheck:function(){var e=ue.options.imgTotal;ue.options.imgCount<e?$("#saveToThreadWithCheckDom").modal("show"):o()},saveDraft:o,disabledPostButtonByProtocol:a,toggleAnonymousDom:i,verifyAnonymousPermission:r,getSelectedColumnCategoriesId:d,postToThreadWithCheck:function(){var e=ue.options.imgTotal;ue.options.imgCount<e?$("#postToThreadWithCheckDom").modal("show"):s()},onPost:s,getSearchKV:u,GetUrlParam:h,htmlDecode:f,mediaInsertUE:g,appUpdateVideo:function(){var e=window.location.protocol+"//"+window.location.host+"/r";$("#attach").css("display","none"),api.getPicture({sourceType:"camera",encodingType:"jpg",mediaValue:"video",destinationType:"url",allowEdit:!1,quality:100,saveToPhotoAlbum:!1,videoQuality:"medium"},(function(t,o){t?(api.toast({msg:"视频正在处理，请稍后...",duration:3e3,location:"bottom"}),api.ajax({url:e,method:"post",timeout:15,headers:{FROM:"nkcAPI"},data:{values:{},files:{file:t.data}}},(function(e,t){e?(g(e.r.rid,e.r.ext,e.r.oname),api.toast({msg:"视频处理完毕",duration:1e3,location:"bottom"})):api.toast({msg:"视频处理失败，请检查当前网络环境...",duration:1e3,location:"bottom"})}))):api.toast({msg:"已取消视频处理",duration:1e3,location:"bottom"})}))},appUpdateImage:function(){var e=window.location.protocol+"//"+window.location.host+"/r";$("#attach").css("display","none"),api.getPicture({sourceType:"camera",encodingType:"jpg",mediaValue:"pic",destinationType:"url",allowEdit:!1,quality:100,saveToPhotoAlbum:!1},(function(t,o){t?(api.toast({msg:"图片正在处理，请稍后...",duration:2e3,location:"bottom"}),api.ajax({url:e,method:"post",timeout:15,headers:{FROM:"nkcAPI"},data:{values:{},files:{file:t.data}}},(function(e,t){e?(g(e.r.rid,e.r.ext,e.r.oname),api.toast({msg:"图片已处理",duration:1e3,location:"bottom"})):(api.toast({msg:"已取消图片处理",duration:1e3,location:"bottom"}),console.log(JSON.stringify(t)))}))):api.toast({msg:"已取消图片处理",duration:1e3,location:"bottom"})}))},appAttachHideOrShow:function(){loadMediaRe(),"block"===$("#attach").css("display")?($("#showOrHideAttach").text("插入图片、媒体、文件"),$("#attach").css("display","none")):($("#showOrHideAttach").text("收起附件管理器"),$("#attach").css("display","block"))},saveUEContentToLocal:function(){var e=ue.getContent();api.setPrefs({key:"ueContent",value:e})},setLocalContentToUE:y,removeLocalContent:v,getSurveyData:w,disabledSurveyForm:function(e){var t=$(e);window.SurveyEdit&&(SurveyEdit.app.disabled?(SurveyEdit.app.disabled=!1,t.text("取消"),t.removeClass("btn-success").addClass("btn-danger")):(SurveyEdit.app.disabled=!0,t.text("创建"),t.removeClass("btn-danger").addClass("btn-success")))}})}));
