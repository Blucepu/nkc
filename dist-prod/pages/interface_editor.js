!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";function e(){return(e=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function t(e){var t="String"==typeof e?document.getElementById(e):e;if("selectionStart"in t){var r=t.selectionEnd-t.selectionStart;return{start:t.selectionStart,end:t.selectionEnd,length:r,text:t.value.substr(t.selectionStart,r)}}if(document.selection){t.focus();var n=document.selection.createRange(),i=t.createTextRange(),a=i.duplicate();if(a.moveToBookmark(n.getBookmark()),i.setEndPoint("EndToStart",a),null===n||null===i)return{start:t.value.length,end:t.value.length,length:0,text:""};var o=n.text.replace(/[\r\n]/g,"."),s=t.value.replace(/[\r\n]/g,".").indexOf(o,i.text.length);return{start:s,end:s+o.length,length:o.length,text:n.text}}return{start:t.value.length,end:t.value.length,length:0,text:""}}function r(e,r,i){var a="string"==typeof e?document.getElementById(e):e;selection=t(e);var o=selection.start,s=o+r.length;return a.value=a.value.substr(0,o)+r+a.value.substr(selection.end,a.value.length),i&&n(e,s,s),{start:o,end:s,length:r.length,text:r}}function n(e,r,n){var a="string"==typeof e?document.getElementById(e):e;if("selectionStart"in a)a.focus(),a.selectionStart=r,a.selectionEnd=n;else if(document.selection){a.focus();var o=a.createTextRange(),s=r;for(i=0;i<s;i++)-1!==a.value.charAt(i).search(/[\r\n]/)&&(r-=.5);for(s=n,i=0;i<s;i++)-1!==a.value.charAt(i).search(/[\r\n]/)&&(n-=.5);o.moveEnd("textedit",-1),o.moveStart("character",r),o.moveEnd("character",n-r),o.select()}return t(e)}function a(){this.parents=geid("parents"),this.children=geid("children"),this.post=geid("post"),this.draft=geid("draft"),this.title=geid("title"),this.content=geid("content")||geid("text-elem"),this.specialMark="",geid("content")?this.specialMark="old":this.specialMark="new",this.threadTypes=geid("threadTypes"),this.postController=geid("postController"),this.language=geid("lang"),this.query=o(),this.blocked=!1,this.update=function(){var e={t:this.title.value.trim(),c:this.content.value,l:this.language?this.language.value.toLowerCase().trim():"html",cat:this.threadTypeID};e.resources=h(e.c);var t=e.t||"";t.length?geid("parsedtitle").style.color="initial":(t="标题为空",geid("parsedtitle").style.color="#ccc"),hset("parsedtitle",t);var r;r=render.experimental_render(e),hset("parsedcontent",r)},this.trigger=function(e){var t=this;t.debounce_timer&&clearTimeout(t.debounce_timer),"old"==this.specialMark&&(t.debounce_timer=setTimeout((function(){t.update()}),300))}.bind(this),this.init=function(){var e=this;this.title.addEventListener("keyup",this.trigger),this.content.addEventListener("keyup",this.trigger),this.post&&(this.post.onclick=c(e)),this.draft&&(this.draft.onclick=s(e),setInterval(s(e),18e4)),this.query.type&&"forum"!==this.query.type&&"redit"!==this.query.type&&(this.blocked=!0)}}function o(){var e=window.location.search.match(/[\d\w]*=[\d\w\/]*/g),t={};if(e)for(var r=0;r<e.length;r++){var n=e[r].split("="),i=n[0],a=n[1];t[i]=a}return t}function s(e){return function(){$(".MathJax_Preview").each((function(){if(0!==$(this).next().next().length){if($(this).next().next().attr("type").length>15)var e="$$"+$(this).next().next().html()+"$$";else e="$"+$(this).next().next().html()+"$";$(this).next().next().replaceWith(e),$(this).next().replaceWith(""),$(this).replaceWith("")}else $(this).parent().remove()}));var t=document.getElementById("quoteContent").innerHTML,r=$("#draftId").html(),n=t+e.content.innerHTML.trim(),i=e.title.value.trim(),a=e.query.type;a&&""!=a||(a="forum");var o=a,s=e.query.id;e.query.cat,e.blocked?e.query.id:e.childID;var c=e.language.value.toLowerCase().trim();if(""!==n.replace(/<[^>]+>/g,"")||"thread"===a||"post"===a||"application"===a||""!==i){geid("parseURL").checked&&("markdown"===c&&(n=common.URLifyMarkdown(n)),"bbcode"!==c&&"pwbb"!==c||(n=common.URLifyBBcode(n)));var l={t:i,c:n,l:c,cat:e.threadTypeID,did:r,desType:o,desTypeId:s},d={};try{d=paperProto.paperExport()}catch(e){return void screenTopWarning(e)}for(var h in d)l[h]=d[h];u();var p=$("#userNowId").html();return nkcAPI("/u/"+p+"/drafts","POST",{post:l}).then((function(t){"success"==t.status&&($("#draftId").html(t.did),screenTopAlert("保存成功！")),t.redirect?redirect(t.redirect):"post"===e.type&&redirect()})).catch((function(e){screenTopWarning(e.error),geid("post").disabled=!1}))}screenTopWarning("请填写内容或标题")}}function c(e){return function(){var t=e.specialMark;$(".MathJax_Preview").each((function(){if(0!==$(this).next().next().length){if($(this).next().next().attr("type").length>15)var e="$$"+$(this).next().next().html()+"$$";else e="$"+$(this).next().next().html()+"$";$(this).next().next().replaceWith(e),$(this).next().replaceWith(""),$(this).replaceWith("")}else $(this).parent().remove()}));var r=document.getElementById("quoteContent")?document.getElementById("quoteContent").innerHTML:"";if("old"==t)var n=e.content.value;else n=r+e.content.innerHTML.trim();var i=$("#draftDelType").html()||"",a=$("#draftDelTypeId").html()||"",o=$("#draftId").html()||"",s=e.title.value.trim(),c=e.query.type,l=e.query.cat,d=[],h=[],u=e.blocked?e.query.id:e.childID;if("forum"!==c&&c&&"forum"!==i)e.blocked&&(u=e.query.id);else{var p=$("#tabPanel").tagsinput("items");if(0==p.length)return void screenTopWarning("请选择专业");for(var f=0;f<p.length;f++)if(-1==d.indexOf(p[f].fid)&&d.push(p[f].fid),""!==p[f].cid){var g=p[f].cid.substr(1);-1==h.indexOf(g)&&h.push(g)}u=d[0],l=h[0],c="forum"}var v=e.language?e.language.value.toLowerCase().trim():"html";if(""!==n){if("redit"===c||"thread"===c||"post"===c||"application"===c||""!==s||"forum_declare"===c){geid("parseURL").checked&&(n="markdown"===v?common.URLifyMarkdown(n):"bbcode"===v||"pwbb"===v?common.URLifyBBcode(n):common.URLifyHTML(n));var m,y,x,T={t:s,c:n,l:v||"html",did:o,fids:d,cids:h,cat:l,mid:e.query.mid,desType:i,desTypeId:a};if(!("post"!=c&&"thread"!=c&&"forum"!=c||t&&"new"!=t)){var w;try{w=paperProto.paperExport()}catch(e){return void screenTopWarning(e)}for(var b in w)T[b]=w[b]}if(e.post.disabled=!0,"post"===c)m="PUT",y="/p/"+u,x={post:T};else if("forum"===c)m="POST",y="/f/"+u,x={post:T};else if("thread"===c)m="POST",y="/t/"+u,x={post:T};else if("application"===c&&"p"===l)m="PUT",y="/fund/a/"+u,x={project:T,s:3};else if("application"===c&&"c"===l)m="POST",y="/fund/a/"+u+"/comment",x={comment:T};else if("application"===c&&"r"===l)m="POST",y="/fund/a/"+u+"/report",x={c:T.c,t:T.t,l:T.l};else if("redit"===c)"thread"===i?(m="POST",y="/t/"+a,x={post:T}):"post"===i&&(m="PUT",y="/p/"+a,x={post:T});else{if("forum_declare"!==c)return screenTopWarning("未知的请求类型："+c);m="PUT",y="/f/"+u+"/settings/info",x={declare:T.c,operation:"updateDeclare"}}return nkcAPI(y,m,x).then((function(t){t.redirect?redirect(t.redirect):"post"===e.type&&redirect()})).catch((function(e){screenTopWarning(e||e.error),geid("post").disabled=!1}))}screenTopWarning("请填写标题。")}else screenTopWarning("请填写内容。")}}function l(e){var t=document.createTextNode(e),r=document.createElement("option");return r.appendChild(t),r}$((function(){var e=new a;e.init(),window.editor=e;var t=geid("content");0===$("#text-elem").length&&geid("proxy").addEventListener("click",(function(e){r(t,e.target.getAttribute("data-unicode"),!0)}))})),$("document").ready((function(){$(".w-e-text-container").css("height","300px"),0!==$(".w-e-text-container").length&&($(".w-e-text-container").resizable({containment:"#body",minHeight:100,minWidth:100,maxWidth:1400}),$("#content_test").on("paste",(function(){setTimeout((function(){$("#text-elem img[srcs]").each((function(){if(!$(this).attr("srcs"))return!0;var e=$(this).attr("srcs"),t="<img src='"+e+"'>";if(-1!==e.indexOf("kechuang"))return $(this).replaceWith(t),!0;if(1==new RegExp("file:").test(e))return $(this).replaceWith("<img src='/resources/site_specific/picdefault.png'>"),!0;if(e.length>10){var r={loadsrc:e},n=$(this);nkcAPI("/download","POST",r).then((function(e){n.attr("src",""),n.attr("srcs","");var t="<img src='/r/"+e.r.rid+"' style='max-width: 100%'>";n.replaceWith(t),list&&list.refresh()})).catch((function(e){n.attr("src",""),n.attr("srcs",""),n.replaceWith("<img src='/resources/site_specific/picdefault.png'>")}))}}))}),5e3)})))}));var d=!1;function h(e){if(render&&render.resource_extractor&&window.list&&window.list.rlist){var t=e.match(render.resource_extractor);if(t){var r=[];return t.map((function(e){var t=e.replace(render.resource_extractor,"$1");window.list.rlist.map((function(e){e.rid==t&&r.push(e)}))})),r}}}function u(){MathJax&&MathJax.Hub.PreProcess(geid("text-elem"),(function(){MathJax.Hub.Process(geid("text-elem"))})),hljs&&ReHighlightEverything()}e(window,{dataURItoBlob:function(e){var t;t=e.split(",")[0].indexOf("base64")>=0?atob(e.split(",")[1]):unescape(e.split(",")[1]);for(var r=e.split(",")[0].split(":")[1].split(";")[0],n=new Uint8Array(t.length),i=0;i<t.length;i++)n[i]=t.charCodeAt(i);return new Blob([n],{type:r})},get_selection:t,replace_selection:r,set_selection:n,Editor:a,getSearchKV:o,blockOnChange:function(e){return function(){var t="block";e.postController.style.display===t?e.postController.style.display="none":e.postController.style.display=t}},threadTypesOnChange:function(e){return function(){var t=e.forumsList,r=e.parents.value,n=e.children.value,i=e.threadTypes.value;for(var a in e.threadTypeID=void 0,t)if(t[a].displayName===r){var o=t[a];for(var s in o.children)if(o.children[s].displayName===n){var c=o.children[s].threadTypes;for(var l in c)c[l].name===i&&(e.threadTypeID=c[l].cid)}}}},childrenOnChange:function(e){return function(){var t=e.forumsList,r=e.parents.value,n=e.children.value;e.childID=void 0;var i=e.threadTypes.childNodes;for(e.threadTypes.value=e.threadTypesDefault;i.length>2;)e.threadTypes.removeChild(i[i.length-1]);for(var a in t)if(t[a].displayName===r){var o=t[a];for(var s in o.children){var c=o.children[s];if(c.displayName===n){e.childID=c.fid,e.query.type="forum";var d=c.threadTypes,h=e.threadTypes.lastChild;for(var u in d)e.threadTypes.insertBefore(l(d[u].name),h);e.threadTypes.insertBefore(h,e.threadTypes[0])}}}e.childID||screenTopWarning("在当前学院下未找到所选专业,请重新选择.")}},parentsOnChange:function(e){return function(){var t=e.parents.value,r=e.forumsList,n=e.children;e.children.value=e.childrenDefault,e.parentID=void 0;for(var i=n.childNodes;i.length>2;)n.removeChild(i[i.length-1]);for(var a in r){var o=r[a];if(o.displayName===t){e.parentID=o.fid;var s=n.lastChild;for(var c in r[a].children)n.insertBefore(l(r[a].children[c].displayName),s);n.insertBefore(n.lastChild,n[0])}}}},saveDraft:s,onPost:c,groupingForums:function(e){for(var t in e.sort((function(e,t){return e.order-t.order})),e)e[t].children&&e[t].children.sort((function(e,t){return e.order-t.order}));return e},createOption:l,mathfresh:function(){MathJax&&MathJax.Hub.PreProcess(geid("parsedcontent"),(function(){MathJax.Hub.Process(geid("parsedcontent"))})),hljs&&ReHighlightEverything()},fitscreen:function(){var e=$(window).height().toString()+"px";geid("content").style.height=d?"300px":e,geid("parsedcontent").style["max-height"]=d?"800px":e,d=!d},extract_resource_from_tag:h,mathfreshnew:u,mathfresha1:function(){$("#editora2").html($("#editora1").val()),MathJax&&MathJax.Hub.PreProcess(geid("editora2"),(function(){MathJax.Hub.Process(geid("editora2"))})),hljs&&ReHighlightEverything()},reedit:function(e){$(".w-e-icon-math").click(),$(e).find("script").attr("type").length<15?$("#editora1").val("$"+$(e).find("script").html()+"$"):$("#editora1").val("$$"+$(e).find("script").html()+"$$"),$(e).addClass("righteditor"),window.localStorage.pMark="1"},fitscreennew:function(){var e=$(window).height().toString()+"px";geid("content").style.height=d?"300px":e,geid("parsedcontent").style["max-height"]=d?"800px":e,d=!d},cancelQuote:function(){geid("quoteContent").innerHTML="",geid("quoteCancel").style.display="none"}})}));
