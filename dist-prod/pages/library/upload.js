!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";var e,r,o,t=NKC.methods.getDataById("data");t.forum;var i=new Vue({el:"#app",data:{resource:"",name:"",description:"",category:"",labels:[],forums:t.forum?[t.forum]:[],submitting:!1,file:"",cover:"",coverUrl:"",coverData:""},computed:{forumsId:function(){for(var e=this.forums,r=[],o=0;o<e.length;o++)r.push(e[o].fid);return r}},mounted:function(){window.SelectResource=new NKC.modules.SelectResource,window.SelectForum=new NKC.modules.MoveThread,window.SelectImage=new NKC.methods.selectImage,t.rid&&this.getResource(t.rid)},methods:{getSize:NKC.methods.tools.getSize,format:NKC.methods.format,removeResourceFromLibrary:removeResourceFromLibrary,removeForum:function(e){this.forums.splice(e,1)},sr:function(){var r=this;e.open((function(e){var o=e.resources[0];Promise.resolve().then((function(){if(o.forumsId.length)return sweetQuestion("已选文件已经被添加到文库了，已输入内容将会被该文件的信息覆盖。确认要继续？")})).then((function(){r.getResource(e.resourcesId[0])}))}),{countLimit:1,allowedExt:["attachment","video","audio"]})},sc:function(){var r=this;e.open((function(e){var t,i=e.resources[0];t=i.originId?"/ro/"+i.originId:"/r/"+i.rid,o.show((function(e){r.coverData=e,NKC.methods.fileToUrl(NKC.methods.blobToFile(e)).then((function(e){r.coverUrl=e,o.close()}))}),{url:t})}),{countLimit:1,allowedExt:["picture"]})},sf:function(){var e=this;r.open((function(o){for(var t=[],i=0;i<o.forums.length;i++){var n=o.forums[i];t.push({fid:n.fid,displayName:n.fName,color:n.color})}e.forums=t,r.close()}),{selectedForumsId:this.forumsId,hideMoveType:!0})},slf:function(){var e=document.getElementById("localFile").files;if(e.length){var r=e[0];if(r.size>209715200)return sweetError("文件大小不能超过200MB");this.resource={oname:r.name,size:r.size,toc:r.lastModified},this.name||(this.name=this.resource.oname),this.file=r}},inForums:function(e){for(var r=this.forums,o=!1,t=0;t<r.length;t++){if(r[t].fid===e.fid){o=!0;break}}return o},clearCover:function(){this.cover="",this.coverUrl="",this.coverData=""},getResource:function(e){var r=this;nkcAPI("/r/"+e+"/info","GET").then((function(e){var o=e.resource;if(r.resource=e.resource,o.category){r.cover=o.cover,r.category=e.resource.category,r.forums=t.forum?[t.forum]:[];for(var i=0;i<e.forums.length;i++){var n=e.forums[i];r.inForums(n)||r.forums.push(n)}r.name=r.resource.name||r.resource.oname,r.description=r.resource.description}})).catch((function(e){sweetError(e)}))},submit:function(){var e=this;e.submitting=!0;var r={},o=new FormData;Promise.resolve().then((function(){if(!e.resource)throw"请选择文件";if(!e.category)throw"请选择文件类型";if(!e.name)throw"请输入文件名称";if(!e.description)throw"请输入文件说明";if(!e.forums.length)throw"请选择专业领域";r.name=e.name,r.category=e.category,r.description=e.description,r.forumsId=[];for(var t=0;t<e.forums.length;t++)r.forumsId.push(e.forums[t].fid);if(e.resource.rid&&(r.rid=e.resource.rid),e.coverData?o.append("cover",e.coverData):e.cover&&(r.cover=e.cover),!e.resource.rid){var i=new FormData;return i.append("file",e.file),nkcUploadFile("/r","POST",i)}})).then((function(e){if(e){if("mediaPicture"===e.r.mediaType)throw"暂不支持将图片上传到文库";r.rid=e.r.rid}return o.append("body",JSON.stringify(r)),nkcUploadFile("/library","POST",o)})).then((function(){e.submitting=!1,sweetSuccess("提交成功"),t.forum&&setTimeout((function(){NKC.methods.visitUrl("/f/"+t.forum.fid+"/library")}),2e3)})).catch((function(r){e.submitting=!1,sweetError(r)}))}}});window.app=i}));
