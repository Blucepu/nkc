// - var url = '/t/' + thread.tid
// - var ocUser = thread.firstPost.user||{}
// - var lmUser = thread.lastPost.user||{}
// - var oc = thread.firstPost
// - var avatar = '/avatar_small/' + oc.uid
// - var uid = oc.uid
// - var digest = thread.digest
// -var hasFile = thread.hasFile
// -var hasImage = thread.hasImage
// -var topped = thread.topped
// -var belong_forum = null; var pf=null
// -if(data.forum&&data.forum.type!='forum'&&data.forumList)
//   -data.forumList.map(group=>{group.children.map(f=>{if(f.fid==thread.fid){belong_forum=f;pf=group;}})})
//   -var forumcolor = (belong_forum?belong_forum.color:null)||(pf?pf.color:null)||'#aaa'
//
// -if(data.forumListkv)
//   -var v = data.forumListkv[thread.fid]||{}
//   -belong_forum = v.belong_forum;pf = v.pf; var forumcolor = v.color;
//   //span #{belong_forum._key}
//   //span #{thread.fid}
//
// -var threadtype = data.threadTypes?data.threadTypes.filter(k=>k.cid==thread.cid)[0]:null;
// .ForumThreadItem
//   .parent.clearfix(id='')
//     .avatar-left
//       - var title = '';
//       -if(ocUser && ocUser.navbarDesc)
//         - var navbarDesc = ocUser.navbarDesc;
//         -title = `${navbarDesc.username}\n`+`学术分 ${navbarDesc.xsf}\n`+`科创币 ${navbarDesc.kcb}\n`+`${navbarDesc.cs}`;
//       a(href=`/m/${uid}` title=`${title}`)
//         img.ForumThreadAvatar(src=`/avatar/${uid}`)
//
//     .content-right
//       .ForumThreadTitle
//         .ForumThreadTitle1(style="float:left;width:77%;")
//           - var brief = oc.c.replace(/\[.*?]/g,'').trim().slice(0,100)
//           //span.f12.ForumThreadDigestText [精]
//           if belong_forum && (belong_forum.fid!==(data.forum?data.forum.fid:null))
//             a.ForumThreadHasImage(style=`background-color:${forumcolor};` href=`/f/${belong_forum.fid}`)
//               | #{belong_forum.abbr||belong_forum.displayName}
//
//           if threadtype
//             a.ForumThreadHasImage(href=`/f/${thread.fid}?cat=${threadtype.cid}` style=`background-color:${forumcolor};`) #{threadtype.name}
//
//           a(class=`${digest?"ForumThreadDigestText":"ForumThreadNormal"}` href=`${url}` title=`${brief}`) #{oc.t}
//
//           if topped
//             span.ForumThreadHasImage.ForumThreadTopped 顶
//           if hasImage
//             span.ForumThreadHasImage 图
//           if hasFile
//             span.ForumThreadHasImage.ForumThreadHasFile 附
//
//         .ForumThreadTitle2(style="float:right;width:21%;")
//           .ForumThreadTitle22(style="float:right;")
//             -var count = (thread.count_remain||thread.count)-1
//             -var hits = thread.hits
//             if hits
//               .ForumThreadStat
//                 span.ThreadHits 浏览:#{thread.hits}
//             if count
//               .ForumThreadStat
//                 span.ThreadCount 回复:#{count}
//             else
//               .ForumThreadStat
//                 span.ThreadCount 回复:0
//
//             .ForumThreadTitle3(style="display:inline-block;")
//               if(item && item.cid)
//                 input.ThreadCheckboxes(id=`${item.cid}` type='checkbox' style=`${showTicks?'':'display:none;'}`)
//               else
//                 input.ThreadCheckboxes(id=`${(item?item.tid:null)||thread.tid}` type='checkbox' style=`${showTicks?'':'display:none;'}`)
//
//
//
//
//           //span.lighttext cat#{thread.category}
//
//           //帖子标题链接
//           //span.hidden-xs.lighttext (#{oc.c.length} 字节，#{thread.hits} 点击)
//
//
//       .ForumThreadCreatorInfo(style="width:50%!important;")
//
//         if 1
//           span.hidden-xs.lighttext.ForumThreadItemCreationTime #{dateTimeString(thread.toc).split(' ')[0]} from
//
//         a.ForumThreadItemUsername(href=`/m/${ocUser.uid}`) #{ocUser.username}
//
//         if Date.now()-thread.tlm<86400000
//           span.lighttext.reddish #{fromNow(thread.tlm)}
//         else
//           span.lighttext #{fromNow(thread.tlm)}
//           //帖子最后回复时间和回复者
//
//         span.lighttext(style='margin-right:7px;')   by
//         a.ForumThreadItemUsername(href=`/m/${lmUser.uid}`) #{lmUser.username}
//
-const {firstPost, lastPost} = thread
-const {t, resources, toc, tid} = firstPost;
-const targetUser = firstPost.user;
-let childrenForum;
-let parentForum;
-data.forumList.map(p => {if(p.children){p.children.map(c => {if (c.fid === firstPost.fid) {childrenForum = c;parentForum = p}})}});
.new-content(style='overflow: hidden')
  .new-content-info
    span
      a(href=`/m/${targetUser.uid}`)
        img(src=`/avatar_small/${targetUser.uid}`)
    span
      a(href=`/m/${targetUser.uid}`)= targetUser.username
    if(parentForum)
      span.new-content-forumAbbr(style=`background-color:${parentForum.color};`)
        a(href=`/f/${parentForum.fid}`)= parentForum.displayName
    if(childrenForum)
      span.new-content-forumAbbr(style=`background-color:${childrenForum.color};`)
        a(href=`/f/${childrenForum.fid}`)= childrenForum.abbr
    span.icon-font=fromNow(toc)
    if thread
      span(title=`${thread.hits}次浏览`)
        span.glyphicon.glyphicon-eye-open.icon
        span.icon-font=thread.hits
      span(title=`${thread.count}条回复`)
        span.glyphicon.glyphicon-comment.icon
        span.icon-font=(thread.count-1)
    else
      span(title=`${firstPost.recUsers.length}次点赞`)
        span.glyphicon.glyphicon-heart.icon
        span.icon-font=firstPost.recUsers.length
  .new-content-title
    -let digest = '';
    if thread && thread.digest
      -digest = 'digest-thread-title';
    a.ForumThreadNormal(class=digest href=`/t/${tid}`)
      span #{t}
    -const pageCount = thread.count / 30
    span(style='margin-left: 1rem; margin-right: 1rem;') >>>
    -let ellipsis = false
    - for(let i = 0; i < pageCount; i++)
      if(i < 3 || i > pageCount - 3)
        a(href=`/t/${thread.tid}?&page=${i}` style='font-size: 14px; text-decoration: none; font-weight: normal;')
          span(style='padding-left: 0.5rem; padding-right: 0.5rem; margin: 0.3rem; background-color: cyan; color: white; border-radius: 0.4rem;') #{i + 1}
      else if(!ellipsis)
        -ellipsis = true
        span(style='padding-left: 0.5rem; padding-right: 0.5rem; margin: 0.3rem; background-color: cyan; color: white; border-radius: 0.4rem;') ...
  .new-content-body
    -let imgId;
    -const imgArr = ['jpg', 'png', 'jpeg'];
    -for(let r of resources)
      if(imgArr.includes(r.ext))
        -imgId = r.rid;
        -break;
    if imgId
      .new-content-left.fixed-height(style=`background-image: url(/r/${imgId})`)
    .new-content-right(class=imgId?'div-img fixed-height': 'div-noImg')
      p(class=imgId?'p-img': 'p-noImg')
        a(href=`/t/${tid}?&last_page=true#${lastPost.pid}` style='text-decoration: none; color: inherit;')!= replaceContent(experimental_render(lastPost))
  .new-content-info(style='float: right;')
    span.icon-font=fromNow(toc)
    span
      a(href=`/m/${lastPost.user.uid}`)
        img(src=`/avatar_small/${lastPost.user.uid}`)
    span
      a(href=`/m/${lastPost.user.uid}`)= lastPost.user.username
hr