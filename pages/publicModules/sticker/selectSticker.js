(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
"use strict";

NKC.modules.SelectSticker = function () {
  var self = this;
  self.dom = $("#moduleSelectSticker");
  self.app = new Vue({
    el: "#moduleSelectStickerApp",
    data: {
      type: "own",
      pageNumber: "",
      perpage: 20,
      sharePerpage: 24,
      emoji: [],
      share: false,
      localStickers: [],
      stickers: [],
      paging: {}
    },
    mounted: function mounted() {},
    methods: {
      getUrl: NKC.methods.tools.getUrl,
      initModule: function initModule() {
        var height = "43.5rem";
        self.dom.css({
          height: height
        });
        self.dom.draggable({
          scroll: false,
          handle: ".module-ss-title",
          drag: function drag(event, ui) {
            if (ui.position.top < 0) ui.position.top = 0;
            var height = $(window).height();
            if (ui.position.top > height - 30) ui.position.top = height - 30;
            var width = self.dom.width();
            if (ui.position.left < 100 - width) ui.position.left = 100 - width;
            var winWidth = $(window).width();
            if (ui.position.left > winWidth - 100) ui.position.left = winWidth - 100;
          }
        });
      },
      resetDomPosition: function resetDomPosition() {
        var dom = self.dom;
        var width = $(window).width();
        var height = $(window).height();

        if (width < 700) {
          // 小屏幕
          dom.css({
            "width": width * 0.8,
            "top": 0,
            "right": 0
          });
        } else {
          // 宽屏
          dom.css("left", (width - dom.width()) * 0.5 - 40);
        }
      },
      selectType: function selectType(type) {
        this.type = type;

        if (["own", "share"].includes(type)) {
          this.getStickers();
        }
      },
      changePage: function changePage(type) {
        var paging = this.paging;
        if (paging.buttonValue.length <= 1) return;
        if (type === "last" && paging.page === 0) return;
        if (type === "next" && paging.page + 1 === paging.pageCount) return;
        var count = type === "last" ? -1 : 1;
        this.getStickers(paging.page + count);
      },
      getStickers: function getStickers() {
        var page = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 0;
        var type = this.type;
        if (!["own", "share"].includes(type)) return;
        var url = "/sticker?page=".concat(page, "&c=own&reviewed=true&perpage=").concat(this.perpage);

        if (type === "share") {
          url = "/stickers?page=".concat(page, "&perpage=").concat(this.sharePerpage);
        }

        console.log(url);
        nkcAPI(url, "GET").then(function (data) {
          self.app.stickers = data.stickers;
          self.app.paging = data.paging;

          if (data.emoji) {
            self.app.emoji = data.emoji;
          }
        })["catch"](sweetError);
      },
      fastSelectPage: function fastSelectPage() {
        var pageNumber = this.pageNumber - 1;
        var paging = this.paging;
        if (!paging || !paging.buttonValue.length) return;
        var lastNumber = paging.buttonValue[paging.buttonValue.length - 1].num;
        if (pageNumber < 0 || lastNumber < pageNumber) return sweetInfo("输入的页数超出范围");
        this.getStickers(pageNumber);
      },
      selectSticker: function selectSticker(sticker) {
        self.callback({
          type: "sticker",
          data: sticker
        });
      },
      selectEmoji: function selectEmoji(emojiCode, index) {
        self.callback({
          type: "emoji",
          data: emojiCode
        });
      },
      addLocalFile: function addLocalFile(file) {
        this.fileToSticker(file).then(function (sticker) {
          self.app.localStickers.push(sticker);
          self.app.uploadLocalSticker(sticker);
        });
      },
      fileToSticker: function fileToSticker(file) {
        return new Promise(function (resolve, reject) {
          var sticker = {
            file: file
          };
          sticker.status = "unUploaded";
          sticker.progress = 0;
          NKC.methods.fileToUrl(file).then(function (base64) {
            sticker.url = base64;
            resolve(sticker);
          })["catch"](reject);
        });
      },
      selectedLocalFile: function selectedLocalFile() {
        var input = $("#moduleSelectStickerInput");
        var files = input[0].files;

        for (var i = 0; i < files.length; i++) {
          var file = files[i];
          self.app.addLocalFile(file);
        }
      },
      selectLocalFile: function selectLocalFile() {
        $("#moduleSelectStickerInput").click();
      },
      uploadLocalSticker: function uploadLocalSticker(sticker) {
        Promise.resolve().then(function () {
          sticker.status = "uploading";
          var formData = new FormData();
          formData.append("file", sticker.file);
          formData.append("type", "sticker");
          formData.append("fileName", sticker.file.name);

          if (self.app.share) {
            formData.append("share", "true");
          }

          return nkcUploadFile("/r", "POST", formData, function (e, progress) {
            sticker.progress = progress;
          });
        }).then(function () {
          sticker.status = "uploaded";
          self.app.localStickers.splice(self.app.localStickers.indexOf(sticker), 1);
          if (!self.app.localStickers.length) self.app.selectType("own");
        })["catch"](function (data) {
          screenTopWarning(data.error || data);
          sticker.error = data.error || data;
          sticker.status = "unUploaded";
        });
      },
      restartUpload: function restartUpload(s) {
        this.uploadLocalSticker(s);
      },
      open: function open(callback, options) {
        self.callback = callback;
        this.resetDomPosition();
        this.initModule();
        self.dom.show();
        this.getStickers();
      },
      close: function close() {
        self.dom.hide();
      }
    }
  });
  self.open = self.app.open;
  self.close = self.app.close;
};

},{}]},{},[1])
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9fYnJvd3Nlci1wYWNrQDYuMS4wQGJyb3dzZXItcGFjay9fcHJlbHVkZS5qcyIsInBhZ2VzL3B1YmxpY01vZHVsZXMvc3RpY2tlci9zZWxlY3RTdGlja2VyLm1qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7O0FDQUEsR0FBRyxDQUFDLE9BQUosQ0FBWSxhQUFaLEdBQTRCLFlBQVc7QUFDckMsTUFBSSxJQUFJLEdBQUcsSUFBWDtBQUNBLEVBQUEsSUFBSSxDQUFDLEdBQUwsR0FBVyxDQUFDLENBQUMsc0JBQUQsQ0FBWjtBQUNBLEVBQUEsSUFBSSxDQUFDLEdBQUwsR0FBVyxJQUFJLEdBQUosQ0FBUTtBQUNqQixJQUFBLEVBQUUsRUFBRSx5QkFEYTtBQUVqQixJQUFBLElBQUksRUFBRTtBQUNKLE1BQUEsSUFBSSxFQUFFLEtBREY7QUFFSixNQUFBLFVBQVUsRUFBRSxFQUZSO0FBR0osTUFBQSxPQUFPLEVBQUUsRUFITDtBQUlKLE1BQUEsWUFBWSxFQUFFLEVBSlY7QUFLSixNQUFBLEtBQUssRUFBRSxFQUxIO0FBTUosTUFBQSxLQUFLLEVBQUUsS0FOSDtBQU9KLE1BQUEsYUFBYSxFQUFFLEVBUFg7QUFRSixNQUFBLFFBQVEsRUFBRSxFQVJOO0FBU0osTUFBQSxNQUFNLEVBQUU7QUFUSixLQUZXO0FBYWpCLElBQUEsT0FBTyxFQUFFLG1CQUFZLENBRXBCLENBZmdCO0FBZ0JqQixJQUFBLE9BQU8sRUFBRTtBQUNQLE1BQUEsTUFBTSxFQUFFLEdBQUcsQ0FBQyxPQUFKLENBQVksS0FBWixDQUFrQixNQURuQjtBQUVQLE1BQUEsVUFGTyx3QkFFTTtBQUNYLFlBQUksTUFBTSxHQUFHLFNBQWI7QUFDQSxRQUFBLElBQUksQ0FBQyxHQUFMLENBQVMsR0FBVCxDQUFhO0FBQ1gsVUFBQSxNQUFNLEVBQUU7QUFERyxTQUFiO0FBR0EsUUFBQSxJQUFJLENBQUMsR0FBTCxDQUFTLFNBQVQsQ0FBbUI7QUFDakIsVUFBQSxNQUFNLEVBQUUs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QyxJQUFMLEdBQVksSUFBSSxDQUFDLEdBQUwsQ0FBUyxJQUFyQjtBQUNBLEVBQUEsSUFBSSxDQUFDLEtBQUwsR0FBYSxJQUFJLENBQUMsR0FBTCxDQUFTLEtBQXRCO0FBQ0QsQ0F4TEQiLCJmaWxlIjoiZ2VuZXJhdGVkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXNDb250ZW50IjpbIihmdW5jdGlvbigpe2Z1bmN0aW9uIHIoZSxuLHQpe2Z1bmN0aW9uIG8oaSxmKXtpZighbltpXSl7aWYoIWVbaV0pe3ZhciBjPVwiZnVuY3Rpb25cIj09dHlwZW9mIHJlcXVpcmUmJnJlcXVpcmU7aWYoIWYmJmMpcmV0dXJuIGMoaSwhMCk7aWYodSlyZXR1cm4gdShpLCEwKTt2YXIgYT1uZXcgRXJyb3IoXCJDYW5ub3QgZmluZCBtb2R1bGUgJ1wiK2krXCInXCIpO3Rocm93IGEuY29kZT1cIk1PRFVMRV9OT1RfRk9VTkRcIixhfXZhciBwPW5baV09e2V4cG9ydHM6e319O2VbaV1bMF0uY2FsbChwLmV4cG9ydHMsZnVuY3Rpb24ocil7dmFyIG49ZVtpXVsxXVtyXTtyZXR1cm4gbyhufHxyKX0scCxwLmV4cG9ydHMscixlLG4sdCl9cmV0dXJuIG5baV0uZXhwb3J0c31mb3IodmFyIHU9XCJmdW5jdGlvblwiPT10eXBlb2YgcmVxdWlyZSYmcmVxdWlyZSxpPTA7aTx0Lmxlbmd0aDtpKyspbyh0W2ldKTtyZXR1cm4gb31yZXR1cm4gcn0pKCkiLCJOS0MubW9kdWxlcy5TZWxlY3RTdGlja2VyID0gZnVuY3Rpb24oKSB7XHJcbiAgdmFyIHNlbGYgPSB0aGlzO1xyXG4gIHNlbGYuZG9tID0gJChcIiNtb2R1bGVTZWxlY3RTdGlja2VyXCIpO1xyXG4gIHNlbGYuYXBwID0gbmV3IFZ1ZSh7XHJcbiAgICBlbDogXCIjbW9kdWxlU2VsZWN0U3RpY2tlckFwcFwiLFxyXG4gICAgZGF0YToge1xyXG4gICAgICB0eXBlOiBcIm93blwiLFxyXG4gICAgICBwYWdlTnVtYmVyOiBcIlwiLFxyXG4gICAgICBwZXJwYWdlOiAyMCxcclxuICAgICAgc2hhcmVQZXJwYWdlOiAyNCxcclxuICAgICAgZW1vamk6IFtdLFxyXG4gICAgICBzaGFyZTogZmFsc2UsXHJcbiAgICAgIGxvY2FsU3RpY2tlcnM6IFtdLFxyXG4gICAgICBzdGlja2VyczogW10sXHJcbiAgICAgIHBhZ2luZzoge31cclxuICAgIH0sXHJcbiAgICBtb3VudGVkOiBmdW5jdGlvbiAoKSB7XHJcbiAgICBcclxuICAgIH0sXHJcbiAgICBtZXRob2RzOiB7XHJcbiAgICAgIGdldFVybDogTktDLm1ldGhvZHMudG9vbHMuZ2V0VXJsLFxyXG4gICAgICBpbml0TW9kdWxlKCkge1xyXG4gICAgICAgIHZhciBoZWlnaHQgPSBcIjQzLjVyZW1cIjtcclxuICAgICAgICBzZWxmLmRvbS5jc3Moe1xyXG4gICAgICAgICAgaGVpZ2h0OiBoZWlnaHRcclxuICAgICAgICB9KTtcclxuICAgICAgICBzZWxmLmRvbS5kcmFnZ2FibGUoe1xyXG4gICAgICAgICAgc2Nyb2xsOiBmYWxzZSxcclxuICAgICAgICAgIGhhbmRsZTogXCIubW9kdWxlLXNzLXRpdGxlXCIsXHJcbiAgICAgICAgICBkcmFnOiBmdW5jdGlvbihldmVudCwgdWkpIHtcclxuICAgICAgICAgICAgaWYodWkucG9zaXRpb24udG9wIDwgMCkgdWkucG9zaXRpb24udG9wID0gMDtcclxuICAgICAgICAgICAgdmFyIGhlaWdodCA9ICQod2luZG93KS5oZWlnaHQoKTtcclxuICAgICAgICAgICAgaWYodWkucG9zaXRpb24udG9wID4gaGVpZ2h0IC0gMzApIHVpLnBvc2l0aW9uLnRvcCA9IGhlaWdodCAtIDMwO1xyXG4gICAgICAgICAgICB2YXIgd2lkdGggPSBzZWxmLmRvbS53aWR0aCgpO1xyXG4gICAgICAgICAgICBpZih1aS5wb3NpdGlvbi5sZWZ0IDwgMTAwIC0gd2lkdGgpIHVpLnBvc2l0aW9uLmxlZnQgPSAxMDAgLSB3aWR0aDtcclxuICAgICAgICAgICAgdmFyIHdpbldpZHRoID0gJCh3aW5kb3cpLndpZHRoKCk7XHJcbiAgICAgICAgICAgIGlmKHVpLnBvc2l0aW9uLmxlZnQgPiB3aW5XaWR0aCAtIDEwMCkgdWkucG9zaXRpb24ubGVmdCA9IHdpbldpZHRoIC0gMTAwO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9LFxyXG4gICAgICByZXNldERvbVBvc2l0aW9uOiBmdW5jdGlvbigpIHtcclxuICAgICAgICB2YXIgZG9tID0gc2VsZi5kb207XHJcbiAgICAgICAgdmFyIHdpZHRoID0gJCh3aW5kb3cpLndpZHRoKCk7XHJcbiAgICAgICAgdmFyIGhlaWdodCA9ICQod2luZG93KS5oZWlnaHQoKTtcclxuICAgICAgICBpZih3aWR0aCA8IDcwMCkge1xyXG4gICAgICAgICAgLy8g5bCP5bGP5bmVXHJcbiAgICAgICAgICBkb20uY3NzKHtcclxuICAgICAgICAgICAgXCJ3aWR0aFwiOiB3aWR0aCAqIDAuOCxcclxuICAgICAgICAgICAgXCJ0b3BcIjogMCxcclxuICAgICAgICAgICAgXCJyaWdodFwiOiAwXHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgLy8g5a695bGPXHJcbiAgICAgICAgICBkb20uY3NzKFwibGVmdFwiLCAod2lkdGggLSBkb20ud2lkdGgoKSkqMC41IC0gIDQwKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0sXHJcbiAgICAgIHNlbGVjdFR5cGUodHlwZSkge1xyXG4gICAgICAgIHRoaXMudHlwZSA9IHR5cGU7XHJcbiAgICAgICAgaWYoW1wib3duXCIsIFwic2hhcmVcIl0uaW5jbHVkZXModHlwZSkpIHtcclxuICAgICAgICAgIHRoaXMuZ2V0U3RpY2tlcnMoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0sXHJcbiAgICAgIGNoYW5nZVBhZ2UodHlwZSkge1xyXG4gICAgICAgIGNvbnN0IHBhZ2luZyA9IHRoaXMucGFnaW5nO1xyXG4gICAgICAgIGlmKHBhZ2luZy5idXR0b25WYWx1ZS5sZW5ndGggPD0gMSkgcmV0dXJuO1xyXG4gICAgICAgIGlmKHR5cGUgPT09IFwibGFzdFwiICYmIHBhZ2luZy5wYWdlID09PSAwKSByZXR1cm47XHJcbiAgICAgICAgaWYodHlwZSA9PT0gXCJuZXh0XCIgJiYgcGFnaW5nLnBhZ2UgKyAxID09PSBwYWdpbmcucGFnZUNvdW50KSByZXR1cm47XHJcbiAgICAgICAgY29uc3QgY291bnQgPSB0eXBlID09PSBcImxhc3RcIj8gLTE6IDE7XHJcbiAgICAgICAgdGhpcy5nZXRTdGlja2VycyhwYWdpbmcucGFnZSArIGNvdW50KTtcclxuICAgICAgfSxcclxuICAgICAgZ2V0U3RpY2tlcnMocGFnZSA9IDApIHtcclxuICAgICAgICBjb25zdCB7dHlwZX0gPSB0aGlzO1xyXG4gICAgICAgIGlmKCFbXCJvd25cIiwgXCJzaGFyZVwiXS5pbmNsdWRlcyh0eXBlKSkgcmV0dXJuO1xyXG4gICAgICAgIGxldCB1cmwgPSBgL3N0aWNrZXI/cGFnZT0ke3BhZ2V9JmM9b3duJnJldmlld2VkPXRydWUmcGVycGFnZT0ke3RoaXMucGVycGFnZX1gO1xyXG4gICAgICAgIGlmKHR5cGUgPT09IFwic2hhcmVcIikge1xyXG4gICAgICAgICAgdXJsID0gYC9zdGlja2Vycz9wYWdlPSR7cGFnZX0mcGVycGFnZT0ke3RoaXMuc2hhcmVQZXJwYWdlfWA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnNvbGUubG9nKHVybCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgbmtjQVBJKHVybCwgXCJHRVRcIilcclxuICAgICAgICAgIC50aGVuKGRhdGEgPT4ge1xyXG4gICAgICAgICAgICBzZWxmLmFwcC5zdGlja2VycyA9IGRhdGEuc3RpY2tlcnM7XHJcbiAgICAgICAgICAgIHNlbGYuYXBwLnBhZ2luZyA9IGRhdGEucGFnaW5nO1xyXG4gICAgICAgICAgICBpZihkYXRhLmVtb2ppKSB7XHJcbiAgICAgICAgICAgICAgc2VsZi5hcHAuZW1vamkgPSBkYXRhLmVtb2ppO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgICAgLmNhdGNoKHN3ZWV0RXJyb3IpO1xyXG4gICAgICB9LFxyXG4gICAgICBmYXN0U2VsZWN0UGFnZSgpIHtcclxuICAgICAgICBjb25zdCBwYWdlTnVtYmVyID0gdGhpcy5wYWdlTnVtYmVyIC0gMTtcclxuICAgICAgICBjb25zdCBwYWdpbmcgPSB0aGlzLnBhZ2luZztcclxuICAgICAgICBpZighcGFnaW5nIHx8ICFwYWdpbmcuYnV0dG9uVmFsdWUubGVuZ3RoKSByZXR1cm47XHJcbiAgICAgICAgY29uc3QgbGFzdE51bWJlciA9IHBhZ2luZy5idXR0b25WYWx1ZVtwYWdpbmcuYnV0dG9uVmFsdWUubGVuZ3RoIC0gMV0ubnVtO1xyXG4gICAgICAgIGlmKHBhZ2VOdW1iZXIgPCAwIHx8IGxhc3ROdW1iZXIgPCBwYWdlTnVtYmVyKSByZXR1cm4gc3dlZXRJbmZvKFwi6L6T5YWl55qE6aG15pWw6LaF5Ye66IyD5Zu0XCIpO1xyXG4gICAgICAgIHRoaXMuZ2V0U3RpY2tlcnMocGFnZU51bWJlcik7XHJcbiAgICAgIH0sXHJcbiAgICAgIHNlbGVjdFN0aWNrZXIoc3RpY2tlcikge1xyXG4gICAgICAgIHNlbGYuY2FsbGJhY2soe1xyXG4gICAgICAgICAgdHlwZTogXCJzdGlja2VyXCIsXHJcbiAgICAgICAgICBkYXRhOiBzdGlja2VyXHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0sXHJcbiAgICAgIHNlbGVjdEVtb2ppKGVtb2ppQ29kZSwgaW5kZXgpIHtcclxuICAgICAgICBzZWxmLmNhbGxiYWNrKHtcclxuICAgICAgICAgIHR5cGU6IFwiZW1vamlcIixcclxuICAgICAgICAgIGRhdGE6IGVtb2ppQ29kZVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9LFxyXG4gICAgICBhZGRMb2NhbEZpbGUoZmlsZSkge1xyXG4gICAgICAgIHRoaXMuZmlsZVRvU3RpY2tlcihmaWxlKVxyXG4gICAgICAgICAgLnRoZW4oc3RpY2tlciA9PiB7XHJcbiAgICAgICAgICAgIHNlbGYuYXBwLmxvY2FsU3RpY2tlcnMucHVzaChzdGlja2VyKTtcclxuICAgICAgICAgICAgc2VsZi5hcHAudXBsb2FkTG9jYWxTdGlja2VyKHN0aWNrZXIpO1xyXG4gICAgICAgICAgfSlcclxuICAgICAgfSxcclxuICAgICAgZmlsZVRvU3RpY2tlcihmaWxlKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgIGNvbnN0IHN0aWNrZXIgPSB7ZmlsZX07XHJcbiAgICAgICAgICBzdGlja2VyLnN0YXR1cyA9IFwidW5VcGxvYWRlZFwiO1xyXG4gICAgICAgICAgc3RpY2tlci5wcm9ncmVzcyA9IDA7XHJcbiAgICAgICAgICBOS0MubWV0aG9kcy5maWxlVG9VcmwoZmlsZSlcclxuICAgICAgICAgICAgLnRoZW4oYmFzZTY0ID0+IHtcclxuICAgICAgICAgICAgICBzdGlja2VyLnVybCA9IGJhc2U2NDtcclxuICAgICAgICAgICAgICByZXNvbHZlKHN0aWNrZXIpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuY2F0Y2gocmVqZWN0KTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuICAgICAgfSxcclxuICAgICAgc2VsZWN0ZWRMb2NhbEZpbGUoKSB7XHJcbiAgICAgICAgY29uc3QgaW5wdXQgPSAkKFwiI21vZHVsZVNlbGVjdFN0aWNrZXJJbnB1dFwiKTtcclxuICAgICAgICBjb25zdCBmaWxlcyA9IGlucHV0WzBdLmZpbGVzO1xyXG4gICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBmaWxlcy5sZW5ndGg7IGkgKyspIHtcclxuICAgICAgICAgIGNvbnN0IGZpbGUgPSBmaWxlc1tpXTtcclxuICAgICAgICAgIHNlbGYuYXBwLmFkZExvY2FsRmlsZShmaWxlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0sXHJcbiAgICAgIHNlbGVjdExvY2FsRmlsZSgpIHtcclxuICAgICAgICAkKFwiI21vZHVsZVNlbGVjdFN0aWNrZXJJbnB1dFwiKS5jbGljaygpO1xyXG4gICAgICB9LFxyXG4gICAgICB1cGxvYWRMb2NhbFN0aWNrZXIoc3RpY2tlcikge1xyXG4gICAgICAgIFByb21pc2UucmVzb2x2ZSgpXHJcbiAgICAgICAgICAudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICAgIHN0aWNrZXIuc3RhdHVzID0gXCJ1cGxvYWRpbmdcIjtcclxuICAgICAgICAgICAgY29uc3QgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTtcclxuICAgICAgICAgICAgZm9ybURhdGEuYXBwZW5kKFwiZmlsZVwiLCBzdGlja2VyLmZpbGUpO1xyXG4gICAgICAgICAgICBmb3JtRGF0YS5hcHBlbmQoXCJ0eXBlXCIsIFwic3RpY2tlclwiKTtcclxuICAgICAgICAgICAgZm9ybURhdGEuYXBwZW5kKFwiZmlsZU5hbWVcIiwgc3RpY2tlci5maWxlLm5hbWUpO1xyXG4gICAgICAgICAgICBpZihzZWxmLmFwcC5zaGFyZSkge1xyXG4gICAgICAgICAgICAgIGZvcm1EYXRhLmFwcGVuZChcInNoYXJlXCIsIFwidHJ1ZVwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gbmtjVXBsb2FkRmlsZShcIi9yXCIsIFwiUE9TVFwiLCBmb3JtRGF0YSwgZnVuY3Rpb24oZSwgcHJvZ3Jlc3MpIHtcclxuICAgICAgICAgICAgICBzdGlja2VyLnByb2dyZXNzID0gcHJvZ3Jlc3M7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfSlcclxuICAgICAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgc3RpY2tlci5zdGF0dXMgPSBcInVwbG9hZGVkXCI7XHJcbiAgICAgICAgICAgIHNlbGYuYXBwLmxvY2FsU3RpY2tlcnMuc3BsaWNlKHNlbGYuYXBwLmxvY2FsU3RpY2tlcnMuaW5kZXhPZihzdGlja2VyKSwgMSk7XHJcbiAgICAgICAgICAgIGlmKCFzZWxmLmFwcC5sb2NhbFN0aWNrZXJzLmxlbmd0aCkgc2VsZi5hcHAuc2VsZWN0VHlwZShcIm93blwiKTtcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgICAuY2F0Y2goKGRhdGEpID0+IHtcclxuICAgICAgICAgICAgc2NyZWVuVG9wV2FybmluZyhkYXRhLmVycm9yIHx8IGRhdGEpO1xyXG4gICAgICAgICAgICBzdGlja2VyLmVycm9yID0gZGF0YS5lcnJvciB8fCBkYXRhO1xyXG4gICAgICAgICAgICBzdGlja2VyLnN0YXR1cyA9IFwidW5VcGxvYWRlZFwiO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgIH0sXHJcbiAgICAgIHJlc3RhcnRVcGxvYWQocykge1xyXG4gICAgICAgIHRoaXMudXBsb2FkTG9jYWxTdGlja2VyKHMpO1xyXG4gICAgICB9LFxyXG4gICAgICBvcGVuKGNhbGxiYWNrLCBvcHRpb25zKSB7XHJcbiAgICAgICAgc2VsZi5jYWxsYmFjayA9IGNhbGxiYWNrO1xyXG4gICAgICAgIHRoaXMucmVzZXREb21Qb3NpdGlvbigpO1xyXG4gICAgICAgIHRoaXMuaW5pdE1vZHVsZSgpO1xyXG4gICAgICAgIHNlbGYuZG9tLnNob3coKTtcclxuICAgICAgICB0aGlzLmdldFN0aWNrZXJzKCk7XHJcbiAgICAgIH0sXHJcbiAgICAgIGNsb3NlKCkge1xyXG4gICAgICAgIHNlbGYuZG9tLmhpZGUoKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH0pO1xyXG4gIHNlbGYub3BlbiA9IHNlbGYuYXBwLm9wZW47XHJcbiAgc2VsZi5jbG9zZSA9IHNlbGYuYXBwLmNsb3NlO1xyXG59OyJdfQ==
