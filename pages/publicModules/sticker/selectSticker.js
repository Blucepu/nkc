(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
"use strict";

NKC.modules.SelectSticker = function () {
  var self = this;
  self.dom = $("#moduleSelectSticker");
  self.app = new Vue({
    el: "#moduleSelectStickerApp",
    data: {
      type: "own",
      pageNumber: "",
      perpage: 20,
      sharePerpage: 24,
      emoji: [],
      share: false,
      localStickers: [],
      stickers: [],
      paging: {}
    },
    mounted: function mounted() {},
    methods: {
      getUrl: NKC.methods.tools.getUrl,
      initModule: function initModule() {
        var height = "43.5rem";
        self.dom.css({
          height: height
        });
        self.dom.draggable({
          scroll: false,
          handle: ".module-ss-title",
          drag: function drag(event, ui) {
            if (ui.position.top < 0) ui.position.top = 0;
            var height = $(window).height();
            if (ui.position.top > height - 30) ui.position.top = height - 30;
            var width = self.dom.width();
            if (ui.position.left < 100 - width) ui.position.left = 100 - width;
            var winWidth = $(window).width();
            if (ui.position.left > winWidth - 100) ui.position.left = winWidth - 100;
          }
        });
      },
      resetDomPosition: function resetDomPosition() {
        var dom = self.dom;
        var width = $(window).width();
        var height = $(window).height();

        if (width < 700) {
          // 小屏幕
          dom.css({
            "width": width * 0.8,
            "top": 0,
            "right": 0
          });
        } else {
          // 宽屏
          dom.css("left", (width - dom.width()) * 0.5 - 40);
        }
      },
      selectType: function selectType(type) {
        this.type = type;

        if (["own", "share"].includes(type)) {
          this.getStickers();
        }
      },
      changePage: function changePage(type) {
        var paging = this.paging;
        if (paging.buttonValue.length <= 1) return;
        if (type === "last" && paging.page === 0) return;
        if (type === "next" && paging.page + 1 === paging.pageCount) return;
        var count = type === "last" ? -1 : 1;
        this.getStickers(paging.page + count);
      },
      getStickers: function getStickers() {
        var page = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 0;
        var type = this.type;
        if (!["own", "share"].includes(type)) return;
        var url = "/sticker?page=".concat(page, "&c=own&reviewed=true&perpage=").concat(this.perpage);

        if (type === "share") {
          url = "/stickers?page=".concat(page, "&perpage=").concat(this.sharePerpage);
        }

        nkcAPI(url, "GET").then(function (data) {
          self.app.stickers = data.stickers;
          self.app.paging = data.paging;

          if (data.emoji) {
            self.app.emoji = data.emoji;
          }
        })["catch"](sweetError);
      },
      fastSelectPage: function fastSelectPage() {
        var pageNumber = this.pageNumber - 1;
        var paging = this.paging;
        if (!paging || !paging.buttonValue.length) return;
        var lastNumber = paging.buttonValue[paging.buttonValue.length - 1].num;
        if (pageNumber < 0 || lastNumber < pageNumber) return sweetInfo("输入的页数超出范围");
        this.getStickers(pageNumber);
      },
      selectSticker: function selectSticker(sticker) {
        self.callback({
          type: "sticker",
          data: sticker
        });
      },
      selectEmoji: function selectEmoji(emojiCode, index) {
        self.callback({
          type: "emoji",
          data: emojiCode
        });
      },
      addLocalFile: function addLocalFile(file) {
        this.fileToSticker(file).then(function (sticker) {
          self.app.localStickers.push(sticker);
          self.app.uploadLocalSticker(sticker);
        });
      },
      fileToSticker: function fileToSticker(file) {
        return new Promise(function (resolve, reject) {
          var sticker = {
            file: file
          };
          sticker.status = "unUploaded";
          sticker.progress = 0;
          NKC.methods.fileToUrl(file).then(function (base64) {
            sticker.url = base64;
            resolve(sticker);
          })["catch"](reject);
        });
      },
      selectedLocalFile: function selectedLocalFile() {
        var input = $("#moduleSelectStickerInput");
        var files = input[0].files;

        for (var i = 0; i < files.length; i++) {
          var file = files[i];
          self.app.addLocalFile(file);
        }
      },
      selectLocalFile: function selectLocalFile() {
        $("#moduleSelectStickerInput").click();
      },
      uploadLocalSticker: function uploadLocalSticker(sticker) {
        Promise.resolve().then(function () {
          sticker.status = "uploading";
          var formData = new FormData();
          formData.append("file", sticker.file);
          formData.append("type", "sticker");
          formData.append("fileName", sticker.file.name);

          if (self.app.share) {
            formData.append("share", "true");
          }

          return nkcUploadFile("/r", "POST", formData, function (e, progress) {
            sticker.progress = progress;
          });
        }).then(function () {
          sticker.status = "uploaded";
          self.app.localStickers.splice(self.app.localStickers.indexOf(sticker), 1);
          if (!self.app.localStickers.length) self.app.selectType("own");
        })["catch"](function (data) {
          screenTopWarning(data.error || data);
          sticker.error = data.error || data;
          sticker.status = "unUploaded";
        });
      },
      restartUpload: function restartUpload(s) {
        this.uploadLocalSticker(s);
      },
      open: function open(callback, options) {
        self.callback = callback;
        this.resetDomPosition();
        this.initModule();
        self.dom.show();
        this.getStickers();
      },
      close: function close() {
        self.dom.hide();
      }
    }
  });
  self.open = self.app.open;
  self.close = self.app.close;
};

},{}]},{},[1])
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9fYnJvd3Nlci1wYWNrQDYuMS4wQGJyb3dzZXItcGFjay9fcHJlbHVkZS5qcyIsInBhZ2VzL3B1YmxpY01vZHVsZXMvc3RpY2tlci9zZWxlY3RTdGlja2VyLm1qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7O0FDQUEsR0FBRyxDQUFDLE9BQUosQ0FBWSxhQUFaLEdBQTRCLFlBQVc7QUFDckMsTUFBSSxJQUFJLEdBQUcsSUFBWDtBQUNBLEVBQUEsSUFBSSxDQUFDLEdBQUwsR0FBVyxDQUFDLENBQUMsc0JBQUQsQ0FBWjtBQUNBLEVBQUEsSUFBSSxDQUFDLEdBQUwsR0FBVyxJQUFJLEdBQUosQ0FBUTtBQUNqQixJQUFBLEVBQUUsRUFBRSx5QkFEYTtBQUVqQixJQUFBLElBQUksRUFBRTtBQUNKLE1BQUEsSUFBSSxFQUFFLEtBREY7QUFFSixNQUFBLFVBQVUsRUFBRSxFQUZSO0FBR0osTUFBQSxPQUFPLEVBQUUsRUFITDtBQUlKLE1BQUEsWUFBWSxFQUFFLEVBSlY7QUFLSixNQUFBLEtBQUssRUFBRSxFQUxIO0FBTUosTUFBQSxLQUFLLEVBQUUsS0FOSDtBQU9KLE1BQUEsYUFBYSxFQUFFLEVBUFg7QUFRSixNQUFBLFFBQVEsRUFBRSxFQVJOO0FBU0osTUFBQSxNQUFNLEVBQUU7QUFUSixLQUZXO0FBYWpCLElBQUEsT0FBTyxFQUFFLG1CQUFZLENBRXBCLENBZmdCO0FBZ0JqQixJQUFBLE9BQU8sRUFBRTtBQUNQLE1BQUEsTUFBTSxFQUFFLEdBQUcsQ0FBQyxPQUFKLENBQVksS0FBWixDQUFrQixNQURuQjtBQUVQLE1BQUEsVUFGTyx3QkFFTTtBQUNYLFlBQUksTUFBTSxHQUFHLFNBQWI7QUFDQSxRQUFBLElBQUksQ0FBQyxHQUFMLENBQVMsR0FBVCxDQUFhO0FBQ1gsVUFBQSxNQUFNLEVBQUU7QUFERyxTQUFiO0FBR0EsUUFBQSxJQUFJLENBQUMsR0FBTCxDQUFTLFNBQVQsQ0FBbUI7QUFDakIsVUFBQSxNQUFNLEVBQUUs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ckI7QUFDQSxFQUFBLElBQUksQ0FBQyxLQUFMLEdBQWEsSUFBSSxDQUFDLEdBQUwsQ0FBUyxLQUF0QjtBQUNELENBdkxEIiwiZmlsZSI6ImdlbmVyYXRlZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24oKXtmdW5jdGlvbiByKGUsbix0KXtmdW5jdGlvbiBvKGksZil7aWYoIW5baV0pe2lmKCFlW2ldKXt2YXIgYz1cImZ1bmN0aW9uXCI9PXR5cGVvZiByZXF1aXJlJiZyZXF1aXJlO2lmKCFmJiZjKXJldHVybiBjKGksITApO2lmKHUpcmV0dXJuIHUoaSwhMCk7dmFyIGE9bmV3IEVycm9yKFwiQ2Fubm90IGZpbmQgbW9kdWxlICdcIitpK1wiJ1wiKTt0aHJvdyBhLmNvZGU9XCJNT0RVTEVfTk9UX0ZPVU5EXCIsYX12YXIgcD1uW2ldPXtleHBvcnRzOnt9fTtlW2ldWzBdLmNhbGwocC5leHBvcnRzLGZ1bmN0aW9uKHIpe3ZhciBuPWVbaV1bMV1bcl07cmV0dXJuIG8obnx8cil9LHAscC5leHBvcnRzLHIsZSxuLHQpfXJldHVybiBuW2ldLmV4cG9ydHN9Zm9yKHZhciB1PVwiZnVuY3Rpb25cIj09dHlwZW9mIHJlcXVpcmUmJnJlcXVpcmUsaT0wO2k8dC5sZW5ndGg7aSsrKW8odFtpXSk7cmV0dXJuIG99cmV0dXJuIHJ9KSgpIiwiTktDLm1vZHVsZXMuU2VsZWN0U3RpY2tlciA9IGZ1bmN0aW9uKCkge1xuICB2YXIgc2VsZiA9IHRoaXM7XG4gIHNlbGYuZG9tID0gJChcIiNtb2R1bGVTZWxlY3RTdGlja2VyXCIpO1xuICBzZWxmLmFwcCA9IG5ldyBWdWUoe1xuICAgIGVsOiBcIiNtb2R1bGVTZWxlY3RTdGlja2VyQXBwXCIsXG4gICAgZGF0YToge1xuICAgICAgdHlwZTogXCJvd25cIixcbiAgICAgIHBhZ2VOdW1iZXI6IFwiXCIsXG4gICAgICBwZXJwYWdlOiAyMCxcbiAgICAgIHNoYXJlUGVycGFnZTogMjQsXG4gICAgICBlbW9qaTogW10sXG4gICAgICBzaGFyZTogZmFsc2UsXG4gICAgICBsb2NhbFN0aWNrZXJzOiBbXSxcbiAgICAgIHN0aWNrZXJzOiBbXSxcbiAgICAgIHBhZ2luZzoge31cbiAgICB9LFxuICAgIG1vdW50ZWQ6IGZ1bmN0aW9uICgpIHtcbiAgICBcbiAgICB9LFxuICAgIG1ldGhvZHM6IHtcbiAgICAgIGdldFVybDogTktDLm1ldGhvZHMudG9vbHMuZ2V0VXJsLFxuICAgICAgaW5pdE1vZHVsZSgpIHtcbiAgICAgICAgdmFyIGhlaWdodCA9IFwiNDMuNXJlbVwiO1xuICAgICAgICBzZWxmLmRvbS5jc3Moe1xuICAgICAgICAgIGhlaWdodDogaGVpZ2h0XG4gICAgICAgIH0pO1xuICAgICAgICBzZWxmLmRvbS5kcmFnZ2FibGUoe1xuICAgICAgICAgIHNjcm9sbDogZmFsc2UsXG4gICAgICAgICAgaGFuZGxlOiBcIi5tb2R1bGUtc3MtdGl0bGVcIixcbiAgICAgICAgICBkcmFnOiBmdW5jdGlvbihldmVudCwgdWkpIHtcbiAgICAgICAgICAgIGlmKHVpLnBvc2l0aW9uLnRvcCA8IDApIHVpLnBvc2l0aW9uLnRvcCA9IDA7XG4gICAgICAgICAgICB2YXIgaGVpZ2h0ID0gJCh3aW5kb3cpLmhlaWdodCgpO1xuICAgICAgICAgICAgaWYodWkucG9zaXRpb24udG9wID4gaGVpZ2h0IC0gMzApIHVpLnBvc2l0aW9uLnRvcCA9IGhlaWdodCAtIDMwO1xuICAgICAgICAgICAgdmFyIHdpZHRoID0gc2VsZi5kb20ud2lkdGgoKTtcbiAgICAgICAgICAgIGlmKHVpLnBvc2l0aW9uLmxlZnQgPCAxMDAgLSB3aWR0aCkgdWkucG9zaXRpb24ubGVmdCA9IDEwMCAtIHdpZHRoO1xuICAgICAgICAgICAgdmFyIHdpbldpZHRoID0gJCh3aW5kb3cpLndpZHRoKCk7XG4gICAgICAgICAgICBpZih1aS5wb3NpdGlvbi5sZWZ0ID4gd2luV2lkdGggLSAxMDApIHVpLnBvc2l0aW9uLmxlZnQgPSB3aW5XaWR0aCAtIDEwMDtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSxcbiAgICAgIHJlc2V0RG9tUG9zaXRpb246IGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgZG9tID0gc2VsZi5kb207XG4gICAgICAgIHZhciB3aWR0aCA9ICQod2luZG93KS53aWR0aCgpO1xuICAgICAgICB2YXIgaGVpZ2h0ID0gJCh3aW5kb3cpLmhlaWdodCgpO1xuICAgICAgICBpZih3aWR0aCA8IDcwMCkge1xuICAgICAgICAgIC8vIOWwj+Wxj+W5lVxuICAgICAgICAgIGRvbS5jc3Moe1xuICAgICAgICAgICAgXCJ3aWR0aFwiOiB3aWR0aCAqIDAuOCxcbiAgICAgICAgICAgIFwidG9wXCI6IDAsXG4gICAgICAgICAgICBcInJpZ2h0XCI6IDBcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyDlrr3lsY9cbiAgICAgICAgICBkb20uY3NzKFwibGVmdFwiLCAod2lkdGggLSBkb20ud2lkdGgoKSkqMC41IC0gIDQwKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIHNlbGVjdFR5cGUodHlwZSkge1xuICAgICAgICB0aGlzLnR5cGUgPSB0eXBlO1xuICAgICAgICBpZihbXCJvd25cIiwgXCJzaGFyZVwiXS5pbmNsdWRlcyh0eXBlKSkge1xuICAgICAgICAgIHRoaXMuZ2V0U3RpY2tlcnMoKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIGNoYW5nZVBhZ2UodHlwZSkge1xuICAgICAgICBjb25zdCBwYWdpbmcgPSB0aGlzLnBhZ2luZztcbiAgICAgICAgaWYocGFnaW5nLmJ1dHRvblZhbHVlLmxlbmd0aCA8PSAxKSByZXR1cm47XG4gICAgICAgIGlmKHR5cGUgPT09IFwibGFzdFwiICYmIHBhZ2luZy5wYWdlID09PSAwKSByZXR1cm47XG4gICAgICAgIGlmKHR5cGUgPT09IFwibmV4dFwiICYmIHBhZ2luZy5wYWdlICsgMSA9PT0gcGFnaW5nLnBhZ2VDb3VudCkgcmV0dXJuO1xuICAgICAgICBjb25zdCBjb3VudCA9IHR5cGUgPT09IFwibGFzdFwiPyAtMTogMTtcbiAgICAgICAgdGhpcy5nZXRTdGlja2VycyhwYWdpbmcucGFnZSArIGNvdW50KTtcbiAgICAgIH0sXG4gICAgICBnZXRTdGlja2VycyhwYWdlID0gMCkge1xuICAgICAgICBjb25zdCB7dHlwZX0gPSB0aGlzO1xuICAgICAgICBpZighW1wib3duXCIsIFwic2hhcmVcIl0uaW5jbHVkZXModHlwZSkpIHJldHVybjtcbiAgICAgICAgbGV0IHVybCA9IGAvc3RpY2tlcj9wYWdlPSR7cGFnZX0mYz1vd24mcmV2aWV3ZWQ9dHJ1ZSZwZXJwYWdlPSR7dGhpcy5wZXJwYWdlfWA7XG4gICAgICAgIGlmKHR5cGUgPT09IFwic2hhcmVcIikge1xuICAgICAgICAgIHVybCA9IGAvc3RpY2tlcnM/cGFnZT0ke3BhZ2V9JnBlcnBhZ2U9JHt0aGlzLnNoYXJlUGVycGFnZX1gO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBua2NBUEkodXJsLCBcIkdFVFwiKVxuICAgICAgICAgIC50aGVuKGRhdGEgPT4ge1xuICAgICAgICAgICAgc2VsZi5hcHAuc3RpY2tlcnMgPSBkYXRhLnN0aWNrZXJzO1xuICAgICAgICAgICAgc2VsZi5hcHAucGFnaW5nID0gZGF0YS5wYWdpbmc7XG4gICAgICAgICAgICBpZihkYXRhLmVtb2ppKSB7XG4gICAgICAgICAgICAgIHNlbGYuYXBwLmVtb2ppID0gZGF0YS5lbW9qaTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICAgIC5jYXRjaChzd2VldEVycm9yKTtcbiAgICAgIH0sXG4gICAgICBmYXN0U2VsZWN0UGFnZSgpIHtcbiAgICAgICAgY29uc3QgcGFnZU51bWJlciA9IHRoaXMucGFnZU51bWJlciAtIDE7XG4gICAgICAgIGNvbnN0IHBhZ2luZyA9IHRoaXMucGFnaW5nO1xuICAgICAgICBpZighcGFnaW5nIHx8ICFwYWdpbmcuYnV0dG9uVmFsdWUubGVuZ3RoKSByZXR1cm47XG4gICAgICAgIGNvbnN0IGxhc3ROdW1iZXIgPSBwYWdpbmcuYnV0dG9uVmFsdWVbcGFnaW5nLmJ1dHRvblZhbHVlLmxlbmd0aCAtIDFdLm51bTtcbiAgICAgICAgaWYocGFnZU51bWJlciA8IDAgfHwgbGFzdE51bWJlciA8IHBhZ2VOdW1iZXIpIHJldHVybiBzd2VldEluZm8oXCLovpPlhaXnmoTpobXmlbDotoXlh7rojIPlm7RcIik7XG4gICAgICAgIHRoaXMuZ2V0U3RpY2tlcnMocGFnZU51bWJlcik7XG4gICAgICB9LFxuICAgICAgc2VsZWN0U3RpY2tlcihzdGlja2VyKSB7XG4gICAgICAgIHNlbGYuY2FsbGJhY2soe1xuICAgICAgICAgIHR5cGU6IFwic3RpY2tlclwiLFxuICAgICAgICAgIGRhdGE6IHN0aWNrZXJcbiAgICAgICAgfSk7XG4gICAgICB9LFxuICAgICAgc2VsZWN0RW1vamkoZW1vamlDb2RlLCBpbmRleCkge1xuICAgICAgICBzZWxmLmNhbGxiYWNrKHtcbiAgICAgICAgICB0eXBlOiBcImVtb2ppXCIsXG4gICAgICAgICAgZGF0YTogZW1vamlDb2RlXG4gICAgICAgIH0pO1xuICAgICAgfSxcbiAgICAgIGFkZExvY2FsRmlsZShmaWxlKSB7XG4gICAgICAgIHRoaXMuZmlsZVRvU3RpY2tlcihmaWxlKVxuICAgICAgICAgIC50aGVuKHN0aWNrZXIgPT4ge1xuICAgICAgICAgICAgc2VsZi5hcHAubG9jYWxTdGlja2Vycy5wdXNoKHN0aWNrZXIpO1xuICAgICAgICAgICAgc2VsZi5hcHAudXBsb2FkTG9jYWxTdGlja2VyKHN0aWNrZXIpO1xuICAgICAgICAgIH0pXG4gICAgICB9LFxuICAgICAgZmlsZVRvU3RpY2tlcihmaWxlKSB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgY29uc3Qgc3RpY2tlciA9IHtmaWxlfTtcbiAgICAgICAgICBzdGlja2VyLnN0YXR1cyA9IFwidW5VcGxvYWRlZFwiO1xuICAgICAgICAgIHN0aWNrZXIucHJvZ3Jlc3MgPSAwO1xuICAgICAgICAgIE5LQy5tZXRob2RzLmZpbGVUb1VybChmaWxlKVxuICAgICAgICAgICAgLnRoZW4oYmFzZTY0ID0+IHtcbiAgICAgICAgICAgICAgc3RpY2tlci51cmwgPSBiYXNlNjQ7XG4gICAgICAgICAgICAgIHJlc29sdmUoc3RpY2tlcik7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmNhdGNoKHJlamVjdCk7XG4gICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgIH0sXG4gICAgICBzZWxlY3RlZExvY2FsRmlsZSgpIHtcbiAgICAgICAgY29uc3QgaW5wdXQgPSAkKFwiI21vZHVsZVNlbGVjdFN0aWNrZXJJbnB1dFwiKTtcbiAgICAgICAgY29uc3QgZmlsZXMgPSBpbnB1dFswXS5maWxlcztcbiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGZpbGVzLmxlbmd0aDsgaSArKykge1xuICAgICAgICAgIGNvbnN0IGZpbGUgPSBmaWxlc1tpXTtcbiAgICAgICAgICBzZWxmLmFwcC5hZGRMb2NhbEZpbGUoZmlsZSk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBzZWxlY3RMb2NhbEZpbGUoKSB7XG4gICAgICAgICQoXCIjbW9kdWxlU2VsZWN0U3RpY2tlcklucHV0XCIpLmNsaWNrKCk7XG4gICAgICB9LFxuICAgICAgdXBsb2FkTG9jYWxTdGlja2VyKHN0aWNrZXIpIHtcbiAgICAgICAgUHJvbWlzZS5yZXNvbHZlKClcbiAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICBzdGlja2VyLnN0YXR1cyA9IFwidXBsb2FkaW5nXCI7XG4gICAgICAgICAgICBjb25zdCBmb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSgpO1xuICAgICAgICAgICAgZm9ybURhdGEuYXBwZW5kKFwiZmlsZVwiLCBzdGlja2VyLmZpbGUpO1xuICAgICAgICAgICAgZm9ybURhdGEuYXBwZW5kKFwidHlwZVwiLCBcInN0aWNrZXJcIik7XG4gICAgICAgICAgICBmb3JtRGF0YS5hcHBlbmQoXCJmaWxlTmFtZVwiLCBzdGlja2VyLmZpbGUubmFtZSk7XG4gICAgICAgICAgICBpZihzZWxmLmFwcC5zaGFyZSkge1xuICAgICAgICAgICAgICBmb3JtRGF0YS5hcHBlbmQoXCJzaGFyZVwiLCBcInRydWVcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gbmtjVXBsb2FkRmlsZShcIi9yXCIsIFwiUE9TVFwiLCBmb3JtRGF0YSwgZnVuY3Rpb24oZSwgcHJvZ3Jlc3MpIHtcbiAgICAgICAgICAgICAgc3RpY2tlci5wcm9ncmVzcyA9IHByb2dyZXNzO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSlcbiAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICBzdGlja2VyLnN0YXR1cyA9IFwidXBsb2FkZWRcIjtcbiAgICAgICAgICAgIHNlbGYuYXBwLmxvY2FsU3RpY2tlcnMuc3BsaWNlKHNlbGYuYXBwLmxvY2FsU3RpY2tlcnMuaW5kZXhPZihzdGlja2VyKSwgMSk7XG4gICAgICAgICAgICBpZighc2VsZi5hcHAubG9jYWxTdGlja2Vycy5sZW5ndGgpIHNlbGYuYXBwLnNlbGVjdFR5cGUoXCJvd25cIik7XG4gICAgICAgICAgfSlcbiAgICAgICAgICAuY2F0Y2goKGRhdGEpID0+IHtcbiAgICAgICAgICAgIHNjcmVlblRvcFdhcm5pbmcoZGF0YS5lcnJvciB8fCBkYXRhKTtcbiAgICAgICAgICAgIHN0aWNrZXIuZXJyb3IgPSBkYXRhLmVycm9yIHx8IGRhdGE7XG4gICAgICAgICAgICBzdGlja2VyLnN0YXR1cyA9IFwidW5VcGxvYWRlZFwiO1xuICAgICAgICAgIH0pO1xuICAgICAgfSxcbiAgICAgIHJlc3RhcnRVcGxvYWQocykge1xuICAgICAgICB0aGlzLnVwbG9hZExvY2FsU3RpY2tlcihzKTtcbiAgICAgIH0sXG4gICAgICBvcGVuKGNhbGxiYWNrLCBvcHRpb25zKSB7XG4gICAgICAgIHNlbGYuY2FsbGJhY2sgPSBjYWxsYmFjaztcbiAgICAgICAgdGhpcy5yZXNldERvbVBvc2l0aW9uKCk7XG4gICAgICAgIHRoaXMuaW5pdE1vZHVsZSgpO1xuICAgICAgICBzZWxmLmRvbS5zaG93KCk7XG4gICAgICAgIHRoaXMuZ2V0U3RpY2tlcnMoKTtcbiAgICAgIH0sXG4gICAgICBjbG9zZSgpIHtcbiAgICAgICAgc2VsZi5kb20uaGlkZSgpO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG4gIHNlbGYub3BlbiA9IHNlbGYuYXBwLm9wZW47XG4gIHNlbGYuY2xvc2UgPSBzZWxmLmFwcC5jbG9zZTtcbn07Il19
