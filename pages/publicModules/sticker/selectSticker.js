(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
"use strict";

NKC.modules.SelectSticker = function () {
  var self = this;
  self.dom = $("#moduleSelectSticker");
  self.app = new Vue({
    el: "#moduleSelectStickerApp",
    data: {
      type: "own",
      pageNumber: "",
      perpage: 20,
      sharePerpage: 24,
      emoji: [],
      share: false,
      localStickers: [],
      stickers: [],
      paging: {}
    },
    mounted: function mounted() {},
    methods: {
      getUrl: NKC.methods.tools.getUrl,
      initModule: function initModule() {
        var height = "43.5rem";
        self.dom.css({
          height: height
        });
        self.dom.draggable({
          scroll: false,
          handle: ".module-ss-title",
          drag: function drag(event, ui) {
            if (ui.position.top < 0) ui.position.top = 0;
            var height = $(window).height();
            if (ui.position.top > height - 30) ui.position.top = height - 30;
            var width = self.dom.width();
            if (ui.position.left < 100 - width) ui.position.left = 100 - width;
            var winWidth = $(window).width();
            if (ui.position.left > winWidth - 100) ui.position.left = winWidth - 100;
          }
        });
      },
      resetDomPosition: function resetDomPosition() {
        var dom = self.dom;
        var width = $(window).width();
        var height = $(window).height();

        if (width < 700) {
          // 小屏幕
          dom.css({
            "width": width * 0.8,
            "top": 0,
            "right": 0
          });
        } else {
          // 宽屏
          dom.css("left", (width - dom.width()) * 0.5 - 40);
        }
      },
      selectType: function selectType(type) {
        this.type = type;

        if (["own", "share"].includes(type)) {
          this.getStickers();
        }
      },
      changePage: function changePage(type) {
        var paging = this.paging;
        if (paging.buttonValue.length <= 1) return;
        if (type === "last" && paging.page === 0) return;
        if (type === "next" && paging.page + 1 === paging.pageCount) return;
        var count = type === "last" ? -1 : 1;
        this.getStickers(paging.page + count);
      },
      getStickers: function getStickers() {
        var page = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 0;
        var type = this.type;
        if (!["own", "share"].includes(type)) return;
        var url = "/sticker?page=".concat(page, "&c=own&reviewed=true&perpage=").concat(this.perpage);

        if (type === "share") {
          url = "/stickers?page=".concat(page, "&perpage=").concat(this.sharePerpage);
        }

        nkcAPI(url, "GET").then(function (data) {
          self.app.stickers = data.stickers;
          self.app.paging = data.paging;

          if (data.emoji) {
            self.app.emoji = data.emoji;
          }
        })["catch"](sweetError);
      },
      fastSelectPage: function fastSelectPage() {
        var pageNumber = this.pageNumber - 1;
        var paging = this.paging;
        if (!paging || !paging.buttonValue.length) return;
        var lastNumber = paging.buttonValue[paging.buttonValue.length - 1].num;
        if (pageNumber < 0 || lastNumber < pageNumber) return sweetInfo("输入的页数超出范围");
        this.getStickers(pageNumber);
      },
      selectSticker: function selectSticker(sticker) {
        self.callback({
          type: "sticker",
          data: sticker
        });
      },
      selectEmoji: function selectEmoji(emojiCode, index) {
        self.callback({
          type: "emoji",
          data: emojiCode
        });
      },
      addLocalFile: function addLocalFile(file) {
        this.fileToSticker(file).then(function (sticker) {
          self.app.localStickers.push(sticker);
          self.app.uploadLocalSticker(sticker);
        });
      },
      fileToSticker: function fileToSticker(file) {
        return new Promise(function (resolve, reject) {
          var sticker = {
            file: file
          };
          sticker.status = "unUploaded";
          sticker.progress = 0;
          NKC.methods.fileToUrl(file).then(function (base64) {
            sticker.url = base64;
            resolve(sticker);
          })["catch"](reject);
        });
      },
      selectedLocalFile: function selectedLocalFile() {
        var input = $("#moduleSelectStickerInput");
        var files = input[0].files;

        for (var i = 0; i < files.length; i++) {
          var file = files[i];
          self.app.addLocalFile(file);
        }
      },
      selectLocalFile: function selectLocalFile() {
        $("#moduleSelectStickerInput").click();
      },
      uploadLocalSticker: function uploadLocalSticker(sticker) {
        Promise.resolve().then(function () {
          sticker.status = "uploading";
          var formData = new FormData();
          formData.append("file", sticker.file);
          formData.append("type", "sticker");
          formData.append("fileName", sticker.file.name);

          if (self.app.share) {
            formData.append("share", "true");
          }

          return nkcUploadFile("/r", "POST", formData, function (e, progress) {
            sticker.progress = progress;
          });
        }).then(function () {
          sticker.status = "uploaded";
          self.app.localStickers.splice(self.app.localStickers.indexOf(sticker), 1);
          if (!self.app.localStickers.length) self.app.selectType("own");
        })["catch"](function (data) {
          screenTopWarning(data.error || data);
          sticker.error = data.error || data;
          sticker.status = "unUploaded";
        });
      },
      restartUpload: function restartUpload(s) {
        this.uploadLocalSticker(s);
      },
      open: function open(callback, options) {
        self.callback = callback;
        this.resetDomPosition();
        this.initModule();
        self.dom.show();
        this.getStickers();
      },
      close: function close() {
        self.dom.hide();
      }
    }
  });
  self.open = self.app.open;
  self.close = self.app.close;
};

},{}]},{},[1])
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCJwYWdlcy9wdWJsaWNNb2R1bGVzL3N0aWNrZXIvc2VsZWN0U3RpY2tlci5tanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7OztBQ0FBLEdBQUcsQ0FBQyxPQUFKLENBQVksYUFBWixHQUE0QixZQUFXO0FBQ3JDLE1BQUksSUFBSSxHQUFHLElBQVg7QUFDQSxFQUFBLElBQUksQ0FBQyxHQUFMLEdBQVcsQ0FBQyxDQUFDLHNCQUFELENBQVo7QUFDQSxFQUFBLElBQUksQ0FBQyxHQUFMLEdBQVcsSUFBSSxHQUFKLENBQVE7QUFDakIsSUFBQSxFQUFFLEVBQUUseUJBRGE7QUFFakIsSUFBQSxJQUFJLEVBQUU7QUFDSixNQUFBLElBQUksRUFBRSxLQURGO0FBRUosTUFBQSxVQUFVLEVBQUUsRUFGUjtBQUdKLE1BQUEsT0FBTyxFQUFFLEVBSEw7QUFJSixNQUFBLFlBQVksRUFBRSxFQUpWO0FBS0osTUFBQSxLQUFLLEVBQUUsRUFMSDtBQU1KLE1BQUEsS0FBSyxFQUFFLEtBTkg7QUFPSixNQUFBLGFBQWEsRUFBRSxFQVBYO0FBUUosTUFBQSxRQUFRLEVBQUUsRUFSTjtBQVNKLE1BQUEsTUFBTSxFQUFFO0FBVEosS0FGVztBQWFqQixJQUFBLE9BQU8sRUFBRSxtQkFBWSxDQUVwQixDQWZnQjtBQWdCakIsSUFBQSxPQUFPLEVBQUU7QUFDUCxNQUFBLE1BQU0sRUFBRSxHQUFHLENBQUMsT0FBSixDQUFZLEtBQVosQ0FBa0IsTUFEbkI7QUFFUCxNQUFBLFVBRk8sd0JBRU07QUFDWCxZQUFJLE1BQU0sR0FBRyxTQUFiO0FBQ0EsUUFBQSxJQUFJLENBQUMsR0FBTCxDQUFTLEdBQVQsQ0FBYTtBQUNYLFVBQUEsTUFBTSxFQUFFO0FBREcsU0FBYjtBQUdBLFFBQUEsSUFBSSxDQUFDLEdBQUwsQ0FBUyxTQUFULENBQW1CO0FBQ2pCLFVBQUEsTUFBTSxFQUFFLEtBRFM7QUFFakIsVUFBQSxNQUFN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QUMsS0FBTCxHQUFhLElBQUksQ0FBQyxHQUFMLENBQVMsS0FBdEI7QUFDRCxDQXZMRCIsImZpbGUiOiJnZW5lcmF0ZWQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uKCl7ZnVuY3Rpb24gcihlLG4sdCl7ZnVuY3Rpb24gbyhpLGYpe2lmKCFuW2ldKXtpZighZVtpXSl7dmFyIGM9XCJmdW5jdGlvblwiPT10eXBlb2YgcmVxdWlyZSYmcmVxdWlyZTtpZighZiYmYylyZXR1cm4gYyhpLCEwKTtpZih1KXJldHVybiB1KGksITApO3ZhciBhPW5ldyBFcnJvcihcIkNhbm5vdCBmaW5kIG1vZHVsZSAnXCIraStcIidcIik7dGhyb3cgYS5jb2RlPVwiTU9EVUxFX05PVF9GT1VORFwiLGF9dmFyIHA9bltpXT17ZXhwb3J0czp7fX07ZVtpXVswXS5jYWxsKHAuZXhwb3J0cyxmdW5jdGlvbihyKXt2YXIgbj1lW2ldWzFdW3JdO3JldHVybiBvKG58fHIpfSxwLHAuZXhwb3J0cyxyLGUsbix0KX1yZXR1cm4gbltpXS5leHBvcnRzfWZvcih2YXIgdT1cImZ1bmN0aW9uXCI9PXR5cGVvZiByZXF1aXJlJiZyZXF1aXJlLGk9MDtpPHQubGVuZ3RoO2krKylvKHRbaV0pO3JldHVybiBvfXJldHVybiByfSkoKSIsIk5LQy5tb2R1bGVzLlNlbGVjdFN0aWNrZXIgPSBmdW5jdGlvbigpIHtcbiAgdmFyIHNlbGYgPSB0aGlzO1xuICBzZWxmLmRvbSA9ICQoXCIjbW9kdWxlU2VsZWN0U3RpY2tlclwiKTtcbiAgc2VsZi5hcHAgPSBuZXcgVnVlKHtcbiAgICBlbDogXCIjbW9kdWxlU2VsZWN0U3RpY2tlckFwcFwiLFxuICAgIGRhdGE6IHtcbiAgICAgIHR5cGU6IFwib3duXCIsXG4gICAgICBwYWdlTnVtYmVyOiBcIlwiLFxuICAgICAgcGVycGFnZTogMjAsXG4gICAgICBzaGFyZVBlcnBhZ2U6IDI0LFxuICAgICAgZW1vamk6IFtdLFxuICAgICAgc2hhcmU6IGZhbHNlLFxuICAgICAgbG9jYWxTdGlja2VyczogW10sXG4gICAgICBzdGlja2VyczogW10sXG4gICAgICBwYWdpbmc6IHt9XG4gICAgfSxcbiAgICBtb3VudGVkOiBmdW5jdGlvbiAoKSB7XG4gICAgXG4gICAgfSxcbiAgICBtZXRob2RzOiB7XG4gICAgICBnZXRVcmw6IE5LQy5tZXRob2RzLnRvb2xzLmdldFVybCxcbiAgICAgIGluaXRNb2R1bGUoKSB7XG4gICAgICAgIHZhciBoZWlnaHQgPSBcIjQzLjVyZW1cIjtcbiAgICAgICAgc2VsZi5kb20uY3NzKHtcbiAgICAgICAgICBoZWlnaHQ6IGhlaWdodFxuICAgICAgICB9KTtcbiAgICAgICAgc2VsZi5kb20uZHJhZ2dhYmxlKHtcbiAgICAgICAgICBzY3JvbGw6IGZhbHNlLFxuICAgICAgICAgIGhhbmRsZTogXCIubW9kdWxlLXNzLXRpdGxlXCIsXG4gICAgICAgICAgZHJhZzogZnVuY3Rpb24oZXZlbnQsIHVpKSB7XG4gICAgICAgICAgICBpZih1aS5wb3NpdGlvbi50b3AgPCAwKSB1aS5wb3NpdGlvbi50b3AgPSAwO1xuICAgICAgICAgICAgdmFyIGhlaWdodCA9ICQod2luZG93KS5oZWlnaHQoKTtcbiAgICAgICAgICAgIGlmKHVpLnBvc2l0aW9uLnRvcCA+IGhlaWdodCAtIDMwKSB1aS5wb3NpdGlvbi50b3AgPSBoZWlnaHQgLSAzMDtcbiAgICAgICAgICAgIHZhciB3aWR0aCA9IHNlbGYuZG9tLndpZHRoKCk7XG4gICAgICAgICAgICBpZih1aS5wb3NpdGlvbi5sZWZ0IDwgMTAwIC0gd2lkdGgpIHVpLnBvc2l0aW9uLmxlZnQgPSAxMDAgLSB3aWR0aDtcbiAgICAgICAgICAgIHZhciB3aW5XaWR0aCA9ICQod2luZG93KS53aWR0aCgpO1xuICAgICAgICAgICAgaWYodWkucG9zaXRpb24ubGVmdCA+IHdpbldpZHRoIC0gMTAwKSB1aS5wb3NpdGlvbi5sZWZ0ID0gd2luV2lkdGggLSAxMDA7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0sXG4gICAgICByZXNldERvbVBvc2l0aW9uOiBmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyIGRvbSA9IHNlbGYuZG9tO1xuICAgICAgICB2YXIgd2lkdGggPSAkKHdpbmRvdykud2lkdGgoKTtcbiAgICAgICAgdmFyIGhlaWdodCA9ICQod2luZG93KS5oZWlnaHQoKTtcbiAgICAgICAgaWYod2lkdGggPCA3MDApIHtcbiAgICAgICAgICAvLyDlsI/lsY/luZVcbiAgICAgICAgICBkb20uY3NzKHtcbiAgICAgICAgICAgIFwid2lkdGhcIjogd2lkdGggKiAwLjgsXG4gICAgICAgICAgICBcInRvcFwiOiAwLFxuICAgICAgICAgICAgXCJyaWdodFwiOiAwXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8g5a695bGPXG4gICAgICAgICAgZG9tLmNzcyhcImxlZnRcIiwgKHdpZHRoIC0gZG9tLndpZHRoKCkpKjAuNSAtICA0MCk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBzZWxlY3RUeXBlKHR5cGUpIHtcbiAgICAgICAgdGhpcy50eXBlID0gdHlwZTtcbiAgICAgICAgaWYoW1wib3duXCIsIFwic2hhcmVcIl0uaW5jbHVkZXModHlwZSkpIHtcbiAgICAgICAgICB0aGlzLmdldFN0aWNrZXJzKCk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBjaGFuZ2VQYWdlKHR5cGUpIHtcbiAgICAgICAgY29uc3QgcGFnaW5nID0gdGhpcy5wYWdpbmc7XG4gICAgICAgIGlmKHBhZ2luZy5idXR0b25WYWx1ZS5sZW5ndGggPD0gMSkgcmV0dXJuO1xuICAgICAgICBpZih0eXBlID09PSBcImxhc3RcIiAmJiBwYWdpbmcucGFnZSA9PT0gMCkgcmV0dXJuO1xuICAgICAgICBpZih0eXBlID09PSBcIm5leHRcIiAmJiBwYWdpbmcucGFnZSArIDEgPT09IHBhZ2luZy5wYWdlQ291bnQpIHJldHVybjtcbiAgICAgICAgY29uc3QgY291bnQgPSB0eXBlID09PSBcImxhc3RcIj8gLTE6IDE7XG4gICAgICAgIHRoaXMuZ2V0U3RpY2tlcnMocGFnaW5nLnBhZ2UgKyBjb3VudCk7XG4gICAgICB9LFxuICAgICAgZ2V0U3RpY2tlcnMocGFnZSA9IDApIHtcbiAgICAgICAgY29uc3Qge3R5cGV9ID0gdGhpcztcbiAgICAgICAgaWYoIVtcIm93blwiLCBcInNoYXJlXCJdLmluY2x1ZGVzKHR5cGUpKSByZXR1cm47XG4gICAgICAgIGxldCB1cmwgPSBgL3N0aWNrZXI/cGFnZT0ke3BhZ2V9JmM9b3duJnJldmlld2VkPXRydWUmcGVycGFnZT0ke3RoaXMucGVycGFnZX1gO1xuICAgICAgICBpZih0eXBlID09PSBcInNoYXJlXCIpIHtcbiAgICAgICAgICB1cmwgPSBgL3N0aWNrZXJzP3BhZ2U9JHtwYWdlfSZwZXJwYWdlPSR7dGhpcy5zaGFyZVBlcnBhZ2V9YDtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgbmtjQVBJKHVybCwgXCJHRVRcIilcbiAgICAgICAgICAudGhlbihkYXRhID0+IHtcbiAgICAgICAgICAgIHNlbGYuYXBwLnN0aWNrZXJzID0gZGF0YS5zdGlja2VycztcbiAgICAgICAgICAgIHNlbGYuYXBwLnBhZ2luZyA9IGRhdGEucGFnaW5nO1xuICAgICAgICAgICAgaWYoZGF0YS5lbW9qaSkge1xuICAgICAgICAgICAgICBzZWxmLmFwcC5lbW9qaSA9IGRhdGEuZW1vamk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgICAuY2F0Y2goc3dlZXRFcnJvcik7XG4gICAgICB9LFxuICAgICAgZmFzdFNlbGVjdFBhZ2UoKSB7XG4gICAgICAgIGNvbnN0IHBhZ2VOdW1iZXIgPSB0aGlzLnBhZ2VOdW1iZXIgLSAxO1xuICAgICAgICBjb25zdCBwYWdpbmcgPSB0aGlzLnBhZ2luZztcbiAgICAgICAgaWYoIXBhZ2luZyB8fCAhcGFnaW5nLmJ1dHRvblZhbHVlLmxlbmd0aCkgcmV0dXJuO1xuICAgICAgICBjb25zdCBsYXN0TnVtYmVyID0gcGFnaW5nLmJ1dHRvblZhbHVlW3BhZ2luZy5idXR0b25WYWx1ZS5sZW5ndGggLSAxXS5udW07XG4gICAgICAgIGlmKHBhZ2VOdW1iZXIgPCAwIHx8IGxhc3ROdW1iZXIgPCBwYWdlTnVtYmVyKSByZXR1cm4gc3dlZXRJbmZvKFwi6L6T5YWl55qE6aG15pWw6LaF5Ye66IyD5Zu0XCIpO1xuICAgICAgICB0aGlzLmdldFN0aWNrZXJzKHBhZ2VOdW1iZXIpO1xuICAgICAgfSxcbiAgICAgIHNlbGVjdFN0aWNrZXIoc3RpY2tlcikge1xuICAgICAgICBzZWxmLmNhbGxiYWNrKHtcbiAgICAgICAgICB0eXBlOiBcInN0aWNrZXJcIixcbiAgICAgICAgICBkYXRhOiBzdGlja2VyXG4gICAgICAgIH0pO1xuICAgICAgfSxcbiAgICAgIHNlbGVjdEVtb2ppKGVtb2ppQ29kZSwgaW5kZXgpIHtcbiAgICAgICAgc2VsZi5jYWxsYmFjayh7XG4gICAgICAgICAgdHlwZTogXCJlbW9qaVwiLFxuICAgICAgICAgIGRhdGE6IGVtb2ppQ29kZVxuICAgICAgICB9KTtcbiAgICAgIH0sXG4gICAgICBhZGRMb2NhbEZpbGUoZmlsZSkge1xuICAgICAgICB0aGlzLmZpbGVUb1N0aWNrZXIoZmlsZSlcbiAgICAgICAgICAudGhlbihzdGlja2VyID0+IHtcbiAgICAgICAgICAgIHNlbGYuYXBwLmxvY2FsU3RpY2tlcnMucHVzaChzdGlja2VyKTtcbiAgICAgICAgICAgIHNlbGYuYXBwLnVwbG9hZExvY2FsU3RpY2tlcihzdGlja2VyKTtcbiAgICAgICAgICB9KVxuICAgICAgfSxcbiAgICAgIGZpbGVUb1N0aWNrZXIoZmlsZSkge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHN0aWNrZXIgPSB7ZmlsZX07XG4gICAgICAgICAgc3RpY2tlci5zdGF0dXMgPSBcInVuVXBsb2FkZWRcIjtcbiAgICAgICAgICBzdGlja2VyLnByb2dyZXNzID0gMDtcbiAgICAgICAgICBOS0MubWV0aG9kcy5maWxlVG9VcmwoZmlsZSlcbiAgICAgICAgICAgIC50aGVuKGJhc2U2NCA9PiB7XG4gICAgICAgICAgICAgIHN0aWNrZXIudXJsID0gYmFzZTY0O1xuICAgICAgICAgICAgICByZXNvbHZlKHN0aWNrZXIpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5jYXRjaChyZWplY3QpO1xuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICB9LFxuICAgICAgc2VsZWN0ZWRMb2NhbEZpbGUoKSB7XG4gICAgICAgIGNvbnN0IGlucHV0ID0gJChcIiNtb2R1bGVTZWxlY3RTdGlja2VySW5wdXRcIik7XG4gICAgICAgIGNvbnN0IGZpbGVzID0gaW5wdXRbMF0uZmlsZXM7XG4gICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBmaWxlcy5sZW5ndGg7IGkgKyspIHtcbiAgICAgICAgICBjb25zdCBmaWxlID0gZmlsZXNbaV07XG4gICAgICAgICAgc2VsZi5hcHAuYWRkTG9jYWxGaWxlKGZpbGUpO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgc2VsZWN0TG9jYWxGaWxlKCkge1xuICAgICAgICAkKFwiI21vZHVsZVNlbGVjdFN0aWNrZXJJbnB1dFwiKS5jbGljaygpO1xuICAgICAgfSxcbiAgICAgIHVwbG9hZExvY2FsU3RpY2tlcihzdGlja2VyKSB7XG4gICAgICAgIFByb21pc2UucmVzb2x2ZSgpXG4gICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgc3RpY2tlci5zdGF0dXMgPSBcInVwbG9hZGluZ1wiO1xuICAgICAgICAgICAgY29uc3QgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTtcbiAgICAgICAgICAgIGZvcm1EYXRhLmFwcGVuZChcImZpbGVcIiwgc3RpY2tlci5maWxlKTtcbiAgICAgICAgICAgIGZvcm1EYXRhLmFwcGVuZChcInR5cGVcIiwgXCJzdGlja2VyXCIpO1xuICAgICAgICAgICAgZm9ybURhdGEuYXBwZW5kKFwiZmlsZU5hbWVcIiwgc3RpY2tlci5maWxlLm5hbWUpO1xuICAgICAgICAgICAgaWYoc2VsZi5hcHAuc2hhcmUpIHtcbiAgICAgICAgICAgICAgZm9ybURhdGEuYXBwZW5kKFwic2hhcmVcIiwgXCJ0cnVlXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIG5rY1VwbG9hZEZpbGUoXCIvclwiLCBcIlBPU1RcIiwgZm9ybURhdGEsIGZ1bmN0aW9uKGUsIHByb2dyZXNzKSB7XG4gICAgICAgICAgICAgIHN0aWNrZXIucHJvZ3Jlc3MgPSBwcm9ncmVzcztcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0pXG4gICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgc3RpY2tlci5zdGF0dXMgPSBcInVwbG9hZGVkXCI7XG4gICAgICAgICAgICBzZWxmLmFwcC5sb2NhbFN0aWNrZXJzLnNwbGljZShzZWxmLmFwcC5sb2NhbFN0aWNrZXJzLmluZGV4T2Yoc3RpY2tlciksIDEpO1xuICAgICAgICAgICAgaWYoIXNlbGYuYXBwLmxvY2FsU3RpY2tlcnMubGVuZ3RoKSBzZWxmLmFwcC5zZWxlY3RUeXBlKFwib3duXCIpO1xuICAgICAgICAgIH0pXG4gICAgICAgICAgLmNhdGNoKChkYXRhKSA9PiB7XG4gICAgICAgICAgICBzY3JlZW5Ub3BXYXJuaW5nKGRhdGEuZXJyb3IgfHwgZGF0YSk7XG4gICAgICAgICAgICBzdGlja2VyLmVycm9yID0gZGF0YS5lcnJvciB8fCBkYXRhO1xuICAgICAgICAgICAgc3RpY2tlci5zdGF0dXMgPSBcInVuVXBsb2FkZWRcIjtcbiAgICAgICAgICB9KTtcbiAgICAgIH0sXG4gICAgICByZXN0YXJ0VXBsb2FkKHMpIHtcbiAgICAgICAgdGhpcy51cGxvYWRMb2NhbFN0aWNrZXIocyk7XG4gICAgICB9LFxuICAgICAgb3BlbihjYWxsYmFjaywgb3B0aW9ucykge1xuICAgICAgICBzZWxmLmNhbGxiYWNrID0gY2FsbGJhY2s7XG4gICAgICAgIHRoaXMucmVzZXREb21Qb3NpdGlvbigpO1xuICAgICAgICB0aGlzLmluaXRNb2R1bGUoKTtcbiAgICAgICAgc2VsZi5kb20uc2hvdygpO1xuICAgICAgICB0aGlzLmdldFN0aWNrZXJzKCk7XG4gICAgICB9LFxuICAgICAgY2xvc2UoKSB7XG4gICAgICAgIHNlbGYuZG9tLmhpZGUoKTtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xuICBzZWxmLm9wZW4gPSBzZWxmLmFwcC5vcGVuO1xuICBzZWxmLmNsb3NlID0gc2VsZi5hcHAuY2xvc2U7XG59OyJdfQ==
