(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
"use strict";

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

NKC.modules.downloadResource = /*#__PURE__*/function () {
  function _class() {
    _classCallCheck(this, _class);

    var self = this;
    self.dom = $("#moduleDownloadResource");
    self.app = new Vue({
      el: "#moduleDownloadResourceApp",
      data: {
        rid: "",
        fileName: "未知",
        type: "",
        size: 0,
        costs: [],
        hold: [],
        status: "loadding",
        fileCountLimitInfo: '',
        errorInfo: '',
        settingNoNeed: false
      },
      computed: {
        costMessage: function costMessage() {
          return this.costs.map(function (c) {
            return c.name + c.number;
          }).join("、");
        },
        holdMessage: function holdMessage() {
          return this.hold.map(function (c) {
            return c.name + c.number;
          }).join("、");
        }
      },
      methods: {
        fromNow: NKC.methods.fromNow,
        initDom: function initDom() {
          var height = "37rem";
          self.dom.css({
            height: height
          });
          self.dom.draggable({
            scroll: false,
            handle: ".module-sd-title",
            drag: function drag(event, ui) {
              if (ui.position.top < 0) ui.position.top = 0;
              var height = $(window).height();
              if (ui.position.top > height - 30) ui.position.top = height - 30;
              var width = self.dom.width();
              if (ui.position.left < 100 - width) ui.position.left = 100 - width;
              var winWidth = $(window).width();
              if (ui.position.left > winWidth - 100) ui.position.left = winWidth - 100;
            }
          });
          var width = $(window).width();

          if (width < 700) {
            // 小屏幕
            self.dom.css({
              "width": width * 0.8,
              "top": 0,
              "right": 0
            });
          } else {
            // 宽屏
            self.dom.css("left", (width - self.dom.width()) * 0.5 - 20);
          }

          self.dom.show();
        },
        getResourceInfo: function getResourceInfo(rid) {
          var self = this;
          self.status = 'loadding';
          self.errorInfo = ''; // 下载此附件是否需要积分

          nkcAPI("/r/".concat(rid, "?c=query&random=").concat(Math.random()), "GET", {}).then(function (data) {
            self.fileCountLimitInfo = data.fileCountLimitInfo;
            var dataUrl = "/r/".concat(rid, "?t=attachment&c=download&random=").concat(Math.random());
            /*if(data.settingNoNeed) {
              let downloadLink = $("<a></a>");
              downloadLink.attr("href", dataUrl);
              downloadLink[0].click();
              self.close();
              return;
            }*/

            self.status = data.need ? "needScore" : "noNeedScore";
            self.settingNoNeed = data.settingNoNeed;
            self.rid = data.rid;
            self.fileName = data.resource.oname;
            self.type = data.resource.ext;
            self.size = NKC.methods.getSize(data.resource.size);
            var myAllScore = data.myAllScore;
            if (!myAllScore) return;
            self.costs = myAllScore.map(function (score) {
              return {
                name: score.name,
                number: score.addNumber / 100 * -1
              };
            });
            self.hold = myAllScore.map(function (score) {
              return {
                name: score.name,
                number: score.number / 100
              };
            });
          })["catch"](function (data) {
            // self.close();
            // sweetError(data);
            self.fileCountLimitInfo = data.fileCountLimitInfo;
            self.status = 'error';
            self.errorInfo = data.error || data.message || data;
          });
        },
        open: function open(rid) {
          this.status = "loadding";
          this.initDom();
          this.getResourceInfo(rid);
        },
        close: function close() {
          self.dom.hide();
        }
      }
    });
    self.open = self.app.open;
    self.close = self.app.close;
  }

  return _class;
}();

(function () {
  var dr = new NKC.modules.downloadResource();
  var attachments = [].slice.call($("[data-tag='nkcsource'][data-type='attachment']"));
  attachments.forEach(function (attachment) {
    $(attachment).find("a.article-attachment-name").on("click", function (e) {
      e.preventDefault();
      e.stopPropagation();
      var rid = $(attachment).attr("data-id");
      dr.open(rid);
      return false;
    });
  });
})();

},{}]},{},[1])
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCJwYWdlcy9wdWJsaWNNb2R1bGVzL2Rvd25sb2FkUmVzb3VyY2UvZG93bmxvYWRSZXNvdXJjZS5tanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7O0FDQUEsR0FBRyxDQUFDLE9BQUosQ0FBWSxnQkFBWjtBQUNFLG9CQUFjO0FBQUE7O0FBQ1osUUFBTSxJQUFJLEdBQUcsSUFBYjtBQUNBLElBQUEsSUFBSSxDQUFDLEdBQUwsR0FBVyxDQUFDLENBQUMseUJBQUQsQ0FBWjtBQUNBLElBQUEsSUFBSSxDQUFDLEdBQUwsR0FBVyxJQUFJLEdBQUosQ0FBUTtBQUNqQixNQUFBLEVBQUUsRUFBRSw0QkFEYTtBQUVqQixNQUFBLElBQUksRUFBRTtBQUNKLFFBQUEsR0FBRyxFQUFFLEVBREQ7QUFFSixRQUFBLFFBQVEsRUFBRSxJQUZOO0FBR0osUUFBQSxJQUFJLEVBQUUsRUFIRjtBQUlKLFFBQUEsSUFBSSxFQUFFLENBSkY7QUFLSixRQUFBLEtBQUssRUFBRSxFQUxIO0FBTUosUUFBQSxJQUFJLEVBQUUsRUFORjtBQU9KLFFBQUEsTUFBTSxFQUFFLFVBUEo7QUFRSixRQUFBLGtCQUFrQixFQUFFLEVBUmhCO0FBU0osUUFBQSxTQUFTLEVBQUUsRUFUUDtBQVVKLFFBQUEsYUFBYSxFQUFFO0FBVlgsT0FGVztBQWNqQixNQUFBLFFBQVEsRUFBRTtBQUNSLFFBQUEsV0FEUSx5QkFDTTtBQUNaLGlCQUFPLEtBQUssS0FBTCxDQUFXLEdBQVgsQ0FBZSxVQUFBLENBQUM7QUFBQSxtQkFBSSxDQUFDLENBQUMsSUFBRixHQUFTLENBQUMsQ0FBQyxNQUFmO0FBQUEsV0FBaEIsRUFBdUMsSUFBdkMsQ0FBNEMsR0FBNUMsQ0FBUDtBQUNELFNBSE87QUFJUixRQUFBLFdBSlEseUJBSU07QUFDWixpQkFBTyxLQUFLLElBQUwsQ0FBVSxHQUFWLENBQWMsVUFBQSxDQUFDO0FBQUEsbUJBQUksQ0FBQyxD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QU5EO0FBT0QsR0FSRDtBQVNELENBWkEsR0FBRCIsImZpbGUiOiJnZW5lcmF0ZWQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uKCl7ZnVuY3Rpb24gcihlLG4sdCl7ZnVuY3Rpb24gbyhpLGYpe2lmKCFuW2ldKXtpZighZVtpXSl7dmFyIGM9XCJmdW5jdGlvblwiPT10eXBlb2YgcmVxdWlyZSYmcmVxdWlyZTtpZighZiYmYylyZXR1cm4gYyhpLCEwKTtpZih1KXJldHVybiB1KGksITApO3ZhciBhPW5ldyBFcnJvcihcIkNhbm5vdCBmaW5kIG1vZHVsZSAnXCIraStcIidcIik7dGhyb3cgYS5jb2RlPVwiTU9EVUxFX05PVF9GT1VORFwiLGF9dmFyIHA9bltpXT17ZXhwb3J0czp7fX07ZVtpXVswXS5jYWxsKHAuZXhwb3J0cyxmdW5jdGlvbihyKXt2YXIgbj1lW2ldWzFdW3JdO3JldHVybiBvKG58fHIpfSxwLHAuZXhwb3J0cyxyLGUsbix0KX1yZXR1cm4gbltpXS5leHBvcnRzfWZvcih2YXIgdT1cImZ1bmN0aW9uXCI9PXR5cGVvZiByZXF1aXJlJiZyZXF1aXJlLGk9MDtpPHQubGVuZ3RoO2krKylvKHRbaV0pO3JldHVybiBvfXJldHVybiByfSkoKSIsIk5LQy5tb2R1bGVzLmRvd25sb2FkUmVzb3VyY2UgPSBjbGFzcyB7XHJcbiAgY29uc3RydWN0b3IoKSB7XHJcbiAgICBjb25zdCBzZWxmID0gdGhpcztcclxuICAgIHNlbGYuZG9tID0gJChcIiNtb2R1bGVEb3dubG9hZFJlc291cmNlXCIpO1xyXG4gICAgc2VsZi5hcHAgPSBuZXcgVnVlKHtcclxuICAgICAgZWw6IFwiI21vZHVsZURvd25sb2FkUmVzb3VyY2VBcHBcIixcclxuICAgICAgZGF0YToge1xyXG4gICAgICAgIHJpZDogXCJcIixcclxuICAgICAgICBmaWxlTmFtZTogXCLmnKrnn6VcIixcclxuICAgICAgICB0eXBlOiBcIlwiLFxyXG4gICAgICAgIHNpemU6IDAsXHJcbiAgICAgICAgY29zdHM6IFtdLFxyXG4gICAgICAgIGhvbGQ6IFtdLFxyXG4gICAgICAgIHN0YXR1czogXCJsb2FkZGluZ1wiLFxyXG4gICAgICAgIGZpbGVDb3VudExpbWl0SW5mbzogJycsXHJcbiAgICAgICAgZXJyb3JJbmZvOiAnJyxcclxuICAgICAgICBzZXR0aW5nTm9OZWVkOiBmYWxzZSxcclxuICAgICAgfSxcclxuICAgICAgY29tcHV0ZWQ6IHtcclxuICAgICAgICBjb3N0TWVzc2FnZSgpIHtcclxuICAgICAgICAgIHJldHVybiB0aGlzLmNvc3RzLm1hcChjID0+IGMubmFtZSArIGMubnVtYmVyKS5qb2luKFwi44CBXCIpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgaG9sZE1lc3NhZ2UoKSB7XHJcbiAgICAgICAgICByZXR1cm4gdGhpcy5ob2xkLm1hcChjID0+IGMubmFtZSArIGMubnVtYmVyKS5qb2luKFwi44CBXCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSxcclxuICAgICAgbWV0aG9kczoge1xyXG4gICAgICAgIGZyb21Ob3c6IE5LQy5tZXRob2RzLmZyb21Ob3csXHJcbiAgICAgICAgaW5pdERvbSgpIHtcclxuICAgICAgICAgIGNvbnN0IGhlaWdodCA9IFwiMzdyZW1cIjtcclxuICAgICAgICAgIHNlbGYuZG9tLmNzcyh7XHJcbiAgICAgICAgICAgIGhlaWdodFxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgICBzZWxmLmRvbS5kcmFnZ2FibGUoe1xyXG4gICAgICAgICAgICBzY3JvbGw6IGZhbHNlLFxyXG4gICAgICAgICAgICBoYW5kbGU6IFwiLm1vZHVsZS1zZC10aXRsZVwiLFxyXG4gICAgICAgICAgICBkcmFnOiBmdW5jdGlvbihldmVudCwgdWkpIHtcclxuICAgICAgICAgICAgICBpZih1aS5wb3NpdGlvbi50b3AgPCAwKSB1aS5wb3NpdGlvbi50b3AgPSAwO1xyXG4gICAgICAgICAgICAgIGNvbnN0IGhlaWdodCA9ICQod2luZG93KS5oZWlnaHQoKTtcclxuICAgICAgICAgICAgICBpZih1aS5wb3NpdGlvbi50b3AgPiBoZWlnaHQgLSAzMCkgdWkucG9zaXRpb24udG9wID0gaGVpZ2h0IC0gMzA7XHJcbiAgICAgICAgICAgICAgY29uc3Qgd2lkdGggPSBzZWxmLmRvbS53aWR0aCgpO1xyXG4gICAgICAgICAgICAgIGlmKHVpLnBvc2l0aW9uLmxlZnQgPCAxMDAgLSB3aWR0aCkgdWkucG9zaXRpb24ubGVmdCA9IDEwMCAtIHdpZHRoO1xyXG4gICAgICAgICAgICAgIGNvbnN0IHdpbldpZHRoID0gJCh3aW5kb3cpLndpZHRoKCk7XHJcbiAgICAgICAgICAgICAgaWYodWkucG9zaXRpb24ubGVmdCA+IHdpbldpZHRoIC0gMTAwKSB1aS5wb3NpdGlvbi5sZWZ0ID0gd2luV2lkdGggLSAxMDA7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgY29uc3Qgd2lkdGggPSAkKHdpbmRvdykud2lkdGgoKTtcclxuICAgICAgICAgIGlmKHdpZHRoIDwgNzAwKSB7XHJcbiAgICAgICAgICAgIC8vIOWwj+Wxj+W5lVxyXG4gICAgICAgICAgICBzZWxmLmRvbS5jc3Moe1xyXG4gICAgICAgICAgICAgIFwid2lkdGhcIjogd2lkdGggKiAwLjgsXHJcbiAgICAgICAgICAgICAgXCJ0b3BcIjogMCxcclxuICAgICAgICAgICAgICBcInJpZ2h0XCI6IDBcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyDlrr3lsY9cclxuICAgICAgICAgICAgc2VsZi5kb20uY3NzKFwibGVmdFwiLCAod2lkdGggLSBzZWxmLmRvbS53aWR0aCgpKSowLjUgLSAyMCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBzZWxmLmRvbS5zaG93KCk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBnZXRSZXNvdXJjZUluZm8ocmlkKSB7XHJcbiAgICAgICAgICBsZXQgc2VsZiA9IHRoaXM7XHJcbiAgICAgICAgICBzZWxmLnN0YXR1cyA9ICdsb2FkZGluZyc7XHJcbiAgICAgICAgICBzZWxmLmVycm9ySW5mbyA9ICcnO1xyXG4gICAgICAgICAgLy8g5LiL6L295q2k6ZmE5Lu25piv5ZCm6ZyA6KaB56ev5YiGXHJcbiAgICAgICAgICBua2NBUEkoYC9yLyR7cmlkfT9jPXF1ZXJ5JnJhbmRvbT0ke01hdGgucmFuZG9tKCl9YCwgXCJHRVRcIiwge30pXHJcbiAgICAgICAgICAgIC50aGVuKGRhdGEgPT4ge1xyXG4gICAgICAgICAgICAgIHNlbGYuZmlsZUNvdW50TGltaXRJbmZvID0gZGF0YS5maWxlQ291bnRMaW1pdEluZm87XHJcbiAgICAgICAgICAgICAgbGV0IGRhdGFVcmwgPSBgL3IvJHtyaWR9P3Q9YXR0YWNobWVudCZjPWRvd25sb2FkJnJhbmRvbT0ke01hdGgucmFuZG9tKCl9YDtcclxuICAgICAgICAgICAgICAvKmlmKGRhdGEuc2V0dGluZ05vTmVlZCkge1xyXG4gICAgICAgICAgICAgICAgbGV0IGRvd25sb2FkTGluayA9ICQoXCI8YT48L2E+XCIpO1xyXG4gICAgICAgICAgICAgICAgZG93bmxvYWRMaW5rLmF0dHIoXCJocmVmXCIsIGRhdGFVcmwpO1xyXG4gICAgICAgICAgICAgICAgZG93bmxvYWRMaW5rWzBdLmNsaWNrKCk7XHJcbiAgICAgICAgICAgICAgICBzZWxmLmNsb3NlKCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgfSovXHJcbiAgICAgICAgICAgICAgc2VsZi5zdGF0dXMgPSBkYXRhLm5lZWRcclxuICAgICAgICAgICAgICAgID8gXCJuZWVkU2NvcmVcIlxyXG4gICAgICAgICAgICAgICAgOiBcIm5vTmVlZFNjb3JlXCJcclxuICAgICAgICAgICAgICBzZWxmLnNldHRpbmdOb05lZWQgPSBkYXRhLnNldHRpbmdOb05lZWQ7XHJcbiAgICAgICAgICAgICAgc2VsZi5yaWQgPSBkYXRhLnJpZDtcclxuICAgICAgICAgICAgICBzZWxmLmZpbGVOYW1lID0gZGF0YS5yZXNvdXJjZS5vbmFtZTtcclxuICAgICAgICAgICAgICBzZWxmLnR5cGUgPSBkYXRhLnJlc291cmNlLmV4dDtcclxuICAgICAgICAgICAgICBzZWxmLnNpemUgPSBOS0MubWV0aG9kcy5nZXRTaXplKGRhdGEucmVzb3VyY2Uuc2l6ZSk7XHJcbiAgICAgICAgICAgICAgbGV0IG15QWxsU2NvcmUgPSBkYXRhLm15QWxsU2NvcmU7XHJcbiAgICAgICAgICAgICAgaWYoIW15QWxsU2NvcmUpIHJldHVybjtcclxuICAgICAgICAgICAgICBzZWxmLmNvc3RzID0gbXlBbGxTY29yZS5tYXAoc2NvcmUgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgbmFtZTogc2NvcmUubmFtZSxcclxuICAgICAgICAgICAgICAgICAgbnVtYmVyOiBzY29yZS5hZGROdW1iZXIgLyAxMDAgKiAtMVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgIHNlbGYuaG9sZCA9IG15QWxsU2NvcmUubWFwKHNjb3JlID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgIG5hbWU6IHNjb3JlLm5hbWUsXHJcbiAgICAgICAgICAgICAgICAgIG51bWJlcjogc2NvcmUubnVtYmVyIC8gMTAwXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5jYXRjaChkYXRhID0+IHtcclxuICAgICAgICAgICAgICAvLyBzZWxmLmNsb3NlKCk7XHJcbiAgICAgICAgICAgICAgLy8gc3dlZXRFcnJvcihkYXRhKTtcclxuICAgICAgICAgICAgICBzZWxmLmZpbGVDb3VudExpbWl0SW5mbyA9IGRhdGEuZmlsZUNvdW50TGltaXRJbmZvO1xyXG4gICAgICAgICAgICAgIHNlbGYuc3RhdHVzID0gJ2Vycm9yJztcclxuICAgICAgICAgICAgICBzZWxmLmVycm9ySW5mbyA9IGRhdGEuZXJyb3IgfHwgZGF0YS5tZXNzYWdlIHx8IGRhdGE7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfSxcclxuICAgICAgICBvcGVuKHJpZCkge1xyXG4gICAgICAgICAgdGhpcy5zdGF0dXMgPSBcImxvYWRkaW5nXCI7XHJcbiAgICAgICAgICB0aGlzLmluaXREb20oKTtcclxuICAgICAgICAgIHRoaXMuZ2V0UmVzb3VyY2VJbmZvKHJpZCk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBjbG9zZSgpIHtcclxuICAgICAgICAgIHNlbGYuZG9tLmhpZGUoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgc2VsZi5vcGVuID0gc2VsZi5hcHAub3BlbjtcclxuICAgIHNlbGYuY2xvc2UgPSBzZWxmLmFwcC5jbG9zZTtcclxuICB9XHJcbn07XHJcblxyXG5cclxuKGZ1bmN0aW9uKCkge1xyXG4gIGNvbnN0IGRyID0gbmV3IE5LQy5tb2R1bGVzLmRvd25sb2FkUmVzb3VyY2UoKTtcclxuICBsZXQgYXR0YWNobWVudHMgPSBbXS5zbGljZS5jYWxsKCQoXCJbZGF0YS10YWc9J25rY3NvdXJjZSddW2RhdGEtdHlwZT0nYXR0YWNobWVudCddXCIpKTtcclxuICBhdHRhY2htZW50cy5mb3JFYWNoKGF0dGFjaG1lbnQgPT4ge1xyXG4gICAgJChhdHRhY2htZW50KS5maW5kKFwiYS5hcnRpY2xlLWF0dGFjaG1lbnQtbmFtZVwiKS5vbihcImNsaWNrXCIsIGUgPT4ge1xyXG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgIGxldCByaWQgPSAkKGF0dGFjaG1lbnQpLmF0dHIoXCJkYXRhLWlkXCIpO1xyXG4gICAgICBkci5vcGVuKHJpZCk7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH0pXHJcbiAgfSlcclxufSgpKTtcclxuIl19
