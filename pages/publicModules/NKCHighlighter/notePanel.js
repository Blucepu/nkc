(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
"use strict";

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

NKC.modules.NotePanel =
/*#__PURE__*/
function () {
  function _class() {
    _classCallCheck(this, _class);

    var self = this;
    self.app = new Vue({
      el: "#moduleNotePanel",
      data: {
        uid: NKC.configs.uid,
        disableNoteContent: false,
        show: false,
        edit: false,
        // 新添加的笔记内容
        content: "",
        // 显示笔记
        note: ""
        /* note的数据结构
        {
          _id: Number,
          type,
          targetId,
          notes: [
            {
              toc: Date,
              uid: String,
              user: {
                username: String,
                avatar: String,
                uid: String
              },
              content: String
            }
          ],
        }
        */

      },
      updated: function updated() {
        this.resetDom();
      },
      methods: {
        fromNow: NKC.methods.fromNow,
        getUrl: NKC.methods.tools.getUrl,
        visitUrl: NKC.methods.visitUrl,
        setTextareaSize: function setTextareaSize(size) {
          var textarea = this.$el.getElementsByClassName("create-textarea")[0];
          textarea.style.height = size;
        },
        resetTextarea: function resetTextarea() {
          this.content = "";
          this.setTextareaSize("2.5rem");
        },
        autoResize: function autoResize(e) {
          var textArea = e.target;
          var num = 2.5 * 12;
          textArea.style.height = '2.5rem';

          if (num < textArea.scrollHeight) {
            textArea.style.height = textArea.scrollHeight + 'px';
          }
        },
        saveNewNote: function saveNewNote() {
          // 创建新的
          var content = this.content,
              note = this.note;
          Promise.resolve().then(function () {
            if (!content) throw "请输入笔记内容";
            var type = note.type,
                targetId = note.targetId,
                nodes = note.nodes,
                _id = note._id;
            return nkcAPI("/note", "POST", {
              _id: _id,
              type: type,
              targetId: targetId,
              content: content,
              nodes: nodes
            });
          }).then(function (data) {
            self.app.content = "";
            self.app.resetTextarea();
            self.app.resetDom();
            self.callback(data.note);
            self.app.extendNoteContent(data.note);
            self.app.note = data.note;
            setTimeout(function () {
              self.app.scrollToBottom();
            }, 200);
          })["catch"](sweetError);
        },
        modifyNoteContent: function modifyNoteContent(n) {
          if (n.edit) {
            n.edit = false;
          } else {
            n.edit = true;
            if (!n._content) n._content = n.content;
          }
        },
        extendNoteContent: function extendNoteContent(note) {
          note.notes.map(function (n) {
            n.edit = false;
            n._content = "";
          });
        },
        saveNote: function saveNote(n) {
          // 保存编辑
          var note = this.note,
              uid = this.uid;
          var url,
              method,
              data = {};

          if (n.uid === uid) {
            url = "/note/".concat(note._id, "/c/").concat(n._id);
            method = "PATCH";
            data.content = n._content;
          } else {
            url = "/nkc/note";
            method = "POST";
            data.type = "modify";
            data.noteId = note._id;
            data.noteContentId = n._id;
            data.content = n._content;
          }

          nkcAPI(url, method, data).then(function (data) {
            n.content = n._content;
            n.html = data.noteContentHTML;
            self.app.modifyNoteContent(n);
            Vue.set(note.notes, note.notes.indexOf(n), n);
          })["catch"](sweetError);
        },
        open: function open(callback, options) {
          var _this = this;

          new Promise(function (resolve, reject) {
            self.app.resetDom();
            self.callback = callback;
            var id = options.id,
                note = options.note;

            if (note) {
              self.app.note = note;
              resolve();
            } else {
              nkcAPI("/note/".concat(id), "GET").then(function (data) {
                self.app.extendNoteContent(data.note);
                self.app.note = data.note;
                resolve();
              })["catch"](reject);
            }
          }).then(function () {
            _this.show = true;
            NKC.methods.initUnfixedPanel();
          })["catch"](sweetError);
        },
        close: function close() {
          this.show = false;
        },
        resetDom: function resetDom() {
          var dom = this.$el;
          dom.style.height = "auto";
        },
        scrollToBottom: function scrollToBottom() {
          var dom = this.$el.getElementsByClassName("note-panel-notes")[0];
          dom.scrollTop = dom.scrollHeight + 10000;
        },
        deleteNoteContent: function deleteNoteContent(n, type) {
          var note = this.note;
          var url,
              method,
              data = {};

          if (type === "delete") {
            url = "/note/".concat(note._id, "/c/").concat(n._id);
            method = "DELETE";
          } else {
            method = "POST";
            url = "/nkc/note";
            data.type = "disable";
            data.noteId = note._id;
            data.noteContentId = n._id;
          }

          sweetQuestion("确定要执行此操作？").then(function () {
            return nkcAPI(url, method, data);
          }).then(function () {
            sweetSuccess("操作成功");
          })["catch"](sweetError);
        }
      }
    });
    self.open = self.app.open;
    self.close = self.app.close;
  }

  return _class;
}();

},{}]},{},[1])
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9fYnJvd3Nlci1wYWNrQDYuMS4wQGJyb3dzZXItcGFjay9fcHJlbHVkZS5qcyIsInBhZ2VzL3B1YmxpY01vZHVsZXMvTktDSGlnaGxpZ2h0ZXIvbm90ZVBhbmVsLm1qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7QUNBQSxHQUFHLENBQUMsT0FBSixDQUFZLFNBQVo7QUFBQTtBQUFBO0FBQ0Usb0JBQWM7QUFBQTs7QUFDWixRQUFNLElBQUksR0FBRyxJQUFiO0FBQ0EsSUFBQSxJQUFJLENBQUMsR0FBTCxHQUFXLElBQUksR0FBSixDQUFRO0FBQ2pCLE1BQUEsRUFBRSxFQUFFLGtCQURhO0FBRWpCLE1BQUEsSUFBSSxFQUFFO0FBQ0osUUFBQSxHQUFHLEVBQUUsR0FBRyxDQUFDLE9BQUosQ0FBWSxHQURiO0FBRUosUUFBQSxrQkFBa0IsRUFBRSxLQUZoQjtBQUdKLFFBQUEsSUFBSSxFQUFFLEtBSEY7QUFJSixRQUFBLElBQUksRUFBRSxLQUpGO0FBS0o7QUFDQSxRQUFBLE9BQU8sRUFBRSxFQU5MO0FBT0o7QUFDQSxRQUFBLElBQUksRUFBRTtBQUNKOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQVRFLE9BRlc7QUErQmpCLE1BQUEsT0EvQmlCLHFCQStCUDtBQUNSLGFBQUssUUFBTDtBQUNELE9BakNnQjtBQWtDakIsTUFBQSxPQUFPLEVBQUU7QUFDUCxRQUFBLE9BQU8sRUFBRSxHQUFHLENBQUMsT0FBSixDQUFZLE9BRGQ7QUFFUCxRQUFBLE1BQU0sRUFBRSxHQUFHLENBQUMsT0FBSixDQUFZLEtBQVosQ0FBa0IsTUFGbkI7QUFHUCxRQUFBLFFBQVEsRUFBRSxHQUFHLENBQUMsT0FBSixDQUFZLFFBSGY7QUFJUCxRQUFBLGVBSk8sMkJBSVMsSUFKVCxFQUllO0FBQ3BCLGNBQU0sUUFBUSxHQUFHLEtBQUssR0FBTCxDQUFTLHNCQUFULENBQWdDLGlCQUFoQyxFQUFtRCxDQUFuRCxDQUFqQjtBQUNBLFVBQUEsUUFBUSxDQUFD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QUMsR0FBTCxDQUFTLElBQXJCO0FBQ0EsSUFBQSxJQUFJLENBQUMsS0FBTCxHQUFhLElBQUksQ0FBQyxHQUFMLENBQVMsS0FBdEI7QUFDRDs7QUF6TEg7QUFBQSIsImZpbGUiOiJnZW5lcmF0ZWQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uKCl7ZnVuY3Rpb24gcihlLG4sdCl7ZnVuY3Rpb24gbyhpLGYpe2lmKCFuW2ldKXtpZighZVtpXSl7dmFyIGM9XCJmdW5jdGlvblwiPT10eXBlb2YgcmVxdWlyZSYmcmVxdWlyZTtpZighZiYmYylyZXR1cm4gYyhpLCEwKTtpZih1KXJldHVybiB1KGksITApO3ZhciBhPW5ldyBFcnJvcihcIkNhbm5vdCBmaW5kIG1vZHVsZSAnXCIraStcIidcIik7dGhyb3cgYS5jb2RlPVwiTU9EVUxFX05PVF9GT1VORFwiLGF9dmFyIHA9bltpXT17ZXhwb3J0czp7fX07ZVtpXVswXS5jYWxsKHAuZXhwb3J0cyxmdW5jdGlvbihyKXt2YXIgbj1lW2ldWzFdW3JdO3JldHVybiBvKG58fHIpfSxwLHAuZXhwb3J0cyxyLGUsbix0KX1yZXR1cm4gbltpXS5leHBvcnRzfWZvcih2YXIgdT1cImZ1bmN0aW9uXCI9PXR5cGVvZiByZXF1aXJlJiZyZXF1aXJlLGk9MDtpPHQubGVuZ3RoO2krKylvKHRbaV0pO3JldHVybiBvfXJldHVybiByfSkoKSIsIk5LQy5tb2R1bGVzLk5vdGVQYW5lbCA9IGNsYXNzIHtcclxuICBjb25zdHJ1Y3RvcigpIHtcclxuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xyXG4gICAgc2VsZi5hcHAgPSBuZXcgVnVlKHtcclxuICAgICAgZWw6IFwiI21vZHVsZU5vdGVQYW5lbFwiLFxyXG4gICAgICBkYXRhOiB7XHJcbiAgICAgICAgdWlkOiBOS0MuY29uZmlncy51aWQsXHJcbiAgICAgICAgZGlzYWJsZU5vdGVDb250ZW50OiBmYWxzZSxcclxuICAgICAgICBzaG93OiBmYWxzZSxcclxuICAgICAgICBlZGl0OiBmYWxzZSxcclxuICAgICAgICAvLyDmlrDmt7vliqDnmoTnrJTorrDlhoXlrrlcclxuICAgICAgICBjb250ZW50OiBcIlwiLFxyXG4gICAgICAgIC8vIOaYvuekuueslOiusFxyXG4gICAgICAgIG5vdGU6IFwiXCIsXHJcbiAgICAgICAgICAvKiBub3Rl55qE5pWw5o2u57uT5p6EXHJcbiAgICAgICAgICB7XHJcbiAgICAgICAgICAgIF9pZDogTnVtYmVyLFxyXG4gICAgICAgICAgICB0eXBlLFxyXG4gICAgICAgICAgICB0YXJnZXRJZCxcclxuICAgICAgICAgICAgbm90ZXM6IFtcclxuICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICB0b2M6IERhdGUsXHJcbiAgICAgICAgICAgICAgICB1aWQ6IFN0cmluZyxcclxuICAgICAgICAgICAgICAgIHVzZXI6IHtcclxuICAgICAgICAgICAgICAgICAgdXNlcm5hbWU6IFN0cmluZyxcclxuICAgICAgICAgICAgICAgICAgYXZhdGFyOiBTdHJpbmcsXHJcbiAgICAgICAgICAgICAgICAgIHVpZDogU3RyaW5nXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgY29udGVudDogU3RyaW5nXHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBdLFxyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgKi9cclxuICAgICAgfSxcclxuICAgICAgdXBkYXRlZCgpIHtcclxuICAgICAgICB0aGlzLnJlc2V0RG9tKCk7XHJcbiAgICAgIH0sXHJcbiAgICAgIG1ldGhvZHM6IHtcclxuICAgICAgICBmcm9tTm93OiBOS0MubWV0aG9kcy5mcm9tTm93LFxyXG4gICAgICAgIGdldFVybDogTktDLm1ldGhvZHMudG9vbHMuZ2V0VXJsLFxyXG4gICAgICAgIHZpc2l0VXJsOiBOS0MubWV0aG9kcy52aXNpdFVybCxcclxuICAgICAgICBzZXRUZXh0YXJlYVNpemUoc2l6ZSkge1xyXG4gICAgICAgICAgY29uc3QgdGV4dGFyZWEgPSB0aGlzLiRlbC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKFwiY3JlYXRlLXRleHRhcmVhXCIpWzBdO1xyXG4gICAgICAgICAgdGV4dGFyZWEuc3R5bGUuaGVpZ2h0ID0gc2l6ZTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHJlc2V0VGV4dGFyZWEoKSB7XHJcbiAgICAgICAgICB0aGlzLmNvbnRlbnQgPSBcIlwiO1xyXG4gICAgICAgICAgdGhpcy5zZXRUZXh0YXJlYVNpemUoXCIyLjVyZW1cIik7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBhdXRvUmVzaXplKGUpIHtcclxuICAgICAgICAgIGNvbnN0IHRleHRBcmVhID0gZS50YXJnZXQ7XHJcbiAgICAgICAgICBjb25zdCBudW0gPSAyLjUgKiAxMjtcclxuICAgICAgICAgIHRleHRBcmVhLnN0eWxlLmhlaWdodCA9ICcyLjVyZW0nO1xyXG4gICAgICAgICAgaWYobnVtIDwgdGV4dEFyZWEuc2Nyb2xsSGVpZ2h0KSB7XHJcbiAgICAgICAgICAgIHRleHRBcmVhLnN0eWxlLmhlaWdodCA9IHRleHRBcmVhLnNjcm9sbEhlaWdodCArICdweCc7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzYXZlTmV3Tm90ZSgpIHtcclxuICAgICAgICAgIC8vIOWIm+W7uuaWsOeahFxyXG4gICAgICAgICAgY29uc3Qge2NvbnRlbnQsIG5vdGV9ID0gdGhpcztcclxuICAgICAgICAgIFByb21pc2UucmVzb2x2ZSgpXHJcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgICBpZighY29udGVudCkgdGhyb3cgXCLor7fovpPlhaXnrJTorrDlhoXlrrlcIjtcclxuICAgICAgICAgICAgICBjb25zdCB7dHlwZSwgdGFyZ2V0SWQsIG5vZGVzLCBfaWR9ID0gbm90ZTtcclxuICAgICAgICAgICAgICByZXR1cm4gbmtjQVBJKFwiL25vdGVcIiwgXCJQT1NUXCIsIHtcclxuICAgICAgICAgICAgICAgIF9pZCxcclxuICAgICAgICAgICAgICAgIHR5cGUsXHJcbiAgICAgICAgICAgICAgICB0YXJnZXRJZCxcclxuICAgICAgICAgICAgICAgIGNvbnRlbnQsXHJcbiAgICAgICAgICAgICAgICBub2Rlc1xyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAudGhlbihkYXRhID0+IHtcclxuICAgICAgICAgICAgICBzZWxmLmFwcC5jb250ZW50ID0gXCJcIjtcclxuICAgICAgICAgICAgICBzZWxmLmFwcC5yZXNldFRleHRhcmVhKCk7XHJcbiAgICAgICAgICAgICAgc2VsZi5hcHAucmVzZXREb20oKTtcclxuICAgICAgICAgICAgICBzZWxmLmNhbGxiYWNrKGRhdGEubm90ZSk7XHJcbiAgICAgICAgICAgICAgc2VsZi5hcHAuZXh0ZW5kTm90ZUNvbnRlbnQoZGF0YS5ub3RlKTtcclxuICAgICAgICAgICAgICBzZWxmLmFwcC5ub3RlID0gZGF0YS5ub3RlO1xyXG4gICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5hcHAuc2Nyb2xsVG9Cb3R0b20oKTtcclxuICAgICAgICAgICAgICB9LCAyMDApXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5jYXRjaChzd2VldEVycm9yKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIG1vZGlmeU5vdGVDb250ZW50KG4pIHtcclxuICAgICAgICAgIGlmKG4uZWRpdCkge1xyXG4gICAgICAgICAgICBuLmVkaXQgPSBmYWxzZTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIG4uZWRpdCA9IHRydWU7XHJcbiAgICAgICAgICAgIGlmKCFuLl9jb250ZW50KSBuLl9jb250ZW50ID0gbi5jb250ZW50O1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZXh0ZW5kTm90ZUNvbnRlbnQobm90ZSkge1xyXG4gICAgICAgICAgbm90ZS5ub3Rlcy5tYXAobiA9PiB7XHJcbiAgICAgICAgICAgIG4uZWRpdCA9IGZhbHNlO1xyXG4gICAgICAgICAgICBuLl9jb250ZW50ID0gXCJcIjtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2F2ZU5vdGUobikge1xyXG4gICAgICAgICAgLy8g5L+d5a2Y57yW6L6RXHJcbiAgICAgICAgICBjb25zdCB7bm90ZSwgdWlkfSA9IHRoaXM7XHJcbiAgICAgICAgICBsZXQgdXJsLCBtZXRob2QsIGRhdGEgPSB7fTtcclxuICAgICAgICAgIGlmKG4udWlkID09PSB1aWQpIHtcclxuICAgICAgICAgICAgdXJsID0gYC9ub3RlLyR7bm90ZS5faWR9L2MvJHtuLl9pZH1gO1xyXG4gICAgICAgICAgICBtZXRob2QgPSBcIlBBVENIXCI7XHJcbiAgICAgICAgICAgIGRhdGEuY29udGVudCA9IG4uX2NvbnRlbnQ7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB1cmwgPSBgL25rYy9ub3RlYDtcclxuICAgICAgICAgICAgbWV0aG9kID0gXCJQT1NUXCI7XHJcbiAgICAgICAgICAgIGRhdGEudHlwZSA9IFwibW9kaWZ5XCI7XHJcbiAgICAgICAgICAgIGRhdGEubm90ZUlkID0gbm90ZS5faWQ7XHJcbiAgICAgICAgICAgIGRhdGEubm90ZUNvbnRlbnRJZCA9IG4uX2lkO1xyXG4gICAgICAgICAgICBkYXRhLmNvbnRlbnQgPSBuLl9jb250ZW50O1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgbmtjQVBJKHVybCwgbWV0aG9kLCBkYXRhKVxyXG4gICAgICAgICAgICAudGhlbigoZGF0YSkgPT4ge1xyXG4gICAgICAgICAgICAgIG4uY29udGVudCA9IG4uX2NvbnRlbnQ7XHJcbiAgICAgICAgICAgICAgbi5odG1sID0gZGF0YS5ub3RlQ29udGVudEhUTUw7XHJcbiAgICAgICAgICAgICAgc2VsZi5hcHAubW9kaWZ5Tm90ZUNvbnRlbnQobik7XHJcbiAgICAgICAgICAgICAgVnVlLnNldChub3RlLm5vdGVzLCBub3RlLm5vdGVzLmluZGV4T2YobiksIG4pO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuY2F0Y2goc3dlZXRFcnJvcik7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBvcGVuKGNhbGxiYWNrLCBvcHRpb25zKSB7XHJcbiAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIHNlbGYuYXBwLnJlc2V0RG9tKCk7XHJcbiAgICAgICAgICAgIHNlbGYuY2FsbGJhY2sgPSBjYWxsYmFjaztcclxuICAgICAgICAgICAgY29uc3Qge2lkLCBub3RlfSA9IG9wdGlvbnM7XHJcbiAgICAgICAgICAgIGlmKG5vdGUpIHtcclxuICAgICAgICAgICAgICBzZWxmLmFwcC5ub3RlID0gbm90ZTtcclxuICAgICAgICAgICAgICByZXNvbHZlKCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgbmtjQVBJKGAvbm90ZS8ke2lkfWAsIFwiR0VUXCIpXHJcbiAgICAgICAgICAgICAgICAudGhlbihkYXRhID0+IHtcclxuICAgICAgICAgICAgICAgICAgc2VsZi5hcHAuZXh0ZW5kTm90ZUNvbnRlbnQoZGF0YS5ub3RlKTtcclxuICAgICAgICAgICAgICAgICAgc2VsZi5hcHAubm90ZSA9IGRhdGEubm90ZTtcclxuICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC5jYXRjaChyZWplY3QpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgICB0aGlzLnNob3cgPSB0cnVlO1xyXG4gICAgICAgICAgICAgIE5LQy5tZXRob2RzLmluaXRVbmZpeGVkUGFuZWwoKTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmNhdGNoKHN3ZWV0RXJyb3IpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgY2xvc2UoKSB7XHJcbiAgICAgICAgICB0aGlzLnNob3cgPSBmYWxzZTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHJlc2V0RG9tKCkge1xyXG4gICAgICAgICAgY29uc3QgZG9tID0gdGhpcy4kZWw7XHJcbiAgICAgICAgICBkb20uc3R5bGUuaGVpZ2h0ID0gXCJhdXRvXCI7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzY3JvbGxUb0JvdHRvbSgpIHtcclxuICAgICAgICAgIGNvbnN0IGRvbSA9IHRoaXMuJGVsLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoXCJub3RlLXBhbmVsLW5vdGVzXCIpWzBdO1xyXG4gICAgICAgICAgZG9tLnNjcm9sbFRvcCA9IGRvbS5zY3JvbGxIZWlnaHQgKyAxMDAwMDtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGRlbGV0ZU5vdGVDb250ZW50KG4sIHR5cGUpIHtcclxuICAgICAgICAgIGNvbnN0IHtub3RlfSA9IHRoaXM7XHJcbiAgICAgICAgICBsZXQgdXJsLCBtZXRob2QsIGRhdGEgPSB7fTtcclxuICAgICAgICAgIGlmKHR5cGUgPT09IFwiZGVsZXRlXCIpIHtcclxuICAgICAgICAgICAgdXJsID0gYC9ub3RlLyR7bm90ZS5faWR9L2MvJHtuLl9pZH1gO1xyXG4gICAgICAgICAgICBtZXRob2QgPSBcIkRFTEVURVwiO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgbWV0aG9kID0gXCJQT1NUXCI7XHJcbiAgICAgICAgICAgIHVybCA9IGAvbmtjL25vdGVgO1xyXG4gICAgICAgICAgICBkYXRhLnR5cGUgPSBcImRpc2FibGVcIjtcclxuICAgICAgICAgICAgZGF0YS5ub3RlSWQgPSBub3RlLl9pZDtcclxuICAgICAgICAgICAgZGF0YS5ub3RlQ29udGVudElkID0gbi5faWQ7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBzd2VldFF1ZXN0aW9uKFwi56Gu5a6a6KaB5omn6KGM5q2k5pON5L2c77yfXCIpXHJcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgICByZXR1cm4gbmtjQVBJKHVybCwgbWV0aG9kLCBkYXRhKTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgc3dlZXRTdWNjZXNzKFwi5pON5L2c5oiQ5YqfXCIpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuY2F0Y2goc3dlZXRFcnJvcilcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgc2VsZi5vcGVuID0gc2VsZi5hcHAub3BlbjtcclxuICAgIHNlbGYuY2xvc2UgPSBzZWxmLmFwcC5jbG9zZTtcclxuICB9XHJcbn07Il19
