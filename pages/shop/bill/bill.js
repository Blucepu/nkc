!function n(o,s,i){function a(t,e){if(!s[t]){if(!o[t]){var r="function"==typeof require&&require;if(!e&&r)return r(t,!0);if(c)return c(t,!0);throw(r=new Error("Cannot find module '"+t+"'")).code="MODULE_NOT_FOUND",r}r=s[t]={exports:{}},o[t][0].call(r.exports,function(e){return a(o[t][1][e]||e)},r,r.exports,n,o,s,i)}return s[t].exports}for(var c="function"==typeof require&&require,e=0;e<i.length;e++)a(i[e]);return a}({1:[function(e,t,r){"use strict";function u(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return a(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return a(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,t=function(){};return{s:t,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:t}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,i=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){i=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(i)throw o}}}}function a(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var n=NKC.methods.getDataById("data");n.results.map(function(e){e.buyMessage="",e.products.map(function(e){var t=e.product;t.isFreePost||(e.freightName=t.freightTemplates[0].name,e.certId="")})});new Vue({el:"#app",data:{addresses:n.addresses,selectedAddress:n.addresses[0]||"",results:n.results,freightTotal:0,priceTotal:0,showAddressForm:!1,addressForm:{username:"",address:"",location:"",mobile:""}},mounted:function(){this.extendProduct(),window.SelectAddress=new NKC.modules.SelectAddress},methods:{getUrl:NKC.methods.tools.getUrl,visitUrl:NKC.methods.visitUrl,checkString:NKC.methods.checkData.checkString,switchAddressForm:function(){this.showAddressForm=!this.showAddressForm},saveAddressForm:function(){var t=this,e=this.addressForm,r=e.username,n=e.address,o=e.location,s=e.mobile;Promise.resolve().then(function(){return t.checkString(r,{name:"收件人姓名",minLength:1,maxLength:50}),t.checkString(o,{name:"所在地区",minLength:1,maxLength:100}),t.checkString(n,{name:"详细地址",minLength:1,maxLength:500}),t.checkString(s,{name:"手机号",minLength:1,maxLength:100}),nkcAPI("/u/".concat(NKC.configs.uid,"/settings/transaction"),"PUT",{operation:"add",addresses:[t.addressForm]})}).then(function(e){t.addresses=e.addresses,t.addresses.length?t.selectedAddress=t.addresses[t.addresses.length-1]:t.selectedAddress="",t.switchAddressForm()}).catch(sweetError)},selectLocation:function(){var t=this;SelectAddress.open(function(e){t.addressForm.location=e.join(" ")})},changeCount:function(e,t){if("up"==e){if(t.count>=t.productParam.stocksSurplus)return void screenTopWarning("库存不足");t.count++}else 1<t.count&&t.count--;this.extendProduct()},extendProduct:function(){var c=0,d=0;this.results.map(function(e){e.products.map(function(e){var t=e.freightName,r=e.product,n=r.freightTemplates,r=r.isFreePost;if(!r){var o=u(n);try{for(o.s();!(s=o.n()).done;){var s=s.value;s.name===t&&(e.freight=s)}}catch(e){o.e(e)}finally{o.f()}}var i=0,a=0;e.params.map(function(e){var t=e.count,e=e.price;i+=t,a+=t*e}),e.countTotal=i,e.priceTotal=a,e.freightTotal=0,r||(1===e.countTotal?e.freightTotal=e.freight.firstPrice:e.freightTotal=e.freight.firstPrice+e.freight.addPrice*(e.countTotal-1)),c+=e.freightTotal,d+=e.priceTotal})}),this.freightTotal=c,this.priceTotal=d},selectAddress:function(e){this.selectedAddress=e},setFreightByName:function(){this.extendProduct()},getAddresses:function(){var t=this;nkcAPI(window.location.href+"&t=".concat(Date.now()),"GET").then(function(e){t.addresses=e.addresses,sweetSuccess("刷新成功")}).catch(sweetError)},selectedFile:function(t,r){var e=r.product,n=$("input.hidden.input-".concat(e.productId))[0].files[0],e=new FormData;e.append("type","shopping"),e.append("file",n),nkcUploadFile("/shop/cert","POST",e).then(function(e){r.certId=e.cert._id,Vue.set(t.products,t.products.indexOf(r),r),sweetSuccess("上传成功")}).catch(sweetError)},getCert:function(e){NKC.methods.visitUrl("/shop/cert/".concat(e),!0)},submit:function(){var e=this.results,n={params:[],address:this.selectedAddress};Promise.resolve().then(function(){if(!n.address)throw"请选择收货地址";return e.map(function(e){var t=e.products,r=e.user,e=e.buyMessage,a={uid:r.uid,buyMessage:e,products:[]};t.map(function(e){var t=e.product,r=e.params,n=e.priceTotal,o=e.freightTotal,s=e.certId,e=e.freightName;if(t.uploadCert&&!s)throw"请上传凭证";if(!t.isFreePost&&!e)throw"请选择物流";var i={productId:t.productId,priceTotal:n,freightTotal:o,certId:s,freightName:e,productParams:[]};r.map(function(e){var t=e.productParam,r=e.count,n=e.price,e=e.cartId;i.productParams.push({_id:t._id,cartId:e,count:r,price:n})}),a.products.push(i)}),n.params.push(a)}),console.log(n),nkcAPI("/shop/order","POST",n)}).then(function(e){openToNewLocation("/shop/pay?ordersId="+e.ordersId.join("-")),sweetSuccess("提交成功，正在前往付款页面")}).catch(sweetError)}}})},{}]},{},[1]);