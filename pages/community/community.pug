extends ../bootstrap_base
block title
  title=`社区 - ${state.serverSettings.websiteName} - ${state.serverSettings.brief}`
  +includeCSS('/community/community.css')
block content
  include ./homeForumList
  .container-fluid.max-width
    .row
      .col-xs-12.col-md-8.box-shadow-panel
        for cf in data.categoryForums
          .home-forums-list.m-b-1.category-forums
            .panel-header=cf.name
            //-.home-header
              .header-name(title=cf.description)=cf.name
            for f in cf.forums
              if cf.displayStyle === 'simple'
                +forumList(f, cf.displayStyle)
              else if cf.displayStyle === 'detailed'
                +detailedForumList(f)
              else
                +normalForumList(f)
      .col-xs-12.col-md-4.box-shadow-panel.p-l-0
        .m-b-1
          include ../publicModules/canvas_logo
        include ../publicModules/improveUserInfo
        if data.notices && data.notices.length
          .home-forums-other.m-b-1
            .panel-header 公告通知
            .home-notices
              for thread in data.notices
                .home-notice
                  a(href=`/t/${thread.tid}`)= thread.firstPost.t
        if data.user && data.subForums.length
          .m-b-1
            .panel-header 关注的专业
            .home-forums-list
              //-.home-header
                //.fa.fa-tags
                .header-name 关注的专业
                //.header-description 关注最新话题，足不出户便能游遍世界~
              .home-subscribes
                if data.subscribesDisplayMode === "column"
                  for forum in data.subForums
                    include ../home/subscribes_column
                if data.subscribesDisplayMode === "row" || !data.subscribesDisplayMode
                  for forum in data.subForums
                    a(href=`/f/${forum.fid}` data-float-fid=forum.fid).home-subscribe-forum
                      .home-subscribe-forum-avatar
                        if forum.logo
                          img(src=tools.getUrl("forumLogo", forum.logo))
                        else
                          div(style=`background-color: ${forum.color}`)
                      .home-subscribe-forum-info=forum.displayName
                if data.subscribesDisplayMode === 'brief'
                  for forum in data.subForums
                    a.home-subscribe-forum-brief(href=`/f/${forum.fid}` data-float-fid=forum.fid)=forum.displayName
        if permissionsOr(["visitExperimentalStatus", "complaintGet", "review", "visitProblemList", "getLibraryLogs", "nkcManagement"])
          .home-forums-other.m-b-1
            .panel-header 网站管理
            .home-managements
              if permission("nkcManagement")
                a.home-management(href="/nkc" target='_blank')
                  .fa.fa-cogs
                  span &nbsp;前台管理
              if permission("visitExperimentalStatus")
                a.home-management(href="/e" target='_blank')
                  .fa.fa-cogs
                  span &nbsp;后台管理
              if permission("review")
                a.home-management(href="/review" target='_blank')
                  .fa.fa-shield
                  span &nbsp;审核内容
                  if data.unReviewedCount
                    .count=data.unReviewedCount
              if permission("complaintGet")
                a.home-management(href="/complaint" target='_blank')
                  .fa.fa-minus-circle
                  span &nbsp;投诉列表
                  if data.unResolvedComplaintCount
                    .count=data.unResolvedComplaintCount
              if permission("visitProblemList")
                a.home-management(href="/problem/list" target='_blank')
                  .fa.fa-exclamation-circle
                  span &nbsp;问题列表
                  if data.unResolvedProblemCount
                    .count=data.unResolvedProblemCount
              if permission("getLibraryLogs")
                a.home-management(href="/libraries/logs" target='_blank')
                  .fa.fa-book
                  span &nbsp;文库记录
        .home-forums-other.m-b-1.m-t-1
          .panel-header 应用
          .home-apps
            if data.enableFund
              a.home-app(href=`/fund` target="_blank")
                .home-app-img
                  img(src=`/statics/apps/fund.png`)
                .home-app-name= data.fundName || "基金"
            a.home-app(href=`/exam` target="_blank")
              .home-app-img
                img(src=`/statics/apps/exam.png`)
              .home-app-name 考试系统
            if data.showActivityEnter
              a.home-app(href=`/activity` target="_blank")
                .home-app-img
                  img(src=`/statics/apps/activity.png`)
                .home-app-name 活动
            if data.siteToolEnabled
              a.home-app(href=`/tools` target="_blank")
                .home-app-img
                  img(src=`/statics/apps/tools.png`)
                .home-app-name 计算工具
        //- 最新发表
        if data.originalThreads && data.originalThreads.length > 0
          .home-forums-list.m-b-1
            .panel-header.m-b-0 最新发表
            .home-threads
              -const defaultThreadListStyle = {type: 'brief'}
              for thread in data.originalThreads
                include ../publicModules/thread_panel/thread_panel
              a.home-threads-more-link(href=`/?t=latest`) 查看全部新讨论
        .home-forums-other.m-b-1
          .panel-header 最新回复
          .home-posts
            for post in data.latestPosts
              .home-post
                .home-post-time
                  //-=fromNow(post.toc)
                  +fromNow(post.toc)
                if !post.user
                  span 匿名用户
                else
                  a.home-post-user(href=`/u/${post.user.uid}` target="_blank")
                    img(src=tools.getUrl("userAvatar", post.user.avatar) data-float-uid=post.user.uid)
                    span=post.user.username
                if post.type === "reply"
                  span 回复
                else
                  span 评论
                if !post.targetUser
                  span 匿名用户
                else
                  a.home-post-user(href=`/u/${post.targetUser.uid}` target="_blank")
                    img(src=tools.getUrl("userAvatar", post.targetUser.avatar) data-float-uid=post.targetUser.uid)
                    span=post.targetUser.username
                span ：
                a.home-post-content(href=post.url target="_blank")
                  div=post.c

        //- 推荐阅读
        .home-forums-other.m-b-1
          .panel-header 推荐阅读
          .home-threads
            for thread in data.featuredThreads
              .home-thread
                a(href=`/t/${thread.tid}` target="_blank").home-thread-title=thread.firstPost.t
                if thread.firstPost.cover
                  .home-thread-cover
                    img(src=tools.getUrl("postCover", thread.firstPost.cover))
                .home-thread-content
                  .home-thread-abstract=thread.firstPost.abstractCn || thread.firstPost.c
                  .home-thread-info
                    if thread.firstPost.anonymous
                      a.home-thread-user
                        img(src=anonymousInfo.avatar)
                        span=anonymousInfo.username
                    else
                      a(href=`/u/${thread.firstPost.uid}` target="_blank").home-thread-user
                        img(src=tools.getUrl("userAvatar", thread.firstPost.user.avatar) data-float-uid=thread.firstPost.uid)
                        span=thread.firstPost.user.username
                    a(href=`/f/${thread.forums[0].fid}` target="_blank" data-float-fid=thread.forums[0].fid).home-thread-forum=thread.forums[0].displayName
        //- 最新基金申请
        if data.enableFund
          .m-b-1
            .panel-header 最新基金申请
            .home-funds
              for form in data.fundApplicationForms
                .home-fund
                  a.home-fund-name(href=`/fund/a/${form._id}` target="_blank")=form.project.t
                  .home-fund-info
                    .home-fund-code=form.code
                    a(href=`/fund/list/${form.fund._id}` target="_blank").home-fund-link.fund-name=form.fund.name
                    a(href=`/u/${form.uid}` target="_blank").home-fund-user
                      img(src=tools.getUrl("userAvatar", form.applicant.user.avatar) data-float-uid=form.uid)
                      span=form.applicant.user.username

              a.home-fund-donation(href=`/fund/donation` target="_blank")= `赞助${data.fundName}`
        // 最近活跃用户
        if data.activeUsers && data.activeUsers.length > 0
          include ../publicModules/activeUsers/activeUsers
          +activeUsers(data.activeUsers)
        //- 活跃用户
        //- 最新发表