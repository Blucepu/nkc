!function s(o,i,r){function a(t,e){if(!i[t]){if(!o[t]){var n="function"==typeof require&&require;if(!e&&n)return n(t,!0);if(c)return c(t,!0);throw(n=new Error("Cannot find module '"+t+"'")).code="MODULE_NOT_FOUND",n}n=i[t]={exports:{}},o[t][0].call(n.exports,function(e){return a(o[t][1][e]||e)},n,n.exports,s,o,i,r)}return i[t].exports}for(var c="function"==typeof require&&require,e=0;e<r.length;e++)a(r[e]);return a}({1:[function(e,t,n){"use strict";function v(e){return function(e){if(Array.isArray(e))return s(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||a(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function T(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=a(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var s=0,t=function(){};return{s:t,n:function(){return s>=e.length?{done:!0}:{done:!1,value:e[s++]}},e:function(e){throw e},f:t}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,r=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){r=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(r)throw o}}}}function a(e,t){if(e){if("string"==typeof e)return s(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?s(e,t):void 0}}function s(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,s=new Array(t);n<t;n++)s[n]=e[n];return s}var o=NKC.methods.getDataById("data");new Audio;window.app=new Vue({el:"#app",data:{socketId:Date.now()+""+Math.round(1e3*Math.random()),type:o.type,originMessages:o.messages,showStickerPanel:!1,twemoji:o.twemoji,tUser:o.tUser,mUser:o.mUser,content:"",getMessageStatus:"canLoad",audio:new Audio},methods:{timeFormat:NKC.methods.timeFormat,getUrl:NKC.methods.tools.getUrl,toast:function(e){e=e.error||e.message||e,NKC.methods.rn.emit("toast",{content:e})},scrollToBottom:function(){var t=this;setTimeout(function(){var e=t.$refs.listContent;e.scrollTop=e.scrollHeight+1e4},200)},switchStickerPanel:function(e){this.showStickerPanel=void 0===e?!this.showStickerPanel:!!e},selectSticker:function(e){var t,n=this,s=this.content,o=this.$refs.input;o.selectionStart?i=o.selectionStart:document.selection&&(o.focus(),(t=(r=document.selection.createRange()).duplicate()).moveToElementText(o),t.setEndPoint("EndToEnd",r),i=t.text.length-r.text.length);var i,r="[f/"+e+"]";1<i?(i=(e=s.substring(0,i))+r,this.content=s.replace(e,i)):this.content=r+(this.content||""),setTimeout(function(){n.autoResize()},200)},autoResize:function(e){var t=this.$refs.input;t.style.height=2.8*12+"px",!e&&2.8*12<t.scrollHeight&&(t.style.height=t.scrollHeight+"px")},keepFocus:function(e){e&&this.$refs.input.focus()},visitImages:function(e){var t=[],n=T(this.messages);try{for(n.s();!(s=n.n()).done;){var s=s.value;"img"===s.contentType&&t.push({name:s.content.filename,url:s.content.fileUrl})}}catch(e){n.e(e)}finally{n.f()}e=t.map(function(e){return e.url}).indexOf(e);t.map(function(e){return e.url=location.origin+e.url}),NKC.methods.rn.emit("viewImage",{index:e,urls:t})},openUserHome:function(e){"UTU"===e.messageType&&(NKC.configs.uid===e.s?NKC.methods.visitUrl(NKC.methods.tools.getUrl("userHome",e.s),!0):NKC.methods.visitUrl(NKC.methods.tools.getUrl("messageUserDetail",e.s),!0))},selectLocalFiles:function(){var e=this.$refs.file;e.value=null,e.click()},selectedLocalFiles:function(){var t=T(this.$refs.file.files);try{for(t.s();!(e=t.n()).done;){var e=e.value;this.sendMessage("sendFile",e)}}catch(e){t.e(e)}finally{t.f()}},sendMessage:function(e,t){var n,s,o=this;NKC.methods.rn.emit("getKeyboardStatus",{},function(e){o.keepFocus("show"===e.keyboardStatus)}),["sendText","sendFile"].includes(e)?(n={_id:Date.now(),contentType:"html",s:o.mUser.uid,r:o.tUser.uid,messageType:"UTU"},s=new FormData,"sendText"===e?n.content=t:(n.content=t.name,s.append("file",t)),s.append("content",n.content),s.append("socketId",o.socketId),n.formData=s):n=t,n.status="sending",n.time=Date.now(),Promise.resolve().then(function(){if(!n.content)throw"请输入聊天内容";return"resend"!==e&&o.originMessages.push(n),o.content="",o.autoResize(!0),o.scrollToBottom(),nkcUploadFile("/message/user/".concat(n.r),"POST",n.formData)}).then(function(e){var t=o.originMessages.indexOf(n);n.status="sent",0<=t&&(Vue.set(o.originMessages,t,e.message2),o.scrollToBottom())}).catch(function(e){n.status="error",o.toast(e.error||e.message||e)})},getMessage:function(){var e=self=this,t=e.firstMessageId,n=e.tUser,e=e.type,e="/message/data?type=".concat(e);if(t&&(e+="&firstMessageId=".concat(t)),n.uid&&(e+="&uid=".concat(n.uid)),"canLoad"===self.getMessageStatus)return self.getMessageStatus="loading",nkcAPI(e,"GET").then(function(e){self.originMessages=self.originMessages.concat(e.messages2),e.messages2.length?self.getMessageStatus="canLoad":self.getMessageStatus="cantLoad"}).catch(function(e){self.toast(e),self.getMessageStatus="canLoad"})},getOriginMessageById:function(e){var t=T(this.originMessages);try{for(t.s();!(n=t.n()).done;){var n=n.value;if(n._id===e)return n}}catch(e){t.e(e)}finally{t.f()}},insertMessage:function(e){var t=e.messageType,n=e.r,s=e.s,o=this.tUser,i=this.mUser;if("UTU"===t){o=[o.uid,i.uid];if(!o.includes(n)||!o.includes(s))return;this.mUser.uid!==e.s&&this.markAsRead()}else if("STU"===t){if(n!==i.uid)return;this.markAsRead()}else if("STE"===t)this.markAsRead();else if("friendsApplication"===t&&n!==i.uid)return;this.originMessages.push(e),this.scrollToBottom()},withdrawn:function(t,e){var n=this;Promise.resolve().then(function(){if(!e)return nkcAPI("/message/withdrawn","PUT",{messageId:t})}).then(function(){var e=n.getOriginMessageById(t);e&&(e.contentType="withdrawn")}).catch(n.toast)},markAsRead:function(){var e=self=this,t=e.type,n=e.tUser;setTimeout(function(){nkcAPI("/message/mark","PUT",{type:t,uid:n.uid}).catch(self.toast)},1e3)},useCamera:function(e){var t="takePictureAndSendToUser";"video"===e?t="takeVideoAndSendToUser":"audio"===e&&(t="recordAudioAndSendToUser"),NKC.methods.rn.emit(t,{uid:this.tUser.uid,socketId:null})},newFriendOperation:function(e,t){var n=this.getOriginMessageById(e);nkcAPI("/u/"+n.s+"/friends/agree","POST",{agree:t}).then(function(e){n.content=e.message.content}).catch(this.toast)},playVoice:function(e){var t=this.audio,n=this.stopPlayVoice,s=this.getOriginMessageById;if("playing"===e.content.playStatus)return n();n(),t.src=e.content.fileUrl+"&t=".concat(Date.now()),setTimeout(function(){t.play(),s(e._id).content.playStatus="playing"},200)},stopPlayVoice:function(){var e=this.audio;try{e.pause()}catch(e){}var t=T(this.originMessages);try{for(t.s();!(n=t.n()).done;){var n=n.value;"voice"===n.contentType&&(n.content.playStatus="unPlay")}}catch(e){t.e(e)}finally{t.f()}}},computed:{firstMessageId:function(){var t=T(this.messages);try{for(t.s();!(e=t.n()).done;){var e=e.value;if("time"!==e.contentType)return e._id}}catch(e){t.e(e)}finally{t.f()}},messages:function(){var e=this.originMessages,t=this.mUser,n=this.tUser,s=(new Date).getTime(),o=[],i={},r=[],a=T(e);try{for(a.s();!(l=a.n()).done;){var c=l.value,u=c._id,l=c.s===t.uid;o.push(u),c.position=l?"right":"left",c.sUser=l?t:n,c.canWithdrawn="sent"===c.status&&l&&s-new Date(c.time)<6e4,i[u]=c}}catch(e){a.e(e)}finally{a.f()}var f=T(o=(o=v(new Set(o))).sort(function(e,t){return e-t}));try{for(f.s();!(d=f.n()).done;){var d=d.value;r.push(i[d])}}catch(e){f.e(e)}finally{f.f()}for(var h=[],g=0;g<r.length;g++){var m,p=r[g],y=p.time;0===g?h.push({contentType:"time",content:y}):(m=r[g-1],6e4<new Date(y).getTime()-new Date(m.time).getTime()&&h.push({contentType:"time",content:y})),h.push(p)}return h}},mounted:function(){var t=this,n=t.$refs.listContent;window.addEventListener("click",function(){t.showStickerPanel&&t.switchStickerPanel(!1)}),t.scrollToBottom(),n.onscroll=function(){20<this.scrollTop||(n.scrollTo=n.scrollTop,n.height=n.scrollHeight,t.getMessage().then(function(){var e=n.scrollHeight;n.scrollTop=e-n.height}).catch(function(e){t.toast(e.error||e.message||e)}))},t.audio.addEventListener("ended",function(){t.stopPlayVoice()})}})},{}]},{},[1]);