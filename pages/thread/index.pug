extends ../bootstrap_base.pug

block title
  -let showEditor = true;
  -const thread = data.thread;
  title= `${thread.firstPost.t} - 科创`
  meta#replytarget(value=`${data.replyTarget}`)

  -let modifyPostTimeLimit = 0;
  -for(let i = 0; i < data.userRoles.length; i++)
    -const r = data.userRoles[i];
    if r.modifyPostTimeLimit > modifyPostTimeLimit
      -modifyPostTimeLimit = r.modifyPostTimeLimit
    if r.modifyPostTimeLimit === -1
      -modifyPostTimeLimit = -1;
      -break;

  -const postTo = data.userOperationsId.includes('quotePost')
  -const addCredit = data.userOperationsId.includes('creditXsf') && data.isModerator
  -const addKcb = data.userOperationsId.includes('creditKcb')
  -const disablePost = data.userOperationsId.includes('disabledPost') || data.userOperationsId.includes('moveDraft')
  -const highlight = data.highlight;
  -const digestPost = data.userOperationsId.includes('digestPost') && data.isModerator;
  -const unDigestPost = data.userOperationsId.includes('unDigestPost')  && data.isModerator;

  if (thread.firstPost&&thread.firstPost.c)
    -var processed=thread.firstPost.c.replace(/\[.*?]|\#|\n|\<.*?>/gm,'').trim().slice(0,140)
    
    meta(name='description' content=`${processed}`)
    meta(name='keywords' content=`${thread.firstPost.t}`)
    link(rel='stylesheet' href=`/external_pkgs/imageToBig/preview.css?v=${global.NKC.startTime}`)
    +includeCSS("/jquery-ui-1.10.4.custom.css")
    +includeJS("/external_pkgs/imageToBig/preview.js")
    include ../publicModules/plyr/plyr.css.pug
  if !state.isApp
    style=`body{background-color: ${(data.user?data.user.color:null) || "#f4f4f4"}!important;`

  mixin postOptions(post, targetThread, index, dropType)
    -dropType = dropType || "dropdown";
    .inline-block.post-options(style='margin-right: 0;color: #aaaaaa;' class=dropType)
      div(class=`dropdown-toggle` data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false")
        span.fa.fa-sliders
        if targetThread
          span &nbsp;操作
      //-ul.dropdown-menu.stop-propagation(style='left: auto;right: 0;' data-stopPropagation=true)
      ul.dropdown-menu(style='left: auto;right: 0;' data-stopPropagation=true)
        if targetThread && data.authorColumn
          li
            if !data.addedToColumn
              a(href=`javascript:addToColumn("${targetThread.oc}", "${data.authorColumn._id}")`)
                span.fa.fa-share-square-o &nbsp;推送到我的专栏
            else
              a(href=`javascript:removeToColumn("${targetThread.oc}", "${data.authorColumn._id}")`)
                span.fa.fa-share-square-o &nbsp;从我的专栏撤稿
        li
          a(href=`/p/${post.pid}`)
            span.fa.fa-newspaper-o &nbsp;
            span 详情
        if permission("getPostAuthor") && post.anonymous
          li
            a(onclick=`getPostAuthor('${post.pid}')`)
              span.fa.fa-user-secret &nbsp;
              span 作者
        if permission("anonymousPost")
          li
            a(onclick=`anonymousPost('${post.pid}', ${!!!post.anonymous})`)
              span.fa.fa-user-secret &nbsp;
              span=post.anonymous? "取消匿名": "设为匿名"
        if postTo && !thread.closed
          if targetThread
            li
              a(onclick="quotePostWithout()")
                span.fa.fa-comment-o &nbsp;
                span 回复
          else
            li
              a(onclick=`quotePost('${post.pid}', '${data.paging.start + index}', '${data.paging.page.toString()}')`)
                span.fa.fa-comment-o &nbsp;
                span 回复
        if !thread.closed && !post.anonymous
          li
            a(onclick=`at('${post.user.username}')`)
              span.fa.fa-at= ` ${post.user.username}`
        if targetThread && targetThread.oc === post.pid && !targetThread.firstPost.anonymous
          li
            a(href=`/t/${thread.tid}?t=author`)
              .fa.fa-filter &nbsp;只看作者

        if targetThread && targetThread.oc === post.pid && data.user && data.userOperationsId.includes('collectThread')

          li
            if data.collected
              a(onclick=`SubscribeTypes.collectionThread('${thread.tid}', false)`)
                span.fa.fa-folder-o &nbsp;已收藏
            else
              a(onclick=`SubscribeTypes.collectionThread('${thread.tid}', true)`)
                span.fa.fa-folder-o &nbsp;加入收藏
          li
            if data.subscribed
              a(onclick=`SubscribeTypes.subscribeThread('${thread.tid}', false)`)
                span.fa.fa-bookmark-o &nbsp;取消关注
            else
              a(onclick=`SubscribeTypes.subscribeThread('${thread.tid}', true)`)
                span.fa.fa-bookmark-o &nbsp;关注
        if data.user && data.thread.oc !== post.pid && data.hasPermissionToHidePost
          li
            a(onclick=`openHidePostPanel('${post.pid}', '${post.hide}')`)
              .fa.fa-compress &nbsp;折叠回复
        if data.thread.oc !== post.pid && data.topPost
          li
            if data.thread.toppedPostsId.includes(post.pid)
              a(onclick=`topPost('${post.pid}', false)`)
               .fa.fa-thumb-tack &nbsp;取消置顶
            else
              a(onclick=`topPost('${post.pid}', true)`)
               .fa.fa-thumb-tack &nbsp;置顶

        if addCredit
          li
            a(onclick=`credit('${post.pid}', 'xsf')`)
              span.fa.fa-graduation-cap &nbsp;
              span 评学术分
        if digestPost && !post.digest
          li
            a(onclick=`digestPost("${post.pid}")`)
              span.fa.fa-star-o &nbsp;设为精选
        if unDigestPost && post.digest
          li
            a(onclick=`unDigestPost("${post.pid}")`)
              span.fa.fa-star &nbsp;取消精选
        - var ownership = data.userOperationsId.includes('modifyOtherPosts')
        - ownership = ownership?true:(post.ownPost)
        //-if addKcb && post.uid !== data.user.uid
          li
            a(onclick=` credit("${post.pid}", 'kcb', ${data.user.kcb})`)
              span.fa.fa-thumbs-o-up &nbsp;
              span 鼓励
        if permission("postWarningPost")
          li
            a(onclick=`openPostWarningDom("${post.pid}")`)
              span.fa.fa-ambulance &nbsp;建议修改

        if(testModifyTimeLimit(modifyPostTimeLimit, ownership, post.toc))
          if (post.ownPost) || (data.isModerator && permission('modifyOtherPosts'))
            if !targetThread || targetThread.type !== "fund"
              li
                a(href=`/editor?ver=ue&type=post&id=${post.pid}`)
                  span.fa.fa-edit &nbsp;编辑
        if disablePost && !targetThread
          li
            a(onclick=`disablePostClick('${post.pid}', "${targetThread?'thread':'post'}")`)
              span.fa.fa-eye-slash &nbsp;退修或删除
        if(post.tlm > post.toc && data.userOperationsId.includes('visitPostHistory'))
          if !post.hideHistories || data.userOperationsId.includes('displayPostHideHistories')
            li
              a(href=`/p/${post.pid}/history`)
                span.fa.fa-history &nbsp;历史版本
        if data.user
          li.divider
            if targetThread && targetThread.oc === post.pid
              li
                a(onclick=`moduleComplaint.open("thread", "${thread.tid}")`)
                  span.fa.fa-minus-circle &nbsp;投诉
            else
              li
                a(onclick=`moduleComplaint.open("post", "${post.pid}")`)
                  span.fa.fa-minus-circle &nbsp;投诉
        li.divider
        li
          a
            span.fa.fa-clock-o= ` ${post.toc.toLocaleString()}`
        if disablePost
          li
            -const ipoc = post.iplm || post.ipoc;
            a(href=`http://www.ip138.com/ips138.asp?ip=${ipoc.toString()}&action=2` title=ipoc target='_blank')
              span.fa.fa-map-marker(style='margin-left: 2px;')= ` ${ipoc}`

  mixin postEditTime(post)
    if post.toc.toLocaleString() !== post.tlm.toLocaleString()
      p.lighttext [修改于 #{fromNow(post.tlm)} - #{dateString(post.tlm)}]
  mixin postCredits(post)
    if post && post.credits && post.credits.length > 0
      .nkcpanel.ThreadPostCredits
        for c,index in post.credits
          -var username = c.fromUser.username
          -var profile = '/u/'+c.from
          .ThreadPostCreditItem
            if c.type === "creditKcb"
              -c.num = c.num/100;
            span.TPCQ!= `${(c.num > 0 ? '+' : '')}${c.num} &nbsp;`
            span.TPCType #{creditString(c.type)} &nbsp;&nbsp;
            span.TPCIA
              a(href=`${profile}` style='text-decoration: none;')
                img.TPCIAI(src=`/avatar/${c.fromUser.avatar}?t=sm`)
                span.TPCIssuer &nbsp;#{username} &nbsp;&nbsp;
            span.TPCDate #{dateTimeString(c.toc).split(' ')[0]} &nbsp;&nbsp;
            span.TPCReason #{c.description}
            if c.type === 'xsf' && data.user && permission('cancelXsf')
              a(style='margin-left: 0.5rem;cursor: pointer;' onclick=`cancelXsf("${post.pid}", ${c._id})`) 撤销
            if c.type === 'creditKcb' && data.user && permission('modifyKcbRecordReason')
              if !c.hideDescription
                a(style='margin-left: 0.5rem;cursor: pointer;' onclick=`hideKcbRecordReason("${post.pid}", ${c._id}, true)`) 屏蔽
              else
                a(style='margin-left: 0.5rem;cursor: pointer;' onclick=`hideKcbRecordReason("${post.pid}", ${c._id}, false)`) 取消屏蔽
block content
  include ../publicModules/mobile_drawer/right_drawer
  -const moveThread = data.isModerator || data.userOperationsId.includes('moveThread');
  -const {exactPost} = data
    .container-fluid.max-width
      .hidden#threadId= data.thread.tid
      .hidden#threadForumsId=objToStr({pid: data.thread.oc, tid: data.thread.tid, mainForumsId: data.thread.mainForumsId, categoriesId: data.thread.categoriesId})
      if data.step
        .hidden#quotePost= JSON.stringify({page: data.paging.page, step: data.step, pid: data.pid})
      include ../module_credit
      include ../module_digest
      .row
        .col-xs-12.col-md-9#wrap.box-shadow-panel
          .m-b-1
            .row
              .thread-div
                .col-xs-12.col-md-12
                  .thread-management
                    .title
                      if thread.forum
                        a(href=`/f/${thread.forum.fid}` style='text-decoration: none;')
                          span(style=`padding: 2px 5px;color: #ffffff;border-radius:5px;background-color: ${thread.forum.color}`)= thread.forum.displayName
                      if data.user
                        -let canManagement = false;
                        -for(let i = 0; i < data.userOperationsId.length; i++)
                          -const operationId = data.userOperationsId[i];
                          if ['moveDraft', 'moveThread', 'digestThread', 'unDigestThread', 'toppedThread', 'unToppedThread', 'homeTop', 'unHomeTop'].includes(operationId)
                            -canManagement = true;
                            -break;
                        if data.isModerator && canManagement
                          a(onclick="displayManagement();" style='text-decoration: none;float: right;')
                            .highlight.fa.fa-cog
                      if data.user
                        div.managementDiv(style='display: none;margin-top: 1rem;')
                          .form-inline
                            //- 设置置顶
                            if data.isModerator && data.userOperationsId.includes('toppedThread') && !thread.topped
                              button.btn.btn-default.btn-sm#threadTop(onclick=`setTopped('${data.thread.tid}')`) 专业置顶
                            if data.isModerator && data.userOperationsId.includes('unToppedThread') && thread.topped
                              button.btn.btn-default.btn-sm#threadTop(onclick=`cancelTopped('${data.thread.tid}')`) 取消专业置顶
                            if data.userOperationsId.includes("homeAd")
                              if data.homeAd
                                button.btn.btn-default.btn-sm(onclick=`unHomeAd('${data.thread.tid}')`) 取消首页推荐
                              else
                                a.btn.btn-default.btn-sm(href=`/t/${data.thread.tid}/ad`).m-l-05 首页推荐
                            if data.userOperationsId.includes("homeTop")
                              if data.homeTopped
                                button.btn.btn-default.btn-sm(onclick=`unHomeTop('${data.thread.tid}')`) 取消首页置顶
                              else
                                button.btn.btn-default.btn-sm(onclick=`homeTop('${data.thread.tid}')`) 首页置顶
                            if data.userOperationsId.includes("pushGoodsToHome") && data.product
                              if data.goodsHomeTopped
                                button.btn.btn-default.btn-sm(onclick=`pushGoodsToHome('${data.product.productId}', 'unPush')`) 取消热销
                              else
                                button.btn.btn-default.btn-sm(onclick=`pushGoodsToHome('${data.product.productId}', 'push')`) 设为热销
                            //-if data.userOperationsId.includes('homeTop') && !data.ads.movable.includes(data.thread.tid) && !data.ads.fixed.includes(data.thread.tid)
                              button.btn.btn-default.btn-sm#threadTop(onclick=`homeTop('${data.thread.tid}')`) 首页置顶
                            //-if data.userOperationsId.includes('unHomeTop') && (data.ads.movable.includes(data.thread.tid) || data.ads.fixed.includes(data.thread.tid))
                              button.btn.btn-default.btn-sm#threadTop(onclick=`unHomeTop('${data.thread.tid}')`) 取消首页置顶
                            if data.userOperationsId.includes('closeThread') && !thread.closed
                              button.btn.btn-default.btn-sm(onclick=`closeThread('${data.thread.tid}')`) 关闭主题
                            if data.userOperationsId.includes('openThread') && thread.closed
                              button.btn.btn-default.btn-sm(onclick=`openThread('${data.thread.tid}')`) 开放主题
                            if permission("moveThreads")
                               button.btn-sm.btn.btn-default(onclick="moveThread()") 移动
                            if permissionsOr(["movePostsToDraft", "movePostsToRecycle"])
                              button.btn-sm.btn.btn-danger(onclick="deleteThread()") 退修/删除
                          if data.thread.type === "fund"
                            h5.text-danger 科创基金类文章无法退修
                          //-if permission('addThreadForum') || permission("removeThreadForum") || permission('moveThread') || permission("moveDraft")
                            div
                              if permission('addThreadForum') || permission("removeThreadForum")
                                div(v-if='forums.length !== 0')
                                  h5 已选择专业
                                  div
                                    for forum in thread.forums
                                      span(style=`border-radius: 4px;display: inline-block;margin-right: 0.5rem;color: #fff;padding: 0.5rem 1rem;background-color: ${forum.color}`)=`${forum.forumType === 'topic'?'(话题)':'(学科)'}${forum.displayName}`
                                        .fa.fa-remove(style='cursor: pointer;' onclick=`removeForumsId("${data.thread.tid}", "${forum.fid}")`)

                              if permission('moveThread') || permission("moveDraft")
                                if data.thread.type === "fund"
                                  h5.text-danger 科创基金类文章无法退修
                                div(style='margin-top:0.5rem;')
                                  button.btn.btn-danger.btn-sm(type="button" class="btn btn-primary" data-toggle="modal" data-target="#recycleModal" data-whatever="@mdo") 退修或删除

                .col-xs-12.col-md-12
                  .row
                    if !thread.reviewed
                      -let reviewData = {reviewPid: thread.oc, reviewType: "thread"}
                      include ../publicModules/module_review
                    .col-xs-12.col-md-12(style=`margin: 0.5rem 0 0 0;${thread.recycleMark?'border: 1px solid #ff5a0b;padding: 0.5rem;border-radius: 5px;background-color: #fafafa;':''}`)
                      if thread.recycleMark
                        .h4.text-center(style='color: #ff5a0b;') 本文已被退回修改，请作者点击编辑按钮进入编辑界面
                        p.text-center(style='border-bottom: 1px solid #ff5a0b; padding-bottom: 1rem;color: #ff5a0b;')= `退修原因：${thread.reason}`
                      if thread.type !== "fund"
                        .h3.thread-title.text-center= thread.firstPost.t
                      -const post = thread.firstPost;
                      -post.c = hideContentByUser(post.c, data.user, 'thread')
                      if post.authorInfos && post.authorInfos.length > 0 && data.thread.type !== "product"
                        -var agencyIndex = 1;
                        -var agencyArray = [];
                        -var agencyAddArray = [];
                        -for(var i=0;i<post.authorInfos.length;i++) {
                          -if(post.authorInfos[i].agency){
                            -if(agencyArray.indexOf(post.authorInfos[i].agency) == -1){
                              -agencyArray.push(post.authorInfos[i].agency);
                              -if(post.authorInfos[i].agencyCountry && post.authorInfos[i].agencyCountry.length > 0){
                                -post.authorInfos[i].agencyAdd = post.authorInfos[i].agencyAdd.replace(/\//igm, " ");
                                -agencyAddArray.push(post.authorInfos[i].agency+"，"+post.authorInfos[i].agencyCountry+" "+post.authorInfos[i].agencyAdd);
                              -}else if(post.authorInfos[i].agencyAdd){
                                -agencyAddArray.push(post.authorInfos[i].agency+"，" + post.authorInfos[i].agencyAdd);
                              -}else{
                                -agencyAddArray.push(post.authorInfos[i].agency);
                              -}
                              -post.authorInfos[i].agencyIndex = agencyIndex;
                              -agencyIndex++;
                            -}else{
                              -post.authorInfos[i].agencyIndex = agencyArray.indexOf(post.authorInfos[i].agency)+1;
                            -}
                          -}
                        -}
                        .thread-info.text-center(style="color:#000;margin-top:1rem")
                          if post.authorInfos.length > 1
                            for auth,index in post.authorInfos
                              span(style="margin-right:10px;font-weight: bold;")
                                if auth.kcid.length > 0
                                  span(style="cursor: pointer;" onclick=`turnUser(${auth.kcid})`)!=`${auth.name}`
                                  if auth.agencyIndex && agencyAddArray.length > 1
                                    sup!=`${auth.agencyIndex}`
                                else
                                  span!=`${auth.name}`
                                  if auth.agencyIndex && agencyAddArray.length > 1
                                    sup!=`${auth.agencyIndex}`
                                if auth.isContract
                                  span.fa.fa-envelope-open-o(style="color:#000" onclick="displayAuthor('"+objToStr(auth.contractObj)+"')")

                          else
                            for auth,index in post.authorInfos
                              span(style="margin-right:10px;font-weight: bold;")
                                if auth.kcid.length > 0
                                  span(style="cursor: pointer;" onclick=`turnUser(${auth.kcid})`)!=`${auth.name}`
                                else
                                  span!=`${auth.name}`
                                if auth.isContract
                                  span.fa.fa-envelope-open-o(style="color:#000" onclick="displayAuthor('"+objToStr(auth.contractObj)+"')")

                        .thread-info.text-center(style="color:#000;margin-top:1rem")
                          if post.authorInfos.length > 1
                            for agad,index in agencyAddArray
                              span(style="margin-right:10px")!=`${index+1}.${agad}`
                          else
                            for agad,index in agencyAddArray
                              span(style="margin-right:10px")!=`${agad}`
                      if thread.type !== "fund"
                        .thread-info.text-center(style="margin-top:1.5rem")
                          if !thread.firstPost.anonymous
                            a(href=`/u/${thread.uid}` data-float-uid=thread.uid)
                              img(src=`/avatar/${thread.firstPost.user.avatar}?t=sm` style='width: 1.5rem;height: 1.5rem;border-radius:50%;')
                              span= ` ${thread.firstPost.user.username}`
                          else
                            img(src=anonymousInfo.avatar style='width: 1.5rem;height: 1.5rem;border-radius:50%;')
                            span.anonymous-name= ` ${anonymousInfo.username}`
                          span(style='color: #555555;margin-right:5px')= ` ${thread.toc.toLocaleDateString()}`
                          if thread.firstPost.originState && thread.firstPost.originState !== "0"
                            -var levelText = getOriginLevel(thread.firstPost.originState);
                            if thread.firstPost.originState == "3" || thread.firstPost.originState == "4" || thread.firstPost.originState == "5" || thread.firstPost.originState == "6"
                              span(style="color:#9baec8;margin-right:3px") 原创
                            span(class="dropdown")
                              a(id="dropdown-level" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle")
                                span.fa.fa-caret-square-o-down(style="color:#b5b4b4")
                              .dropdown-menu(aria-labelledby='dropdown-level')
                                span(style="padding:5px")!=`${levelText}`
                          if data.columnPost
                            a(href=`/m/${data.targetColumn._id}`)= data.targetColumn.name
                          else
                            for forum, index in thread.forums
                              if index > 0
                                span ,&nbsp;
                              a(href=`/f/${forum.fid}` data-float-fid=forum.fid)=forum.displayName
                        if (post.abstractCn.length !== 0 || post.abstractEn.length !== 0) && data.thread.type !== "product"
                          .abstract(style="margin-top:1rem; word-break: break-all;")
                            if post.abstractCn.length !== 0
                              .panel.panel-default(style="border:0;margin-bottom:0")
                                .panel-heading.paperHeader 中文摘要
                                .panel-body!=LineFeedConversion(post.abstractCn)
                            if post.abstractEn.length !== 0
                              .panel.panel-default(style="border:0;margin-bottom:0")
                                .panel-heading.paperHeader Abstract
                                .panel-body!=LineFeedConversion(post.abstractEn)
                        if (post.keyWordsCn.length !== 0 || post.keyWordsEn.length !== 0) && data.thread.type !== "product"
                          .keyWords(style="margin-top:1rem;")
                            .panel.panel-default(style="border:0;margin-bottom:0")
                              .panel-heading.paperHeader 关键词
                              .panel-body(style="padding:5px")
                                if post.keyWordsCn.length !== 0
                                  div
                                    for keyCn in post.keyWordsCn
                                      span.keyWordstagCn(style="cursor:pointer" onclick=`turnSearch("${keyCn}")`)!=keyCn
                                if post.keyWordsEn.length !== 0
                                  div(style="margin-top:5px")
                                    for keyEn in post.keyWordsEn
                                      span.keyWordstagEn(style="cursor:pointer" onclick=`turnSearch("${keyEn}")`)!=keyEn
                      if data.paging.page === 0
                        if data.thread.type === "article"
                          div.thread-content.ThreadPostBody#thread-content!= experimental_render(post)
                        else if data.thread.type === "product"
                          div.thread-content.ThreadPostBody
                            include ./product/product.pug
                        else if data.thread.type === "fund"
                          include ../fund/initData
                          div.thread-content.ThreadPostBody#thread-content
                            include ./fund/fund.pug
                        +postEditTime(post)
                        -const creditPost = data.posts[0];
                        include ./postCredits
                      else
                        div.thread-content(style='max-height: 10rem;')
                          .hiddenThreadContent
                          div.ThreadPostBody#thread-content!= experimental_render(post)
                          +postEditTime(post)
                          -const creditPost = data.posts[0];
                          include ./postCredits
                        .text-center
                          .showThreadContentBtn(onclick='showThreadContent()' hide-text='收起') 加载全文
                      if post.disabled && disablePost
                        a(onclick=`enablePost('${post.pid}')`) [此楼已屏蔽，点击解除]
                      .m-t-05
                        //- 文章所属专业
                        span 来自：
                        for forums, index in data.forumsNav
                          if index !== 0
                            span ，
                          for f,index in forums
                            if index !== 0
                              span &nbsp;/&nbsp;
                            a(href=`/f/${f.fid}` data-float-fid=f.fid)=f.displayName
                        .pull-right.text-right
                          if thread.firstPost.digest
                            .inline-block
                              span.fa.fa-star(style='color: #ffbf16;' title='精选')
                              span &nbsp;
                          - const votePost = thread.firstPost;
                          .inline-block(style="vertical-align: text-top;")
                            include ../module_vote
                          //- 展开附件
                          if data.attachmentsCount > 0
                            .pointer.inline-block(style="color: #aaa;margin-right: 2px;" onclick="showAttachments()")
                              .fa.fa-file-o
                              span &nbsp;查看附件
                          if !thread.firstPost.anonymous && addKcb && data.user && thread.firstPost.uid !== data.user.uid
                            .inline-block(style='color: #aaa;')
                              .fa.fa-cny(title='鼓励' style='cursor:pointer;' onclick=`credit("${thread.firstPost.pid}", 'kcb', ${data.user.kcb})`) &nbsp;鼓励&nbsp;
                          .highlight.fa.fa-qrcode.dropdown(class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false" style="color: #aaa;") &nbsp;分享&nbsp;
                          .dropdown-menu.stop-propagation(data-stopPropagation=true style='left: auto;right: 0;border: none;box-shadow: none;margin-right: 0.5rem;width:90px;background:none')
                            div(style="display:inline-block;width:100%;vertical-align:top;text-align:right;")
                              .ThreadTitle2(style="display:inline-block;max-width:100%;vertical-align:top;")
                                .ThreadTitle22(style="border: 1px solid #ddd;border-radius: 10px;overflow: hidden;padding: 3px 3px 0 3px;background:#FFFFFF")
                                  div.changeDis(style="width:100%")
                                    p.lighttext.airnum1(style="font-size:21px;text-align:center;margin-top:0px;margin-bottom:0px;") 文 号
                                    .hrdiv(style="width:80%;height:1px;background-color:#ddd;margin:0 auto;")
                                    -var tpid = thread.firstPost.pid
                                    p.lighttext.airnum2(style="font-size:21px;text-align:center;color:#cdf;margin-bottom:0px;margin-top:0px;") #{tpid}
                                    .hrdiv(style="width:80%;height:1px;background-color:#ddd;margin:0 auto;")
                                    p.lighttext.airnum3(style="text-align:center;") #{(thread.count)?(thread.count)+' 回复 /':''} #{thread.hits} 浏览
                                  if !state.isApp
                                    div.changeDisNone.text-center(style='width: 100%;')
                                      .col-xs-12.col-md-12
                                        .col-xs-3.col-md-3(style="padding:0px")
                                          a.btn-block(style="display:inline-block" href="javascript:void(0);" onclick=`shareTo('thread', 'qq', window.location.origin+window.location.pathname, '${thread.firstPost.t}', "${thread.tid}")`)
                                            img(src="/default/QQ.png" style="")
                                        .col-xs-3.col-md-3(style="padding:0px")
                                          a.btn-block(style="display:inline-block" href="javascript:void(0);" onclick=`shareTo('thread', 'qzone', window.location.origin+window.location.pathname, '${thread.firstPost.t}', "${thread.tid}")`)
                                            img(src="/default/qzone.png" style="")
                                        .col-xs-3.col-md-3(style="padding:0px")
                                          a.btn-block(style="display:inline-block" href="javascript:void(0);" onclick=`shareTo('thread', 'weibo', window.location.origin+window.location.pathname, '${thread.firstPost.t}', "${thread.tid}")`)
                                            img(src="/default/weibo.png" style="")
                                        .col-xs-3.col-md-3(style="padding:0px")
                                          a.btn-block(style="display:inline-block" href="javascript:void(0);" onclick=`shareTo('thread', 'weChat', window.location.origin+window.location.pathname, '${thread.firstPost.t}', "${thread.tid}")`)
                                            img(src="/default/weChat.png" style="")
                                      .col-xs-12.col-md-12
                                        a.btn-block(style="display:inline-block" href="javascript:void(0);" onclick=`shareTo('thread', 'link', window.location.origin+window.location.pathname, '${thread.firstPost.t}', "${thread.tid}")`) 获取分享链接
                                      .col-xs-12.col-md-12(id=`copyArea${thread.tid}` style="display:none")
                                        input(type="text", id=`copyLink${thread.tid}`, name=`copyLink${thread.tid}` style="width:inherit")
                                        button(onclick=`copyLink('${thread.tid}')` id=`copyButton${thread.tid}`) 复制
                                      canvas#threadQrcode.inline-block(style="display:none")
                          if data.user
                            +postOptions(thread.firstPost, thread, 0)
                      if data.attachmentsCount > 0
                        .thread-attachment.m-t-1
                          include ../publicModules/attachments/attachments
          if data.thread.firstPost.surveyId
            .m-b-1
              -const surveyFormId = `surveyForm${data.thread.firstPost.pid}`;
              -const surveyId = data.thread.firstPost.surveyId;
              include ../publicModules/survey/form
          if data.toppedPosts && data.toppedPosts.length
            .m-b-1
              .row
                .thread-div
                  .topped-post
                    .fa.fa-thumb-tack &nbsp;
                    | 置顶回复
                  .col-xs-12.col-md-12(style='margin-top: 1rem;')
                    -const hidePostOptions = true;
                    -const hidePostStep = true;
                    //- 置顶的回复不折叠
                    -const disabledHidePost = true;
                    -const showPostUrl = true;
                    -const disabledHighlight = true;
                    for post, index in data.toppedPosts
                      include single_post
          if data.posts.length
            div
              .row
                .thread-div
                  .col-xs-12.col-md-12
                    .row
                      .col-xs-12.col-md-12(style='margin-top: 1rem;')
                        include ../publicModules/paging/paging
                        //-include ../interface_navigation_paging
                        //-if- !data.thread.firstPost.anonymous
                        .paging-button
                          a.button.radius-left(href=`/t/${thread.tid}` class=data.t!=="author"?"active":"")  全部
                          a.button.radius-right(href=`/t/${thread.tid}?t=author` class=data.t==="author"?"active":"")  只看作者

                      .col-xs-12.col-md-12(style='margin-top: 1rem;margin-bottom: 1rem;')#ThreadPostBody
                        for post, index in data.posts
                          if index !== 0 || data.paging.page !== 0
                            //- 文章作者的post无需折叠
                            -let disabledHidePost;
                            if data.thread.uid && post.uid && data.thread.uid === post.uid
                              //- 作者的回复不折叠
                              -disabledHidePost = true;
                            else
                              //- 服务器根据证书判断的该用户的回复是否需要折叠
                              -disabledHidePost = !['half', 'all'].includes(post.hidePost);
                              //- -disabledHidePost = !post.hide;
                            -let previousPost;
                            if index !== 1
                              -previousPost = data.posts[index-1];
                            include single_post
                      .col-xs-12.col-md-12
                        include ../publicModules/paging/paging_input
                      if data.user
                        .col-xs-12.col-md-12
                          - var hasMobile = data.user.authLevel > 0;

                          //- 回复的输入面板
                          mixin inputPanel
                            .form-group
                              div#quoteContent
                            .form-group
                              div#quoteCancel(style='display: none')
                                button#quoteCancel.ForumThreadHasImage(style='background-color: #337ab7' onclick=`cancelQuote()`) 取消引用
                            .form-group(style="background-color:#fff;")
                              script#container(name='content', type='text/plain')
                            .row
                              .col-xs-12
                                label(style="font-size:16px") 专栏
                                include ../editor/toColumn

                                if data.sendAnonymousPost
                                  .checkbox
                                    label
                                      if data.user && data.thread && data.thread.firstPost && data.thread.firstPost.ownPost && data.thread.firstPost.anonymous
                                        input#sendAnonymousPost(type='checkbox' checked=true)
                                      else
                                        input#sendAnonymousPost(type='checkbox')
                                      span 匿名发表
                                //-
                                  if state.userColumn && !data.addedToColumn
                                    -const column = state.userColumn
                                    include ../publicModules/toColumn/selectCategories
                                div
                                  .checkbox
                                    label
                                      input#protocolCheckbox(type="checkbox" checked=true)
                                      span
                                        | 我已阅读并同意遵守与本次发表相关的全部协议。
                                        a(href=`/protocol` target="_blank") 查看协议
                                .form-group
                                  button#ButtonReply.btn.btn-primary(onclick=`submit(${thread.tid})`) 回复
                                  button#draft.btn.btn-primary(onclick=`saveDraft(${thread.tid},${data.user.uid})`) 保存草稿
                                  button#GoEditor.btn.btn-default(onclick='goEditor()') 去编辑器
                          //- 主题已关闭
                          if thread.closed
                            .col-xs-12.col-md-12(style='margin: 2rem 0;')
                              .h4.text-center(style='color: #aaaaaa;')
                                span.fa.fa-times &nbsp;主题已关闭，暂不能发表回复/评论
                          else
                            //- 发表权限判断
                            include ./postPermission
                            if showEditor
                              +inputPanel

                      else
                        .col-xs-12.col-md-12
                          p 想参与大家的讨论？现在就&nbsp;
                            a.pointer(onclick="NKC.methods.toLogin('login')") 登录
                            | &nbsp;或者&nbsp;
                            a.pointer(onclick="NKC.methods.toLogin('register')") 注册
                            | 。

        .col-xs-12.col-md-3.box-shadow-panel#rightDom
          if data.thread.type === "fund"
            include ../fund/initData
            include ../fund/options
          if data.targetUser
            .m-b-1
              //- .panel-header 作者
              -const author = data.targetUser;
              include ./authorInfo
            if data.targetUserThreads && data.targetUserThreads.length
              -let sideThreads = data.targetUserThreads
              -let sideThreadsHeader= "作者最新文章"
              -let sideThreadsHideInfo = false;
              include ../publicModules/side_thread_list
          if data.sameThreads && data.sameThreads.length
            -let sideThreads = data.sameThreads
            -let sideThreadsHeader = "相似文章推荐"
            -let sideThreadsHideInfo = false;
            include ../publicModules/side_thread_list
          .hidden-sm.hidden-xs
            include ../publicModules/footer/footer_sm

          include ../module_scrollTo

    //- 作者信息
    .modal.fade#moduleAuthor(tabindex="-1" role="dialog" aria-labelledby="myModalLabel")
      .modal-dialog.modal-sm(role="document" v-cloak v-if="contract")#moduleAuthorApp
        .modal-content
          .modal-header
            button.close(data-dismiss="modal" aria-label="Close")
              span(aria-hidden="true") &times;
            h4.modal-title 通信作者
          .modal-body
            .form
              .form-group(v-if="contract.contractEmail")
                h5 通信邮箱：
                strong {{contract.contractEmail}}
              .form-group(v-if="contract.contractTel")
                h5 电话号码：
                strong {{contract.contractTel}}
              .form-group(v-if="contract.contractAdd")
                h5 通信地址：
                strong {{contract.contractAdd}}
              .form-group(v-if="contract.contractCode")
                h5 邮政编码：
                strong {{contract.contractCode}}

    include ../debug_output.pug
    include ../thread_to_recycle.pug
    include ../post_to_recycle.pug
    include ../publicModules/post_warning
    if state.userColumn
      -const column = state.userColumn
      include ../publicModules/toColumn/toColumn

block scripts
  include ../publicModules/plyr/plyr.js.pug
  script.
    NKC.configs.postHeight = {};
  script=`NKC.configs.postHeight.xs=${data.postHeight.xs}`
  script=`NKC.configs.postHeight.sm=${data.postHeight.sm}`
  script=`NKC.configs.postHeight.md=${data.postHeight.md}`
  script=`NKC.configs.postHeight.float=${data.postHeight.float || 0.5}`
  script(src='/commonmark/dist/commonmark.js')
  script(src='/plain_escaper.js')
  script(src='/xbbcode-parser/xbbcode.js')
  script(src='/xss/dist/xss.js')

  +includeJS("/nkc_render.js")
  +includeJS("/interface_editor_reply.js")
  +includeJS('/external_pkgs/etalage/js/jquery.etalage.min.js')
  +includeJS('/shop/shop.js')
  +includeJS("/publicModules/survey/form.js")
  include ../publicModules/subscribeTypes/subscribeTypes
  include ../publicModules/sticker/sticker
  include ../publicModules/selectResource/selectResource
  include ../publicModules/sticker/selectSticker
  include ../publicModules/selectDraft/selectDraft
  include ../publicModules/floatForumPanel/floatForumPanel
  include ../publicModules/floatUserPanel/floatUserPanel.2.pug
  include ../publicModules/highlight/highlight_editor
  include ../publicModules/complaint/complaint
  include ../publicModules/crop/crop
  include ../publicModules/moment
  include ../publicModules/hidePost/hidePost
  include ../publicModules/lazySizes
  include ../publicModules/moveThread/moveThread
  include ../publicModules/disabledPost/disabledPost
  if data.attachmentsCount > 0
    include ../publicModules/resourceInfo/resourceInfo
    include ../publicModules/attachments/attachments_js
    script=`NKC.configs.pid = '${data.thread.oc}';`
    -let fid;
    for f in data.thread.forums
      if f.lid
        -fid = f.fid;
    if fid
      script=`NKC.configs.fid = '${fid}';`
  if data.user
    include ../ueditor/ueditorBase
  include ../MathJax.pug
  if data.user && showEditor
    +includeJS("/thread/initPostInput.js")
  if state.userColumn && !data.addedToColumn && showEditor
    +includeJS("/publicModules/toColumn/selectCategories.js")
  +includeJS("/thread/comments.js")
  if permission("getPostAuthor")
    include ../publicModules/floatUserPanel/userInfo
  include ../publicModules/imageViewer
  +includeJS("/thread/index.js")
