extends ../bootstrap_base.pug

block title
  -const thread = data.thread;
  title= `${thread.firstPost.t} - 科创论坛`
  meta#replytarget(value=`${data.replyTarget}`)

  -let modifyPostTimeLimit = 0;
  -for(let i = 0; i < data.userRoles.length; i++)
    -const r = data.userRoles[i];
    if r.modifyPostTimeLimit > modifyPostTimeLimit
      -modifyPostTimeLimit = r.modifyPostTimeLimit
    if r.modifyPostTimeLimit === -1
      -modifyPostTimeLimit = -1;
      -break;

  -const postTo = data.userOperationsId.includes('quotePost')
  -const addCredit = data.userOperationsId.includes('creditXsf')
  -const addKcb = data.userOperationsId.includes('creditKcb')
  -const disablePost = data.userOperationsId.includes('disabledPost') || data.userOperationsId.includes('moveDraft')
  -const highlight = data.highlight;
  -const digestPost = data.userOperationsId.includes('digestPost');
  -const unDigestPost = data.userOperationsId.includes('unDigestPost');
  include ../MathJax.pug

  if (thread.firstPost&&thread.firstPost.c)
    -var processed=thread.firstPost.c.replace(/\[.*?]|\#|\n|\<.*?>/gm,'').trim().slice(0,140)
    
    meta(name='description' content=`${processed}`)
    meta(name='keywords' content=`${thread.firstPost.t}`)

  mixin postOptions(post, targetThread, index)
    .inline-block.highlight.post-options(style='float: right;margin-right: 0.5rem;color: #aaaaaa;')
      .dropdown(class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false")
        span.fa.fa-sliders
        if targetThread
          span &nbsp;操作
      ul.dropdown-menu.stop-propagation(style='left: auto;right: 0;' data-stopPropagation=true)
        if postTo && !thread.closed
          li
            a(href=`javascript:quotePost('${post.pid}', '${data.paging.start + index}', '${data.paging.page.toString()}')`)
              span.fa.fa-comment-o &nbsp;
              span 引用
        if !thread.closed
          li
            a(href=`javascript:at('${post.user.username}')`)
              span.fa.fa-at= ` ${post.user.username}`
        if targetThread && targetThread.oc === post.pid && data.user && data.userOperationsId.includes('collectThread')
          li
            if data.collected
              a(href=`javascript: addColl('${thread.tid}')`)
                span.fa.fa-folder-o &nbsp;已收藏
            else
              a(href=`javascript: addColl('${thread.tid}')`)
                span.fa.fa-folder-o &nbsp;加入收藏
        if addCredit
          li
            a(href=`javascript:addCredit('${post.pid}')`)
              span.fa.fa-graduation-cap &nbsp;
              span 评学术分
        if digestPost && !post.digest
          li
            a(href=`javascript:digestPost("${post.pid}")`)
              span.fa.fa-star-o &nbsp;设为精选
        if unDigestPost && post.digest
          li
            a(href=`javascript:unDigestPost("${post.pid}")`)
              span.fa.fa-star &nbsp;取消精选
        - var ownership = data.userOperationsId.includes('modifyOtherPosts')
        - ownership = ownership?true:(data.user.uid===post.uid)
        if addKcb && post.uid !== data.user.uid
          li
            a(href=`javascript: addKcb("${post.pid}", ${data.user.kcb})`)
              span.fa.fa-thumbs-o-up &nbsp;
              span 鼓励
        if(testModifyTimeLimit(modifyPostTimeLimit, ownership, post.toc))
          li
            a(href=`/editor?type=post&id=${post.pid}`)
              span.fa.fa-edit &nbsp;编辑
        if disablePost && !targetThread
          li
            a(href=`###` onclick=`disablePostClick('${post.pid}', "${targetThread?'thread':'post'}")` data-toggle="modal" data-target="#postRecycleModal" data-whatever="@mdo")
              span.fa.fa-eye-slash &nbsp;屏蔽
        if(post.tlm > post.toc && data.userOperationsId.includes('visitPostHistory'))
          if !post.hideHistories || data.userOperationsId.includes('displayPostHideHistories')
            li
              a(href=`/p/${post.pid}/history`)
                span.fa.fa-history &nbsp;历史版本
        li.divider
        li
          a
            span.fa.fa-clock-o= ` ${post.toc.toLocaleString()}`
        if disablePost
          li
            -const ipoc = post.iplm || post.ipoc;
            a(href=`http://ip138.com/ips138.asp?ip=${ipoc.toString()}&action=2` title=ipoc target='_blank')
              span.fa.fa-map-marker(style='margin-left: 2px;')= ` ${ipoc}`
  mixin postEditTime(post)
    if post.toc.toLocaleString() !== post.tlm.toLocaleString()
      p.lighttext [修改于 #{fromNow(post.tlm)} - #{dateString(post.tlm)}]
  mixin postCredits(post)
    if post.credits && post.credits.length > 0
      .nkcpanel.ThreadPostCredits
        each c,index in post.credits
          -var username = c.username||c.uid
          -var profile = (c.uid&&c.uid!=='0')?'/m/'+c.uid:'/user_activities_byname/'+c.username
          .ThreadPostCreditItem
            span.TPCQ #{(c.q > 0 ? '+' : '-')}#{c.q} &nbsp;
            span.TPCType #{creditString(c.type)} &nbsp;&nbsp;
            span.TPCIA
              a(href=`${profile}`)
                img.TPCIAI(src=`/avatar_small/${c.uid}`)
            span.TPCIssuer #{username} &nbsp;&nbsp;
            span.TPCDate #{dateTimeString(c.toc).split(' ')[0]} &nbsp;&nbsp;
            span.TPCReason #{c.reason}
  
block content
  -const mainContainer1400 = true;
  -const moveThread = data.isModerator || data.userOperationsId.includes('moveThread');
  -const {exactPost} = data

    .container-fluid(style="max-width:1400px;")
      .row
        .col-xs-12.col-md-9
          .fullwidthpanel.ThreadBox.nkcpanel
            .row
              .thread-div
                .col-xs-12.col-md-12
                  .thread-management
                    .title
                      if thread.forum.parentForum
                        a(href=`/f/${thread.forum.parentForum.fid}` style='text-decoration: none;margin-right: 0.5rem;')
                          span(style=`padding: 2px 5px;color: #ffffff;border-radius:5px;background-color: ${thread.forum.parentForum.color}`)= thread.forum.parentForum.displayName
                      if thread.forum
                        a(href=`/f/${thread.forum.fid}` style='text-decoration: none;')
                          span(style=`padding: 2px 5px;color: #ffffff;border-radius:5px;background-color: ${thread.forum.color}`)= thread.forum.displayName
                      if data.user
                        -let canManagement = false;
                        -for(let i = 0; i < data.userOperationsId.length; i++)
                          -const operationId = data.userOperationsId[i];
                          if ['digestThread', 'unDigestThread', 'toppedThread', 'unToppedThread', 'homeTop', 'unHomeTop'].includes(operationId)
                            -canManagement = true;
                            -break;
                        if data.isModerator || canManagement
                          a(href=`javascript:displayManagement();` style='text-decoration: none;float: right;')
                            .highlight.fa.fa-cog
                        +postOptions(thread.firstPost, thread, 0)
                      .inline-block(style='float: right;')
                        .highlight.fa.fa-qrcode.dropdown(class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false") &nbsp;分享
                        .dropdown-menu.stop-propagation(data-stopPropagation=true style='left: auto;right: 0;border: none;box-shadow: none;margin-right: 0.5rem;width:90px;background:none')
                          div(style="display:inline-block;width:100%;vertical-align:top;text-align:right;")
                            .ThreadTitle2(style="display:inline-block;max-width:100%;vertical-align:top;")
                              .ThreadTitle22(style="border: 1px solid #ddd;border-radius: 10px;overflow: hidden;padding: 3px 3px 0 3px;background:#FFFFFF")
                                div.changeDis(style="width:100%")
                                  p.lighttext.airnum1(style="font-size:21px;text-align:center;margin-top:0px;margin-bottom:0px;") 文 号
                                  .hrdiv(style="width:80%;height:1px;background-color:#ddd;margin:0 auto;")
                                  -var tpid = thread.firstPost.pid
                                  p.lighttext.airnum2(style="font-size:21px;text-align:center;color:#cdf;margin-bottom:0px;margin-top:0px;") #{tpid}
                                  .hrdiv(style="width:80%;height:1px;background-color:#ddd;margin:0 auto;")
                                  p.lighttext.airnum3(style="text-align:center;") #{(thread.count-1)?(thread.count-1)+' 回复 /':''} #{thread.hits+1} 浏览
                                div.changeDisNone.text-center(style='width: 100%;')
                                  .col-xs-12.col-md-12
                                    .col-xs-4.col-md-4(style="padding:0px")
                                      a.btn-block(style="display:inline-block" href="javascript:void(0);" onclick=`shareTo('thread', 'qq', window.location.href, '${thread.firstPost.t}')`)
                                        img(src="/default/QQ.png" style="")
                                    .col-xs-4.col-md-4(style="padding:0px")
                                      a.btn-block(style="display:inline-block" href="javascript:void(0);" onclick=`shareTo('thread', 'qzone', window.location.href, '${thread.firstPost.t}')`)
                                        img(src="/default/qzone.png" style="")
                                    .col-xs-4.col-md-4(style="padding:0px")
                                      a.btn-block(style="display:inline-block" href="javascript:void(0);" onclick=`shareTo('thread', 'weibo', window.location.href, '${thread.firstPost.t}')`)
                                        img(src="/default/weibo.png" style="")
                                    //- .col-xs-4.col-md-4(style="padding:5px" onclick=`shareTo('thread', 'qzone', window.location.href, '${thread.firstPost.t}')`)
                                    //-   img(src="/default/qzone.png" style="width:100%")
                                    //- .col-xs-4.col-md-4(style="padding:5px" onclick=`shareTo('thread', 'weibo', window.location.href, '${thread.firstPost.t}')`)
                                    //-   img(src="/default/weibo.png" style="width:100%")
                                  canvas.qrcode.inline-block
                      .inline-block.post-thumbsUp
                        //span &nbsp;
                        //-const recUsers = thread.firstPost.recUsers || [];
                        //if data.user && recUsers.includes(data.user.uid)
                        //  span(data-pid=thread.firstPost.pid).thumbsUp.fa.fa-thumbs-o-up=`${recUsers.length || ''}`
                        //else
                        //  span(data-pid=thread.firstPost.pid).thumbsDown.fa.fa-thumbs-o-up=`${recUsers.length || ''}`
                        // - post = thread.firstPost;
                        - const votePost = thread.firstPost;
                        include ../module_vote
                      if thread.firstPost.digest
                        .inline-block.post-thumbsUp
                          span &nbsp;
                          span.fa.fa-star(style='color: #ffbf16;' title='精选')


                      if data.user
                        div.managementDiv(style='display: none;margin-top: 1rem;')
                          .form-inline
                            //- 设置精华
                            //if data.isModerator || data.userOperationsId.includes('digestThread') && !thread.digest
                            //  button.btn.btn-default.btn-sm#threadDigest(onclick=`setDigest('${data.thread.tid}')`) 设为优秀文章
                            //if data.isModerator || data.userOperationsId.includes('unDigestThread') && thread.digest
                            //  button.btn.btn-default.btn-sm#threadDigest(onclick=`cancelDigest('${data.thread.tid}')`) 取消设为优秀文章
                            //- 设置置顶
                            if data.isModerator || data.userOperationsId.includes('toppedThread') && !thread.topped
                              button.btn.btn-default.btn-sm#threadTop(onclick=`setTopped('${data.thread.tid}')`) 专业置顶
                            if data.isModerator || data.userOperationsId.includes('unToppedThread') && thread.topped
                              button.btn.btn-default.btn-sm#threadTop(onclick=`cancelTopped('${data.thread.tid}')`) 取消专业置顶
                            if data.userOperationsId.includes('homeTop') && !data.ads.includes(data.thread.tid)
                              button.btn.btn-default.btn-sm#threadTop(onclick=`homeTop('${data.thread.tid}')`) 首页置顶
                            if data.userOperationsId.includes('unHomeTop') && data.ads.includes(data.thread.tid)
                              button.btn.btn-default.btn-sm#threadTop(onclick=`unHomeTop('${data.thread.tid}')`) 取消首页置顶
                            if data.userOperationsId.includes('closeThread') && !thread.closed
                              button.btn.btn-default.btn-sm(onclick=`closeThread('${data.thread.tid}')`) 关闭主题
                            if data.userOperationsId.includes('openThread') && thread.closed
                              button.btn.btn-default.btn-sm(onclick=`openThread('${data.thread.tid}')`) 开放主题
                          if moveThread || (!thread.fid && !thread.toMid && isMyForumMdr)
                            .form-inline(style='margin: 0.5rem 0')
                              .form-group.form-group-sm
                                include ../forumlist_dropdown.pug
                                button.btn.btn-default.btn-sm(onclick=`moveThreads('${thread.tid}')`) #{moveThread? '移动' : '转发'}
                              if moveThread
                                .form-group
                                  //- button#recyclebtn.btn.btn-sm.btn-danger(onclick=`moveThreadToRecycle('${data.thread.tid}')`) 送回收站
                                  button.btn.btn-danger.btn-sm(type="button" class="btn btn-primary" data-toggle="modal" data-target="#recycleModal" data-whatever="@mdo") 送回收站
                                  //- <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal" data-whatever="@mdo">Open modal for @mdo</button>
                .col-xs-12.col-md-12
                  .row
                    .col-xs-12.col-md-12(style=`margin: 3rem 0 1rem 0;${thread.recycleMark?'border: 1px solid #ff5a0b;padding: 0.5rem;border-radius: 5px;background-color: #fafafa;':''}`)
                      if thread.recycleMark
                        .h4.text-center(style='color: #ff5a0b;') 本文已被退回修改，请作者点击编辑按钮进入编辑界面
                        p.text-center(style='border-bottom: 1px solid #ff5a0b; padding-bottom: 1rem;color: #ff5a0b;')= `退修原因：${thread.reason}`
                      .h3.thread-title.text-center= thread.firstPost.t
                      .thread-info.text-center
                        a(href=`/u/${thread.uid}`)
                          img(src=`/avatar_small/${thread.uid}` style='width: 1.5rem;height: 1.5rem;border-radius:50%;')
                          span= ` ${thread.firstPost.user.username}`
                        span(style='color: #555555;')= ` ${thread.toc.toLocaleString()}`

                      -const post = thread.firstPost;
                      -post.c = hideContentByUser(post.c, data.user, 'thread')
                      if data.paging.page === 0
                        div.thread-content.ThreadPostBody!= experimental_render(post)
                        +postEditTime(post)
                        +postCredits(post)
                      else
                        div.thread-content(style='max-height: 10rem;')
                          .hiddenThreadContent
                          div.ThreadPostBody!= experimental_render(post)
                          +postEditTime(post)
                          +postCredits(post)
                        .text-center
                          .showThreadContentBtn(onclick='showThreadContent()' hide-text='收起') 加载全文
                      if post.disabled && disablePost
                        a(href=`javascript:enablePost('${post.pid}')`) [此楼已屏蔽，点击解除]
          .fullwidthpanel.ThreadBox.nkcpanel
            .row
              .thread-div
                .col-xs-12.col-md-12
                  .row
                    .col-xs-12.col-md-12(style='margin-top: 1rem;')
                      include ../interface_navigation_paging
                    .col-xs-12.col-md-12(style='margin-top: 1rem;margin-bottom: 1rem;')
                      for post, index in data.posts
                        if index !== 0 || data.paging.page !== 0
                          -let previousPost;
                          if index !== 1
                            -previousPost = data.posts[index-1];
                          include single_post
                    .col-xs-12.col-md-12
                      include ../interface_navigation_paging
                    if data.user
                      .col-xs-12.col-md-12
                        - var hasMobile = data.user.authLevel > 0;
                        //- if hasMobile && data.user.volumeA

                        // 回复的输入面板
                        mixin inputPanel
                          .form-group
                            div#quoteContent
                          .form-group
                            div#quoteCancel(style='display: none')
                              button#quoteCancel.ForumThreadHasImage(style='background-color: #337ab7' onclick=`cancelQuote()`) 取消引用
                          .form-group
                            div#ReplyContent
                          .form-inline
                            .form-group
                              button#ButtonReply.btn.btn-primary(onclick=`submit(${thread.tid})`) 回复
                              button#draft.btn.btn-primary(onclick=`saveDraft(${thread.tid},${data.user.uid})`) 保存草稿

                            .checkbox-inline
                              label
                                input#ParseURL(type='checkbox' checked)
                                | 处理URL

                            if 0
                              .form-group
                                button#WiderArea.hidden-xs.btn.btn-default(onclick='widerArea()') 拓展
                            //- include twemoji.pug
                            .form-group
                              button#GoEditor.btn.btn-default(onclick='goEditor()') 去编辑器
                          .form-group
                          .nkcpanel(id='file-uploading' target='/r')
                            //uploader section
                            include ../interface_attachment_uploader_uploader.pug

                          .panel.panel-default
                            .panel-heading 我的附件（点击插入帖子）
                            .panel-body(id='list-container')


                        if hasMobile
                          if !thread.closed
                            if !data.user.volumeA
                              -const volumeAFailedPostCountOneDay = data.examSettings.volumeAFailedPostCountOneDay;
                              if volumeAFailedPostCountOneDay === -1
                                // 对未通过A卷的用户回复不做限制
                                +inputPanel
                              else if volumeAFailedPostCountOneDay === 0
                                .text-danger
                                  .h4(style='margin-bottom: 0rem;')=`您还未参加考试，暂不能发表文章和回复。`
                                  .h4
                                    a(href='/exam' target='_blank') 点击这里参加考试
                              else if data.userPostCountToday >= data.examSettings.volumeAFailedPostCountOneDay
                                .text-danger
                                  .h4(style='margin-bottom: 0rem;')=`您还未参加考试，每天只能发表${data.examSettings.volumeAFailedPostCountOneDay}条回复，且不能发表文章。`
                                  .h4= `今日已发表${data.userPostCountToday}条回复，`
                                    a(href='/exam' target='_blank') 点击这里参加考试
                                    span ，通过后将获得更多发言权限。
                              else
                                //- .form-group
                                //-   textarea#ReplyContent.form-control(rows='5' placeholder='快速回复（bbcode语法）' style='resize:vertical; ')
                                // 未通过A卷考试的用户能看到提示
                                .form-group.text-danger(style='margin-bottom: 0rem;')=`您还未参加考试，每天只能发表${data.examSettings.volumeAFailedPostCountOneDay}条回复，且不能发表文章。`
                                  div=`今日已发表${data.userPostCountToday}条回复，`
                                    a(href='/exam' target='_blank') 点击这里参加考试
                                    span ，通过后将获得更多发言权限。
                                +inputPanel
                            else
                              +inputPanel
                          else
                            .col-xs-12.col-md-12(style='margin: 2rem 0;')
                              .h4.text-center(style='color: #aaaaaa;')
                                span.fa.fa-times &nbsp;主题已关闭，暂不能发表回复


                      include ../exam_notification.pug

                    else
                      .col-xs-12.col-md-12
                        :markdown
                          想参与大家的讨论？现在就 [登录](/login) 或者 [注册](/register)。

        .col-xs-12.col-md-3
          -var user = data.thread.firstPost.user
          if user
            include ../interface_thread_userpatch.pug
          if data.targetUserThreads && data.targetUserThreads.length !== 0
            .fullwidthpanel.ThreadBox.nkcpanel.user-threads
              .thread-aside-header 作者最新文章
              for thread, index in data.targetUserThreads
                .thread-aside-title
                  a(href=`/t/${thread.tid}`)
                    span= index+1+'. '
                    span= thread.firstPost.t
          if data.sameThreads && data.sameThreads.length !== 0
          .fullwidthpanel.ThreadBox.nkcpanel.user-threads
            .thread-aside-header 相似文章推荐
            for thread, index in data.sameThreads
              .thread-aside-title
                a(href=`/t/${thread.tid}`)
                  span= index + 1 + '. '
                  span= thread.firstPost.t
          .fullwidthpanel.ThreadBox.nkcpanel.hidden-sm.hidden-xs
            ul.HomeFriendlyLink
              include ../nkc_footer_links.pug
          .hidden-xs.hidden-sm
            .nkcpanel2#topB(style='margin-left: -25px; position: fixed; top: 50%; display: block;')
              button(class="glyphicon glyphicon-chevron-up btn btn-sm btn-default" style="margin-bottom:10px; padding: 10px 3px;" onclick="javascript:window.scrollTo(0,0);")
              br
              button(class="glyphicon glyphicon-chevron-down btn btn-sm btn-default" onclick="location.href='#bm'" style="padding: 10px 3px;")


    include ../debug_output.pug
    include ../thread_to_recycle.pug
    include ../post_to_recycle.pug
    #bm
block scripts
  script(src=`/interface_common.js?v=${global.NKC.startTime}`)
  script(src='/module_dropdown.js?v=3')
  script(src=`/thread/index.js?v=${global.NKC.startTime}`)
  script.
    common.backcolorChange("#{(data.user?data.user.color:null)||'#e4e4e4'}");
  script(src="/jquery-1.10.2.js")
  script(src="/jquery-ui-1.10.4.custom.js")
  script(src='/commonmark/dist/commonmark.js')
  script(src='/plain_escaper.js')
  script(src='/xbbcode-parser/xbbcode.js')
  script(src='/xss/dist/xss.js')
  
  script(src='/external_pkgs/react/react.min.js')
  script(src='/external_pkgs/react/JSXTransformer.js')
  script(src=`/nkc_render.js?v=${global.NKC.startTime}`)
  script(src=`/interface_editor_reply.js?v=${global.NKC.startTime}`)
  script(src=`/interface_attachment_uploader.js?v=${global.NKC.startTime}`)
  script(type='text/jsx;harmony=true' src=`/interface_attachment_list_display_test.js?v=${global.NKC.startTime}`)
  script(type="text/javascript" src=`/wangEditor.js?v=${global.NKC.startTime}`)
  script(type="text/javascript" src=`/newEditor_reply.js?v=${global.NKC.startTime}`)