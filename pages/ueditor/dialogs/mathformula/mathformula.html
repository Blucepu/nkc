<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>公式插入框</title>
  <script type="text/javascript" src="../internal.js"></script>
  <script src="../../MathJax-2.6-latest/MathJax.js"></script>
  <script src="./mathformula.js"></script>
  <style>
    body {
      font: 12px/1.5 sans-serif, "宋体", "Arial Narrow", HELVETICA !important;
      color: #000 !important;
    }
    .mathDiaFieldset {
      border: 1px solid #ddd;
      padding:5px;
      padding-left: 5px;
      margin: 10px;
      margin-bottom: 10px;
      padding-bottom: 5px;
    }
  </style>
</head>
<body style="padding: 2px">
  <div>
    <fieldset class="mathDiaFieldset">
        <legend>温馨提示</legend>
        <table>
          <tbody>
            <tr>
              <td class="ignoreRender">1. 正文显示(inline)：请使用$....$或\(....\)包裹代码</td>
            </tr>
            <tr>
              <td class="ignoreRender">2. 单独显示(display)：请使用$$....$$或\[....\]包裹代码</td>
            </tr>
            <tr>
              <td class="ignoreRender">3. 插入的公式在编辑时不会渲染，请检查无误后再插入。</td>
            </tr>
          </tbody>
        </table>
    </fieldset>
  </div>
  <div>
    <fieldset class="mathDiaFieldset">
        <legend>公式输入</legend>
        <textarea id="mathInput" style="width: 100%;border: 0;height: 50px;cursor: inherit;" placeholder="$\sum_{i=0}^N\int_{a}^{b}g(t,i)\text{d}t$" class="ignoreRender" oninput="putTextToOutput()" onpropertychange="putTextToOutput()"></textarea>
    </fieldset>
  </div>
  <div>
    <fieldset class="mathDiaFieldset">
        <legend>公式预览</legend>
        <div id="mathOutput">$\sum_{i=0}^N\int_{a}^{b}g(t,i)\text{d}t$</div>
    </fieldset>
  </div>
  <script src="./jquery-1.11.0.min.js"></script>
  <script>
      MathJax.Hub.Config({
        jax: ["input/TeX","output/CommonHTML"],
        extensions: ["tex2jax.js","MathZoom.js"],
        tex2jax:{
            inlineMath:  [["$", "$"], ["\\(","\\)"]],
            displayMath: [["$$","$$"], ["\\[","\\]"]],
          ignoreClass:'container|ignoreRender',
          processClass:"ThreadPostBody|QuestionText"
        },
        "CommonHTML":{
          showMathMenu:false,
          preferredFont:"STIX",
          scale: 100,
          minScaleAdjust: 50
        },
        TeX: {
          equationNumbers: {autoNumber: "AMS"}
        },
        messageStyle: "none",
      });
  </script>
  <script>
    dialog.onok = function(){
      // 获取公式源代码
      var formulaCodeText = $("#mathInput").val();
      var formulaCode = formulaCodeText.substr(0, 2);
      
      if(formulaCode.indexOf("$") > -1) {
        if(formulaCode === "$$"){
          // insertformulacode
          // 3: $$...$$
          editor.execCommand('inserthtml', formulaToHtml(3, formulaCodeText));
        }else{
          // 1: $...$
          editor.execCommand('inserthtml', formulaToHtml(1, formulaCodeText));
        }
      }else{
        if(formulaCode === "\\(") {
          // 2: \(...\)
          editor.execCommand('inserthtml', formulaToHtml(2, formulaCodeText));
        }else {
          // 4: \[...\]
          if(formulaCodeText.substring(0, 2) !== "\\[") {   // 没带头尾加上头尾
            editor.execCommand('inserthtml', formulaToHtml(4, "\\["+ formulaCodeText +"\\]"));
          }else {
            editor.execCommand('inserthtml', formulaToHtml(4, formulaCodeText));
          }
        }
      }
      dialog.close();
      return false;
    }





    // 转换成nkcsource标签的html文本
  function formulaToHtml(typeid, code) {
    var nkcsource = document.createElement("nkcsource");
    nkcsource.setAttribute("data-type", "formula");
    nkcsource.setAttribute("data-id", typeid);
    // nkcsource.setAttribute("contenteditable", "false");
    if(typeid == 3 || typeid == 4) {
      // 占整行
      nkcsource.innerHTML = code;
    }else {
      // 行内
      nkcsource.innerHTML = code;
    }
    return nkcsource.outerHTML;
  }
  </script>
</body>
</html>